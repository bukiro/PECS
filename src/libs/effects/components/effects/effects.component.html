<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
<app-character-sheet-card>
    <div
        class="attributeBox"
        id="{{creature}}-effects-height"
        [ngClass]="{'snug':!fullDisplay}"
    >
        <ng-container *ngIf="componentParameters$() | async as componentParameters">
            <ng-template
                #conditionTemplate
                let-conditionGain="conditionGain"
            >
                <div
                    *ngIf="conditionParameters(conditionGain, componentParameters.isTimeStopped) as conditionParameters"
                    style="display:flex"
                    [ngClass]="{'attention':(conditionGain.durationIsInstant) || (conditionGain.nextStage === -1)}"
                >
                    <ng-template #conditionContent>
                        <app-condition
                            class="newrow"
                            [creature]="creature"
                            [conditionGain]="conditionGain"
                            [condition]="conditionParameters.condition"
                            [showItem]="shownItem()"
                            [fullDisplay]="fullDisplay"
                            (showItemMessage)="receiveShownItemMessage($event)"
                        />
                    </ng-template>

                    <div
                        *ngIf="!fullDisplay"
                        triggers="click"
                        style="display:flex;"
                        [stickyPopover]="conditionContent"
                    >
                        <app-grid-icon
                            class="condition"
                            placement="right bottom top"
                            [updateId]="conditionGain.id"
                            [ngClass]="conditionClasses(conditionParameters)"
                            [condition]="conditionGain"
                            [originalCondition]="conditionParameters.condition"
                            [superTitle]="conditionSuperTitle(conditionGain, conditionParameters.condition)"
                            [ngbTooltip]="conditionGain.name"
                            [openDelay]=0
                        />
                    </div>

                    <div
                        *ngIf="fullDisplay"
                        class="list-item gridicon-fullsizebox"
                    >
                        <app-grid-icon
                            class="condition"
                            [updateId]="conditionGain.id"
                            [condition]="conditionGain"
                            [originalCondition]="conditionParameters.condition"
                            [superTitle]="conditionSuperTitle(conditionGain, conditionParameters.condition)"
                            [ngClass]="conditionClasses(conditionParameters)"
                        />

                        <ng-container *ngTemplateOutlet="conditionContent" />
                    </div>
                </div>
            </ng-template>

            <ng-template
                #effectTemplate
                let-effect="effect"
            >
                <ng-template #effectContent>
                    <div class="newrow">
                        <span>
                            <strong
                                class="no-shadow"
                                [ngClass]="{'penalty':effect.penalty, 'bonus':(!effect.penalty && !effect.setValue && !effect.toggle), 'absolute':(effect.setValue || effect.toggle)}"
                            >
                                {{effect.target}}
                                {{effect.displayTitle(true)}}
                            </strong>
                        </span>
                    </div>

                    <div
                        *ngIf="effect.ignored"
                        class="newrow"
                    >
                        <span>
                            <strong>Ignored</strong>
                            This effect doesn't apply while it is ignored.
                        </span>
                    </div>

                    <div
                        *ngIf="effect.type !== 'untyped' && !effect.toggle && !effect.setValue"
                        class="newrow"
                    >
                        <span>
                            <strong>Type</strong>
                            {{effect.type + " " + (effect.penalty ? 'penalty' : 'bonus')}}
                        </span>
                    </div>

                    <div
                        *ngIf="effect.duration"
                        class="newrow"
                    >
                        <span>
                            <strong>Duration</strong>
                            {{effect.duration ? durationDescription$(effect.duration) : ''}}
                        </span>
                    </div>

                    <div class="newrow">
                        <span>
                            <strong>Granted by</strong>
                            {{effect.source.includes('conditional, ') ? effect.source.substr(13) : effect.source}}
                        </span>
                    </div>

                    <div
                        *ngIf="effect.source.includes('conditional, ')"
                        class="newrow"
                    >
                        <span>
                            <strong>Conditional</strong>
                            This effect only applies for certain actions or under specific circumstances.
                        </span>
                    </div>

                    <span>
                        <button
                            *ngIf="!effect.ignored"
                            type="button"
                            [ngbTooltip]="'Ignore effects on ' + effect.target + ' from ' + effect.source"
                            (click)="onIgnoreEffect(effect, true)"
                        >
                            Ignore
                        </button>

                        <button
                            *ngIf="effect.ignored"
                            (click)="onIgnoreEffect(effect, false)"
                        >
                            Stop ignoring
                        </button>
                    </span>

                </ng-template>

                <div
                    *ngIf="!fullDisplay"
                    triggers="click"
                    style="display:flex;"
                    [ngbPopover]="effectContent"
                >
                    <app-grid-icon
                        class="effect"
                        placement="left bottom top"
                        [effect]="effect"
                        [ngClass]="{'penalty':!effect.toggle && effect.penalty && !effect.ignored, 'bonus':!effect.toggle && !effect.penalty && !effect.setValue && !effect.ignored, 'absolute':(effect.toggle || effect.setValue) && !effect.ignored, 'inactive-button':effect.ignored}"
                        [ngbTooltip]="effect.target + ' ' + effect.displayTitle(true)"
                        [openDelay]=0
                    />
                </div>

                <div
                    *ngIf="fullDisplay"
                    class="list-item gridicon-fullsizebox"
                >
                    <app-grid-icon
                        class="effect"
                        [effect]="effect"
                        [ngClass]="{'penalty':!effect.toggle && effect.penalty && !effect.ignored, 'bonus':!effect.toggle && !effect.penalty && !effect.setValue && !effect.ignored, 'absolute':(effect.toggle || effect.setValue) && !effect.ignored, 'inactive-button':effect.ignored}"
                    />

                    <div class="gridicon-sidebar effect">
                        <ng-container *ngTemplateOutlet="effectContent" />
                    </div>
                </div>
            </ng-template>

            <ng-container *ngIf="!fullDisplay">
                <app-tags
                    [creature]="creature"
                    [objectName]="'Effects'"
                    [showTraits]=true
                    [showFeats]=true
                    [showItems]=true
                    [showActivities]=true
                    [showConditions]=true
                    [showEffects]=true
                />

                <div class="character-sheet-column-container padding-8">
                    <div class="icon-list left-aligned dashed-border">
                        <div
                            class="icon-list-title"
                            style="right: 0"
                        >
                            <header class="sectionHeader box-header">Conditions</header>
                        </div>

                        <ng-container *ngFor="let conditionGain of appliedConditions(componentParameters.conditions, true, true); trackBy:trackByObjectId;">
                            <ng-container *ngTemplateOutlet="conditionTemplate;context:{conditionGain:conditionGain}" />
                        </ng-container>
                    </div>

                    <app-time />

                    <div class="icon-list right-aligned dashed-border">
                        <div
                            class="icon-list-title"
                            style="left: 0"
                        >
                            <header class="sectionHeader box-header">Effects</header>
                        </div>

                        <ng-container *ngFor="let effect of appliedEffects(componentParameters.effects); trackBy:trackByObjectId;">
                            <ng-container *ngTemplateOutlet="effectTemplate;context:{effect:effect}" />
                        </ng-container>
                    </div>
                </div>
            </ng-container>

            <ng-container *ngIf="fullDisplay">
                <header class="sectionHeader">Conditions & Effects</header>

                <app-time />

                <app-tags
                    [creature]="creature"
                    [objectName]="'Effects'"
                    [showTraits]=true
                    [showFeats]=true
                    [showItems]=true
                    [showActivities]=true
                    [showConditions]=true
                    [showEffects]=true
                />

                <div class="vlist">
                    <header class="subsectionHeader">Active Conditions</header>

                    <ng-container *ngFor="let conditionGain of appliedConditions(componentParameters.conditions, true); trackBy:trackByObjectId;">
                        <ng-container *ngTemplateOutlet="conditionTemplate;context:{conditionGain:conditionGain}" />
                    </ng-container>
                </div>

                <div class="vlist">
                    <header class="subsectionHeader">Active Effects</header>

                    <ng-container *ngFor="let effect of appliedEffects(componentParameters.effects); trackBy:trackByObjectId;">
                        <ng-container *ngTemplateOutlet="effectTemplate;context:{effect:effect}" />
                    </ng-container>
                </div>

                <div class="vlist">
                    <header class="subsectionHeader">Inactive Conditions</header>

                    <ng-container *ngFor="let conditionGain of appliedConditions(componentParameters.conditions, false); trackBy:trackByObjectId;">
                        <ng-container *ngTemplateOutlet="conditionTemplate;context:{conditionGain:conditionGain}" />
                    </ng-container>
                </div>

                <div class="vlist">
                    <header class="subsectionHeader">Inactive Effects</header>

                    <ng-container *ngFor="let effect of notAppliedEffects(componentParameters.effects); trackBy:trackByObjectId;">
                        <ng-container *ngTemplateOutlet="effectTemplate;context:{effect:effect}" />
                    </ng-container>
                </div>

                <div class="vlist">
                    <header class="subsectionHeader">Hidden Effects</header>

                    <ng-container *ngFor="let effect of hiddenEffects(componentParameters.effects); trackBy:trackByObjectId;">
                        <ng-container *ngTemplateOutlet="effectTemplate;context:{effect:effect}" />
                    </ng-container>
                </div>
            </ng-container>
        </ng-container>
    </div>
</app-character-sheet-card>
