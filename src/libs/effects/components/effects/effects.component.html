<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
<app-character-sheet-card>
    <div
        class="attributeBox"
        id="{{ creature }}-effects-height"
        [ngClass]="{ snug: !fullDisplay }"
    >
        @if (componentParameters$() | async; as componentParameters) {
            <ng-template
                #conditionTemplate
                let-conditionGain="conditionGain"
            >
                @if (
                    conditionParameters(
                        conditionGain,
                        componentParameters.isTimeStopped
                    );
                    as conditionParameters
                ) {
                    <div
                        style="display: flex"
                        [ngClass]="{
                            attention:
                                conditionGain.durationIsInstant ||
                                conditionGain.nextStage === -1,
                        }"
                    >
                        <ng-template #conditionContent>
                            <app-condition
                                class="newrow"
                                [creature]="creature"
                                [conditionGain]="conditionGain"
                                [condition]="conditionParameters.condition"
                                [showItem]="shownItem()"
                                [fullDisplay]="fullDisplay"
                                (showItemMessage)="
                                    receiveShownItemMessage($event)
                                "
                            />
                        </ng-template>

                        @if (!fullDisplay) {
                            <div
                                triggers="click"
                                style="display: flex"
                                [stickyPopover]="conditionContent"
                            >
                                <app-grid-icon
                                    class="condition"
                                    placement="right bottom top"
                                    [updateId]="conditionGain.id"
                                    [ngClass]="
                                        conditionClasses(conditionParameters)
                                    "
                                    [condition]="conditionGain"
                                    [originalCondition]="
                                        conditionParameters.condition
                                    "
                                    [superTitle]="
                                        conditionSuperTitle(
                                            conditionGain,
                                            conditionParameters.condition
                                        )
                                    "
                                    [ngbTooltip]="conditionGain.name"
                                    [openDelay]="0"
                                />
                            </div>
                        }

                        @if (fullDisplay) {
                            <div class="list-item gridicon-fullsizebox">
                                <app-grid-icon
                                    class="condition"
                                    [updateId]="conditionGain.id"
                                    [condition]="conditionGain"
                                    [originalCondition]="
                                        conditionParameters.condition
                                    "
                                    [superTitle]="
                                        conditionSuperTitle(
                                            conditionGain,
                                            conditionParameters.condition
                                        )
                                    "
                                    [ngClass]="
                                        conditionClasses(conditionParameters)
                                    "
                                />

                                <ng-container
                                    *ngTemplateOutlet="conditionContent"
                                />
                            </div>
                        }
                    </div>
                }
            </ng-template>

            <ng-template
                #effectTemplate
                let-effect="effect"
            >
                <ng-template #effectContent>
                    <div class="newrow">
                        <span>
                            <strong
                                class="no-shadow"
                                [ngClass]="{
                                    penalty: effect.penalty,
                                    bonus:
                                        !effect.penalty &&
                                        !effect.setValue &&
                                        !effect.toggle,
                                    absolute: effect.setValue || effect.toggle,
                                }"
                            >
                                {{ effect.target }}
                                {{ effect.displayTitle(true) }}
                            </strong>
                        </span>
                    </div>

                    @if (effect.ignored) {
                        <div class="newrow">
                            <span>
                                <strong>Ignored</strong>
                                This effect doesn't apply while it is ignored.
                            </span>
                        </div>
                    }

                    @if (
                        effect.type !== "untyped" &&
                        !effect.toggle &&
                        !effect.setValue
                    ) {
                        <div class="newrow">
                            <span>
                                <strong>Type</strong>
                                {{
                                    effect.type +
                                        " " +
                                        (effect.penalty ? "penalty" : "bonus")
                                }}
                            </span>
                        </div>
                    }

                    @if (effect.duration) {
                        <div class="newrow">
                            <span>
                                <strong>Duration</strong>
                                {{
                                    effect.duration
                                        ? durationDescription$(effect.duration)
                                        : ""
                                }}
                            </span>
                        </div>
                    }

                    <div class="newrow">
                        <span>
                            <strong>Granted by</strong>
                            {{
                                effect.source.includes("conditional, ")
                                    ? effect.source.substr(13)
                                    : effect.source
                            }}
                        </span>
                    </div>

                    @if (effect.source.includes("conditional, ")) {
                        <div class="newrow">
                            <span>
                                <strong>Conditional</strong>
                                This effect only applies for certain actions or
                                under specific circumstances.
                            </span>
                        </div>
                    }

                    <span>
                        @if (!effect.ignored) {
                            <button
                                type="button"
                                [ngbTooltip]="
                                    'Ignore effects on ' +
                                    effect.target +
                                    ' from ' +
                                    effect.source
                                "
                                (click)="onIgnoreEffect(effect, true)"
                            >
                                Ignore
                            </button>
                        }

                        @if (effect.ignored) {
                            <button (click)="onIgnoreEffect(effect, false)">
                                Stop ignoring
                            </button>
                        }
                    </span>
                </ng-template>

                @if (!fullDisplay) {
                    <div
                        triggers="click"
                        style="display: flex"
                        [ngbPopover]="effectContent"
                    >
                        <app-grid-icon
                            class="effect"
                            placement="left bottom top"
                            [effect]="effect"
                            [ngClass]="{
                                penalty:
                                    !effect.toggle &&
                                    effect.penalty &&
                                    !effect.ignored,
                                bonus:
                                    !effect.toggle &&
                                    !effect.penalty &&
                                    !effect.setValue &&
                                    !effect.ignored,
                                absolute:
                                    (effect.toggle || effect.setValue) &&
                                    !effect.ignored,
                                'inactive-button': effect.ignored,
                            }"
                            [ngbTooltip]="
                                effect.target + ' ' + effect.displayTitle(true)
                            "
                            [openDelay]="0"
                        />
                    </div>
                }

                @if (fullDisplay) {
                    <div class="list-item gridicon-fullsizebox">
                        <app-grid-icon
                            class="effect"
                            [effect]="effect"
                            [ngClass]="{
                                penalty:
                                    !effect.toggle &&
                                    effect.penalty &&
                                    !effect.ignored,
                                bonus:
                                    !effect.toggle &&
                                    !effect.penalty &&
                                    !effect.setValue &&
                                    !effect.ignored,
                                absolute:
                                    (effect.toggle || effect.setValue) &&
                                    !effect.ignored,
                                'inactive-button': effect.ignored,
                            }"
                        />

                        <div class="gridicon-sidebar effect">
                            <ng-container *ngTemplateOutlet="effectContent" />
                        </div>
                    </div>
                }
            </ng-template>

            @if (!fullDisplay) {
                <app-tags
                    [creature]="creature"
                    [objectName]="'Effects'"
                    [showTraits]="true"
                    [showFeats]="true"
                    [showItems]="true"
                    [showActivities]="true"
                    [showConditions]="true"
                    [showEffects]="true"
                />

                <div class="character-sheet-column-container padding-8">
                    <div class="icon-list left-aligned dashed-border">
                        <div
                            class="icon-list-title"
                            style="right: 0"
                        >
                            <header class="sectionHeader box-header">
                                Conditions
                            </header>
                        </div>

                        @for (
                            conditionGain of appliedConditions(
                                componentParameters.conditions,
                                true,
                                true
                            );
                            track conditionGain.id
                        ) {
                            <ng-container
                                *ngTemplateOutlet="
                                    conditionTemplate;
                                    context: { conditionGain: conditionGain }
                                "
                            />
                        }
                    </div>

                    <app-time />

                    <div class="icon-list right-aligned dashed-border">
                        <div
                            class="icon-list-title"
                            style="left: 0"
                        >
                            <header class="sectionHeader box-header">
                                Effects
                            </header>
                        </div>

                        @for (
                            effect of appliedEffects(
                                componentParameters.effects
                            );
                            track effect.id
                        ) {
                            <ng-container
                                *ngTemplateOutlet="
                                    effectTemplate;
                                    context: { effect: effect }
                                "
                            />
                        }
                    </div>
                </div>
            }

            @if (fullDisplay) {
                <header class="sectionHeader">Conditions & Effects</header>

                <app-time />

                <app-tags
                    [creature]="creature"
                    [objectName]="'Effects'"
                    [showTraits]="true"
                    [showFeats]="true"
                    [showItems]="true"
                    [showActivities]="true"
                    [showConditions]="true"
                    [showEffects]="true"
                />

                <div class="vlist">
                    <header class="subsectionHeader">Active Conditions</header>

                    @for (
                        conditionGain of appliedConditions(
                            componentParameters.conditions,
                            true
                        );
                        track conditionGain.id
                    ) {
                        <ng-container
                            *ngTemplateOutlet="
                                conditionTemplate;
                                context: { conditionGain: conditionGain }
                            "
                        />
                    }
                </div>

                <div class="vlist">
                    <header class="subsectionHeader">Active Effects</header>

                    @for (
                        effect of appliedEffects(componentParameters.effects);
                        track effect.id
                    ) {
                        <ng-container
                            *ngTemplateOutlet="
                                effectTemplate;
                                context: { effect: effect }
                            "
                        />
                    }
                </div>

                <div class="vlist">
                    <header class="subsectionHeader">
                        Inactive Conditions
                    </header>

                    @for (
                        conditionGain of appliedConditions(
                            componentParameters.conditions,
                            false
                        );
                        track conditionGain.id
                    ) {
                        <ng-container
                            *ngTemplateOutlet="
                                conditionTemplate;
                                context: { conditionGain: conditionGain }
                            "
                        />
                    }
                </div>

                <div class="vlist">
                    <header class="subsectionHeader">Inactive Effects</header>

                    @for (
                        effect of notAppliedEffects(
                            componentParameters.effects
                        );
                        track effect.id
                    ) {
                        <ng-container
                            *ngTemplateOutlet="
                                effectTemplate;
                                context: { effect: effect }
                            "
                        />
                    }
                </div>

                <div class="vlist">
                    <header class="subsectionHeader">Hidden Effects</header>

                    @for (
                        effect of hiddenEffects(componentParameters.effects);
                        track effect.id
                    ) {
                        <ng-container
                            *ngTemplateOutlet="
                                effectTemplate;
                                context: { effect: effect }
                            "
                        />
                    }
                </div>
            }
        }
    </div>
</app-character-sheet-card>
