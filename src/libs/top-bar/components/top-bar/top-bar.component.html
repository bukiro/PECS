<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
<app-logo
    class="logo"
    ngbTooltip="Pathfinder Excessive Character Sheet"
></app-logo>

<app-button
    class="top-bar-button top-bar-button--loading"
    *ngIf="isLoadingCharacter$ | async; else MenuTemplate"
>
    {{loadingStatus$ | async}}
</app-button>

<ng-template #MenuTemplate>
    <app-button
        class="top-bar-button"
        [toggled]="characterMenuState=== 'in'"
        (click)="toggleMenu(MenuNamesEnum.CharacterMenu)"
    >
        <div class=top-bar-button__content>
            <i class="ra ra-player"></i>

            <i class="bi-gear"></i>
        </div>
    </app-button>

    <app-button
        class="top-bar-button"
        [toggled]="companionMenuState=== 'in'"
        (click)="toggleMenu(MenuNamesEnum.CompanionMenu)"
        *ngIf="isCompanionAvailable()"
    >
        <div class=top-bar-button__content>
            <i class="ra ra-wolf-howl"></i>
        </div>
    </app-button>

    <app-button
        class="top-bar-button"
        [toggled]="familiarMenuState=== 'in'"
        (click)="toggleMenu(MenuNamesEnum.FamiliarMenu)"
        *ngIf="isFamiliarAvailable()"
    >
        <div class=top-bar-button__content>
            <i class="ra ra-raven"></i>
        </div>
    </app-button>

    <app-button
        class="top-bar-button"
        [toggled]="itemsMenuState=== 'in'"
        (click)="toggleMenu(MenuNamesEnum.ItemsMenu)"
    >
        Items
    </app-button>

    <app-button
        class="top-bar-button"
        [toggled]="craftingMenuState=== 'in'"
        (click)="toggleMenu(MenuNamesEnum.CraftingMenu)"
    >
        Crafting
    </app-button>

    <app-button
        class="top-bar-button"
        [toggled]="spellsMenuState=== 'in'"
        (click)="toggleMenu(MenuNamesEnum.SpellsMenu)"
        *ngIf="hasAnySpells()"
    >
        Spellbook
    </app-button>

    <app-button
        class="top-bar-button"
        [toggled]="spellLibraryMenuState=== 'in'"
        (click)="toggleMenu(MenuNamesEnum.SpellLibraryMenu)"
    >
        Spell&nbsp;Library
    </app-button>

    <app-button
        class="top-bar-button"
        [toggled]="conditionsMenuState=== 'in'"
        (click)="toggleMenu(MenuNamesEnum.ConditionsMenu)"
    >
        Conditions
    </app-button>

    <app-button
        class="top-bar-button"
        label="Dice"
        [toggled]="diceMenuState=== 'in'"
        (click)="toggleMenu(MenuNamesEnum.DiceMenu)"
    >
        <app-dice-icon-D20 class="top-bar-button__content top-bar-button__content--dice"></app-dice-icon-D20>
    </app-button>

    <app-button
        *ngIf="areSavegamesInitializing || isLoggingIn"
        class="top-bar-button top-bar-button--loading"
        label="Connecting to database..."
        showLabel
        disabled
    >
        <i class="bi-file-earmark-arrow-up"></i>
    </app-button>

    <app-button
        *ngIf="isGMMode"
        class="top-bar-button"
        label="In GM mode, the character can\'t be saved and can\'t send effects to other players."
        showLabel
        disabled
    >
        GM Mode
    </app-button>

    <ng-container *ngIf="!areSavegamesInitializing && !isLoggingIn">
        <app-button
            *ngIf="cannotLogin"
            class="top-bar-button"
            label="Database connection failed"
            disabled
        >
            <i class="bi-file-earmark-break"></i>
        </app-button>

        <ng-container *ngIf="!cannotLogin">
            <app-button
                *ngIf="!isLoggedIn"
                class="top-bar-button"
                label="Not logged in"
                showLabel
                disabled
            >
                <i class="bi-file-earmark-lock"></i>
            </app-button>

            <app-button
                *ngIf="!hasDBConnectionURL"
                class="top-bar-button"
                label="No database configured"
                showLabel
                disabled
            >
                <i class="bi-file-earmark-x"></i>
            </app-button>

            <ng-container *ngIf="hasDBConnectionURL && isLoggedIn">

                <app-button
                    *ngIf="!savegames"
                    class="top-bar-button"
                    label="Database connection failed"
                    showLabel
                    disabled
                >
                    <i class="bi-file-earmark-break"></i>
                </app-button>

                <ng-container *ngIf="savegames && { isBlankCharacter: isBlankCharacter() } as blankCharacterStatus">
                    <ng-container *ngIf="!isGMMode">
                        <app-button
                            *ngIf="blankCharacterStatus.isBlankCharacter"
                            class="top-bar-button"
                            label="No changes to character yet"
                            showLabel
                            disabled
                        >
                            <i class="bi-file-earmark-arrow-up"></i>
                        </app-button>

                        <app-button
                            *ngIf="!blankCharacterStatus.isBlankCharacter"
                            class="top-bar-button"
                            label="Save Character"
                            showLabel
                            (click)="save()"
                        >
                            <i class="bi-file-earmark-arrow-up"></i>
                        </app-button>
                    </ng-container>

                    <app-button
                        *ngIf="!blankCharacterStatus.isBlankCharacter && !isManualMode"
                        [label]="character.partyName ? 'Check for new effects' : 'You can only receive effects in a party.'"
                        showLabel
                        (click)="getMessages()"
                        [disabled]="!character.partyName"
                    >
                        <i class="ra ra-player-thunder-struck"></i>

                        <ng-container *ngIf="!modalOpen && newMessagesFromService() as newMessages">
                            <div
                                class="window-button-container"
                                *ngIf="newMessages.length"
                            >
                                {{newMessages.length}}
                            </div>
                        </ng-container>
                    </app-button>
                </ng-container>
            </ng-container>
        </ng-container>
    </ng-container>

    <app-button
        class="top-bar-button"
        label="Refresh all"
        showLabel
        (click)="refreshAll()"
    >
        <div class="top-bar-button__content">
            <i class="ra ra-cycle"></i>
        </div>
    </app-button>
</ng-template>

<!-- New Effects Dialog -->
<ng-template
    #NewMessagesModal
    let-modal
>
    <div class="modal-header">
        <header
            class="sectionHeader modal-title"
            id="modal-title"
        >
            {{cachedNewMessages.length}} New Effect{{cachedNewMessages.length > 1 ? "s" : ""}}
        </header>

        <app-button
            class="close"
            label="close"
            (click)="modal.dismiss('Cross click')"
            ngbAutofocus
        >
            <span aria-hidden="true">&times;</span>
        </app-button>
    </div>

    <div class="modal-body vlist">
        <p>
            Select all effects you want to apply. All other effects will be discarded.
        </p>

        <div class="gridicon-fullsizebox">
            <input
                id="messagesSelectAll"
                class="character-choice"
                type="checkbox"
                (change)="onSelectAllMessages($event)"
                [checked]="areAllMessagesSelected()"
            >
            <label
                for="messagesSelectAll"
            >
                <strong>Select all</strong>
            </label>
        </div>

        <div
            class="fullsize-scroll-box vlist"
        >
            <ng-container *ngFor="let message of cachedNewMessages; trackBy:trackByIndex">
                <ng-container *ngIf="creatureFromMessage(message) as creature">
                    <ng-container *ngIf="messageSenderName(message) as sender">
                        <ng-container *ngIf="creature && (message.gainCondition.length || message.offeredItem.length)">
                            <div class="list-item gridicon-fullsizebox">
                                <input
                                    id="message{{message.id}}"
                                    class="character-choice"
                                    type="checkbox"
                                    [(ngModel)]="message.selected"
                                >
                                <label for="message{{message.id}}">
                                    <div class="newrow left-aligned">
                                        <i
                                            class="ra ra-sword"
                                            *ngIf="message.offeredItem.length"
                                        ></i>

                                        <i
                                            class="ra ra-splash"
                                            *ngIf="message.gainCondition.length"
                                        ></i>

                                        <i
                                            class="bi-play-circle"
                                            *ngIf="message.gainCondition.length && message.activateCondition"
                                        ></i>

                                        <i
                                            class="bi-stop-circle"
                                            *ngIf="message.gainCondition.length && !message.activateCondition"
                                        ></i>

                                        <i
                                            class="ra ra-player"
                                            *ngIf="creature.type==='Character'"
                                        ></i>

                                        <i
                                            class="ra ra-wolf-howl"
                                            *ngIf="creature.type==='Companion'"
                                        ></i>

                                        <i
                                            class="ra ra-raven"
                                            *ngIf="creature.type==='Familiar'"
                                        ></i>

                                        <ng-container *ngIf="message.gainCondition.length">
                                            <strong>
                                                {{ message.gainCondition[0].name + (
                                                    message.gainCondition[0].choice
                                                        ? ": " + message.gainCondition[0].choice
                                                        : ""
                                                ) }}
                                            </strong>
                                            {{[durationDescription(message.gainCondition[0].duration)]}}
                                        </ng-container>

                                        <ng-container *ngIf="message.offeredItem.length">
                                            <strong>
                                                {{
                                                    (
                                                        message.itemAmount !== 1
                                                            ? message.itemAmount + " "
                                                            : ""
                                                    ) + message.offeredItem[0].name
                                                }}
                                            </strong>
                                            {{itemMessageIncludedAmount(message)}}
                                        </ng-container>
                                    </div>

                                    <div class="newrow lower">
                                        Sent{{sender ? " by " + sender : ""}} at {{message.time}}
                                    </div>
                                </label>
                            </div>
                        </ng-container>
                    </ng-container>
                </ng-container>
            </ng-container>
        </div>

        <div class="newrow left-aligned">
            <input
                id="checkMessagesAutomatically"
                type="checkbox"
                [(ngModel)]="character.settings.checkMessagesAutomatically"
            >
            <label for="checkMessagesAutomatically">
                Keep checking automatically (can be turned off in settings)
            </label>
        </div>
    </div>

    <div class="modal-footer">
        <app-button
            class="btn btn-outline-secondary"
            (click)="modal.dismiss('Cancel click')"
        >
            Cancel
        </app-button>

        <app-button
            class="btn btn-primary"
            (click)="modal.close('Apply click')"
        >
            Apply selected effects
        </app-button>
    </div>
</ng-template>

<ng-template
    #LoginModal
    let-modal
>
    <div class="modal-header">
        <header
            class="sectionHeader modal-title"
            id="modal-title"
            autocomplete="off"
        >
            Password Required
        </header>
    </div>

    <form>
        <div class="modal-body vlist">
            <p *ngIf="loggedOutMessage as loggedOutMessageText">{{loggedOutMessageText}}</p>

            <p>
                Please enter the password for this PECS server:
            </p>

            <input
                placeholder="Password"
                aria-label="Password"
                name="password"
                id="passwordInput"
                type="password"
                class="fullwidth"
                [(ngModel)]="password"
            >

            <p
                class="problem"
                *ngIf="passwordFailed"
            >
                The password was not correct.
            </p>
        </div>

        <div class="modal-footer">
            <app-button
                type="submit"
                class="btn btn-primary"
                (click)="modal.close('OK click')"
            >
                Login
            </app-button>
        </div>
    </form>
</ng-template>
