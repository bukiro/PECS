<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
<div class="corner-button-tray">
    <app-minimize-button
        *ngIf="shouldShowMinimizeButton"
        [ngModel]="(isMinimized$ | async) ?? false"
        (ngModelChange)="toggleMinimized($event)"
    ></app-minimize-button>
</div>

<div
    id="{{creature}}-abilities-height"
    class="attributeBox"
>
    <header class="sectionHeader box-header">Abilities</header>

    <ng-template #FullSizeTemplate>
        <div
            class="list-item"
            *ngFor="let ability of abilities(); trackBy:trackByIndex;"
        >
            <ng-container *ngIf="calculateAbility(ability) as calculatedAbility">
                <ng-template #EffectsPopoverContent>
                    <div class="minimized-hide newrow">
                        <app-object-effects
                            [creature]="creature"
                            [objectName]="ability.name"
                        ></app-object-effects>
                    </div>
                </ng-template>

                <div class="newrow">
                    <span class="hlist">
                        <span
                            class="minimized-hide"
                            [ngbPopover]="EffectsPopoverContent"
                            #EffectsPopover="ngbPopover"
                            triggers="click"
                        >
                            <i
                                [ngbTooltip]="!EffectsPopover.isOpen() ? 'Edit effects' : ''"
                                class='bi-lightning-charge'
                            ></i>
                        </span>

                        <strong>{{ability.name}}</strong>
                    </span>

                    <span>
                        <div
                            class="value"
                            [ngbPopover]="calculatedAbility.value.explain"
                            [ngClass]="{'penalty':calculatedAbility.penalties, 'bonus':calculatedAbility.bonuses, 'absolute':calculatedAbility.absolutes}"
                        >
                            {{calculatedAbility.value.result}}
                        </div>
                    </span>

                    <strong>Modifier</strong>

                    <span>
                        <div
                            class="value"
                            [ngbPopover]="calculatedAbility.mod.explain"
                            [ngClass]="{'penalty':calculatedAbility.modpenalties, 'bonus':calculatedAbility.modbonuses, 'absolute':calculatedAbility.modabsolutes}"
                        >
                            {{calculatedAbility.mod.result}}
                        </div>
                    </span>
                </div>

                <app-tags
                    class="newrow tags"
                    [creature]="creature"
                    [objectName]=ability.name
                    [showTraits]=true
                    [showFeats]=true
                    [showItems]=true
                    [showActivities]=true
                    [showConditions]=true
                    [showEffects]=true
                >
                </app-tags>
            </ng-container>
        </div>
    </ng-template>

    <ng-container *ngIf="isMinimized$ | async; else FullSizeTemplate">
        <div
            class="list-item newrow"
            *ngFor="let subset of [1,2]; trackBy:trackByIndex;"
        >
            <span
                class="hlist"
                [ngClass]="{'left-aligned':index === 0, 'center-aligned':index === 1, 'right-aligned':index === 2}"
                *ngFor="let ability of abilities(subset); let index = index; trackBy:trackByIndex;"
            >
                <ng-container *ngIf="calculateAbility(ability) as calculatedAbility">
                    <strong>{{ability.modifierName}}</strong>

                    <div
                        class="value"
                        [ngbPopover]="calculatedAbility.mod.explain"
                        [ngClass]="{'penalty':calculatedAbility.modpenalties, 'bonus':calculatedAbility.modbonuses, 'absolute':calculatedAbility.modabsolutes}"
                    >
                        {{calculatedAbility.mod.result}}
                    </div>
                </ng-container>
            </span>
        </div>
    </ng-container>
</div>
