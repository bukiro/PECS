<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
<app-character-sheet-card
    [showMinimizeButton]="shouldShowMinimizeButton"
    [minimized]="(isMinimized$ | async) ?? false"
    (toggleMinimized)="toggleMinimized($event)"
>
    <div
        class="attributeBox"
        id="{{ creature }}-defense-height"
    >
        @if (componentParameters$ | async; as componentParameters) {
            @if (componentParameters.ACSources.value$ | async; as acValue) {
                <ng-template #EffectsPopoverContent>
                    <div class="minimized-hide newrow">
                        <app-object-effects
                            [creature]="creature"
                            [objectName]="'AC'"
                        />
                    </div>
                </ng-template>

                <header class="sectionHeader box-header">
                    <span
                        #EffectsPopover="ngbPopover"
                        class="minimized-hide"
                        triggers="click"
                        [ngbPopover]="EffectsPopoverContent"
                    >
                        <i
                            class="bi-lightning-charge"
                            [ngbTooltip]="
                                !EffectsPopover.isOpen() ? 'Edit effects' : ''
                            "
                        ></i>
                    </span>
                    Defense: Armor Class
                    <span
                        [ngbPopover]="acValue.explain"
                        [ngClass]="{
                            penalty:
                                componentParameters.ACSources.penalties$
                                | async,
                            bonus:
                                componentParameters.ACSources.bonuses$ | async,
                            absolute:
                                componentParameters.ACSources.absolutes$
                                | async,
                        }"
                    >
                        {{ acValue.result }}
                    </span>
                </header>

                <app-tags
                    [creature]="creature"
                    [objectName]="'AC'"
                    [showTraits]="true"
                    [showFeats]="true"
                    [showItems]="true"
                    [showActivities]="true"
                    [showConditions]="true"
                    [showEffects]="false"
                    [specialEffects]="acValue.effects"
                />

                <app-tags
                    [creature]="creature"
                    [objectName]="'Defense'"
                    [showTraits]="true"
                    [showFeats]="true"
                    [showItems]="true"
                    [showActivities]="true"
                    [showConditions]="true"
                    [showEffects]="true"
                />
            }

            <div class="list-item newrow">
                <strong>Quick Status</strong>

                <span class="hlist left-aligned">
                    @if (
                        {
                            value:
                                (componentParameters.flatFooted$ | async) ??
                                undefined,
                        };
                        as flatFooted
                    ) {
                        <button
                            type="button"
                            aria-label="Toggle flat-footed"
                            class="center-aligned bigger"
                            [ngClass]="{ 'fancy-button': flatFooted.value }"
                            [ngbTooltip]="
                                flatFooted.value
                                    ? 'Disable Flat-Footed'
                                    : 'Flat-Footed'
                            "
                            (click)="toggleFlatFooted(flatFooted.value)"
                        >
                            <i class="ra ra-footprint"></i>
                        </button>
                    }

                    @if (
                        {
                            value:
                                (componentParameters.hidden$ | async) ??
                                undefined,
                        };
                        as hidden
                    ) {
                        <button
                            type="button"
                            aria-label="Toggle hidden"
                            class="center-aligned bigger"
                            [ngClass]="{ 'fancy-button': hidden.value }"
                            [ngbTooltip]="
                                hidden.value ? 'Disable Hidden' : 'Hidden'
                            "
                            (click)="toggleHidden(hidden.value)"
                        >
                            <i class="ra ra-player-dodge"></i>
                        </button>
                    }
                </span>

                <strong>Cover</strong>

                @if (
                    { value: (componentParameters.cover$ | async) ?? 0 };
                    as cover
                ) {
                    <span class="hlist right-aligned">
                        <button
                            type="button"
                            aria-label="Toggle lesser cover"
                            class="center-aligned bigger"
                            [ngClass]="{ 'fancy-button': cover.value === 1 }"
                            [ngbTooltip]="
                                cover.value === 1
                                    ? 'End Lesser Cover'
                                    : 'Lesser Cover'
                            "
                            (click)="onSetCover(cover.value === 1 ? 0 : 1)"
                        >
                            <i class="ra ra-player"></i>
                        </button>

                        <button
                            type="button"
                            aria-label="Toggle standard cover"
                            class="center-aligned bigger"
                            [ngClass]="{ 'fancy-button': cover.value === 2 }"
                            [ngbTooltip]="
                                cover.value === 2
                                    ? 'End Standard Cover'
                                    : 'Standard Cover'
                            "
                            (click)="onSetCover(cover.value === 2 ? 0 : 2)"
                        >
                            <i class="ra ra-metal-gate"></i>
                        </button>

                        <button
                            type="button"
                            aria-label="Toggle greater cover"
                            class="center-aligned bigger"
                            [ngClass]="{ 'fancy-button': cover.value === 4 }"
                            [ngbTooltip]="
                                cover.value === 4
                                    ? 'End Greater Cover'
                                    : 'Greater Cover'
                            "
                            (click)="onSetCover(cover.value === 4 ? 0 : 4)"
                        >
                            <i class="ra ra-tower"></i>
                        </button>
                    </span>
                }
            </div>

            @if (!creature.isFamiliar()) {
                <header class="subsectionHeader minimized-hide">Armor</header>

                @for (
                    armorParameters of armorParameters$ | async;
                    track $index
                ) {
                    <div class="minimized-hide list-item">
                        <div>
                            {{ armorParameters.armor.effectiveName$$() | async }}
                        </div>

                        @if (armorParameters.armor.traits.length) {
                            <div class="minimized-hide newrow left-aligned">
                                @for (
                                    trait of armorParameters.armor.traits;
                                    track $index
                                ) {
                                    <app-trait
                                        [name]="trait"
                                        [trait]="traitFromName(trait)"
                                    />
                                }
                            </div>
                        }

                        @if ($first) {
                            <app-tags
                                [creature]="creature"
                                [objectName]="'Armor'"
                                [showTraits]="true"
                                [showFeats]="true"
                                [showItems]="true"
                                [showActivities]="true"
                                [showConditions]="true"
                                [showEffects]="true"
                            />
                        }

                        <app-tags
                            [creature]="creature"
                            [objectName]="armorParameters.armor.name"
                            [showItems]="true"
                        />

                        @if (
                            hintShowingRunes(armorParameters.armor);
                            as hintShowingRunes
                        ) {
                            @if (hintShowingRunes.length) {
                                <div
                                    class="minimized-hide newrow left-aligned"
                                    style="margin-top: initial"
                                >
                                    @for (
                                        rune of hintShowingRunes;
                                        track $index
                                    ) {
                                        @for (
                                            hint of rune.hints;
                                            track $index
                                        ) {
                                            <ng-template #RuneDescTemplate>
                                                @if (rune.sourceBook) {
                                                    <div
                                                        class="newrow left-aligned"
                                                    >
                                                        <strong>Source</strong>

                                                        <i>{{
                                                            rune.sourceBook
                                                        }}</i>
                                                    </div>
                                                }

                                                <div
                                                    class="newrow left-aligned"
                                                >
                                                    {{
                                                        heightenedHintText(hint)
                                                    }}
                                                </div>
                                            </ng-template>

                                            <cite
                                                class="item"
                                                [ngbPopover]="RuneDescTemplate"
                                            >
                                                {{ rune.name }} Rune
                                            </cite>
                                        }
                                    }
                                </div>
                            }
                        }

                        @for (
                            talisman of armorParameters.armor.talismans;
                            track talismanIndex;
                            let talismanIndex = $index
                        ) {
                            <div
                                class="minimized-hide lower newrow left-aligned"
                            >
                                <ng-template #ArmorTalismanTemplate>
                                    @for (
                                        cord of armorParameters.armor
                                            .talismanCords;
                                        track $index
                                    ) {
                                        <div
                                            class="list-item left-aligned lower"
                                        >
                                            <header class="spellHeader newrow">
                                                <span>{{ cord.name }}</span>

                                                <span
                                                    >Level
                                                    {{ cord.level }}</span
                                                >
                                            </header>

                                            <p>
                                                When you activate a talisman
                                                threaded through a cord with the
                                                same magic school trait that's
                                                also the cord's level or lower,
                                                attempt a
                                                <app-quickdice
                                                    [diceString]="'1d20'"
                                                />
                                                DC 16 flat check. On a success,
                                                that talisman is not consumed
                                                and can be used again.
                                            </p>

                                            @for (
                                                talismanCordIndex of [0, 1, 2];
                                                track $index
                                            ) {
                                                @if (
                                                    cord.isTalismanCord >
                                                        talismanCordIndex &&
                                                    cord.data[talismanCordIndex]
                                                ) {
                                                    <div class="newrow">
                                                        <strong>{{
                                                            cord.data[
                                                                talismanCordIndex
                                                            ].name
                                                        }}</strong>
                                                        {{
                                                            cord.data[
                                                                talismanCordIndex
                                                            ].value
                                                        }}
                                                    </div>
                                                }
                                            }
                                        </div>
                                    }

                                    <header class="spellHeader newrow">
                                        <span>{{ talisman.name }}</span>

                                        <span>Level {{ talisman.level }}</span>
                                    </header>

                                    <button
                                        type="button"
                                        class="newrow left-aligned"
                                        (click)="
                                            onTalismanUse(
                                                armorParameters.armor,
                                                talisman,
                                                talismanIndex
                                            )
                                        "
                                    >
                                        <span>
                                            Activate
                                            @if (talisman.actions) {
                                                <app-action-icons
                                                    [actionString]="
                                                        talisman.actions
                                                    "
                                                />
                                            }
                                            {{
                                                talisman.activationType
                                                    ? talisman.activationType
                                                    : ""
                                            }}
                                        </span>
                                    </button>

                                    @if (
                                        hasMatchingTalismanCord(
                                            armorParameters.armor,
                                            talisman
                                        )
                                    ) {
                                        <button
                                            type="button"
                                            class="newrow left-aligned"
                                            (click)="
                                                onTalismanUse(
                                                    armorParameters.armor,
                                                    talisman,
                                                    talismanIndex,
                                                    true
                                                )
                                            "
                                        >
                                            <span>
                                                Activate and preserve with
                                                talisman cord
                                                @if (talisman.actions) {
                                                    <app-action-icons
                                                        [actionString]="
                                                            talisman.actions
                                                        "
                                                    />
                                                }
                                                {{
                                                    talisman.activationType
                                                        ? talisman.activationType
                                                        : ""
                                                }}
                                            </span>
                                        </button>
                                    }

                                    <app-item
                                        [creature]="creature"
                                        [item]="talisman"
                                        [allowActivate]="true"
                                        [isSubItem]="true"
                                    />
                                </ng-template>

                                <button
                                    type="button"
                                    triggers="click"
                                    [ngbPopover]="ArmorTalismanTemplate"
                                >
                                    <span>
                                        {{ talisman.name }}
                                        {{
                                            hasMatchingTalismanCord(
                                                armorParameters.armor,
                                                talisman
                                            )
                                                ? "(matching talisman cord attached)"
                                                : ""
                                        }}
                                    </span>
                                </button>
                            </div>
                        }

                        @for (
                            spec of armorParameters.specializations;
                            track $index
                        ) {
                            <div
                                class="minimized-hide lower newrow left-aligned"
                            >
                                <strong
                                    >Armor specialization effect&nbsp;</strong
                                >
                                {{ spec.desc }}
                            </div>
                        }
                    </div>
                }

                @for (shield of equippedShield$() | async; track $index) {
                    <header class="subsectionHeader minimized-hide">
                        Shield
                    </header>

                    <div class="vlist list-item">
                        <div class="newrow left-aligned">
                            {{ shield.effectiveName$$() }} AC
                            <span class="value">{{
                                shield.effectiveACBonus$() | async
                            }}</span>
                            Hardness:
                            <span class="value">{{
                                shield.effectiveHardness$() | async
                            }}</span>
                        </div>

                        @if (shield.traits.length) {
                            <div class="minimized-hide newrow left-aligned">
                                @for (trait of shield.traits; track $index) {
                                    <app-trait
                                        [name]="trait"
                                        [trait]="traitFromName(trait)"
                                    />
                                }
                            </div>
                        }

                        <app-tags
                            [creature]="creature"
                            [objectName]="'Shield'"
                            [showTraits]="true"
                            [showFeats]="true"
                            [showItems]="true"
                            [showActivities]="true"
                            [showConditions]="true"
                            [showEffects]="true"
                            [specialNames]="
                                (specialShowOnNamesShield$(shield) | async) ??
                                []
                            "
                        />

                        <div class="newrow">
                            @if (!shield.raised) {
                                <button
                                    type="button"
                                    class="center-aligned"
                                    (click)="onRaiseShield(true, shield)"
                                >
                                    Raise shield
                                </button>
                            }

                            @if (shield.raised) {
                                <button
                                    type="button"
                                    class="center-aligned fancy-button"
                                    (click)="onRaiseShield(false, shield)"
                                >
                                    Lower shield
                                </button>
                            }

                            @if (
                                shield.raised &&
                                shield.coverbonus &&
                                !shield.takingCover
                            ) {
                                <button
                                    type="button"
                                    class="center-aligned"
                                    (click)="onSetCover(4, shield)"
                                >
                                    Take cover behind shield
                                </button>
                            }

                            @if (
                                shield.raised &&
                                shield.coverbonus &&
                                shield.takingCover
                            ) {
                                <button
                                    type="button"
                                    class="center-aligned fancy-button"
                                    (click)="onSetCover(0, shield)"
                                >
                                    Leave cover behind shield
                                </button>
                            }
                        </div>

                        <div class="list-item newrow">
                            <strong>HP</strong>

                            <div class="value">
                                {{ shield.currentHitPoints$() | async }}
                            </div>

                            <strong>Max HP</strong>

                            <div class="value">
                                {{ shield.effectiveMaxHP$() | async }}
                            </div>

                            <strong>BT</strong>

                            <div class="value">
                                {{ shield.effectiveBrokenThreshold$() | async }}
                            </div>
                        </div>

                        <div class="list-item newrow">
                            <ng-template #DamageSliderTemplate>
                                <div
                                    class="slider-container"
                                    style="min-width: 25vw; max-width: 100%"
                                    [style.--name]="
                                        '\'Damage: ' + shieldDamage + '\''
                                    "
                                >
                                    <input
                                        aria-label="Shield damage amount slider"
                                        class="slider"
                                        type="range"
                                        min="0"
                                        max="{{
                                            shield.effectiveMaxHP$() | async
                                        }}"
                                        [(ngModel)]="shieldDamage"
                                    />
                                </div>
                            </ng-template>

                            <span>
                                <button
                                    type="button"
                                    [disabled]="shieldDamage === 0"
                                    (click)="
                                        onChangeShieldHP(shield, shieldDamage)
                                    "
                                >
                                    Damage
                                </button>
                            </span>

                            <span class="hlist center-aligned">
                                <input
                                    #DamagePopover="ngbPopover"
                                    aria-label="Shield damage amount"
                                    triggers="manual"
                                    class="number3"
                                    type="number"
                                    maxLength="3"
                                    min="0"
                                    [ngbPopover]="DamageSliderTemplate"
                                    max="{{ shield.effectiveMaxHP$() | async }}"
                                    [(ngModel)]="shieldDamage"
                                    (focus)="DamagePopover.open()"
                                    (keypress)="positiveNumbersOnly($event)"
                                />
                            </span>

                            <span class="right-aligned">
                                <button
                                    type="button"
                                    [disabled]="shieldDamage === 0"
                                    (click)="
                                        onChangeShieldHP(shield, -shieldDamage)
                                    "
                                >
                                    Repair
                                </button>
                            </span>
                        </div>

                        @for (
                            talisman of shield.talismans;
                            track talismanIndex;
                            let talismanIndex = $index
                        ) {
                            <div
                                class="minimized-hide lower newrow left-aligned"
                            >
                                <ng-template #ShieldTalismanTemplate>
                                    @for (
                                        cord of shield.talismanCords;
                                        track $index
                                    ) {
                                        <div
                                            class="list-item left-aligned lower"
                                        >
                                            <header class="spellHeader">
                                                {{ cord.name }}
                                            </header>

                                            <p>
                                                When you activate a talisman
                                                threaded through a cord with the
                                                same magic school trait that's
                                                also the cord's level or lower,
                                                attempt a
                                                <app-quickdice
                                                    [diceString]="'1d20'"
                                                />
                                                DC 16 flat check. On a success,
                                                that talisman is not consumed
                                                and can be used again.
                                            </p>

                                            @for (
                                                talismanCordIndex of [0, 1, 2];
                                                track $index
                                            ) {
                                                @if (
                                                    cord.isTalismanCord >
                                                        talismanCordIndex &&
                                                    cord.data[talismanCordIndex]
                                                ) {
                                                    <div class="newrow">
                                                        <strong>{{
                                                            cord.data[
                                                                talismanCordIndex
                                                            ].name
                                                        }}</strong>
                                                        {{
                                                            cord.data[
                                                                talismanCordIndex
                                                            ].value
                                                        }}
                                                    </div>
                                                }
                                            }
                                        </div>
                                    }

                                    <header class="spellHeader">
                                        {{ talisman.name }}
                                    </header>

                                    <button
                                        type="button"
                                        class="newrow left-aligned"
                                        (click)="
                                            onTalismanUse(
                                                shield,
                                                talisman,
                                                talismanIndex
                                            )
                                        "
                                    >
                                        <span>
                                            Activate
                                            @if (talisman.actions) {
                                                <app-action-icons
                                                    [actionString]="
                                                        talisman.actions
                                                    "
                                                />
                                            }
                                            {{
                                                talisman.activationType
                                                    ? talisman.activationType
                                                    : ""
                                            }}
                                        </span>
                                    </button>

                                    @if (
                                        hasMatchingTalismanCord(
                                            shield,
                                            talisman
                                        )
                                    ) {
                                        <button
                                            type="button"
                                            class="newrow left-aligned"
                                            (click)="
                                                onTalismanUse(
                                                    shield,
                                                    talisman,
                                                    talismanIndex,
                                                    true
                                                )
                                            "
                                        >
                                            <span>
                                                Activate and preserve with
                                                talisman cord
                                                @if (talisman.actions) {
                                                    <app-action-icons
                                                        [actionString]="
                                                            talisman.actions
                                                        "
                                                    />
                                                }
                                                {{
                                                    talisman.activationType
                                                        ? talisman.activationType
                                                        : ""
                                                }}
                                            </span>
                                        </button>
                                    }

                                    <app-item
                                        [creature]="creature"
                                        [item]="talisman"
                                        [allowActivate]="true"
                                        [isSubItem]="true"
                                    />
                                </ng-template>

                                <button
                                    type="button"
                                    triggers="click"
                                    [ngbPopover]="ShieldTalismanTemplate"
                                >
                                    <span>
                                        {{ talisman.name }}
                                        {{
                                            hasMatchingTalismanCord(
                                                shield,
                                                talisman
                                            )
                                                ? "(matching talisman cord attached)"
                                                : ""
                                        }}
                                    </span>
                                </button>
                            </div>
                        }
                    </div>
                }

                <header class="sectionHeader minimized-hide box-header">
                    Saving Throws
                </header>

                <app-tags
                    [creature]="creature"
                    [objectName]="'Saving Throws'"
                    [showTraits]="true"
                    [showFeats]="true"
                    [showItems]="true"
                    [showActivities]="true"
                    [showConditions]="true"
                    [showEffects]="true"
                    [specialNames]="
                        (specialShowOnNamesSavingThrows$() | async) ?? []
                    "
                />

                @for (skill of skillsOfType$("Save") | async; track $index) {
                    <app-skill
                        [creature]="creature"
                        [skill]="skill"
                    />
                }

                <header class="sectionHeader minimized-hide box-header">
                    Armor Proficiencies
                </header>

                @for (
                    skill of skillsOfType$("Armor Proficiency") | async;
                    track $index
                ) {
                    <app-skill
                        class="minimized-hide"
                        [creature]="creature"
                        [skill]="skill"
                        [showValue]="false"
                    />
                }
            }

            @if (creature.isFamiliar()) {
                <header class="sectionHeader minimized-hide box-header">
                    Saving Throws
                </header>

                @for (skill of skillsOfType$("Save") | async; track $index) {
                    <app-skill
                        [creature]="creature"
                        [skill]="skill"
                    />
                }

                <app-tags
                    [creature]="creature"
                    [objectName]="'Saving Throws'"
                    [showTraits]="true"
                    [showFeats]="true"
                    [showItems]="true"
                    [showActivities]="true"
                    [showConditions]="true"
                    [showEffects]="true"
                />
            }
        }
    </div>
</app-character-sheet-card>
