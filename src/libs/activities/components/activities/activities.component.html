<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
<div class="corner-button-tray">
    <app-minimize-button
        *ngIf="shouldShowMinimizeButton"
        [ngModel]="(isMinimized$ | async) ?? false"
        (ngModelChange)="toggleMinimized($event)"
    ></app-minimize-button>

    <app-tile-mode-button
        [ngModel]="(isTileMode$ | async) ?? false"
        (ngModelChange)="toggleTileMode($event)"
    ></app-tile-mode-button>
</div>

<div
    id="{{creature}}-activities-height"
    class="attributeBox"
>
    <header class="sectionHeader box-header">Actions and Activities</header>

    <app-tags
        [creature]="creature"
        [objectName]="'Activities'"
        [showTraits]=true
        [showFeats]=true
        [showItems]=true
        [showActivities]=true
        [showConditions]=true
        [showEffects]=true
    ></app-tags>

    <ng-template #EffectsPopoverContent>
        <div class="minimized-hide newrow">
            <app-object-effects
                [creature]="creature"
                [objectName]="'Class DCs'"
            ></app-object-effects>
        </div>
    </ng-template>

    <div class="vlist">
        <header class="subsectionHeader minimized-hide">
            <span
                class="minimized-hide"
                [ngbPopover]="EffectsPopoverContent"
                #EffectsPopover="ngbPopover"
                triggers="click"
            >
                <i
                    [ngbTooltip]="!EffectsPopover.isOpen() ? 'Edit effects' : ''"
                    class='bi-lightning-charge'
                ></i>
            </span>
            Class DCs
        </header>

        <app-skill
            [skill]=skill
            [isDC]=true
            *ngFor="let skill of classDCs(); trackBy:trackByIndex;"
        >
        </app-skill>
    </div>

    <div class="vlist">
        <header class="subsectionHeader">Actions and Activities</header>

        <ng-container *ngIf="activityParameters() as allActivityParameters">
            <div
                *ngIf="allActivityParameters.length && { enabled: isTileMode$ | async } as tileMode"
                [ngClass]="{'icon-list':tileMode.enabled, 'vlist':!tileMode.enabled}"
            >
                <ng-container *ngFor="let activityParameters of allActivityParameters; trackBy:trackByIndex;">
                    <ng-template #ActivityTitleTemplate>
                        <span *ngIf="!tileMode.enabled">
                            <i
                                class="value bi-patch-plus bonus"
                                *ngIf="!activityParameters.hostile"
                                [ngbTooltip]="'Beneficial activity'"
                            ></i>

                            <i
                                class="value bi-patch-minus-fill penalty"
                                *ngIf="activityParameters.hostile"
                                [ngbTooltip]="'Hostile activity'"
                            ></i>
                        </span>
                        {{activityParameters.name}}
                        <app-action-icons
                            *ngIf="activityParameters.activity.actions"
                            [actionString]="activityParameters.activity.actions"
                        >
                        </app-action-icons>
                        {{(activityParameters.activity.activationType) ?
                            activityParameters.activity.activationType : ""}}
                    </ng-template>

                    <ng-template #ActivityTemplate>
                        <header
                            class="spellHeader"
                            *ngIf="tileMode.enabled"
                        >
                            <ng-container *ngTemplateOutlet="ActivityTitleTemplate"></ng-container>
                        </header>

                        <app-activity
                            [creature]="creature"
                            [activity]=activityParameters.activity
                            [gain]=activityParameters.gain
                            [allowActivate]="true"
                        >
                        </app-activity>
                    </ng-template>

                    <ng-container *ngIf="!tileMode.enabled">
                        <div class="list-item">
                            <button
                                type="button"
                                aria-label="Show activity"
                                class="newrow left-aligned sublist-toggle"
                                [ngClass]="{'fancy-button':activityParameters.gain.active, 'inactive-button':activityParameters.disabled}"
                                (click)="toggleShownActivity(activityParameters.gain.id)"
                            >
                                <ng-container *ngTemplateOutlet="ActivityTitleTemplate"></ng-container>
                            </button>

                            <div
                                class="list-item sublist lower"
                                [ngClass]="{'fancy-list':activityParameters.gain.active, 'inactive-list':activityParameters.disabled}"
                                *ngIf="shownActivity()===activityParameters.gain.id"
                            >
                                <ng-container *ngTemplateOutlet="ActivityTemplate"></ng-container>
                            </div>
                        </div>
                    </ng-container>

                    <ng-container *ngIf="tileMode.enabled">
                        <button
                            type="button"
                            aria-label="Show activity"
                            [stickyPopover]="ActivityTemplate"
                            triggers="click"
                            [ngClass]="{'fancy-button':activityParameters.gain.active, 'inactive-button':activityParameters.disabled, 'penalty':!activityParameters.disabled && activityParameters.hostile, 'bonus':!activityParameters.disabled && !activityParameters.hostile}"
                        >
                            <app-grid-icon
                                [ngClass]="{'fancy-button':activityParameters.gain.active, 'inactive-button':activityParameters.disabled, 'penalty':!activityParameters.disabled && activityParameters.hostile, 'bonus':!activityParameters.disabled && !activityParameters.hostile}"
                                [ngbTooltip]="ActivityTitleTemplate"
                                [title]="activityParameters.name"
                                [activity]="activityParameters.activity"
                                [activityGain]="activityParameters.gain"
                                [updateId]="activityParameters.gain.id"
                            >
                            </app-grid-icon>
                        </button>
                    </ng-container>
                </ng-container>
            </div>
        </ng-container>
    </div>

    <div class="vlist">
        <header class="subsectionHeader box-header">Temporary Feats</header>

        <app-feat-choice
            *ngFor="let choice of temporaryFeatChoices(); trackBy:trackByIndex;"
            (showFeatChoiceMessage)="receiveShownFeatChoiceMessage($event.name)"
            (showFeatMessage)="receiveShownFeatMessage($event)"
            [choice]="choice"
            [levelNumber]="currentCreature.level"
            [showFeat]="shownItem()"
            [showChoice]="shownFeatChoice()"
        >
        </app-feat-choice>
    </div>
</div>
