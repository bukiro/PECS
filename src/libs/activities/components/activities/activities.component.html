<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
<app-character-sheet-card
    [showMinimizeButton]="shouldShowMinimizeButton"
    [showTileModeButton]="true"
    [minimized]="(isMinimized$ | async) ?? false"
    [tileMode]="(isTileMode$ | async) ?? false"
    (toggleMinimized)="toggleMinimized($event)"
    (toggleTileMode)="toggleTileMode($event)"
>
    <div
        class="attributeBox"
        id="{{ creature }}-activities-height"
    >
        <header class="sectionHeader box-header">Actions and Activities</header>

        <app-tags
            [creature]="creature"
            [objectName]="'Activities'"
            [showTraits]="true"
            [showFeats]="true"
            [showItems]="true"
            [showActivities]="true"
            [showConditions]="true"
            [showEffects]="true"
        />

        <ng-template #EffectsPopoverContent>
            <div class="minimized-hide newrow">
                <app-object-effects
                    [creature]="creature"
                    [objectName]="'Class DCs'"
                />
            </div>
        </ng-template>

        <div class="vlist">
            <header class="subsectionHeader minimized-hide">
                <span
                    #EffectsPopover="ngbPopover"
                    class="minimized-hide"
                    triggers="click"
                    [ngbPopover]="EffectsPopoverContent"
                >
                    <i
                        class="bi-lightning-charge"
                        [ngbTooltip]="
                            !EffectsPopover.isOpen() ? 'Edit effects' : ''
                        "
                    ></i>
                </span>
                Class DCs
            </header>

            @for (skill of classDCs$() | async; track $index) {
                <app-skill
                    [skill]="skill"
                    [isDC]="true"
                />
            }
        </div>

        <div class="vlist">
            <header class="subsectionHeader">Actions and Activities</header>

            @if (activityParameters$() | async; as allActivityParameters) {
                @if (
                    allActivityParameters.length && {
                        enabled: isTileMode$ | async,
                    };
                    as tileMode
                ) {
                    <div
                        [ngClass]="{
                            'icon-list': tileMode.enabled,
                            vlist: !tileMode.enabled,
                        }"
                    >
                        @for (
                            activityParameters of allActivityParameters;
                            track $index
                        ) {
                            <ng-template #ActivityTitleTemplate>
                                @if (!tileMode.enabled) {
                                    <span>
                                        @if (!activityParameters.hostile) {
                                            <i
                                                class="value bi-patch-plus bonus"
                                                [ngbTooltip]="
                                                    'Beneficial activity'
                                                "
                                            ></i>
                                        }

                                        @if (activityParameters.hostile) {
                                            <i
                                                class="value bi-patch-minus-fill penalty"
                                                [ngbTooltip]="
                                                    'Hostile activity'
                                                "
                                            ></i>
                                        }
                                    </span>
                                }
                                {{ activityParameters.name }}
                                @if (activityParameters.activity.actions) {
                                    <app-action-icons
                                        [actionString]="
                                            activityParameters.activity.actions
                                        "
                                    />
                                }
                                {{
                                    activityParameters.activity.activationType
                                        ? activityParameters.activity
                                              .activationType
                                        : ""
                                }}
                            </ng-template>

                            <ng-template #ActivityTemplate>
                                @if (tileMode.enabled) {
                                    <header class="spellHeader">
                                        <ng-container
                                            *ngTemplateOutlet="
                                                ActivityTitleTemplate
                                            "
                                        />
                                    </header>
                                }

                                <app-activity
                                    [creature]="creature"
                                    [activity]="activityParameters.activity"
                                    [gain]="activityParameters.gain"
                                    [allowActivate]="true"
                                />
                            </ng-template>

                            @if (!tileMode.enabled) {
                                <div class="list-item">
                                    <button
                                        type="button"
                                        aria-label="Show activity"
                                        class="newrow left-aligned sublist-toggle"
                                        [ngClass]="{
                                            'fancy-button':
                                                activityParameters.gain.active,
                                            'inactive-button':
                                                activityParameters.disabledReason,
                                        }"
                                        (click)="
                                            toggleShownActivity(
                                                activityParameters.gain.id
                                            )
                                        "
                                    >
                                        <ng-container
                                            *ngTemplateOutlet="
                                                ActivityTitleTemplate
                                            "
                                        />
                                    </button>

                                    @if (
                                        shownActivity() ===
                                        activityParameters.gain.id
                                    ) {
                                        <div
                                            class="list-item sublist lower"
                                            [ngClass]="{
                                                'fancy-list':
                                                    activityParameters.gain
                                                        .active,
                                                'inactive-list':
                                                    activityParameters.disabledReason,
                                            }"
                                        >
                                            <ng-container
                                                *ngTemplateOutlet="
                                                    ActivityTemplate
                                                "
                                            />
                                        </div>
                                    }
                                </div>
                            }

                            @if (tileMode.enabled) {
                                <button
                                    type="button"
                                    aria-label="Show activity"
                                    triggers="click"
                                    [stickyPopover]="ActivityTemplate"
                                    [ngClass]="{
                                        'fancy-button':
                                            activityParameters.gain.active,
                                        'inactive-button':
                                            activityParameters.disabledReason,
                                        penalty:
                                            !activityParameters.disabledReason &&
                                            activityParameters.hostile,
                                        bonus:
                                            !activityParameters.disabledReason &&
                                            !activityParameters.hostile,
                                    }"
                                >
                                    <app-grid-icon
                                        [ngClass]="{
                                            'fancy-button':
                                                activityParameters.gain.active,
                                            'inactive-button':
                                                activityParameters.disabledReason,
                                            penalty:
                                                !activityParameters.disabledReason &&
                                                activityParameters.hostile,
                                            bonus:
                                                !activityParameters.disabledReason &&
                                                !activityParameters.hostile,
                                        }"
                                        [ngbTooltip]="ActivityTitleTemplate"
                                        [title]="activityParameters.name"
                                        [activity]="activityParameters.activity"
                                        [activityGain]="activityParameters.gain"
                                        [updateId]="activityParameters.gain.id"
                                    />
                                </button>
                            }
                        }
                    </div>
                }
            }
        </div>

        <div class="vlist">
            <header class="subsectionHeader box-header">Temporary Feats</header>

            @for (choice of temporaryFeatChoices(); track $index) {
                <app-feat-choice
                    [choice]="choice"
                    [levelNumber]="creature.level"
                    [showFeat]="shownItem()"
                    [showChoice]="shownFeatChoice()"
                    (showFeatChoiceMessage)="
                        receiveShownFeatChoiceMessage($event.name)
                    "
                    (showFeatMessage)="receiveShownFeatMessage($event)"
                />
            }
        </div>
    </div>
</app-character-sheet-card>
