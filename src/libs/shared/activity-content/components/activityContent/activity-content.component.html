<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
<div
    *ngIf="activity.sourceBook"
    class="newrow left-aligned"
>
    <strong>Source</strong>

    <i>{{activity.sourceBook}}</i>
</div>

<div
    *ngIf="activity.inputRequired"
    class="list-item lower newrow problem"
>
    <strong>Player input required:</strong>

    <div
        *ngFor="let inputRequired of activity.inputRequired.split('\n\n'); trackBy:trackByIndex;"
        class="newrow left-aligned"
    >
        <app-description
            class="newrow"
            [text]="inputRequired"
        />
    </div>
</div>

<div
    *ngIf="activity.frequency || ((cooldown !== activity.cooldown) && !activity.cooldownAfterEnd)"
    class="newrow left-aligned"
>
    <span>
        <strong>Frequency</strong>

        <span *ngIf="cooldown === activity.cooldown">&nbsp;{{activity.frequency}}</span>

        <span
            *ngIf="cooldown !== activity.cooldown"
            class="absolute"
        >
            &nbsp;{{maxCharges ? maxCharges + "
            times every " : "once every "}}{{durationDescription$(cooldown, false, false) | async}}
        </span>
    </span>
</div>

<div
    *ngIf="cooldown && activity.cooldownAfterEnd"
    class="newrow left-aligned"
>
    <span>
        <strong>Cooldown after use</strong>

        <span [ngClass]="{'absolute':cooldown !== activity.cooldown}">
            &nbsp;{{durationDescription$(cooldown, false, false) | async}}
        </span>
    </span>
</div>

<div
    *ngIf="activity.cost"
    class="newrow left-aligned"
>
    <span>
        <strong>Cost</strong>
        {{activity.cost}}
    </span>
</div>

<div
    *ngIf="activity.trigger"
    class="newrow left-aligned"
>
    <span>
        <strong>Trigger</strong>
        {{activity.trigger}}
    </span>
</div>

<div
    *ngIf="activity.requirements"
    class="newrow left-aligned"
>
    <span>
        <strong>Requirements</strong>
        {{activity.requirements}}
    </span>
</div>

<div
    *ngFor="let desc of heightenedDescription().split('\n\n'); trackBy:trackByIndex;"
    class="newrow left-aligned"
>
    <app-description
        class="newrow"
        [text]="desc"
    />
</div>

<div
    *ngIf="activity.critsuccess"
    class="newrow gap-text left-aligned"
>
    <strong>Critical Success</strong>

    <app-description
        [text]="activity.critsuccess"
        [oneLiner]="true"
    />
</div>

<div
    *ngIf="activity.success"
    class="newrow gap-text left-aligned"
>
    <strong>Success</strong>

    <app-description
        [text]="activity.success"
        [oneLiner]="true"
    />
</div>

<div
    *ngIf="activity.failure"
    class="newrow gap-text left-aligned"
>
    <strong>Failure</strong>

    <app-description
        [text]="activity.failure"
        [oneLiner]="true"
    />
</div>

<div
    *ngIf="activity.critfailure"
    class="newrow gap-text left-aligned"
>
    <strong>Critical Failure</strong>

    <app-description
        [text]="activity.critfailure"
        [oneLiner]="true"
    />
</div>

<div
    *ngIf="activity.specialdesc"
    class="newrow gap-text left-aligned"
>
    <strong>Special</strong>
    {{activity.specialdesc}}
</div>

<div
    *ngFor="let shownActivityName of activity.showActivities; trackBy:trackByIndex;"
    class="list-item left-aligned"
>
    <ng-container *ngFor="let shownActivity of activities(shownActivityName); trackBy:trackByIndex;">
        <header class="spellHeader">
            {{shownActivity.name}}
            <app-action-icons
                *ngIf="shownActivity.actions"
                [actionString]="shownActivity.actions"
            />
            {{shownActivity.activationType.toString()}}
        </header>

        <div class="newrow left-aligned">
            <app-trait
                *ngFor="let trait of activity.traits; trackBy:trackByIndex;"
                [name]="trait"
                [trait]="traitFromName(trait)"
            />

            <app-trait
                *ngFor="let trait of activity.activationTraits(); trackBy:trackByIndex;"
                [name]="trait"
                [trait]="traitFromName(trait)"
                [extraDescription]="'(This trait was derived from the action components.)'"
            />
        </div>

        <app-activity-content
            [activity]=shownActivity
            [allowActivate]="false"
        />
    </ng-container>
</div>

<div
    *ngFor="let cast of spellCasts(); let spellCastIndex = index; trackBy:trackByIndex;"
    class="list-item newrow left-aligned"
>
    <ng-container *ngIf="spellFromName(cast.name) as spell">
        <header class="spellHeader">
            {{spell.name}}
            <app-action-icons
                *ngIf="spell.actions"
                [actionString]="spell.actions"
            />
            {{spell.castType.toString()}}
        </header>

        <ng-container *ngIf="gain && allowActivate">
            <ng-container *ngFor="let conditionSet of spellConditions$(cast, spellCastIndex) | async; let conditionSetIndex = index; trackBy:trackByIndex">
                <div
                    *ngIf="conditionSet.show"
                    class="newrow list-item left-aligned"
                >
                    <span>
                        {{conditionSet.condition.name}} effect selection:
                        <select
                            aria-label="Select condition effect"
                            [(ngModel)]="gain.spellEffectChoices[spellCastIndex][conditionSetIndex].choice"
                            (ngModelChange)="onEffectChoiceChange()"
                        >
                            <option
                                *ngFor="let choice of conditionSet.choices; trackBy:trackByIndex;"
                                [ngValue]="choice"
                            >
                                {{choice}}
                            </option>
                        </select>
                    </span>
                </div>
            </ng-container>
        </ng-container>

        <div class="newrow left-aligned">
            <app-trait
                *ngFor="let trait of spell.traits; trackBy:trackByIndex;"
                [name]="trait"
                [trait]="traitFromName(trait)"
            />

            <app-trait
                *ngFor="let trait of spell.activationTraits(); trackBy:trackByIndex;"
                [name]="trait"
                [trait]="traitFromName(trait)"
                [extraDescription]="'(This trait was derived from the action components.)'"
            />
        </div>

        <app-spell-content
            class="vlist fullwidth"
            [spell]="spell"
            [spellLevel]="(spellLevelFromBaseLevel$(spell, cast.level) | async) ?? 1"
        />
    </ng-container>
</div>

<div
    *ngFor="let shownSpellSet of activity.showSpells; trackBy:trackByIndex;"
    class="list-item left-aligned"
>
    <ng-container *ngIf="spellFromName(shownSpellSet.name) as shownSpell">
        <header class="spellHeader">
            {{shownSpell.name}}
            <app-action-icons
                *ngIf="shownSpell.actions"
                [actionString]="shownSpell.actions"
            />
            {{shownSpell.castType.toString()}}
        </header>

        <div class="newrow left-aligned">
            <app-trait
                *ngFor="let trait of shownSpell.traits; trackBy:trackByIndex;"
                [name]="trait"
                [trait]="traitFromName(trait)"
            />

            <app-trait
                *ngFor="let trait of shownSpell.activationTraits(); trackBy:trackByIndex;"
                [name]="trait"
                [trait]="traitFromName(trait)"
                [extraDescription]="'(This trait was derived from the action components.)'"
            />
        </div>

        <app-spell-content
            class="vlist fullwidth"
            [spell]="shownSpell"
            [spellLevel]="(spellLevelFromBaseLevel$(shownSpell, shownSpellSet.level) | async) ?? 1"
        />
    </ng-container>
</div>
