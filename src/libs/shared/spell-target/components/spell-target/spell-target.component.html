<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
<ng-container *ngIf="componentParameters$() | async as parameters">
    <div
        *ngIf="parameters.bloodMagicTrigger && asSpellGain() as spellGain"
        class="newrow list-item"
    >
        <strong class="gap-text">
            <input
                id="ignoreBloodMagicTrigger"
                type="checkbox"
                [(ngModel)]="spellGain.ignoreBloodMagicTrigger"
            >
            <label for="ignoreBloodMagicTrigger">
                {{"Don't trigger " + parameters.bloodMagicTrigger + " with this spell"}}
            </label>
        </strong>
    </div>

    <ng-template
        #buttonText
        let-target="target"
        let-canActivate="canActivate"
        let-expend="expend"
    >
        <span>
            {{expend ? 'Expend' : phrase}}{{target}}
            <span *ngIf="showActions">
                <app-action-icons
                    *ngIf="(spell || activity).actions"
                    [actionString]="(spell || activity).actions"
                />
                {{(spell.castType || activity.activationType) ? (spell.castType || activity.activationType) :
                ""}}
            </span>

            <i
                *ngIf="!canActivate"
                class='bi-peace'
            ></i>

            <i
                *ngIf="parameters.shouldBloodMagicApply"
                class='ra ra-droplet-splash'
            ></i>
        </span>
    </ng-template>

    <ng-container *ngIf="(isManualMode$ | async) === false">
        <!-- Button to activate on yourself. -->
        <div
            *ngIf="canTargetSelf()"
            class="newrow"
            [ngbTooltip]="cannotCast"
        >
            <button
                type="button"
                aria-label="Activate on yourself"
                class="center-aligned"
                [disabled]="cannotCast"
                [ngbTooltip]="parameters.bloodMagicWarningWithTarget"
                (click)="onCast('self', true)"
            >
                <ng-container *ngTemplateOutlet="buttonText;context:{target:parameters.target !== 'self' ? ' on yourself' : '', canActivate:parameters.canActivate}" />
            </button>

            <!-- Button to expend if casting on yourself is possible -->
            <!-- //To-do: Do there need to be two expend buttons? -->
            <button
                *ngIf="showExpend && !active && !['ally', 'area', 'minion', 'object', 'other'].includes(parameters.target)"
                type="button"
                aria-label="Expend"
                class="center-aligned"
                [disabled]="cannotExpend"
                [ngbTooltip]="(spell ? 'Cast' : 'Activate') + ' with no effect.'"
                (click)="onCast('', true, {expend: true})"
            >
                <ng-container *ngTemplateOutlet="buttonText;context:{target:'', canActivate:false, expend:true}" />
            </button>
        </div>

        <!-- Button to activate on the Character. -->
        <div
            *ngIf="canTargetCharacter()"
            class="newrow"
            [ngbTooltip]="cannotCast"
        >
            <button
                type="button"
                aria-label="Activate on the character"
                class="center-aligned"
                [disabled]="cannotCast"
                [ngbTooltip]="parameters.bloodMagicWarningWithTarget"
                (click)="onCast(character.type, true)"
            >
                <ng-container *ngTemplateOutlet="buttonText;context:{target:' on ' + (character.name || 'your master'), canActivate:parameters.canActivate}" />
            </button>
        </div>

        <!-- Button to activate on the Companion. -->
        <div
            *ngIf="(canTargetCompanion$() | async) as companion"
            class="newrow"
            [ngbTooltip]="cannotCast"
        >
            <button
                type="button"
                aria-label="Activate on the animal companion"
                class="center-aligned"
                [disabled]="cannotCast"
                [ngbTooltip]="parameters.bloodMagicWarningWithTarget"
                (click)="onCast(companion.type, true)"
            >
                <ng-container *ngTemplateOutlet="buttonText;context:{target:' on ' + (companion.name || 'your animal companion'), canActivate:parameters.canActivate}" />
            </button>
        </div>

        <!-- Button to activate on the Familiar. -->
        <div
            *ngIf="(canTargetFamiliar$() | async) as familiar"
            class="newrow"
            [ngbTooltip]="cannotCast"
        >
            <button
                type="button"
                aria-label="Activate on the familiar"
                class="center-aligned"
                [disabled]="cannotCast"
                [ngbTooltip]="parameters.bloodMagicWarningWithTarget"
                (click)="onCast(familiar.type, true)"
            >
                <ng-container *ngTemplateOutlet="buttonText;context:{target:' on ' + (familiar.name || 'your familiar'), canActivate:parameters.canActivate}" />
            </button>
        </div>

        <!-- Button to activate on selected allies. -->
        <ng-container *ngIf="canTargetAlly(parameters.allowedTargetNumber)">
            <ng-container *ngIf="spellTargets$ | async as targets">
                <ng-template
                    #SpellTargetModal
                    let-modal
                >
                    <div class="modal-header">
                        <header
                            class="sectionHeader modal-title"
                            id="modal-title"
                        >
                            {{(spell || activity).name}}
                            targets
                        </header>

                        <button
                            type="button"
                            class="close"
                            aria-label="close"
                            ngbAutofocus
                            (click)="modal.dismiss('Cross click')"
                        >
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>

                    <div class="modal-body vlist">
                        <p *ngIf="parameters.allowedTargetNumber === 1">
                            Select a target for this
                            {{spell ? "spell" : "activity"}}.
                        </p>

                        <p *ngIf="parameters.allowedTargetNumber > 1">
                            Select up to {{parameters.allowedTargetNumber}} targets for
                            this
                            {{spell ? "spell" : "activity"}}.
                        </p>

                        <p *ngIf="parameters.allowedTargetNumber === -1">
                            Select any number of targets for this {{spell ?
                            "spell"
                            :
                            "activity"}}.
                        </p>

                        <div
                            *ngIf="parameters.allowedTargetNumber === -1 || parameters.allowedTargetNumber >= targets.length"
                            class="gridicon-fullsizebox"
                        >
                            <input
                                id="spelltargetSelectAll"
                                class="character-choice"
                                type="checkbox"
                                [checked]="areAllTargetsSelected(parameters.allowedTargetNumber)"
                                (change)="onSelectAllTargets($event)"
                            >
                            <label
                                for="spelltargetSelectAll"
                                style="font-size: 1.5em;"
                            >
                                <strong>Select all</strong>
                            </label>
                        </div>

                        <div
                            class="fullsize-scroll-box vlist"
                            style="max-height: 50vh;"
                        >
                            <ng-container *ngFor="let target of targets; trackBy:trackByIndex">
                                <div class="list-item gridicon-fullsizebox">
                                    <input
                                        *ngIf="!target.isPlayer || !(spell || activity).cannotTargetCaster"
                                        class="character-choice"
                                        type="checkbox"
                                        id="spelltarget{{target.name}}"
                                        [disabled]="(target.isPlayer && (spell || activity).cannotTargetCaster) || (areAllTargetsSelected(parameters.allowedTargetNumber) && !target.selected)"
                                        [(ngModel)]="target.selected"
                                    >
                                    <input
                                        *ngIf="target.isPlayer && (spell || activity).cannotTargetCaster"
                                        aria-label="Toggle this spell target"
                                        class="character-choice"
                                        type="checkbox"
                                        disabled
                                        checked
                                        id="spelltarget{{target.name}}AlreadySelected"
                                    >
                                    <label
                                        style="font-size: 1.5em;"
                                        for="spelltarget{{target.name}}"
                                    >
                                        <i
                                            *ngIf="target.type==='Character'"
                                            class="ra ra-player"
                                            style="line-height: 1.5;"
                                        ></i>

                                        <i
                                            *ngIf="target.type==='Companion'"
                                            class="ra ra-wolf-howl"
                                            style="line-height: 1.5; margin-left: 1em;"
                                        ></i>

                                        <i
                                            *ngIf="target.type==='Familiar'"
                                            class="ra ra-raven"
                                            style="line-height: 1.5; margin-left: 1em;"
                                        ></i>

                                        <strong>{{target.name}}</strong>
                                    </label>
                                </div>
                            </ng-container>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button
                            type="button"
                            class="btn btn-outline-secondary"
                            (click)="modal.dismiss('Cancel click')"
                        >
                            Cancel
                        </button>

                        <button
                            type="button"
                            class="btn btn-primary"
                            style="background-color: rgb(var(--accent));"
                            (click)="modal.close('Cast click')"
                        >
                            {{spell ? "Cast spell" : "Apply activity"}} on these
                            targets
                        </button>
                    </div>
                </ng-template>

                <div
                    class="newrow"
                    [ngbTooltip]="cannotCast"
                >
                    <button
                        type="button"
                        aria-label="Open spell target selection"
                        class="center-aligned"
                        [disabled]="cannotCast"
                        [ngbTooltip]="parameters.bloodMagicWarningWithTarget"
                        (click)="onOpenSpellTargetModal(SpellTargetModal)"
                    >
                        <ng-container *ngTemplateOutlet="buttonText;context:{target:' on...', canActivate:parameters.canActivate}" />
                    </button>
                </div>
            </ng-container>
        </ng-container>

        <!-- Button to activate without target. -->
        <div
            *ngIf="!active && ['ally', 'area', 'minion', 'object', 'other'].includes(parameters.target)"
            class="newrow"
            [ngbTooltip]="cannotCast || cannotExpend"
        >
            <button
                type="button"
                aria-label="Activate without a target"
                class="center-aligned"
                [disabled]="cannotCast"
                [ngbTooltip]="parameters.bloodMagicWarningWithoutTarget"
                (click)="onCast('', true)"
            >
                <ng-container *ngTemplateOutlet="buttonText;context:{target:'', canActivate:parameters.canActivateWithoutTarget}" />
            </button>

            <!-- Button to expend if casting on yourself is not possible -->
            <button
                *ngIf="showExpend"
                type="button"
                aria-label="Expend"
                class="center-aligned"
                [disabled]="cannotExpend"
                [ngbTooltip]="(spell ? 'Cast' : 'Activate') + ' with no effect.'"
                (click)="onCast('', true, {expend: true})"
            >
                <ng-container *ngTemplateOutlet="buttonText;context:{target:'', canActivate:false, expend:true}" />
            </button>
        </div>
    </ng-container>

    <!-- Manual mode: Just cast/activate without target. -->
    <ng-container *ngIf="isManualMode$ | async">
        <div
            *ngIf="!active"
            class="newrow"
            [ngbTooltip]="cannotCast"
        >
            <button
                type="button"
                aria-label="Activate"
                class="newrow center-aligned"
                [disabled]="cannotCast"
                [ngbTooltip]="parameters.bloodMagicWarningManualMode"
                (click)="onCast('', true)"
            >
                <ng-container *ngTemplateOutlet="buttonText;context:{target:'', canActivate:true}" />
            </button>
        </div>
    </ng-container>

    <!-- Deactivate button -->
    <div
        *ngIf="active && showDismiss"
        class="newrow"
    >
        <button
            type="button"
            aria-label="Deactivate"
            class="newrow center-aligned"
            (click)="onCast(gain.selectedTarget, false)"
        >
            <span [innerHtml]="deactivatePhrase()"></span>
        </button>
    </div>
</ng-container>
