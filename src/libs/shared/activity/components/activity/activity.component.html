<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
@if (activityParameters$() | async; as activityParameters) {
    @if (allowActivate && gain) {
        <div class="newrow">
            <!-- Buttons if the activity does anything, including activating a cooldown or toggling the activity status. -->
            @if (activity.canActivate$(creature) | async) {
                <!-- Spell targets if a spell is cast by this activity. -->
                @if (activityParameters.activitySpell) {
                    <app-spell-target
                        class="newrow vlist"
                        [creature]="creature"
                        [spell]="activityParameters.activitySpell.spell"
                        [phrase]="
                            'Activate' +
                            (activityParameters.maxCharges
                                ? ' (' +
                                  (activityParameters.maxCharges -
                                      gain.chargesUsed) +
                                  ' of ' +
                                  activityParameters.maxCharges +
                                  ' charges)'
                                : '') +
                            ' and cast'
                        "
                        [gain]="activityParameters.activitySpell.gain"
                        [parentActivityGain]="gain"
                        [parentActivity]="activity"
                        [cannotCast]="activityParameters.disabledReason"
                        [effectiveSpellLevel]="
                            activityParameters.activitySpell.cast.level ||
                            activityParameters.activitySpell.spell.levelreq
                        "
                        [spellCast]="activityParameters.activitySpell.cast"
                        [showDismiss]="true"
                        [dismissPhrase]="
                            activity.sustained
                                ? 'Stop Sustaining'
                                : 'Deactivate'
                        "
                        (castMessage)="
                            onActivate(
                                gain,
                                activity,
                                $event.activated,
                                $event.target
                            )
                        "
                    />
                }

                <!-- Activity targets if no spell is cast. -->
                @if (!activityParameters.activitySpell) {
                    <app-spell-target
                        class="newrow vlist"
                        [creature]="creature"
                        [activity]="activity"
                        [phrase]="
                            'Activate' +
                            (activityParameters.maxCharges
                                ? ' (' +
                                  (activityParameters.maxCharges -
                                      gain.chargesUsed) +
                                  ' of ' +
                                  activityParameters.maxCharges +
                                  ' charges)'
                                : '')
                        "
                        [gain]="gain"
                        [cannotCast]="activityParameters.disabledReason"
                        [effectiveSpellLevel]="character.level"
                        [showDismiss]="true"
                        [dismissPhrase]="
                            activity.sustained
                                ? 'Stop Sustaining'
                                : 'Deactivate'
                        "
                        (castMessage)="
                            onActivate(
                                gain,
                                activity,
                                $event.activated,
                                $event.target
                            )
                        "
                    />
                }
            } @else {
                <!-- Activity with no effect, not even toggled. This button literally does nothing. -->
                <button
                    type="button"
                    class="newrow center-aligned"
                    [ngbTooltip]="
                        'The activity has no automatic effects and no target.'
                    "
                >
                    <span>
                        Activate
                        @if ((isManualMode$ | async) === false) {
                            <i class="bi-peace"></i>
                        }
                    </span>
                </button>
            }

            @if (isManualMode$ | async) {
                <!-- End cooldown and restore charges button in manual mode -->
                @if (gain.activeCooldown) {
                    <button
                        type="button"
                        class="center-aligned"
                        (click)="onManualEndCooldown()"
                    >
                        <span>End cooldown</span>
                    </button>
                }

                <!-- Restore charges button in manual mode -->
                @if (gain.chargesUsed) {
                    <button
                        type="button"
                        class="center-aligned"
                        (click)="onManualRestoreCharge()"
                    >
                        <span>Restore charge</span>
                    </button>
                }
            }
        </div>
    }

    <!-- Unslotted Aeon Stone warning -->
    @if (
        isResonant &&
        !(isSubItem || activityParameters.resonantAllowed) &&
        !activityParameters.tooManySlottedAeonStones
    ) {
        <button
            type="button"
            class="newrow list-item"
            disabled
        >
            <strong>
                Slot this item into a Wayfinder to unlock this activation.
            </strong>
        </button>
    }

    <!-- Too many slotted Aeon Stones warning -->
    @if (isResonant && activityParameters.tooManySlottedAeonStones) {
        <div class="newrow list-item problem">
            You have too many aeon stones slotted in wayfinders. All effects of
            these aeon stones are disabled, including this activation.
        </div>
    }

    <div class="newrow left-aligned">
        @for (trait of activity.traits; track $index) {
            <app-trait
                [name]="trait"
                [trait]="traitFromName(trait)"
            />
        }

        @for (trait of activity.activationTraits(); track $index) {
            <app-trait
                [name]="trait"
                [trait]="traitFromName(trait)"
                [extraDescription]="
                    '(This trait was derived from the action components.)'
                "
            />
        }

        <app-tags
            [creature]="creature"
            [objectName]="activity.name"
            [showTraits]="true"
            [showFeats]="true"
            [showItems]="true"
            [showActivities]="true"
            [showConditions]="true"
            [showEffects]="true"
        />
    </div>

    @for (data of gain?.data; track $index) {
        <div class="newrow list-item">
            <strong>{{ data.name }}</strong>

            <input
                aria-label="Activity data value input"
                class="left-aligned"
                type="text"
                [(ngModel)]="data.value"
            />
        </div>
    }

    @for (
        conditionSet of activityConditions$() | async;
        track conditionSetIndex;
        let conditionSetIndex = $index
    ) {
        @if (
            gain &&
            shownConditionChoice(conditionSet, {
                tooManySlottedAeonStones:
                    activityParameters.tooManySlottedAeonStones,
                resonantAllowed: activityParameters.resonantAllowed,
            })
        ) {
            <div class="newrow list-item left-aligned">
                <span>
                    {{ conditionSet.condition.name }} effect selection:
                    @if (
                        gain.effectChoices[conditionSetIndex];
                        as effectChoice
                    ) {
                        <select
                            aria-label="Select condition effect"
                            [(ngModel)]="effectChoice.choice"
                            (ngModelChange)="onEffectChoiceChange()"
                        >
                            @for (
                                choice of conditionSet.choices;
                                track $index
                            ) {
                                <option [ngValue]="choice">
                                    {{ choice }}
                                </option>
                            }
                        </select>
                    }
                </span>
            </div>
        }
    }

    <!-- Additional information coming from other abilities. -->
    <div class="vlist lower">
        <app-activity-content
            class="vlist fullwidth"
            [creature]="creature"
            [activity]="activity"
            [gain]="gain"
            [allowActivate]="allowActivate"
            [cooldown]="activityParameters.cooldown"
            [maxCharges]="activityParameters.maxCharges"
        />

        <!-- Only show related feats and conditions if this activity is not currently being shown on another object - that is, if it's allowed to be activated. -->
        @if (allowActivate) {
            @for (
                feat of characterFeatsShowingHintsOnThis$(activity.name)
                    | async;
                track $index
            ) {
                <div class="list-item newrow left-aligned">
                    <header class="spellHeader">{{ feat.name }}</header>

                    <div class="newrow left-aligned">
                        @for (trait of feat.traits; track $index) {
                            <app-trait
                                [name]="trait"
                                [trait]="traitFromName(trait)"
                            />
                        }
                    </div>

                    @for (desc of feat.desc.split("\n\n"); track $index) {
                        <div class="newrow left-aligned">
                            <app-description
                                class="newrow"
                                [text]="desc"
                            />
                        </div>
                    }
                </div>
            }

            @for (
                conditionSet of conditionsShowingHintsOnThis$(activity.name) | async;
                track $index
            ) {
                <div class="newrow left-aligned">
                    <header class="spellHeader">
                        {{ conditionSet.condition.name }}
                    </header>

                    @for (
                        desc of conditionSet.condition
                            .heightenedText(
                                conditionSet.condition.desc,
                                conditionSet.gain.heightened
                            )
                            .split("\n\n");
                        track $index
                    ) {
                        <div class="newrow left-aligned">
                            <app-description
                                class="newrow"
                                [text]="desc"
                            />
                        </div>
                    }
                </div>
            }

            @for (
                activityGain of activitiesShowingHintsOnThis$(activity.name)
                    | async;
                track $index
            ) {
                <div class="list-item newrow left-aligned">
                    <header class="spellHeader">
                        {{ activityGain.originalActivity.name }}
                        @if (activityGain.originalActivity.actions) {
                            <app-action-icons
                                [actionString]="
                                    activityGain.originalActivity.actions
                                "
                            />
                        }
                        {{
                            activityGain.originalActivity.activationType
                                ? activityGain.originalActivity.activationType
                                : ""
                        }}
                    </header>

                    <app-activity
                        [creature]="creature"
                        [activity]="activityGain.originalActivity"
                        [gain]="activityGain"
                        [allowActivate]="true"
                    />
                </div>
            }

            @if (gain?.name === "Fused Stance") {
                @for (
                    fusedStanceGain of fusedStances$() | async;
                    track $index
                ) {
                    <div class="list-item newrow left-aligned">
                        <header class="spellHeader">
                            {{ fusedStanceGain.originalActivity.name }}
                            @if (fusedStanceGain.originalActivity.actions) {
                                <app-action-icons
                                    [actionString]="
                                        fusedStanceGain.originalActivity.actions
                                    "
                                />
                            }
                            {{
                                fusedStanceGain.originalActivity.activationType
                                    ? fusedStanceGain.originalActivity
                                          .activationType
                                    : ""
                            }}
                        </header>

                        <app-activity
                            [creature]="creature"
                            [activity]="fusedStanceGain.originalActivity"
                            [gain]="fusedStanceGain"
                            [allowActivate]="false"
                        />
                    </div>
                }
            }
        }
    </div>
}
