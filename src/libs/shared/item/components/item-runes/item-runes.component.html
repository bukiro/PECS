<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
<!-- Changing Weapon Runes -->
@if (isRuneItem() && (item.moddable || customItemStore)) {
    <div class="list-item">
        @if (runeItemType(); as runeItemType) {
            @if (previousValues(); as previousValues) {
                <!-- Potency rune -->
                <div class="newrow">
                    <strong>Potency rune</strong>

                    <select
                        aria-label="Select potency rune"
                        [(ngModel)]="item.potencyRune"
                        (ngModelChange)="
                            onSelectPotencyRune(
                                previousValues.potency,
                                runeItemType
                            )
                        "
                    >
                        @for (
                            potencySet of availablePotencyRunes(runeItemType);
                            track $index
                        ) {
                            <option
                                [ngValue]="potencySet.potency"
                                [disabled]="potencySet.disabled"
                                title="{{ runeTitle(potencySet.rune) }}"
                            >
                                {{ item.potencyTitle(potencySet.potency) }}
                            </option>
                        }
                    </select>
                </div>

                <!-- Resilient/Striking rune -->
                @if (item.potencyRune > 0) {
                    <div class="newrow">
                        @if (runeItemType.armor) {
                            <strong>Resilient rune</strong>
                        }

                        @if (runeItemType.weapon) {
                            <strong>Striking rune</strong>
                        }

                        <select
                            aria-label="Select secondary rune"
                            [(ngModel)]="item.secondaryRune"
                            (ngModelChange)="
                                onSelectSecondaryRune(
                                    previousValues.secondary,
                                    runeItemType
                                )
                            "
                        >
                            @for (
                                secondarySet of availableSecondaryRunes(
                                    runeItemType
                                );
                                track $index
                            ) {
                                <option
                                    [ngValue]="secondarySet.secondary"
                                    [disabled]="secondarySet.disabled"
                                    title="{{ runeTitle(secondarySet.rune) }}"
                                >
                                    {{
                                        item.secondaryRuneTitleFunction(
                                            secondarySet.secondary
                                        )
                                    }}
                                </option>
                            }
                        </select>
                    </div>
                }
            }

            <!-- Property runes -->
            @if (item.potencyRune > 0) {
                @for (index of propertyRunesSlots(); track $index) {
                    <div class="newrow">
                        @if ($first) {
                            <strong>Property runes</strong>
                        } @else {
                            <span>&nbsp;</span>
                        }

                        <select
                            aria-label="Select property rune"
                            [disabled]="
                                !item.propertyRunes[index - 1] && index > 0
                            "
                            [(ngModel)]="newPropertyRune[index]"
                            (ngModelChange)="onSelectPropertyRune(index)"
                        >
                            @for (
                                rune of initialPropertyRunes(index);
                                track $index
                            ) {
                                @if ($first) {
                                    <option
                                        [ngValue]="rune"
                                        [selected]="!item.propertyRunes[index]"
                                    >
                                        <!-- Blank option to deselect -->
                                    </option>
                                } @else {
                                    <optgroup label="Current rune">
                                        <option [ngValue]="rune">
                                            {{ rune.rune?.name }}
                                        </option>
                                    </optgroup>
                                }
                            }

                            @for (
                                inv of inventoriesOrCleanItems();
                                track $index
                            ) {
                                @if (
                                    availablePropertyRunes$(
                                        index,
                                        inv,
                                        runeItemType
                                    ) | async;
                                    as availablePropertyRunes
                                ) {
                                    @if (availablePropertyRunes.length) {
                                        <optgroup
                                            [label]="
                                                itemStore
                                                    ? 'Available runes'
                                                    : (inventoryName$(inv)
                                                      | async)
                                            "
                                        >
                                            @for (
                                                runeSet of availablePropertyRunes;
                                                track $index
                                            ) {
                                                <option
                                                    [ngValue]="runeSet"
                                                    [disabled]="
                                                        runeSet.disabled
                                                    "
                                                    title="{{
                                                        runeTitle(runeSet.rune)
                                                    }}"
                                                >
                                                    {{
                                                        (runeSet.rune?.amount ||
                                                            0) > 1
                                                            ? runeSet.rune
                                                                  ?.amount
                                                            : ""
                                                    }}
                                                    {{ runeSet.rune?.name }}
                                                    {{runeCooldownText$(runeSet.rune)}
                                                    | async}
                                                </option>
                                            }
                                        </optgroup>
                                    }
                                }
                            }
                        </select>
                    </div>
                }
            }
        }
    </div>
}
