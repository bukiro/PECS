<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
@if (itemTraits$() | async; as traits) {
    @if (traits.length) {
        <div class="newrow left-aligned tags">
            @for (trait of traits; track $index) {
                <app-trait
                    [name]="trait"
                    [trait]="traitFromName(trait)"
                    [creatureType]="creature.type"
                />
            }
        </div>
    }
}

<div class="newrow left-aligned tags">
    <app-tags
        [creature]="creature"
        [objectName]="item.name"
        [showTraits]="true"
        [showFeats]="true"
        [showItems]="true"
        [showActivities]="true"
        [showConditions]="true"
        [showEffects]="true"
    />
</div>

@if (itemRoles(); as itemRoles) {
    @if (
        itemRoles.asEquipment &&
        itemRoles.asEquipment.choices.length &&
        (itemStore ? true : itemRoles.asEquipment.showChoicesInInventory)
    ) {
        <div class="newrow">
            <span>
                Variation:
                <select
                    aria-label="Select item variation"
                    [(ngModel)]="itemRoles.asEquipment.choice"
                    (ngModelChange)="onSelectVariation()"
                >
                    @for (
                        choice of itemRoles.asEquipment.choices;
                        track $index
                    ) {
                        <option [ngValue]="choice">
                            {{ choice }}
                        </option>
                    }
                </select>
            </span>
        </div>
    }

    <!-- Doubling Rings selection -->
    @if (itemRoles.asWornItem; as asWornItem) {
        @if (
            !itemStore &&
            asWornItem.isDoublingRings &&
            !asWornItem.isTalismanCord &&
            !asWornItem.isRingOfWizardry.length &&
            item.data[0] &&
            item.data[1]
        ) {
            <div class="newrow">
                <header class="spellHeader">Doubling Rings</header>

                <div class="newrow">
                    <strong>Weapon wielded in the gold ring hand</strong>

                    <select
                        aria-label="Select weapon wielded in the hand with the gold doubling ring"
                        [(ngModel)]="item.data[0].value"
                        (ngModelChange)="
                            onSelectDoublingRingsOption(asWornItem)
                        "
                    >
                        @for (
                            weapon of doublingRingsOptions("gold");
                            track $index
                        ) {
                            <option [ngValue]="weapon.id">
                                {{ weapon.effectiveName$() }}
                            </option>
                        }
                    </select>
                </div>

                <div class="newrow">
                    <strong>Weapon wielded in the iron ring hand</strong>

                    <select
                        aria-label="Select weapon wielded in the hand with the iron doubling ring"
                        [(ngModel)]="item.data[1].value"
                        (ngModelChange)="
                            onSelectDoublingRingsOption(asWornItem)
                        "
                    >
                        @for (
                            weapon of doublingRingsOptions("iron");
                            track $index
                        ) {
                            <option [ngValue]="weapon.id">
                                {{ weapon.effectiveName$() }}
                            </option>
                        }
                    </select>
                </div>

                @if (
                    asWornItem.isDoublingRings === "Doubling Rings (Greater)" &&
                    item.data[2]
                ) {
                    <div class="newrow left-aligned">
                        <input
                            type="checkbox"
                            id="{{ item.id }}doublingRingsApplyPropertyRunes"
                            [(ngModel)]="item.data[2].value"
                            (ngModelChange)="
                                onSelectDoublingRingsOption(asWornItem)
                            "
                        />
                        <label
                            for="{{ item.id }}doublingRingsApplyPropertyRunes"
                            >Apply property runes</label
                        >
                    </div>
                }
            </div>
        }

        <!-- Ring of Wizardry selection -->
        @if (
            !itemStore ||
            (asWornItem.isRingOfWizardry.length &&
                !asWornItem.isTalismanCord &&
                !asWornItem.isDoublingRings)
        ) {
            <div class="newrow">
                <header class="spellHeader">Ring of Wizardry</header>

                @for (
                    wizardrySlot of asWornItem.isRingOfWizardry;
                    track wizardryIndex;
                    let wizardryIndex = $index
                ) {
                    <div class="newrow">
                        <strong>
                            {{ ringOfWizardrySlotName(wizardrySlot) }}
                        </strong>

                        @if (item.data[wizardryIndex]; as wizardryData) {
                            <select
                                aria-label="Select spellcasting for ring of wizardry"
                                [(ngModel)]="wizardryData.value"
                                (ngModelChange)="
                                    onSelectRingOfWizardryOption(
                                        asWornItem,
                                        wizardrySlot,
                                        wizardryIndex
                                    )
                                "
                            >
                                @for (
                                    spellCasting of ringOfWizardryOptions(
                                        wizardrySlot
                                    );
                                    track $index
                                ) {
                                    <option [ngValue]="spellCasting">
                                        {{ spellCasting }}
                                    </option>
                                }
                            </select>
                        }
                    </div>
                }
            </div>
        }

        <!-- Talisman Cord school display/selection -->
        @if (
            asWornItem.isTalismanCord &&
            !asWornItem.isDoublingRings &&
            !asWornItem.isRingOfWizardry.length
        ) {
            <div class="newrow">
                <header class="spellHeader">Talisman Cord</header>

                @for (talismanCordIndex of [0, 1, 2]; track $index) {
                    @if (
                        asWornItem.isTalismanCord > talismanCordIndex &&
                        item.data[talismanCordIndex]; as talismanData
                    ) {
                        <div class="newrow">
                            <strong>{{
                                talismanData.name
                            }}</strong>

                            <select
                                aria-label="Select wizard school for talisman cord"
                                [(ngModel)]="talismanData.value"
                            >
                                @for (
                                    school of talismanCordOptions(
                                        asWornItem,
                                        talismanCordIndex
                                    );
                                    track $index
                                ) {
                                    <option [ngValue]="school">
                                        {{ school }}
                                    </option>
                                }
                            </select>
                        </div>
                    }
                }
            </div>
        }
    }

    <app-item-content [item]="item" />

    <!-- Item activities -->
    @for (activity of itemRoles.asActivityBearing?.activities; track $index) {
        <div class="list-item left-aligned">
            @if (activity.name) {
                <header class="spellHeader">
                    {{ activity.name }}
                    @if (activity.actions) {
                        <app-action-icons [actionString]="activity.actions" />
                    }
                    {{ activity.activationType ? activity.activationType : "" }}
                </header>
            }

            <app-activity
                [creature]="creature"
                [activity]="activity"
                [gain]="activity"
                [allowActivate]="
                    allowActivate &&
                    !itemRoles.asEquipment?.broken &&
                    !!(activity.resonant ? isSubItem : true)
                "
                [isSubItem]="isSubItem"
            />
        </div>
    }

    <!-- Known activities -->
    @for (gain of itemRoles.asEquipment?.gainActivities; track $index) {
        @if (activityFromName(gain.name); as activity) {
            <div class="list-item left-aligned">
                <header class="spellHeader">
                    {{ activity.name }}
                    @if (activity.actions) {
                        <app-action-icons [actionString]="activity.actions" />
                    }
                    {{ activity.activationType ? activity.activationType : "" }}
                </header>

                <app-activity
                    [creature]="creature"
                    [activity]="activity"
                    [gain]="gain"
                    [allowActivate]="allowActivate"
                    [isSubItem]="isSubItem"
                />
            </div>
        }
    }

    <!-- Shown/related activities (Talismans only) -->
    @for (activityName of itemRoles.asTalisman?.showActivities; track $index) {
        @if (activityFromName(activityName); as activity) {
            <div class="list-item left-aligned">
                <header class="spellHeader">
                    {{ activity.name }}
                    @if (activity.actions) {
                        <app-action-icons [actionString]="activity.actions" />
                    }
                    {{ activity.activationType ? activity.activationType : "" }}
                </header>

                <app-activity
                    [creature]="creature"
                    [activity]="activity"
                    [allowActivate]="false"
                    [isSubItem]="isSubItem"
                />
            </div>
        }
    }

    <!-- Spells that get cast by activating the item (Oils only) -->
    @for (cast of itemRoles.asOil?.castSpells; track $index) {
        <div class="list-item left-aligned">
            @if (spellFromName(cast.name); as spell) {
                <div>
                    <header class="spellHeader">
                        {{ spell.name }}
                        @if (spell.actions) {
                            <app-action-icons [actionString]="spell.actions" />
                        }
                        {{ spell.castType.toString() }}
                    </header>

                    <app-spell
                        [spell]="spell"
                        [spellLevel]="cast.level ? cast.level : 0"
                    />
                </div>
            }
        </div>
    }

    <!-- Spells that you gain from equipping/investing the item -->
    @for (choice of itemRoles.asEquipment?.gainSpells; track $index) {
        @for (gain of choice.spells; track $index) {
            <div class="list-item left-aligned">
                @if (spellFromName(gain.name); as spell) {
                    <div>
                        <header class="spellHeader">
                            {{ spell.name }}
                            @if (spell.actions) {
                                <app-action-icons
                                    [actionString]="spell.actions"
                                />
                            }
                            {{ spell.castType.toString() }}
                        </header>

                        <app-spell
                            [spell]="spell"
                            [spellLevel]="
                                (gainedSpellLevel$(spell, { gain, choice })
                                    | async) ?? 1
                            "
                        />
                    </div>
                }
            </div>
        }
    }

    <!-- Material description -->
    @for (material of itemRoles.asEquipment?.material; track $index) {
        <div class="list-item left-aligned">
            <header class="spellHeader">{{ material.name }}</header>

            @if (material.sourceBook) {
                <div class="newrow left-aligned">
                    <strong>Source</strong>

                    <i>{{ material.sourceBook }}</i>
                </div>
            }

            @for (desc of material.desc.split("\n\n"); track $index) {
                <app-description
                    class="newrow"
                    [text]="desc"
                />
            }
        </div>
    }

    <!-- Armored skirt description if one is applied -->
    @if (armoredSkirt) {
        <div class="list-item left-aligned">
            <header class="spellHeader">Armored Skirt</header>

            <app-item [item]="armoredSkirt" />
        </div>
    }

    <!-- Spell choices for wands/scrolls/etc -->
    @for (choice of storedSpellChoices(item); track $index) {
        <div class="list-item left-aligned">
            <app-spell-choice
                class="newrow"
                [choice]="choice"
                [showHeightened]="true"
                [level]="choice.level"
                [itemSpell]="true"
            />
        </div>
    }

    <!-- Spell descriptions and effect selections of selected spells -->
    @for (spellSet of storedSpellsTaken(item); track $index) {
        @if (spellFromName(spellSet.taken.name); as spell) {
            <div class="list-item left-aligned">
                <header class="spellHeader">
                    {{ spell.name }}
                    @if (spell.actions) {
                        <app-action-icons [actionString]="spell.actions" />
                    }
                    {{ spell.castType.toString() }}
                </header>

                @if (!itemStore) {
                    @for (
                        conditionSet of spellConditions$(
                            spell,
                            spellSet.choice.level,
                            spellSet.taken
                        ) | async;
                        track conditionSetIndex;
                        let conditionSetIndex = $index
                    ) {
                        @if (conditionSet.show) {
                            <div class="newrow list-item left-aligned">
                                <span>
                                    {{ conditionSet.condition.name }} effect
                                    selection:

                                    @if (
                                        spellSet.taken.effectChoices[
                                            conditionSetIndex
                                        ];
                                        as effectChoice
                                    ) {
                                        <select
                                            aria-label="Select condition effect"
                                            [(ngModel)]="effectChoice.choice"
                                        >
                                            @for (
                                                choice of conditionSet.choices;
                                                track $index
                                            ) {
                                                <option [ngValue]="choice">
                                                    {{ choice }}
                                                </option>
                                            }
                                        </select>
                                    }
                                </span>
                            </div>
                        }
                    }
                }

                <app-spell
                    [spell]="spell"
                    [spellLevel]="spellSet.choice.level || 0"
                />
            </div>
        }
    }

    <!-- Oil descriptions -->
    @for (oil of item.oilsApplied; track $index) {
        <div class="list-item left-aligned">
            <header class="spellHeader">{{ oil.effectiveName$() }}</header>

            <app-item
                [creature]="creature"
                [item]="oil"
                [allowActivate]="allowActivate"
                [isSubItem]="true"
            />
        </div>
    }

    <!-- Poison descriptions -->
    @for (poison of itemRoles.asWeapon?.poisonsApplied; track $index) {
        <div class="list-item left-aligned">
            <header class="spellHeader">{{ poison.name }}</header>

            @if (allowActivate && itemRoles.asWeapon) {
                <button
                    type="button"
                    class="newrow left-aligned"
                    (click)="onActivatePoison(itemRoles.asWeapon, poison)"
                >
                    <span>Spend/Remove</span>
                </button>
            }

            <app-item
                [creature]="creature"
                [item]="poison"
                [allowActivate]="allowActivate"
                [isSubItem]="true"
            />
        </div>
    }

    <!-- Rune descriptions -->
    @for (rune of itemRoles.asEquipment?.propertyRunes; track $index) {
        <div class="list-item left-aligned">
            <header class="spellHeader">{{ rune.name }} Rune</header>

            @if (runeStoredSpell(rune); as spell) {
                <button
                    type="button"
                    class="newrow center-aligned"
                    (click)="onActivateSpellRune(rune)"
                >
                    <span>
                        Use
                        @if (spell.actions) {
                            <app-action-icons [actionString]="spell.actions" />
                        }
                        (Cast spell)
                    </span>
                </button>
            }

            <app-item
                [creature]="creature"
                [item]="rune"
                [allowActivate]="allowActivate"
                [isSubItem]="true"
            />
        </div>
    }

    <!-- Blade ally rune descriptions -->
    @if (itemRoles.asWeapon || itemRoles.asWornItem; as bladeAllyItem) {
        @if (bladeAllyItem.bladeAlly) {
            @for (rune of bladeAllyItem.bladeAllyRunes; track $index) {
                <div class="list-item left-aligned">
                    <header class="spellHeader">{{ rune.name }} Rune</header>

                    <app-item
                        [creature]="creature"
                        [item]="rune"
                        [allowActivate]="allowActivate"
                        [isSubItem]="true"
                    />
                </div>
            }
        }
    }

    <!-- Emulated rune descriptions (oils) -->
    @if (!!itemRoles.asOil && !!itemRoles.asOil.runeEffect) {
        <div class="list-item left-aligned">
            <header class="spellHeader">
                Rune Effect: {{ itemRoles.asOil.runeEffect.name }}
            </header>

            <app-item
                [creature]="creature"
                [item]="itemRoles.asOil.runeEffect"
                [allowActivate]="allowActivate"
                [isSubItem]="isSubItem"
            />
        </div>
    }

    <!-- Aeon stone descriptions -->
    @for (stone of itemRoles.asWornItem?.aeonStones; track $index) {
        <div class="list-item left-aligned">
            <header class="spellHeader">{{ stone.name }}</header>

            <app-item
                [creature]="creature"
                [item]="stone"
                [allowActivate]="allowActivate"
                [isSubItem]="true"
            />
        </div>
    }

    <!-- Talisman cord descriptions -->
    @for (cord of itemRoles.asEquipment?.talismanCords; track $index) {
        <div class="list-item left-aligned lower">
            <header class="spellHeader">{{ cord.name }}</header>

            <p>
                When you activate a talisman threaded through a cord with the
                same magic school trait that's also the cord's level or lower,
                attempt a
                <app-quickdice [diceString]="'1d20'" />
                DC 16 flat check. On a success, that talisman is not consumed
                and can be used again.
            </p>

            @for (talismanCordIndex of [0, 1, 2]; track $index) {
                @if (
                    cord.isTalismanCord > talismanCordIndex &&
                    cord.data[talismanCordIndex]; as talismanCordData
                ) {
                    <div class="newrow">
                        <strong>{{ talismanCordData.name }}</strong>
                        {{ talismanCordData.value }}
                    </div>
                }
            }
        </div>
    }

    <!-- Talisman descriptions and activation -->
    @for (
        talisman of itemRoles.asEquipment?.talismans;
        track index;
        let index = $index
    ) {
        <div class="list-item left-aligned">
            <header class="spellHeader">{{ talisman.name }}</header>

            @if (allowActivate) {
                <button
                    type="button"
                    class="newrow left-aligned"
                    (click)="onActivateTalisman(itemRoles, talisman, index)"
                >
                    <span>
                        Activate
                        @if (talisman.actions) {
                            <app-action-icons
                                [actionString]="talisman.actions"
                            />
                        }
                        {{
                            talisman.activationType
                                ? talisman.activationType
                                : ""
                        }}
                    </span>
                </button>
            }

            @if (
                allowActivate &&
                itemRoles.asEquipment &&
                hasMatchingTalismanCord(itemRoles.asEquipment, talisman)
            ) {
                <button
                    type="button"
                    class="newrow left-aligned"
                    (click)="
                        onActivateTalisman(itemRoles, talisman, index, {
                            preserve: true,
                        })
                    "
                >
                    <span>
                        Activate and preserve with talisman cord
                        @if (talisman.actions) {
                            <app-action-icons
                                [actionString]="talisman.actions"
                            />
                        }
                        {{
                            talisman.activationType
                                ? talisman.activationType
                                : ""
                        }}
                    </span>
                </button>
            }

            <app-item
                [creature]="creature"
                [item]="talisman"
                [allowActivate]="allowActivate"
                [isSubItem]="true"
            />
        </div>
    }
}
