<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
<app-character-sheet-card
    [showMinimizeButton]="shouldShowMinimizeButton"
    [minimized]="(isMinimized$ | async) ?? false"
    [tileMode]="(isTileMode$ | async) ?? false"
    (toggleMinimized)="toggleMinimized($event)"
    (toggleTileMode)="toggleTileMode($event)"
>
    <div
        class="attributeBox"
        id="{{ creature }}-skills-height"
    >
        <header class="sectionHeader box-header">Perception</header>

        @if (ownedActivities$() | async; as activityGains) {
            @for (skill of skillsOfType$("Perception") | async; track $index) {
                <app-skill
                    [creature]="creature"
                    [skill]="skill"
                    [isMinimized]="(isMinimized$ | async) ?? false"
                    [isTileMode]="(isTileMode$ | async) ?? false"
                    [relatedActivityGains]="
                        skillMatchingActivities(activityGains, skill.name)
                    "
                    [showAction]="shownAction()"
                    (showActionMessage)="receiveShowActionMessage($event)"
                />
            }

            <div class="vlist">
                <header class="subsectionHeader">Senses</header>

                @for (sense of senses$() | async; track $index) {
                    <div
                        class="list-item lower"
                        [ngbPopover]="senseDesc(sense)"
                    >
                        {{ sense }}
                    </div>
                }
            </div>

            <app-tags
                [creature]="creature"
                [objectName]="'Senses'"
                [showTraits]="true"
                [showFeats]="true"
                [showItems]="true"
                [showActivities]="true"
                [showConditions]="true"
            />

            @if (creature.isFamiliar()) {
                <header class="sectionHeader box-header">Attack Rolls</header>

                <app-tags
                    [creature]="creature"
                    [objectName]="'Attacks'"
                    [showTraits]="true"
                    [showFeats]="true"
                    [showItems]="true"
                    [showActivities]="true"
                    [showConditions]="true"
                />

                @for (
                    skill of skillsOfType$("Familiar Proficiency") | async;
                    track $index
                ) {
                    <app-skill
                        [creature]="creature"
                        [isMinimized]="(isMinimized$ | async) ?? false"
                        [isTileMode]="(isTileMode$ | async) ?? false"
                        [skill]="skill"
                    />
                }
            }

            <ng-template #SpeedEffectsPopoverContent>
                <div class="minimized-hide newrow">
                    <app-object-effects
                        [creature]="creature"
                        [objectName]="'Land Speed'"
                    />
                </div>

                <div class="minimized-hide newrow">
                    <app-object-effects
                        [creature]="creature"
                        [objectName]="'Burrow Speed'"
                    />
                </div>

                <div class="minimized-hide newrow">
                    <app-object-effects
                        [creature]="creature"
                        [objectName]="'Climb Speed'"
                    />
                </div>

                <div class="minimized-hide newrow">
                    <app-object-effects
                        [creature]="creature"
                        [objectName]="'Fly Speed'"
                    />
                </div>

                <div class="minimized-hide newrow">
                    <app-object-effects
                        [creature]="creature"
                        [objectName]="'Swim Speed'"
                    />
                </div>
            </ng-template>

            <header class="sectionHeader box-header">
                <span
                    #SpeedEffectsPopover="ngbPopover"
                    class="minimized-hide"
                    triggers="click"
                    [ngbPopover]="SpeedEffectsPopoverContent"
                >
                    <i
                        class="bi-lightning-charge"
                        [ngbTooltip]="
                            !SpeedEffectsPopover.isOpen() ? 'Edit effects' : ''
                        "
                    ></i>
                </span>
                Movement
            </header>

            @for (speedParameters of speedParameters$() | async; track $index) {
                <div class="list-item">
                    <div class="newrow">
                        <span>
                            <strong>
                                {{
                                    speedParameters.name === "Speed"
                                        ? "All Speeds"
                                        : speedParameters.name
                                }}
                            </strong>
                        </span>

                        <span>
                            <div
                                class="value"
                                [ngbPopover]="speedParameters.value.explain"
                                [ngClass]="{
                                    penalty: speedParameters.showPenalties,
                                    bonus: speedParameters.showBonuses,
                                    absolute: speedParameters.absolutes.length,
                                }"
                            >
                                {{ speedParameters.value.result }}
                            </div>
                        </span>
                    </div>

                    <app-tags
                        [creature]="creature"
                        [objectName]="speedParameters.name"
                        [showTraits]="true"
                        [showFeats]="true"
                        [showItems]="true"
                        [showActivities]="true"
                        [showConditions]="true"
                        [specialEffects]="
                            speedParameters.absolutes.concat(
                                speedParameters.relatives
                            )
                        "
                    />
                </div>
            }

            <app-tags
                [creature]="creature"
                [objectName]="'Movement'"
                [showTraits]="true"
                [showFeats]="true"
                [showItems]="true"
                [showActivities]="true"
                [showConditions]="true"
                [showEffects]="true"
            />

            <header class="sectionHeader box-header">Skills</header>

            <!-- Skill Increases -->
            @for (choice of skillChoices$() | async; track $index) {
                <app-skill-choice
                    [showTitle]="true"
                    [showContent]="true"
                    [choice]="choice"
                    [showChoice]="shownList()"
                    (showSkillChoiceMessage)="receiveShowChoiceMessage($event)"
                />
            }

            <app-tags
                [creature]="creature"
                [objectName]="'Skills'"
                [showTraits]="true"
                [showFeats]="true"
                [showItems]="true"
                [showActivities]="true"
                [showConditions]="true"
                [showEffects]="true"
            />

            <app-tags
                [creature]="creature"
                [objectName]="'Skill Checks'"
                [showTraits]="true"
                [showFeats]="true"
                [showItems]="true"
                [showActivities]="true"
                [showConditions]="true"
                [showEffects]="true"
            />

            @for (skill of skillsOfType$("Skill") | async; track $index) {
                <app-skill
                    [creature]="creature"
                    [skill]="skill"
                    [isMinimized]="(isMinimized$ | async) ?? false"
                    [isTileMode]="(isTileMode$ | async) ?? false"
                    [relatedActivityGains]="
                        skillMatchingActivities(activityGains, skill.name)
                    "
                    [showAction]="shownAction()"
                    (showActionMessage)="receiveShowActionMessage($event)"
                />
            }
        }
    </div>
</app-character-sheet-card>
