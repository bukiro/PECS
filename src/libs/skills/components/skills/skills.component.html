<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
<app-character-sheet-card
    [showMinimizeButton]="shouldShowMinimizeButton"
    [minimized]="(isMinimized$ | async) ?? false"
    [tileMode]="(isTileMode$ | async) ?? false"
    (toggleMinimized)="toggleMinimized($event)"
    (toggleTileMode)="toggleTileMode($event)"
>
    <div
        class="attributeBox"
        id="{{creature}}-skills-height"
    >
        <header class="sectionHeader box-header">Perception</header>

        <ng-container *ngIf="(ownedActivities$() | async) as activityGains">
            <ng-container *ngFor="let skill of skillsOfType$('Perception') | async; trackBy:trackByIndex;">
                <app-skill
                    [creature]="creature"
                    [skill]=skill
                    [isMinimized]="(isMinimized$ | async) ?? false"
                    [isTileMode]="(isTileMode$ | async) ?? false"
                    [relatedActivityGains]="skillMatchingActivities(activityGains, skill.name)"
                    [showAction]="shownAction()"
                    (showActionMessage)="receiveShowActionMessage($event)"
                />
            </ng-container>

            <div class="vlist">
                <header class="subsectionHeader">Senses</header>

                <div
                    *ngFor="let sense of senses$() | async; trackBy:trackByIndex;"
                    class="list-item lower"
                    [ngbPopover]="senseDesc(sense)"
                >
                    {{sense}}
                </div>
            </div>

            <app-tags
                [creature]="creature"
                [objectName]="'Senses'"
                [showTraits]="true"
                [showFeats]="true"
                [showItems]="true"
                [showActivities]="true"
                [showConditions]="true"
            />

            <ng-container *ngIf="creature.isFamiliar()">
                <header class="sectionHeader box-header">Attack Rolls</header>

                <app-tags
                    [creature]="creature"
                    [objectName]="'Attacks'"
                    [showTraits]="true"
                    [showFeats]="true"
                    [showItems]="true"
                    [showActivities]="true"
                    [showConditions]="true"
                />

                <ng-container *ngFor="let skill of skillsOfType$('Familiar Proficiency') | async; trackBy:trackByIndex;">
                    <app-skill
                        [creature]="creature"
                        [isMinimized]="(isMinimized$ | async) ?? false"
                        [isTileMode]="(isTileMode$ | async) ?? false"
                        [skill]=skill
                    />
                </ng-container>
            </ng-container>

            <ng-template #SpeedEffectsPopoverContent>
                <div class="minimized-hide newrow">
                    <app-object-effects
                        [creature]="creature"
                        [objectName]="'Land Speed'"
                    />
                </div>

                <div class="minimized-hide newrow">
                    <app-object-effects
                        [creature]="creature"
                        [objectName]="'Burrow Speed'"
                    />
                </div>

                <div class="minimized-hide newrow">
                    <app-object-effects
                        [creature]="creature"
                        [objectName]="'Climb Speed'"
                    />
                </div>

                <div class="minimized-hide newrow">
                    <app-object-effects
                        [creature]="creature"
                        [objectName]="'Fly Speed'"
                    />
                </div>

                <div class="minimized-hide newrow">
                    <app-object-effects
                        [creature]="creature"
                        [objectName]="'Swim Speed'"
                    />
                </div>
            </ng-template>

            <header class="sectionHeader box-header">
                <span
                    #SpeedEffectsPopover="ngbPopover"
                    class="minimized-hide"
                    triggers="click"
                    [ngbPopover]="SpeedEffectsPopoverContent"
                >
                    <i
                        class='bi-lightning-charge'
                        [ngbTooltip]="!SpeedEffectsPopover.isOpen() ? 'Edit effects' : ''"
                    ></i>
                </span>
                Movement
            </header>

            <div
                *ngFor="let speedParameters of (speedParameters$() | async); trackBy:trackByIndex;"
                class="list-item"
            >
                <div class="newrow">
                    <span>
                        <strong>
                            {{(speedParameters.name==="Speed") ? "All Speeds" :
                                speedParameters.name}}
                        </strong>
                    </span>

                    <span>
                        <div
                            class="value"
                            [ngbPopover]="speedParameters.value.explain"
                            [ngClass]="{'penalty':speedParameters.showPenalties,
                            'bonus':speedParameters.showBonuses,
                            'absolute':speedParameters.absolutes.length}"
                        >
                            {{speedParameters.value.result}}
                        </div>
                    </span>
                </div>

                <app-tags
                    [creature]="creature"
                    [objectName]="speedParameters.name"
                    [showTraits]="true"
                    [showFeats]="true"
                    [showItems]="true"
                    [showActivities]="true"
                    [showConditions]="true"
                    [specialEffects]="speedParameters.absolutes.concat(speedParameters.relatives)"
                />
            </div>

            <app-tags
                [creature]="creature"
                [objectName]="'Movement'"
                [showTraits]="true"
                [showFeats]="true"
                [showItems]="true"
                [showActivities]="true"
                [showConditions]="true"
                [showEffects]="true"
            />

            <header class="sectionHeader box-header">Skills</header>

            <!-- Skill Increases -->
            <ng-container *ngFor="let choice of skillChoices$() | async; trackBy:trackByIndex;">
                <app-skill-choice
                    [showTitle]="true"
                    [showContent]="true"
                    [choice]="choice"
                    [showChoice]="shownList()"
                    (showSkillChoiceMessage)="receiveShowChoiceMessage($event)"
                />
            </ng-container>

            <app-tags
                [creature]="creature"
                [objectName]="'Skills'"
                [showTraits]="true"
                [showFeats]="true"
                [showItems]="true"
                [showActivities]="true"
                [showConditions]="true"
                [showEffects]="true"
            />

            <app-tags
                [creature]="creature"
                [objectName]="'Skill Checks'"
                [showTraits]="true"
                [showFeats]="true"
                [showItems]="true"
                [showActivities]="true"
                [showConditions]="true"
                [showEffects]="true"
            />

            <ng-container *ngFor="let skill of skillsOfType$('Skill') | async; trackBy:trackByIndex;">
                <app-skill
                    [creature]="creature"
                    [skill]=skill
                    [isMinimized]="(isMinimized$ | async) ?? false"
                    [isTileMode]="(isTileMode$ | async) ?? false"
                    [relatedActivityGains]="skillMatchingActivities(activityGains, skill.name)"
                    [showAction]="shownAction()"
                    (showActionMessage)="receiveShowActionMessage($event)"
                />
            </ng-container>
        </ng-container>
    </div>

</app-character-sheet-card>
