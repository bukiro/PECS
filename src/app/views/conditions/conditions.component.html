<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
<app-fly-in-menu
    position="left"
    [show]="show"
    [showTileModeButton]="true"
    [tileMode]="(isTileMode$ | async) ?? false"
    (toggleTileMode)="toggleTileMode($event)"
>
    <div
        id="conditions"
        class="itembox vlist"
    >
        <button
            type="button"
            class="itembox-close-button list-item center-aligned"
            (click)="toggleConditionsMenu()"
        >
            <header class="sectionHeader">Back to Character Sheet</header>
        </button>

        @if (isMenuOpen$ | async) {
            @if (componentParameters$() | async; as componentParameters) {
                <div class="character-sheet-column-container">
                    <div class="character-sheet-column">
                        <header class="sectionHeader">
                            Duration: {{ durationDescription$() }}
                        </header>

                        <div class="vlist">
                            <div class="list-item">
                                <div class="newrow">
                                    <button
                                        type="button"
                                        class="center-aligned"
                                        [ngClass]="{
                                            'fancy-button': permanent,
                                        }"
                                        (click)="setSpecialDuration(-1)"
                                    >
                                        Permanent
                                    </button>

                                    <button
                                        type="button"
                                        class="center-aligned"
                                        [ngClass]="{
                                            'fancy-button': untilRest,
                                        }"
                                        (click)="setSpecialDuration(-2)"
                                    >
                                        Until your preparations
                                    </button>

                                    <button
                                        type="button"
                                        class="center-aligned"
                                        [ngClass]="{
                                            'fancy-button': untilRefocus,
                                        }"
                                        (click)="setSpecialDuration(-3)"
                                    >
                                        Until you refocus
                                    </button>
                                </div>

                                <div class="newrow">
                                    <button
                                        type="button"
                                        class="center-aligned"
                                        (click)="incDays(-1)"
                                    >
                                        -1 Day
                                    </button>

                                    <button
                                        type="button"
                                        class="center-aligned"
                                        (click)="incDays(1)"
                                    >
                                        +1 Day
                                    </button>
                                </div>

                                <div class="newrow center-aligned">
                                    <div
                                        class="slider-container"
                                        [style.--name]="'\'Hours\''"
                                    >
                                        <input
                                            aria-label="Hours slider"
                                            class="slider"
                                            type="range"
                                            min="0"
                                            max="23"
                                            [(ngModel)]="hours"
                                            (ngModelChange)="
                                                setLinearDuration()
                                            "
                                        />
                                    </div>

                                    <div
                                        class="slider-container"
                                        [style.--name]="'\'Minutes\''"
                                    >
                                        <input
                                            aria-label="Minutes slider"
                                            class="slider"
                                            type="range"
                                            min="0"
                                            max="59"
                                            [(ngModel)]="minutes"
                                            (ngModelChange)="
                                                setLinearDuration()
                                            "
                                        />
                                    </div>

                                    <div
                                        class="slider-container"
                                        [style.--name]="'\'Turns\''"
                                    >
                                        <input
                                            aria-label="Turns slider"
                                            class="slider"
                                            type="range"
                                            min="0"
                                            max="9"
                                            [(ngModel)]="turns"
                                            (ngModelChange)="
                                                setLinearDuration()
                                            "
                                        />
                                    </div>
                                </div>

                                <div class="newrow">
                                    <button
                                        type="button"
                                        class="center-aligned no-animation"
                                        [ngClass]="{
                                            'fancy-button': endOn === 5,
                                        }"
                                    >
                                        <label class="fullwidth center-aligned">
                                            <input
                                                name="endsOnRadio"
                                                id="turnStartRadio"
                                                type="radio"
                                                hidden
                                                [value]="5"
                                                [(ngModel)]="endOn"
                                            />
                                            End on turn start
                                        </label>
                                    </button>

                                    <button
                                        type="button"
                                        class="center-aligned no-animation"
                                        [ngClass]="{
                                            'fancy-button': endOn === 0,
                                        }"
                                    >
                                        <label class="fullwidth center-aligned">
                                            <input
                                                name="endsOnRadio"
                                                id="turnEndRadio"
                                                type="radio"
                                                hidden
                                                [value]="0"
                                                [(ngModel)]="endOn"
                                            />
                                            End on turn end
                                        </label>
                                    </button>
                                </div>
                            </div>

                            <div class="list-item">
                                <button
                                    type="button"
                                    [ngClass]="{
                                        'fancy-button':
                                            shownPurpose() === 'conditions',
                                    }"
                                    (click)="toggleShownPurpose('conditions')"
                                >
                                    Add Conditions
                                </button>

                                <button
                                    type="button"
                                    [ngClass]="{
                                        'fancy-button':
                                            shownPurpose() === 'customeffects',
                                    }"
                                    (click)="
                                        toggleShownPurpose('customeffects')
                                    "
                                >
                                    Custom Effects
                                </button>
                            </div>
                        </div>

                        <div class="fullsize-scroll-box vlist">
                            @if (shownPurpose() === "conditions") {
                                <header class="sectionHeader">
                                    Add Conditions
                                </header>

                                <div class="list-item">
                                    <strong
                                        >Find (in Name or Description)</strong
                                    >

                                    <span class="hlist">
                                        <input
                                            aria-label="Search text"
                                            type="text"
                                            [(ngModel)]="wordFilter"
                                            (keypress)="closeFilterIfTooShort()"
                                        />
                                        <button
                                            type="button"
                                            [disabled]="wordFilter.length < 5"
                                            (click)="setFilterForAll()"
                                        >
                                            Show All
                                        </button>

                                        <button
                                            type="button"
                                            (click)="
                                                wordFilter = '';
                                                closeFilterIfTooShort()
                                            "
                                        >
                                            Clear
                                        </button>
                                    </span>
                                </div>

                                @for (typeSet of conditionTypes; track $index) {
                                    @if (
                                        visibleConditionsOfType(typeSet);
                                        as visibleConditions
                                    ) {
                                        @if (visibleConditions.length) {
                                            <button
                                                type="button"
                                                class="list-item"
                                                [ngClass]="{
                                                    'fancy-button': [
                                                        typeSet,
                                                        'all',
                                                    ].includes(shownList()),
                                                }"
                                                (click)="
                                                    toggleShownList(
                                                        typeSet.label
                                                    )
                                                "
                                            >
                                                <header class="sectionHeader">
                                                    {{ typeSet.label }}
                                                </header>
                                            </button>
                                        }

                                        @if (
                                            visibleConditions.length &&
                                                [typeSet.label, "all"].includes(
                                                    shownList()
                                                ) && {
                                                    enabled:
                                                        isTileMode$ | async,
                                                };
                                            as tileMode
                                        ) {
                                            <div
                                                [ngClass]="{
                                                    'icon-list left-aligned':
                                                        tileMode.enabled,
                                                    'list-item':
                                                        !tileMode.enabled,
                                                }"
                                            >
                                                @if (
                                                    visibleConditions.length >=
                                                        80 &&
                                                    shownList() !== "all"
                                                ) {
                                                    <div
                                                        class="newrow list-item"
                                                        (click)="incRange(-1)"
                                                    >
                                                        <button
                                                            type="button"
                                                            class="center-aligned"
                                                            [disabled]="
                                                                range <= 0
                                                            "
                                                        >
                                                            Previous 40
                                                        </button>

                                                        <header
                                                            class="newrow subsectionHeader center-aligned"
                                                        >
                                                            {{
                                                                shownItemRangeDesc(
                                                                    visibleConditions,
                                                                    range
                                                                )
                                                            }}
                                                        </header>
                                                    </div>
                                                }

                                                @for (
                                                    condition of visibleConditions;
                                                    track conditionIndex;
                                                    let conditionIndex = $index
                                                ) {
                                                    @if (
                                                        isConditionShown(
                                                            visibleConditions,
                                                            conditionIndex,
                                                            range
                                                        )
                                                    ) {
                                                        <ng-template
                                                            #ConditionTitleTemplate
                                                        >
                                                            @if (
                                                                !tileMode.enabled
                                                            ) {
                                                                <span>
                                                                    @if (
                                                                        condition.buff
                                                                    ) {
                                                                        <i
                                                                            class="value bi-patch-plus bonus"
                                                                            [ngbTooltip]="
                                                                                'Positive condition'
                                                                            "
                                                                        ></i>
                                                                    }

                                                                    @if (
                                                                        !condition.buff
                                                                    ) {
                                                                        <i
                                                                            class="value bi-patch-minus-fill penalty"
                                                                            [ngbTooltip]="
                                                                                'Negative condition'
                                                                            "
                                                                        ></i>
                                                                    }
                                                                </span>
                                                            }
                                                            {{ condition.name }}
                                                        </ng-template>

                                                        <ng-template
                                                            #ConditionTemplate
                                                        >
                                                            @if (
                                                                tileMode.enabled
                                                            ) {
                                                                <header
                                                                    class="spellHeader"
                                                                >
                                                                    <ng-container
                                                                        *ngTemplateOutlet="
                                                                            ConditionTitleTemplate
                                                                        "
                                                                    />
                                                                </header>
                                                            }

                                                            @if (
                                                                condition.hasValue &&
                                                                !(
                                                                    !permanent &&
                                                                    condition.name ===
                                                                        "Stunned"
                                                                )
                                                            ) {
                                                                <div
                                                                    class="newrow"
                                                                >
                                                                    <span>
                                                                        Value:
                                                                        <select
                                                                            aria-label="Select condition value"
                                                                            [(ngModel)]="
                                                                                value
                                                                            "
                                                                        >
                                                                            @for (
                                                                                valueNumber of [
                                                                                    1,
                                                                                    2,
                                                                                    3,
                                                                                    4,
                                                                                    5,
                                                                                    6,
                                                                                    7,
                                                                                    8,
                                                                                    9,
                                                                                    10,
                                                                                ];
                                                                                track $index
                                                                            ) {
                                                                                <option
                                                                                    [ngValue]="
                                                                                        valueNumber
                                                                                    "
                                                                                >
                                                                                    {{
                                                                                        valueNumber
                                                                                    }}
                                                                                </option>
                                                                            }
                                                                        </select>

                                                                        <br />
                                                                    </span>
                                                                </div>
                                                            }

                                                            @if (
                                                                condition.type ===
                                                                "spells"
                                                            ) {
                                                                <div
                                                                    class="newrow"
                                                                >
                                                                    <span>
                                                                        Spell
                                                                        level:
                                                                        <select
                                                                            aria-label="Select spell level"
                                                                            [(ngModel)]="
                                                                                heightened
                                                                            "
                                                                        >
                                                                            @for (
                                                                                levelNumber of [
                                                                                    1,
                                                                                    2,
                                                                                    3,
                                                                                    4,
                                                                                    5,
                                                                                    6,
                                                                                    7,
                                                                                    8,
                                                                                    9,
                                                                                    10,
                                                                                ];
                                                                                track $index
                                                                            ) {
                                                                                <option
                                                                                    [ngValue]="
                                                                                        levelNumber
                                                                                    "
                                                                                    [disabled]="
                                                                                        levelNumber <
                                                                                        condition.minLevel
                                                                                    "
                                                                                >
                                                                                    {{
                                                                                        levelNumber >=
                                                                                            condition.minLevel ||
                                                                                        levelNumber !==
                                                                                            heightened
                                                                                            ? levelNumber
                                                                                            : condition.minLevel
                                                                                    }}
                                                                                </option>
                                                                            }
                                                                        </select>

                                                                        <br />
                                                                    </span>
                                                                </div>
                                                            }

                                                            @if (
                                                                condition.name ===
                                                                "Persistent Damage"
                                                            ) {
                                                                <div
                                                                    class="newrow"
                                                                >
                                                                    <span>
                                                                        Damage
                                                                        type and
                                                                        amount:
                                                                        <input
                                                                            aria-label="Damage type and amount"
                                                                            type="text"
                                                                            id="persistentDamage"
                                                                            maxLength="30"
                                                                            [(ngModel)]="
                                                                                condition.choice
                                                                            "
                                                                        />
                                                                    </span>
                                                                </div>
                                                            }

                                                            @if (
                                                                condition
                                                                    .choices
                                                                    .length
                                                            ) {
                                                                <div
                                                                    class="newrow"
                                                                >
                                                                    <span>
                                                                        Effect
                                                                        selection:
                                                                        <select
                                                                            aria-label="Select condition effect"
                                                                            [(ngModel)]="
                                                                                condition.choice
                                                                            "
                                                                        >
                                                                            @for (
                                                                                choice of conditionChoices(
                                                                                    condition
                                                                                );
                                                                                track $index
                                                                            ) {
                                                                                <option
                                                                                    [ngValue]="
                                                                                        choice
                                                                                    "
                                                                                >
                                                                                    {{
                                                                                        choice
                                                                                    }}
                                                                                </option>
                                                                            }
                                                                        </select>
                                                                    </span>
                                                                </div>
                                                            }

                                                            @if (
                                                                !condition.restricted
                                                            ) {
                                                                @if (
                                                                    condition.defaultDuration(
                                                                        condition.choice,
                                                                        heightened
                                                                    );
                                                                    as defaultDuration
                                                                ) {
                                                                    <div
                                                                        class="newrow"
                                                                    >
                                                                        <strong
                                                                            style="
                                                                                margin-bottom: 0;
                                                                            "
                                                                        >
                                                                            Add
                                                                            {{
                                                                                durationDescription$(
                                                                                    defaultDuration.duration,
                                                                                    true
                                                                                )
                                                                            }}
                                                                            ({{
                                                                                defaultDuration.source
                                                                            }})
                                                                        </strong>

                                                                        <div
                                                                            class="newrow"
                                                                        >
                                                                            <button
                                                                                type="button"
                                                                                (click)="
                                                                                    onAddCondition(
                                                                                        character,
                                                                                        condition,
                                                                                        defaultDuration.duration,
                                                                                        false
                                                                                    )
                                                                                "
                                                                            >
                                                                                to
                                                                                {{
                                                                                    character.name ||
                                                                                        "Character"
                                                                                }}
                                                                            </button>

                                                                            @if (
                                                                                componentParameters.isCompanionAvailable &&
                                                                                    (companion$
                                                                                        | async);
                                                                                as companion
                                                                            ) {
                                                                                <button
                                                                                    type="button"
                                                                                    (click)="
                                                                                        onAddCondition(
                                                                                            companion,
                                                                                            condition,
                                                                                            defaultDuration.duration,
                                                                                            false
                                                                                        )
                                                                                    "
                                                                                >
                                                                                    to
                                                                                    {{
                                                                                        companion.name ||
                                                                                            "Animal Companion"
                                                                                    }}
                                                                                </button>
                                                                            }

                                                                            @if (
                                                                                componentParameters.isFamiliarAvailable &&
                                                                                    (familiar$
                                                                                        | async);
                                                                                as familiar
                                                                            ) {
                                                                                <button
                                                                                    type="button"
                                                                                    (click)="
                                                                                        onAddCondition(
                                                                                            familiar,
                                                                                            condition,
                                                                                            defaultDuration.duration,
                                                                                            false
                                                                                        )
                                                                                    "
                                                                                >
                                                                                    to
                                                                                    {{
                                                                                        familiar.name ||
                                                                                            "Familiar"
                                                                                    }}
                                                                                </button>
                                                                            }
                                                                        </div>
                                                                    </div>
                                                                }

                                                                <div
                                                                    class="newrow"
                                                                >
                                                                    <strong
                                                                        style="
                                                                            margin-bottom: 0;
                                                                        "
                                                                    >
                                                                        Add
                                                                        {{
                                                                            durationDescription$(
                                                                                undefined,
                                                                                true
                                                                            )
                                                                        }}
                                                                    </strong>

                                                                    <div
                                                                        class="newrow"
                                                                    >
                                                                        <button
                                                                            type="button"
                                                                            (click)="
                                                                                onAddCondition(
                                                                                    character,
                                                                                    condition
                                                                                )
                                                                            "
                                                                        >
                                                                            to
                                                                            {{
                                                                                character.name ||
                                                                                    "Character"
                                                                            }}
                                                                        </button>

                                                                        @if (
                                                                            componentParameters.isCompanionAvailable &&
                                                                                (companion$
                                                                                    | async);
                                                                            as companion
                                                                        ) {
                                                                            <button
                                                                                type="button"
                                                                                (click)="
                                                                                    onAddCondition(
                                                                                        companion,
                                                                                        condition
                                                                                    )
                                                                                "
                                                                            >
                                                                                to
                                                                                {{
                                                                                    companion.name ||
                                                                                        "Animal Companion"
                                                                                }}
                                                                            </button>
                                                                        }

                                                                        @if (
                                                                            componentParameters.isFamiliarAvailable &&
                                                                                (familiar$
                                                                                    | async);
                                                                            as familiar
                                                                        ) {
                                                                            <button
                                                                                type="button"
                                                                                (click)="
                                                                                    onAddCondition(
                                                                                        familiar,
                                                                                        condition
                                                                                    )
                                                                                "
                                                                            >
                                                                                to
                                                                                {{
                                                                                    familiar.name ||
                                                                                        "Familiar"
                                                                                }}
                                                                            </button>
                                                                        }
                                                                    </div>
                                                                </div>
                                                            }

                                                            @if (
                                                                condition.sourceBook
                                                            ) {
                                                                <div
                                                                    class="newrow left-aligned"
                                                                >
                                                                    <strong
                                                                        >Source</strong
                                                                    >

                                                                    <i>{{
                                                                        condition.sourceBook
                                                                    }}</i>
                                                                </div>
                                                            }

                                                            @for (
                                                                desc of heightenedConditionDescription(
                                                                    condition
                                                                ).split("\n\n");
                                                                track $index
                                                            ) {
                                                                <app-description
                                                                    class="newrow"
                                                                    [text]="
                                                                        desc
                                                                    "
                                                                />
                                                            }

                                                            @if (
                                                                condition.inputRequired
                                                            ) {
                                                                <div
                                                                    class="newrow"
                                                                >
                                                                    <div
                                                                        class="list-item lower"
                                                                    >
                                                                        <strong
                                                                            >Player
                                                                            input
                                                                            required:</strong
                                                                        >

                                                                        @for (
                                                                            inputRequired of condition.inputRequired.split(
                                                                                "\n\n"
                                                                            );
                                                                            track $index
                                                                        ) {
                                                                            <div
                                                                                class="newrow left-aligned"
                                                                            >
                                                                                <app-description
                                                                                    class="newrow"
                                                                                    [text]="
                                                                                        inputRequired
                                                                                    "
                                                                                />
                                                                            </div>
                                                                        }
                                                                    </div>
                                                                </div>
                                                            }
                                                        </ng-template>

                                                        @if (
                                                            !tileMode.enabled
                                                        ) {
                                                            <div
                                                                class="list-item"
                                                            >
                                                                <button
                                                                    type="button"
                                                                    aria-label="Show condition"
                                                                    class="newrow sublist-toggle left-aligned"
                                                                    (click)="
                                                                        toggleShownItem(
                                                                            condition.name
                                                                        )
                                                                    "
                                                                >
                                                                    <ng-container
                                                                        *ngTemplateOutlet="
                                                                            ConditionTitleTemplate
                                                                        "
                                                                    />
                                                                </button>

                                                                @if (
                                                                    shownItem() ===
                                                                    condition.name
                                                                ) {
                                                                    <div
                                                                        class="list-item sublist"
                                                                    >
                                                                        <ng-container
                                                                            *ngTemplateOutlet="
                                                                                ConditionTemplate
                                                                            "
                                                                        />
                                                                    </div>
                                                                }
                                                            </div>
                                                        }

                                                        @if (tileMode.enabled) {
                                                            <button
                                                                type="button"
                                                                aria-label="Show condition"
                                                                triggers="click"
                                                                [ngbPopover]="
                                                                    ConditionTemplate
                                                                "
                                                                [ngClass]="{
                                                                    penalty:
                                                                        !condition.buff,
                                                                    bonus: condition.buff,
                                                                }"
                                                                (click)="
                                                                    toggleShownItem(
                                                                        ''
                                                                    )
                                                                "
                                                            >
                                                                <app-grid-icon
                                                                    [ngbTooltip]="
                                                                        condition.name
                                                                    "
                                                                    [title]="
                                                                        condition.name
                                                                    "
                                                                    [ngClass]="{
                                                                        penalty:
                                                                            !condition.buff,
                                                                        bonus: condition.buff,
                                                                    }"
                                                                />
                                                            </button>
                                                        }
                                                    }
                                                }

                                                @if (
                                                    visibleConditions.length >=
                                                        80 &&
                                                    shownList() !== "all"
                                                ) {
                                                    <div
                                                        class="newrow list-item"
                                                    >
                                                        <button
                                                            type="button"
                                                            class="center-aligned"
                                                            [disabled]="
                                                                (range + 1) *
                                                                    40 >=
                                                                visibleConditions.length
                                                            "
                                                            (click)="
                                                                incRange(1)
                                                            "
                                                        >
                                                            Next 40
                                                        </button>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    }
                                }
                            }

                            @if (shownPurpose() === "customeffects") {
                                <header class="sectionHeader">
                                    Custom Effects
                                </header>

                                @for (
                                    creature of allAvailableCreatures$()
                                        | async;
                                    track $index
                                ) {
                                    <button
                                        type="button"
                                        class="list-item"
                                        (click)="
                                            toggleShownList(
                                                'customEffects' + creature.type
                                            )
                                        "
                                    >
                                        <header class="sectionHeader">
                                            Custom effects on
                                            {{ creature.type }}
                                        </header>
                                    </button>

                                    @if (
                                        shownList() ===
                                        "customEffects" + creature.type
                                    ) {
                                        <div class="list-item">
                                            <button
                                                type="button"
                                                class="newrow center-aligned"
                                                (click)="
                                                    onNewCustomEffect(creature)
                                                "
                                            >
                                                Add effect
                                            </button>

                                            @for (
                                                effect of creature.effects;
                                                track index;
                                                let index = $index
                                            ) {
                                                <div class="list-item">
                                                    <ng-template
                                                        #FormulaTemplate
                                                    >
                                                        <strong>Formula</strong>
                                                        {{
                                                            effect.setValue ||
                                                                effect.value ||
                                                                ""
                                                        }}
                                                    </ng-template>

                                                    <div class="newrow">
                                                        <span class="hlist">
                                                            <strong
                                                                class="no-shadow"
                                                                >Target</strong
                                                            >

                                                            <input
                                                                aria-label="Effect target"
                                                                type="text"
                                                                maxLength="30"
                                                                id="customEffectAffected{{
                                                                    creature.type
                                                                }}{{ index }}"
                                                                [(ngModel)]="
                                                                    effect.affected
                                                                "
                                                            />
                                                        </span>
                                                    </div>

                                                    <div class="newrow">
                                                        <span class="hlist">
                                                            <strong
                                                                class="no-shadow"
                                                                >Granted
                                                                by</strong
                                                            >

                                                            <input
                                                                aria-label="Effect source"
                                                                type="text"
                                                                maxLength="30"
                                                                id="customEffectSource{{
                                                                    creature.type
                                                                }}{{ index }}"
                                                                [(ngModel)]="
                                                                    effect.source
                                                                "
                                                            />
                                                        </span>

                                                        <span class="hlist">
                                                            <strong
                                                                class="no-shadow"
                                                                >Type</strong
                                                            >

                                                            <select
                                                                aria-label="Select effect type"
                                                                [(ngModel)]="
                                                                    effect.type
                                                                "
                                                            >
                                                                @for (
                                                                    type of bonusTypes();
                                                                    track $index
                                                                ) {
                                                                    <option>
                                                                        {{
                                                                            type
                                                                        }}
                                                                    </option>
                                                                }
                                                            </select>
                                                        </span>

                                                        <span class="hlist">
                                                            <strong
                                                                class="no-shadow"
                                                                >Value</strong
                                                            >

                                                            @if (
                                                                !effect.toggle &&
                                                                (effect.setValue ||
                                                                    (effect.value &&
                                                                        isValueFormula(
                                                                            effect.value
                                                                        )))
                                                            ) {
                                                                <span>
                                                                    @if (
                                                                        effectiveEffectValue$(
                                                                            creature,
                                                                            effect
                                                                        )
                                                                            | async;
                                                                        as effectiveValue
                                                                    ) {
                                                                        <span
                                                                            class="value"
                                                                            [ngClass]="{
                                                                                absolute:
                                                                                    effect.setValue,
                                                                                bonus:
                                                                                    !effect.setValue &&
                                                                                    !effectiveValue.isPenalty,
                                                                                penalty:
                                                                                    !effect.setValue &&
                                                                                    effectiveValue.isPenalty,
                                                                            }"
                                                                        >
                                                                            {{
                                                                                effectiveValue.value
                                                                            }}
                                                                        </span>
                                                                    }

                                                                    @if (
                                                                        isValueFormula(
                                                                            effect.setValue
                                                                                ? effect.setValue
                                                                                : effect.value
                                                                        )
                                                                    ) {
                                                                        <i
                                                                            class="bi-calculator"
                                                                            [ngbPopover]="
                                                                                FormulaTemplate
                                                                            "
                                                                        ></i>
                                                                    }
                                                                </span>
                                                            }

                                                            @if (
                                                                effect.toggle
                                                            ) {
                                                                <span
                                                                    class="value absolute"
                                                                    >on</span
                                                                >
                                                            }

                                                            @if (
                                                                !effect.toggle &&
                                                                !effect.setValue &&
                                                                !isValueFormula(
                                                                    effect.value
                                                                )
                                                            ) {
                                                                <input
                                                                    aria-label="Effect value"
                                                                    type="number"
                                                                    class="number4"
                                                                    maxLength="30"
                                                                    id="customEffectValue{{
                                                                        creature.type
                                                                    }}{{
                                                                        index
                                                                    }}"
                                                                    [(ngModel)]="
                                                                        effect.value
                                                                    "
                                                                    (blur)="
                                                                        validate(
                                                                            creature,
                                                                            effect
                                                                        )
                                                                    "
                                                                />
                                                            }
                                                        </span>

                                                        <button
                                                            type="button"
                                                            style="
                                                                flex-basis: auto;
                                                                flex-grow: 0;
                                                            "
                                                            (click)="
                                                                onRemoveEffect(
                                                                    creature,
                                                                    effect
                                                                )
                                                            "
                                                        >
                                                            Remove
                                                        </button>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                }

                                @if (shownPurpose() === "customeffects") {
                                    <button
                                        type="button"
                                        class="list-item"
                                        (click)="
                                            toggleShownList('addCustomEffect')
                                        "
                                    >
                                        <header class="sectionHeader">
                                            Create advanced custom effect
                                        </header>
                                    </button>
                                }

                                @if (
                                    shownPurpose() === "customeffects" &&
                                    shownList() === "addCustomEffect"
                                ) {
                                    <div class="newrow list-item">
                                        @for (
                                            property of customEffectProperties();
                                            track index;
                                            let index = $index
                                        ) {
                                            <div class="newrow list-item">
                                                <div
                                                    class="newrow left-aligned"
                                                >
                                                    <strong
                                                        triggers="hover:click"
                                                        [ngbPopover]="
                                                            property.desc
                                                        "
                                                    >
                                                        {{ property.name }}
                                                        <i
                                                            class="bi-question-circle"
                                                        ></i>
                                                    </strong>
                                                </div>

                                                @if (property.key) {
                                                    <div class="newrow">
                                                        @if (
                                                            !property.type &&
                                                            !property.locked
                                                        ) {
                                                            <input
                                                                aria-label="Text input"
                                                                class="newrow"
                                                                type="text"
                                                                [(ngModel)]="
                                                                    objectPropertyAccessor(
                                                                        property.key
                                                                    ).value
                                                                "
                                                                (blur)="
                                                                    validateAdvancedEffect(
                                                                        property,
                                                                        index
                                                                    )
                                                                "
                                                            />
                                                        }
                                                        @if (
                                                            property.type ===
                                                            "textarea"
                                                        ) {
                                                            <textarea
                                                                aria-label="Multiline text input"
                                                                class="newrow"
                                                                rows="3"
                                                                [(ngModel)]="
                                                                    objectPropertyAccessor(
                                                                        property.key
                                                                    ).value
                                                                "
                                                            ></textarea>
                                                        }

                                                        @if (
                                                            property.type ===
                                                            "checkbox"
                                                        ) {
                                                            <input
                                                                aria-label="Checkbox"
                                                                type="checkbox"
                                                                [(ngModel)]="
                                                                    objectPropertyAccessor(
                                                                        property.key
                                                                    ).value
                                                                "
                                                            />
                                                        }
                                                        @if (
                                                            property.type ===
                                                            "number"
                                                        ) {
                                                            <input
                                                                aria-label="Number input"
                                                                type="number"
                                                                [(ngModel)]="
                                                                    objectPropertyAccessor(
                                                                        property.key
                                                                    ).value
                                                                "
                                                                (blur)="
                                                                    validateAdvancedEffect(
                                                                        property,
                                                                        index
                                                                    )
                                                                "
                                                            />
                                                        }
                                                    </div>
                                                }

                                                @if (validationError[index]) {
                                                    <div class="newrow">
                                                        <span class="problem">{{
                                                            validationError[
                                                                index
                                                            ]
                                                        }}</span>
                                                    </div>
                                                }

                                                @if (validationResult[index]) {
                                                    <div class="newrow">
                                                        <span>
                                                            Current result:
                                                            {{
                                                                validationResult[
                                                                    index
                                                                ]
                                                            }}
                                                        </span>
                                                    </div>
                                                }

                                                @if (
                                                    property.type !==
                                                        "textarea" &&
                                                    property.type !== "checkbox"
                                                ) {
                                                    <div
                                                        class="list-item"
                                                        style="
                                                            margin: initial 0;
                                                        "
                                                    >
                                                        <select
                                                            aria-label="Select example"
                                                            class="newrow left-aligned"
                                                            [disabled]="
                                                                !effectPropertyExamples(
                                                                    property
                                                                ).length
                                                            "
                                                            [(ngModel)]="
                                                                objectPropertyAccessor(
                                                                    property.key
                                                                ).value
                                                            "
                                                            (ngModelChange)="
                                                                validateAdvancedEffect(
                                                                    property,
                                                                    index
                                                                )
                                                            "
                                                        >
                                                            @for (
                                                                example of effectPropertyExamples(
                                                                    property
                                                                );
                                                                track $index
                                                            ) {
                                                                <option
                                                                    [ngValue]="
                                                                        example
                                                                    "
                                                                >
                                                                    {{
                                                                        example
                                                                    }}
                                                                </option>
                                                            }
                                                        </select>
                                                    </div>
                                                }
                                            </div>
                                        }

                                        @for (
                                            creature of allAvailableCreatures$()
                                                | async;
                                            track $index
                                        ) {
                                            <div
                                                [ngbTooltip]="isEffectInvalid()"
                                            >
                                                <button
                                                    type="button"
                                                    class="list-item newrow"
                                                    [disabled]="
                                                        isEffectInvalid()
                                                    "
                                                    (click)="
                                                        onAddEffect(creature)
                                                    "
                                                >
                                                    Add to
                                                    {{
                                                        creature.name ||
                                                            creature.type
                                                    }}
                                                </button>
                                            </div>
                                        }
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    <div class="character-sheet-column mobile-hide">
                        @if (
                            componentParameters.isCompanionAvailable ||
                            componentParameters.isFamiliarAvailable
                        ) {
                            <div class="list-item newrow">
                                <button
                                    type="button"
                                    class="center-aligned"
                                    [ngClass]="{
                                        'fancy-button':
                                            shownCreature() ===
                                            creatureTypesEnum.Character,
                                    }"
                                    (click)="
                                        toggleShownCreature(
                                            creatureTypesEnum.Character
                                        )
                                    "
                                >
                                    Character
                                </button>

                                @if (componentParameters.isCompanionAvailable) {
                                    <button
                                        type="button"
                                        class="center-aligned"
                                        [ngClass]="{
                                            'fancy-button':
                                                shownCreature() ===
                                                creatureTypesEnum.AnimalCompanion,
                                        }"
                                        (click)="
                                            toggleShownCreature(
                                                creatureTypesEnum.AnimalCompanion
                                            )
                                        "
                                    >
                                        Companion
                                    </button>
                                }

                                @if (componentParameters.isFamiliarAvailable) {
                                    <button
                                        type="button"
                                        class="center-aligned"
                                        [ngClass]="{
                                            'fancy-button':
                                                shownCreature() ===
                                                creatureTypesEnum.Familiar,
                                        }"
                                        (click)="
                                            toggleShownCreature(
                                                creatureTypesEnum.Familiar
                                            )
                                        "
                                    >
                                        Familiar
                                    </button>
                                }
                            </div>
                        }

                        @if (
                            creatureFromShownCreature$() | async;
                            as creature
                        ) {
                            <app-effects
                                class="fullwidth"
                                [creature]="creature"
                                [fullDisplay]="true"
                            />
                        }
                    </div>
                </div>
            }
        }
    </div>
</app-fly-in-menu>
