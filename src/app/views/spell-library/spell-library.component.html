<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
<div class="window-button-container">
    <app-tile-mode-button
        [ngModel]="(isTileMode$ | async) ?? false"
        (ngModelChange)="toggleTileMode($event)"
    ></app-tile-mode-button>
</div>

<div
    id="spelllibrary"
    class="itembox vlist"
>
    <button
        type="button"
        class="itembox-close-button list-item center-aligned"
        (click)="toggleSpellLibraryMenu()"
    >
        <header class="sectionHeader">Back to Character Sheet</header>
    </button>

    <ng-container *ngIf="isMenuOpen$ | async">
        <div class="character-sheet-column-container">
            <div class="character-sheet-column">
                <div class="list-item">
                    <strong>Find (in Name, Description or Traits)</strong>

                    <span class="hlist">
                        <input
                            aria-label="Search text"
                            id="SpellsWordFilter"
                            type=text
                            [(ngModel)]="wordFilter"
                            (keypress)="closeFilterIfTooShort()"
                        >
                        <button
                            type="button"
                            (click)="setFilterForAll()"
                            [disabled]="wordFilter.length < 5"
                        >
                            Show All
                        </button>

                        <button
                            type="button"
                            (click)="wordFilter=''; closeFilterIfTooShort()"
                        >
                            Clear
                        </button>
                    </span>
                </div>

                <div class="list-item">
                    <strong>Show spells from</strong>

                    <select aria-label="Select spells source" [(ngModel)]="spellSource">
                        <option
                            *ngFor="let source of ['spell library','your spellbook']; trackBy:trackByIndex;"
                            [ngValue]="source"
                        >
                            {{source}}
                        </option>
                    </select>
                </div>

                <div class="list-item">
                    <strong>Show spells on level</strong>

                    <span>
                        <select aria-label="Select spell level" [(ngModel)]="showLevel">
                            <option
                                *ngFor="let levelOption of [0,1,2,3,4,5,6,7,8,9,10]; trackBy:trackByIndex;"
                                [ngValue]="levelOption"
                            >
                                {{levelOption === 0 ? "Default" : levelOption}}
                            </option>
                        </select>
                    </span>
                </div>

                <div class="list-item">
                    <button
                        type="button"
                        (click)="toggleTraditionFilter('')"
                        [ngClass]="{'fancy-button':(shownTraditionFilter()==='')}"
                    >
                        All except Focus
                    </button>

                    <button
                        type="button"
                        *ngFor="let tradition of spellTraditions; trackBy:trackByIndex"
                        (click)="toggleTraditionFilter(tradition)"
                        [ngClass]="{'fancy-button':(shownTraditionFilter()===tradition)}"
                    >
                        {{tradition}}
                    </button>
                </div>

                <div class="fullsize-scroll-box vlist">
                    <ng-container *ngIf="componentParameters$() | async as componentParameters">
                        <div
                            class="list-item"
                            *ngIf="availableForLearningDescription$(componentParameters.wizardCasting, componentParameters.bardCasting, componentParameters.sorcererCasting) | async as availableForLearningDescription"
                        >
                            <app-description
                                class="newrow"
                                *ngFor="let desc of availableForLearningDescription.split('\n\n'); trackBy:trackByIndex;"
                                [text]="desc"
                            ></app-description>
                        </div>

                        <div
                            class="list-item"
                            *ngIf="spellMasteryAvailableDescription(componentParameters.wizardCasting) as spellMasteryAvailableDescription"
                        >
                            <app-description
                                class="newrow"
                                *ngFor="let desc of spellMasteryAvailableDescription.split('\n\n'); trackBy:trackByIndex;"
                                [text]="desc"
                            ></app-description>
                        </div>

                        <ng-container *ngFor="let level of [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10]; trackBy:trackByIndex;">
                            <ng-container *ngIf="visibleSpellsOfLevel(level) as visibleSpells">
                                <button
                                    type="button"
                                    class="list-item"
                                    (click)="toggleShownList(level)"
                                    [ngClass]="{'fancy-button':[-2,level].includes(shownList())}"
                                    *ngIf="visibleSpells.length"
                                >
                                    <header
                                        class="sectionHeader"
                                        *ngIf="level === 0"
                                    >
                                        Cantrips
                                    </header>

                                    <header
                                        class="sectionHeader"
                                        *ngIf="level > 0"
                                    >
                                        {{"Level "+level}}
                                    </header>
                                </button>

                                <div
                                    [ngClass]="{'icon-list left-aligned':tileMode.enabled, 'list-item':!tileMode.enabled}"
                                    *ngIf="visibleSpells.length && [-2,level].includes(shownList()) && { enabled: isTileMode$ | async } as tileMode"
                                >
                                    <div
                                        class="newrow list-item"
                                        *ngIf="visibleSpells.length >= 80 && shownList()!==-2"
                                        (click)="incRange(-1)"
                                    >
                                        <button
                                            type="button"
                                            class="center-aligned"
                                            [disabled]="range <= 0"
                                        >
                                            Previous 40
                                        </button>

                                        <header class="newrow subsectionHeader center-aligned">
                                            {{shownItemRangeDesc(visibleSpells, range)}}
                                        </header>
                                    </div>

                                    <ng-container *ngFor="let spell of visibleSpells; let spellIndex = index; trackBy:trackByIndex;">
                                        <ng-container *ngIf="isSpellShown(visibleSpells, spellIndex, range)">
                                            <ng-template #SpellTemplate>
                                                <header
                                                    class="spellHeader"
                                                    *ngIf="tileMode.enabled"
                                                >
                                                    {{spell.name}}
                                                    <app-action-icons
                                                        *ngIf="spell.actions"
                                                        [actionString]="spell.actions"
                                                    >
                                                    </app-action-icons>
                                                    {{spell.castType}}
                                                </header>

                                                <button
                                                    type="button"
                                                    class="newRow center-aligned"
                                                    *ngFor="let learningOption of availableSpellLearningOptions(spell, level, componentParameters.wizardCasting, componentParameters.bardCasting, componentParameters.sorcererCasting); trackBy:trackByIndex"
                                                    (click)="learnSpell(spell, learningOption.key)"
                                                    [disabled]="learningOption.disabled"
                                                >
                                                    {{learningOption.title}}
                                                </button>

                                                <button
                                                    type="button"
                                                    class="newrow center-aligned"
                                                    (click)="unlearnSpell(spell)"
                                                    [disabled]
                                                    *ngIf="isSpellLearned(spell.name) as learned"
                                                >
                                                    Unlearn {{learnedSpellSource$(learned.source) | async}}
                                                </button>

                                                <ng-container *ngIf="componentParameters.wizardCasting as wizardCasting">
                                                    <button
                                                        type="button"
                                                        class="newrow center-aligned"
                                                        (click)="addSpellToSpellMastery(spell)"
                                                        [disabled]="!isSpellMasteryAllowedForSpell(wizardCasting, level, spell)"
                                                        *ngIf="canSpellBeSelectedForSpellMastery(wizardCasting, spell)"
                                                    >
                                                        <i class='ra ra-crown'></i>
                                                        Add to Spell Mastery selection
                                                    </button>

                                                    <button
                                                        type="button"
                                                        class="newrow center-aligned"
                                                        (click)="removeSpellFromSpellMastery(wizardCasting, spell)"
                                                        *ngIf="isSpellSelectedForSpellMastery(wizardCasting, spell)"
                                                    >
                                                        <i class='ra ra-crown'></i>
                                                        Remove from Spell Mastery selection
                                                    </button>
                                                </ng-container>

                                                <div class="list-item">
                                                    <strong>Show spell on level</strong>

                                                    <span>
                                                        <select aria-label="Select spell level" [(ngModel)]="showLevel">
                                                            <option
                                                                *ngFor="let levelOption of [0,1,2,3,4,5,6,7,8,9,10]; trackBy:trackByIndex;"
                                                                [disabled]="levelOption && spell.levelreq > levelOption"
                                                                [ngValue]="levelOption"
                                                            >
                                                                {{levelOption === 0 ? "Default (" +
                                                                spell.levelreq + ")" : levelOption}}
                                                            </option>
                                                        </select>
                                                    </span>
                                                </div>

                                                <app-spell
                                                    [spell]="spell"
                                                    [spellLevel]="showLevel ? showLevel : level"
                                                >
                                                </app-spell>
                                            </ng-template>

                                            <ng-template #SpellTitleTemplate>
                                                <span *ngIf="!tileMode.enabled">
                                                    <i
                                                        class="value bi-patch-plus bonus"
                                                        *ngIf="!spell.isHostile()"
                                                        [ngbTooltip]="'Beneficial spell'"
                                                    ></i>

                                                    <i
                                                        class="value bi-patch-minus-fill penalty"
                                                        *ngIf="spell.isHostile()"
                                                        [ngbTooltip]="'Hostile spell'"
                                                    ></i>
                                                </span>

                                                <span>
                                                    {{spell.name}}
                                                    <app-action-icons
                                                        *ngIf="spell.actions"
                                                        [actionString]="spell.actions"
                                                    >
                                                    </app-action-icons>
                                                    {{spell.castType}}
                                                </span>
                                            </ng-template>

                                            <ng-container *ngIf="!tileMode.enabled">
                                                <div class="list-item">
                                                    <button
                                                        type="button"
                                                        aria-label="Show spell"
                                                        class="newrow left-aligned sublist-toggle"
                                                        (click)="toggleShownItem(spell.id)"
                                                        [ngClass]="{'fancy-button choicecleared':isSpellLearned(spell.name)}"
                                                    >
                                                        <span
                                                            [ngbTooltip]="'Spell Mastery spell'"
                                                            *ngIf="isSpellSelectedForSpellMastery(componentParameters.wizardCasting, spell)"
                                                        >
                                                            <i class='ra ra-crown'></i>
                                                        </span>

                                                        <span>
                                                            <ng-container *ngTemplateOutlet="SpellTitleTemplate"></ng-container>

                                                            <ng-container *ngFor="let trait of ['Rare', 'Uncommon']; trackBy:trackByIndex">
                                                                <app-trait
                                                                    *ngIf="spell.traits.includes(trait)"
                                                                    [name]="trait"
                                                                    [trait]="traitFromName(trait)"
                                                                >
                                                                </app-trait>
                                                            </ng-container>
                                                        </span>
                                                    </button>

                                                    <div
                                                        class="list-item sublist"
                                                        *ngIf="shownItem()===spell.id"
                                                        [ngClass]="{'fancy-list':isSpellLearned(spell.name)}"
                                                    >
                                                        <ng-container *ngTemplateOutlet="SpellTemplate"></ng-container>
                                                    </div>
                                                </div>
                                            </ng-container>

                                            <ng-container *ngIf="tileMode.enabled">
                                                <button
                                                    type="button"
                                                    aria-label="Show spell"
                                                    [ngClass]="{'fancy-button choicecleared':isSpellLearned(spell.name), 'penalty':spell.isHostile(), 'bonus':!spell.isHostile()}"
                                                    [ngbPopover]="SpellTemplate"
                                                    triggers="click"
                                                    (click)="toggleShownItem()"
                                                >
                                                    <app-grid-icon
                                                        [ngClass]="{'fancy-button':isSpellLearned(spell.name), 'penalty':spell.isHostile(), 'bonus':!spell.isHostile()}"
                                                        [ngbTooltip]="SpellTitleTemplate"
                                                        [title]="spell.name"
                                                        [detail]="spell.traits.includes('Rare') ? 'R' : (spell.traits.includes('Uncommon') ? 'U' : '')"
                                                        [superTitle]="isSpellSelectedForSpellMastery(componentParameters.wizardCasting, spell) ? 'icon-ra ra-crown' : ''"
                                                        [spell]="spell"
                                                    >
                                                    </app-grid-icon>
                                                </button>
                                            </ng-container>
                                        </ng-container>
                                    </ng-container>

                                    <div
                                        class="newrow list-item"
                                        *ngIf="visibleSpells.length >= 80 && shownList()!==-2"
                                    >
                                        <button
                                            type="button"
                                            class="center-aligned"
                                            [disabled]="(range + 1) * 40 >= visibleSpells.length"
                                            (click)="incRange(1)"
                                        >
                                            Next 40
                                        </button>
                                    </div>
                                </div>
                            </ng-container>
                        </ng-container>
                    </ng-container>
                </div>
            </div>

            <div class="character-sheet-column mobile-hide">
                <app-spellbook [ngClass]="{'minimized':isSpellbookMinimized}"></app-spellbook>
            </div>
        </div>
    </ng-container>
</div>
