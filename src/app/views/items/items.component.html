<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
<app-fly-in-menu
    position="left"
    [show]="show"
    [showTileModeButton]="true"
    [tileMode]="(isTileMode$ | async) ?? false"
    (toggleTileMode)="toggleTileMode($event)"
>
    <div
        id="items"
        class="itembox vlist"
    >
        <button
            type="button"
            class="itembox-close-button list-item center-aligned"
            (click)="toggleItemsMenu()"
        >
            <header class="sectionHeader">Back to Character Sheet</header>
        </button>

        @if (isMenuOpen$ | async) {
            <div class="character-sheet-column-container">
                <div class="character-sheet-column">
                    <div class="list-item">
                        <strong>Find (in Name, Description or Traits)</strong>

                        <span class="hlist">
                            <input
                                aria-label="Search text"
                                id="itemsWordFilter"
                                type="text"
                                [(ngModel)]="wordFilter"
                                (ngModelChange)="closeFilterIfTooShort()"
                            />
                            <button
                                type="button"
                                [disabled]="wordFilter.length < 5"
                                (click)="setFilterForAll()"
                            >
                                Show All
                            </button>

                            <button
                                type="button"
                                (click)="
                                    wordFilter = ''; closeFilterIfTooShort()
                                "
                            >
                                Clear
                            </button>
                        </span>
                    </div>

                    <div class="list-item">
                        <strong>Sort by</strong>

                        <div class="newrow">
                            <button
                                type="button"
                                class="center-aligned"
                                [ngClass]="{
                                    'fancy-button': shownSorting() === 'name',
                                }"
                                (click)="toggleShownSorting('name')"
                            >
                                Name
                            </button>

                            <button
                                type="button"
                                class="center-aligned"
                                [ngClass]="{
                                    'fancy-button':
                                        shownSorting() === 'sortLevel',
                                }"
                                (click)="toggleShownSorting('sortLevel')"
                            >
                                Level
                            </button>
                        </div>
                    </div>

                    @if (
                        otherCreaturesAvailable$() | async;
                        as otherCreaturesAvailable
                    ) {
                        <div class="list-item newrow">
                            <button
                                type="button"
                                class="center-aligned"
                                [ngClass]="{
                                    'fancy-button':
                                        shownCreature() ===
                                        creatureTypesEnum.Character,
                                }"
                                (click)="
                                    toggleShownCreature(
                                        creatureTypesEnum.Character
                                    )
                                "
                            >
                                Character
                            </button>

                            @if (otherCreaturesAvailable.companion) {
                                <button
                                    type="button"
                                    class="center-aligned"
                                    [ngClass]="{
                                        'fancy-button':
                                            shownCreature() ===
                                            creatureTypesEnum.AnimalCompanion,
                                    }"
                                    (click)="
                                        toggleShownCreature(
                                            creatureTypesEnum.AnimalCompanion
                                        )
                                    "
                                >
                                    Companion
                                </button>
                            }

                            @if (otherCreaturesAvailable.familiar) {
                                <button
                                    type="button"
                                    class="center-aligned"
                                    [ngClass]="{
                                        'fancy-button':
                                            shownCreature() ===
                                            creatureTypesEnum.Familiar,
                                    }"
                                    (click)="
                                        toggleShownCreature(
                                            creatureTypesEnum.Familiar
                                        )
                                    "
                                >
                                    Familiar
                                </button>
                            }
                        </div>
                    }

                    <div class="fullsize-scroll-box vlist">
                        @if (shownCreature() === creatureTypesEnum.Character) {
                            <header class="subsectionHeader">
                                Change Currency
                            </header>

                            <app-cash />
                        }

                        @if (shownCreature() === creatureTypesEnum.Character) {
                            <div class="list-item">
                                <button
                                    type="button"
                                    [ngClass]="{
                                        'fancy-button':
                                            selectedPurpose() === 'items',
                                    }"
                                    (click)="toggleSelectedPurpose('items')"
                                >
                                    Get Items
                                </button>

                                @if (characterHasFeat$("Scroll Savant")) {
                                    <button
                                        type="button"
                                        [ngClass]="{
                                            'fancy-button':
                                                selectedPurpose() ===
                                                'scrollsavant',
                                        }"
                                        (click)="
                                            toggleSelectedPurpose(
                                                'scrollsavant'
                                            )
                                        "
                                    >
                                        Scroll Savant
                                    </button>
                                }

                                <button
                                    type="button"
                                    [ngClass]="{
                                        'fancy-button':
                                            selectedPurpose() ===
                                            'createcustomitem',
                                    }"
                                    (click)="
                                        toggleSelectedPurpose(
                                            'createcustomitem'
                                        )
                                    "
                                >
                                    Create Custom Item
                                </button>

                                <button
                                    type="button"
                                    [ngClass]="{
                                        'fancy-button':
                                            selectedPurpose() === 'formulas',
                                    }"
                                    (click)="toggleSelectedPurpose('formulas')"
                                >
                                    Learn Formulas
                                </button>
                            </div>
                        }

                        <app-tags
                            [creature]="creature"
                            [objectName]="'ItemStore'"
                            [showTraits]="true"
                            [showFeats]="true"
                            [showItems]="true"
                            [showActivities]="true"
                            [showConditions]="true"
                            [showEffects]="true"
                        />

                        @if (items(); as items) {
                            @if (
                                availableForLearningParameters$() | async;
                                as availableForLearningParameters
                            ) {
                                @for (
                                    creatureType of shownCreature() ===
                                    creatureTypesEnum.Character
                                        ? [
                                              creatureTypesEnum.Character,
                                              creatureTypesEnum.AnimalCompanion,
                                          ]
                                        : [
                                              creatureTypesEnum.AnimalCompanion,
                                              creatureTypesEnum.Character,
                                          ];
                                    track $index
                                ) {
                                    @if (
                                        selectedPurpose() === "items" ||
                                        shownCreature() !==
                                            creatureTypesEnum.Character
                                    ) {
                                        <header class="sectionHeader">
                                            Get
                                            {{
                                                creatureType ===
                                                creatureTypesEnum.AnimalCompanion
                                                    ? "Companion"
                                                    : ""
                                            }}
                                            Items
                                        </header>
                                    }

                                    @if (
                                        selectedPurpose() === "scrollsavant" &&
                                        creatureType ===
                                            creatureTypesEnum.Character &&
                                        shownCreature() ===
                                            creatureTypesEnum.Character
                                    ) {
                                        <header class="sectionHeader">
                                            Prepare Scrolls
                                        </header>
                                    }

                                    @if (
                                        selectedPurpose() === "formulas" &&
                                        shownCreature() ===
                                            creatureTypesEnum.Character
                                    ) {
                                        <header class="sectionHeader">
                                            Learn
                                            {{
                                                creatureType ===
                                                creatureTypesEnum.AnimalCompanion
                                                    ? "Companion"
                                                    : ""
                                            }}
                                            Formulas
                                        </header>
                                    }

                                    <!-- Formulas available through feats -->
                                    @if (
                                        selectedPurpose() === "formulas" &&
                                        creatureType ===
                                            creatureTypesEnum.Character &&
                                        shownCreature() ===
                                            creatureTypesEnum.Character
                                    ) {
                                        @if (
                                            availableLearningOptions(
                                                availableForLearningParameters
                                            );
                                            as availableLearningOptions
                                        ) {
                                            @if (
                                                availableLearningOptions.length
                                            ) {
                                                <div class="list-item">
                                                    @for (
                                                        desc of availableLearningOptions.split(
                                                            "\n\n"
                                                        );
                                                        track $index
                                                    ) {
                                                        <app-description
                                                            class="newrow"
                                                            [text]="desc"
                                                        />
                                                    }
                                                </div>
                                            }
                                        }
                                    }

                                    <!-- End available formulas -->
                                    <!-- Scroll Savant -->
                                    @if (
                                        selectedPurpose() === "scrollsavant" &&
                                        creatureType ===
                                            creatureTypesEnum.Character
                                    ) {
                                        @if (
                                            scrollSavantSpellCasting$() | async;
                                            as casting
                                        ) {
                                            @if (
                                                scrollSavantDescription$()
                                                    | async;
                                                as scrollSavantDescription
                                            ) {
                                                <div class="list-item">
                                                    @for (
                                                        desc of scrollSavantDescription.split(
                                                            "\n\n"
                                                        );
                                                        track $index
                                                    ) {
                                                        <app-description
                                                            class="newrow"
                                                            [text]="desc"
                                                        />
                                                    }
                                                </div>
                                            }

                                            <button
                                                type="button"
                                                class="list-item fancy-button"
                                            >
                                                <header class="sectionHeader">
                                                    Prepared Scrolls
                                                </header>
                                            </button>

                                            @if (!casting.scrollSavant.length) {
                                                <div class="list-item">
                                                    No scrolls prepared.
                                                </div>
                                            }

                                            @if (casting.scrollSavant.length) {
                                                <div class="list-item">
                                                    @for (
                                                        scroll of scrollSavantScrolls$()
                                                            | async;
                                                        track $index
                                                    ) {
                                                        @for (
                                                            inventoryID of [
                                                                "scrollsavant" +
                                                                    scroll.id,
                                                            ];
                                                            track $index
                                                        ) {
                                                            <div
                                                                class="list-item"
                                                            >
                                                                <button
                                                                    type="button"
                                                                    class="newrow sublist-toggle fancy-button"
                                                                    (click)="
                                                                        toggleShownItem(
                                                                            inventoryID
                                                                        )
                                                                    "
                                                                >
                                                                    <span>{{
                                                                        scroll.effectiveName$()
                                                                            | async
                                                                    }}</span>

                                                                    <span
                                                                        style="
                                                                            flex-basis: auto;
                                                                            flex-grow: 0;
                                                                        "
                                                                    >
                                                                        {{
                                                                            scroll.level
                                                                                ? "Level " +
                                                                                  scroll.level
                                                                                : "&nbsp;"
                                                                        }}
                                                                    </span>
                                                                </button>

                                                                @if (
                                                                    shownItem() ===
                                                                    inventoryID
                                                                ) {
                                                                    <div
                                                                        class="list-item sublist lower fancy-list"
                                                                    >
                                                                        <button
                                                                            type="button"
                                                                            class="newrow center-aligned"
                                                                            (click)="
                                                                                unprepareScrollSavant(
                                                                                    scroll
                                                                                )
                                                                            "
                                                                        >
                                                                            Deselect
                                                                            from
                                                                            daily
                                                                            creation
                                                                        </button>

                                                                        <app-item
                                                                            class="lower"
                                                                            [item]="
                                                                                scroll
                                                                            "
                                                                            [itemStore]="
                                                                                true
                                                                            "
                                                                        />
                                                                    </div>
                                                                }
                                                            </div>
                                                        }
                                                    }
                                                </div>
                                            }
                                        }
                                    }

                                    <!-- End Scroll Savant -->
                                    @if (
                                        selectedPurpose() !==
                                            "createcustomitem" ||
                                        shownCreature() !==
                                            creatureTypesEnum.Character
                                    ) {
                                        @for (
                                            itemSet of items.names;
                                            track index;
                                            let index = $index
                                        ) {
                                            @if (
                                                creatureType +
                                                    (index * 1000 + 1000);
                                                as listID
                                            ) {
                                                @if (
                                                    visibleItems$(
                                                        items,
                                                        itemSet.key,
                                                        creatureType
                                                    ) | async;
                                                    as visibleItems
                                                ) {
                                                    <button
                                                        type="button"
                                                        class="list-item"
                                                        [ngStyle]="{
                                                            display:
                                                                !visibleItems.length
                                                                    ? 'none'
                                                                    : 'flex',
                                                        }"
                                                        (click)="
                                                            toggleShownList(
                                                                listID
                                                            )
                                                        "
                                                    >
                                                        <header
                                                            class="sectionHeader"
                                                        >
                                                            {{
                                                                selectedPurpose() ===
                                                                "scrollsavant"
                                                                    ? "Available "
                                                                    : ""
                                                            }}{{ itemSet.name }}
                                                        </header>
                                                    </button>

                                                    @if (
                                                        ([
                                                            "All",
                                                            listID,
                                                        ].includes(
                                                            shownList()
                                                        ) ||
                                                            (selectedPurpose() ===
                                                                "scrollsavant" &&
                                                                shownCreature() ===
                                                                    creatureTypesEnum.Character)) && {
                                                            enabled:
                                                                isTileMode$
                                                                | async,
                                                        };
                                                        as tileMode
                                                    ) {
                                                        <div
                                                            [ngClass]="{
                                                                'icon-list':
                                                                    tileMode.enabled,
                                                                'list-item':
                                                                    !tileMode.enabled,
                                                            }"
                                                            [ngStyle]="{
                                                                display:
                                                                    !visibleItems.length
                                                                        ? 'none'
                                                                        : 'flex',
                                                            }"
                                                        >
                                                            @if (
                                                                visibleItems.length >=
                                                                    80 &&
                                                                shownList() !==
                                                                    "All"
                                                            ) {
                                                                <div
                                                                    class="newrow list-item"
                                                                    (click)="
                                                                        incRange(
                                                                            -1
                                                                        )
                                                                    "
                                                                >
                                                                    <button
                                                                        type="button"
                                                                        class="center-aligned"
                                                                        [disabled]="
                                                                            range <=
                                                                            0
                                                                        "
                                                                    >
                                                                        Previous
                                                                        40
                                                                    </button>

                                                                    <header
                                                                        class="newrow subsectionHeader center-aligned"
                                                                    >
                                                                        {{
                                                                            shownItemRangeDesc(
                                                                                visibleItems,
                                                                                range
                                                                            )
                                                                        }}
                                                                    </header>
                                                                </div>
                                                            }

                                                            @for (
                                                                itemParameters of visibleItemParameters$(
                                                                    visibleItems
                                                                ) | async;
                                                                track itemIndex;
                                                                let itemIndex = $index
                                                            ) {
                                                                @if (
                                                                    isItemShown(
                                                                        visibleItems,
                                                                        itemIndex,
                                                                        range
                                                                    )
                                                                ) {
                                                                    <ng-template
                                                                        #ItemTitleTemplate
                                                                    >
                                                                        <span>
                                                                            @if (
                                                                                !tileMode.enabled &&
                                                                                itemParameters.canUse ===
                                                                                    false
                                                                            ) {
                                                                                <i
                                                                                    class="value bi-x penalty"
                                                                                    [ngbTooltip]="
                                                                                        'You are not trained with this item.'
                                                                                    "
                                                                                ></i>
                                                                            }

                                                                            @if (
                                                                                !tileMode.enabled &&
                                                                                itemParameters.canUse ===
                                                                                    true
                                                                            ) {
                                                                                <i
                                                                                    class="value bi-check2 bonus"
                                                                                    [ngbTooltip]="
                                                                                        'You are trained with this item.'
                                                                                    "
                                                                                ></i>
                                                                            }
                                                                            {{
                                                                                itemParameters.item.effectiveName$()
                                                                                    | async
                                                                            }}
                                                                        </span>

                                                                        <span
                                                                            style="
                                                                                flex-basis: auto;
                                                                                flex-grow: 0;
                                                                            "
                                                                        >
                                                                            @if (
                                                                                itemParameters
                                                                                    .item
                                                                                    .level
                                                                            ) {
                                                                                <span
                                                                                    >{{
                                                                                        "Level " +
                                                                                            itemParameters
                                                                                                .item
                                                                                                .level
                                                                                    }}</span
                                                                                >
                                                                            }

                                                                            @if (
                                                                                itemParameters.asArmor
                                                                            ) {
                                                                                <span>
                                                                                    {{
                                                                                        itemParameters.asArmor.title$(
                                                                                            {
                                                                                                itemStore: true,
                                                                                            }
                                                                                        )
                                                                                            | async
                                                                                    }}
                                                                                </span>
                                                                            }

                                                                            @if (
                                                                                itemParameters.asWeapon
                                                                            ) {
                                                                                <span
                                                                                    >{{
                                                                                        itemParameters.asWeapon.title()
                                                                                    }}</span
                                                                                >
                                                                            }
                                                                        </span>
                                                                    </ng-template>

                                                                    <ng-template
                                                                        #ItemTooltipTemplate
                                                                    >
                                                                        <span>
                                                                            {{
                                                                                itemParameters.item.effectiveName$(
                                                                                    {
                                                                                        itemStore: true,
                                                                                    }
                                                                                )
                                                                                    | async
                                                                            }}
                                                                        </span>

                                                                        @if (
                                                                            itemParameters
                                                                                .item
                                                                                .level
                                                                        ) {
                                                                            <span
                                                                                >|</span
                                                                            >
                                                                        }

                                                                        @if (
                                                                            itemParameters
                                                                                .item
                                                                                .level
                                                                        ) {
                                                                            <span
                                                                                >{{
                                                                                    "Level " +
                                                                                        itemParameters
                                                                                            .item
                                                                                            .level
                                                                                }}</span
                                                                            >
                                                                        }

                                                                        @if (
                                                                            itemParameters.asArmor ||
                                                                            itemParameters.asWeapon
                                                                        ) {
                                                                            <span
                                                                                >|</span
                                                                            >
                                                                        }

                                                                        @if (
                                                                            itemParameters.asArmor
                                                                        ) {
                                                                            <span>
                                                                                {{
                                                                                    itemParameters.asArmor.title$(
                                                                                        {
                                                                                            itemStore: true,
                                                                                        }
                                                                                    )
                                                                                        | async
                                                                                }}
                                                                            </span>
                                                                        }

                                                                        @if (
                                                                            itemParameters.asWeapon
                                                                        ) {
                                                                            <span
                                                                                >{{
                                                                                    itemParameters.asWeapon.title()
                                                                                }}</span
                                                                            >
                                                                        }
                                                                    </ng-template>

                                                                    <ng-template
                                                                        #ItemTemplate
                                                                    >
                                                                        @if (
                                                                            tileMode.enabled
                                                                        ) {
                                                                            <header
                                                                                class="spellHeader newrow"
                                                                            >
                                                                                <ng-container
                                                                                    *ngTemplateOutlet="
                                                                                        ItemTitleTemplate
                                                                                    "
                                                                                />
                                                                            </header>
                                                                        }

                                                                        @if (
                                                                            selectedPurpose() ===
                                                                                "items" ||
                                                                            shownCreature() !==
                                                                                creatureTypesEnum.Character
                                                                        ) {
                                                                            @if (
                                                                                itemSet.name ===
                                                                                "Snares"
                                                                            ) {
                                                                                <div
                                                                                    class="list-item"
                                                                                >
                                                                                    Snares
                                                                                    cannot
                                                                                    be
                                                                                    bought
                                                                                    or
                                                                                    sold.
                                                                                    They
                                                                                    must
                                                                                    be
                                                                                    crafted
                                                                                    and
                                                                                    are
                                                                                    immediately
                                                                                    deployed
                                                                                    upon
                                                                                    creation.
                                                                                </div>
                                                                            }

                                                                            <button
                                                                                type="button"
                                                                                class="newrow center-aligned"
                                                                                (click)="
                                                                                    grantItem(
                                                                                        itemParameters.item
                                                                                    )
                                                                                "
                                                                            >
                                                                                Gift
                                                                                {{
                                                                                    itemParameters.stack &&
                                                                                    itemParameters.stack >
                                                                                        1
                                                                                        ? itemParameters.stack
                                                                                        : ""
                                                                                }}
                                                                                to
                                                                                {{
                                                                                    creature
                                                                                }}
                                                                            </button>

                                                                            @if (
                                                                                itemSet.name !==
                                                                                    "Snares" &&
                                                                                    effectivePrice(
                                                                                        itemParameters.item
                                                                                    );
                                                                                as effectivePrice
                                                                            ) {
                                                                                <button
                                                                                    class="newrow center-aligned"
                                                                                    [disabled]="
                                                                                        !itemParameters
                                                                                            .item
                                                                                            .tradeable ||
                                                                                        !characterHasFunds(
                                                                                            effectivePrice
                                                                                        )
                                                                                    "
                                                                                    (click)="
                                                                                        grantItem(
                                                                                            itemParameters.item,
                                                                                            true
                                                                                        )
                                                                                    "
                                                                                >
                                                                                    Buy
                                                                                    {{
                                                                                        itemParameters.stack &&
                                                                                        itemParameters.stack >
                                                                                            1
                                                                                            ? itemParameters.stack
                                                                                            : ""
                                                                                    }}
                                                                                    for
                                                                                    {{
                                                                                        creature
                                                                                    }}
                                                                                </button>
                                                                            }

                                                                            @if (
                                                                                itemParameters.asMaterialChangeable
                                                                            ) {
                                                                                <app-item-material
                                                                                    [item]="
                                                                                        itemParameters.asMaterialChangeable
                                                                                    "
                                                                                    [craftingStation]="
                                                                                        false
                                                                                    "
                                                                                    [itemRoles]="
                                                                                        itemParameters
                                                                                    "
                                                                                />
                                                                            }

                                                                            @if (
                                                                                itemParameters.asRuneChangeable
                                                                            ) {
                                                                                <app-item-runes
                                                                                    [item]="
                                                                                        itemParameters.asRuneChangeable
                                                                                    "
                                                                                    [itemStore]="
                                                                                        true
                                                                                    "
                                                                                    [itemRoles]="
                                                                                        itemParameters
                                                                                    "
                                                                                />
                                                                            }

                                                                            @if (
                                                                                itemParameters.asTalismanChangeable
                                                                            ) {
                                                                                <app-item-talismans
                                                                                    [item]="
                                                                                        itemParameters.asTalismanChangeable
                                                                                    "
                                                                                    [itemStore]="
                                                                                        true
                                                                                    "
                                                                                />
                                                                            }
                                                                        }

                                                                        @if (
                                                                            itemParameters.asScroll &&
                                                                                selectedPurpose() ===
                                                                                    "scrollsavant" &&
                                                                                shownCreature() ===
                                                                                    creatureTypesEnum.Character &&
                                                                                (scrollSavantSpellDCLevel$()
                                                                                    | async);
                                                                            as available
                                                                        ) {
                                                                            @if (
                                                                                scrollSavantSpellCasting$()
                                                                                    | async;
                                                                                as scrollSavantCasting
                                                                            ) {
                                                                                <button
                                                                                    type="button"
                                                                                    class="newrow center-aligned"
                                                                                    [disabled]="
                                                                                        (scrollSavantCasting
                                                                                            ?.scrollSavant
                                                                                            ?.length ||
                                                                                            0) >=
                                                                                        available /
                                                                                            2
                                                                                    "
                                                                                    (click)="
                                                                                        prepareScrollSavantScroll(
                                                                                            itemParameters.asScroll
                                                                                        )
                                                                                    "
                                                                                >
                                                                                    Select
                                                                                    scroll
                                                                                    for
                                                                                    daily
                                                                                    creation
                                                                                </button>
                                                                            }
                                                                        }

                                                                        @if (
                                                                            selectedPurpose() ===
                                                                                "formulas" &&
                                                                            shownCreature() ===
                                                                                creatureTypesEnum.Character
                                                                        ) {
                                                                            @if (
                                                                                !learnedFormulas(
                                                                                    itemParameters
                                                                                        .item
                                                                                        .id
                                                                                )
                                                                                    .length &&
                                                                                availableForLearningParameters.alchemicalCraftingAvailable &&
                                                                                itemParameters.item.traits.includes(
                                                                                    "Alchemical"
                                                                                )
                                                                            ) {
                                                                                <button
                                                                                    type="button"
                                                                                    class="newrow center-aligned"
                                                                                    [disabled]="
                                                                                        !canLearnFormula(
                                                                                            itemParameters.item,
                                                                                            'alchemicalcrafting',
                                                                                            availableForLearningParameters
                                                                                        )
                                                                                    "
                                                                                    (click)="
                                                                                        learnFormula(
                                                                                            itemParameters.item,
                                                                                            'alchemicalcrafting'
                                                                                        )
                                                                                    "
                                                                                >
                                                                                    Learn
                                                                                    formula
                                                                                    via
                                                                                    Alchemical
                                                                                    Crafting
                                                                                </button>
                                                                            }

                                                                            @if (
                                                                                !learnedFormulas(
                                                                                    itemParameters
                                                                                        .item
                                                                                        .id
                                                                                )
                                                                                    .length &&
                                                                                availableForLearningParameters.magicalCraftingAvailable &&
                                                                                itemParameters.item.traits.includes(
                                                                                    "Magical"
                                                                                )
                                                                            ) {
                                                                                <button
                                                                                    type="button"
                                                                                    class="newrow center-aligned"
                                                                                    [disabled]="
                                                                                        !canLearnFormula(
                                                                                            itemParameters.item,
                                                                                            'magicalcrafting',
                                                                                            availableForLearningParameters
                                                                                        )
                                                                                    "
                                                                                    (click)="
                                                                                        learnFormula(
                                                                                            itemParameters.item,
                                                                                            'magicalcrafting'
                                                                                        )
                                                                                    "
                                                                                >
                                                                                    Learn
                                                                                    formula
                                                                                    via
                                                                                    Magical
                                                                                    Crafting
                                                                                </button>
                                                                            }

                                                                            @if (
                                                                                !learnedFormulas(
                                                                                    itemParameters
                                                                                        .item
                                                                                        .id
                                                                                )
                                                                                    .length &&
                                                                                availableForLearningParameters.snareCraftingAvailable &&
                                                                                itemParameters.item.traits.includes(
                                                                                    "Snare"
                                                                                )
                                                                            ) {
                                                                                <button
                                                                                    type="button"
                                                                                    class="newrow center-aligned"
                                                                                    [disabled]="
                                                                                        !canLearnFormula(
                                                                                            itemParameters.item,
                                                                                            'snarecrafting',
                                                                                            availableForLearningParameters
                                                                                        )
                                                                                    "
                                                                                    (click)="
                                                                                        learnFormula(
                                                                                            itemParameters.item,
                                                                                            'snarecrafting'
                                                                                        )
                                                                                    "
                                                                                >
                                                                                    Learn
                                                                                    formula
                                                                                    via
                                                                                    Snare
                                                                                    Crafting
                                                                                </button>
                                                                            }

                                                                            @if (
                                                                                !learnedFormulas(
                                                                                    itemParameters
                                                                                        .item
                                                                                        .id
                                                                                )
                                                                                    .length &&
                                                                                availableForLearningParameters.snareSpecialistAvailable &&
                                                                                itemParameters.item.traits.includes(
                                                                                    "Snare"
                                                                                )
                                                                            ) {
                                                                                <button
                                                                                    type="button"
                                                                                    class="newrow center-aligned"
                                                                                    [disabled]="
                                                                                        !canLearnFormula(
                                                                                            itemParameters.item,
                                                                                            'snarespecialist',
                                                                                            availableForLearningParameters
                                                                                        )
                                                                                    "
                                                                                    (click)="
                                                                                        learnFormula(
                                                                                            itemParameters.item,
                                                                                            'snarespecialist'
                                                                                        )
                                                                                    "
                                                                                >
                                                                                    Learn
                                                                                    formula
                                                                                    via
                                                                                    Snare
                                                                                    Specialist
                                                                                </button>
                                                                            }

                                                                            @if (
                                                                                !learnedFormulas(
                                                                                    itemParameters
                                                                                        .item
                                                                                        .id
                                                                                )
                                                                                    .length
                                                                            ) {
                                                                                <button
                                                                                    type="button"
                                                                                    class="newrow center-aligned"
                                                                                    [ngbTooltip]="
                                                                                        'You must manually expend the necessary cost to learn the formula this way.'
                                                                                    "
                                                                                    (click)="
                                                                                        learnFormula(
                                                                                            itemParameters.item,
                                                                                            'other'
                                                                                        )
                                                                                    "
                                                                                >
                                                                                    Learn
                                                                                    formula
                                                                                    (buy,
                                                                                    copy,
                                                                                    invent
                                                                                    or
                                                                                    reverse
                                                                                    engineer)
                                                                                </button>
                                                                            }

                                                                            @for (
                                                                                learned of learnedFormulas(
                                                                                    itemParameters
                                                                                        .item
                                                                                        .id
                                                                                );
                                                                                track $index
                                                                            ) {
                                                                                <button
                                                                                    type="button"
                                                                                    class="newrow center-aligned"
                                                                                    (click)="
                                                                                        unlearnFormula(
                                                                                            itemParameters.item
                                                                                        )
                                                                                    "
                                                                                >
                                                                                    Unlearn
                                                                                    formula
                                                                                    {{
                                                                                        learnedFormulaSource(
                                                                                            learned.source
                                                                                        )
                                                                                    }}
                                                                                </button>
                                                                            }
                                                                        }

                                                                        <app-item
                                                                            class="lower"
                                                                            [item]="
                                                                                itemParameters.item
                                                                            "
                                                                            [itemStore]="
                                                                                true
                                                                            "
                                                                        />
                                                                    </ng-template>

                                                                    @for (
                                                                        inventoryID of [
                                                                            listID +
                                                                                itemParameters
                                                                                    .item
                                                                                    .id,
                                                                        ];
                                                                        track $index
                                                                    ) {
                                                                        @if (
                                                                            !tileMode.enabled
                                                                        ) {
                                                                            <div
                                                                                class="list-item"
                                                                            >
                                                                                <button
                                                                                    type="button"
                                                                                    aria-label="Show item"
                                                                                    class="newrow sublist-toggle"
                                                                                    [ngClass]="{
                                                                                        'fancy-button':
                                                                                            selectedPurpose() ===
                                                                                                'formulas' &&
                                                                                            shownCreature() ===
                                                                                                creatureTypesEnum.Character &&
                                                                                            learnedFormulas(
                                                                                                itemParameters
                                                                                                    .item
                                                                                                    .id
                                                                                            )
                                                                                                .length,
                                                                                    }"
                                                                                    (click)="
                                                                                        toggleShownItem(
                                                                                            inventoryID
                                                                                        )
                                                                                    "
                                                                                >
                                                                                    <ng-container
                                                                                        *ngTemplateOutlet="
                                                                                            ItemTitleTemplate
                                                                                        "
                                                                                    />
                                                                                </button>

                                                                                @if (
                                                                                    shownItem() ===
                                                                                    inventoryID
                                                                                ) {
                                                                                    <div
                                                                                        class="list-item sublist lower"
                                                                                        [ngClass]="{
                                                                                            'fancy-list':
                                                                                                selectedPurpose() ===
                                                                                                    'formulas' &&
                                                                                                shownCreature() ===
                                                                                                    creatureTypesEnum.Character &&
                                                                                                learnedFormulas(
                                                                                                    itemParameters
                                                                                                        .item
                                                                                                        .id
                                                                                                )
                                                                                                    .length,
                                                                                        }"
                                                                                    >
                                                                                        <ng-container
                                                                                            *ngTemplateOutlet="
                                                                                                ItemTemplate
                                                                                            "
                                                                                        />
                                                                                    </div>
                                                                                }
                                                                            </div>
                                                                        }

                                                                        @if (
                                                                            tileMode.enabled
                                                                        ) {
                                                                            <button
                                                                                type="button"
                                                                                aria-label="show Item"
                                                                                triggers="click"
                                                                                [ngbPopover]="
                                                                                    ItemTemplate
                                                                                "
                                                                                [ngClass]="{
                                                                                    'fancy-button':
                                                                                        selectedPurpose() ===
                                                                                            'formulas' &&
                                                                                        shownCreature() ===
                                                                                            creatureTypesEnum.Character &&
                                                                                        learnedFormulas(
                                                                                            itemParameters
                                                                                                .item
                                                                                                .id
                                                                                        )
                                                                                            .length,
                                                                                    penalty:
                                                                                        itemParameters.canUse ===
                                                                                        false,
                                                                                    bonus: itemParameters.canUse,
                                                                                }"
                                                                                (click)="
                                                                                    toggleShownItem()
                                                                                "
                                                                            >
                                                                                <app-grid-icon
                                                                                    [ngClass]="{
                                                                                        'fancy-button':
                                                                                            selectedPurpose() ===
                                                                                                'formulas' &&
                                                                                            shownCreature() ===
                                                                                                creatureTypesEnum.Character &&
                                                                                            learnedFormulas(
                                                                                                itemParameters
                                                                                                    .item
                                                                                                    .id
                                                                                            )
                                                                                                .length,
                                                                                        penalty:
                                                                                            itemParameters.canUse ===
                                                                                            false,
                                                                                        bonus: itemParameters.canUse,
                                                                                    }"
                                                                                    [ngbTooltip]="
                                                                                        ItemTooltipTemplate
                                                                                    "
                                                                                    [title]="
                                                                                        itemParameters.item.gridIconTitle()
                                                                                    "
                                                                                    [superTitle]="
                                                                                        itemParameters.stack &&
                                                                                        itemParameters.stack >
                                                                                            1
                                                                                            ? itemParameters.stack.toString()
                                                                                            : ''
                                                                                    "
                                                                                    [detail]="
                                                                                        'noparse|' +
                                                                                        (itemParameters.item.traits.includes(
                                                                                            'Rare'
                                                                                        )
                                                                                            ? 'R'
                                                                                            : itemParameters.item.traits.includes(
                                                                                                    'Uncommon'
                                                                                                )
                                                                                              ? 'U'
                                                                                              : itemParameters.item.traits.includes(
                                                                                                      'Unique'
                                                                                                  )
                                                                                                ? 'Q'
                                                                                                : '') +
                                                                                        (itemParameters
                                                                                            .item
                                                                                            .level
                                                                                            ? itemParameters.item.level.toString()
                                                                                            : '')
                                                                                    "
                                                                                    [item]="
                                                                                        itemParameters.item
                                                                                    "
                                                                                    [itemStore]="
                                                                                        true
                                                                                    "
                                                                                />
                                                                            </button>
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            @if (
                                                                visibleItems.length >=
                                                                    80 &&
                                                                shownList() !==
                                                                    "All"
                                                            ) {
                                                                <div
                                                                    class="newrow list-item"
                                                                >
                                                                    <button
                                                                        type="button"
                                                                        class="center-aligned"
                                                                        [disabled]="
                                                                            (range +
                                                                                1) *
                                                                                40 >=
                                                                            visibleItems.length
                                                                        "
                                                                        (click)="
                                                                            incRange(
                                                                                1
                                                                            )
                                                                        "
                                                                    >
                                                                        Next 40
                                                                    </button>
                                                                </div>
                                                            }
                                                        </div>
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }

                            @if (
                                selectedPurpose() === "createcustomitem" &&
                                shownCreature() === creatureTypesEnum.Character
                            ) {
                                <header class="sectionHeader">
                                    Create custom item
                                </header>

                                <div class="list-item">
                                    <span>
                                        <strong>Type</strong>
                                    </span>

                                    <span>
                                        <select
                                            aria-label="Select custom item type"
                                            [(ngModel)]="newItemType"
                                            (ngModelChange)="
                                                initializeNewItem()
                                            "
                                        >
                                            @for (
                                                name of newItemTypeOptionsFilter();
                                                track $index
                                            ) {
                                                <option [ngValue]="name.key">
                                                    {{ name.name }}
                                                </option>
                                            }
                                        </select>
                                    </span>
                                </div>

                                @if (newItem) {
                                    @if ("newItem"; as inventoryID) {
                                        <div class="list-item">
                                            <button
                                                type="button"
                                                class="newrow sublist-toggle center-aligned"
                                                (click)="
                                                    toggleShownItem(inventoryID)
                                                "
                                            >
                                                Copy existing item
                                            </button>

                                            @if (shownItem() === inventoryID) {
                                                <div
                                                    class="list-item sublist lower"
                                                >
                                                    <header
                                                        class="subsectionHeader"
                                                    >
                                                        New Items
                                                    </header>

                                                    @for (
                                                        item of itemsToCopy(
                                                            newItemType
                                                        );
                                                        track $index
                                                    ) {
                                                        <div class="list-item">
                                                            <button
                                                                type="button"
                                                                class="newrow center-aligned"
                                                                (click)="
                                                                    copyItemForCustomItem(
                                                                        item
                                                                    )
                                                                "
                                                            >
                                                                {{
                                                                    item.effectiveName$()
                                                                        | async
                                                                }}
                                                            </button>
                                                        </div>
                                                    }

                                                    <header
                                                        class="subsectionHeader"
                                                    >
                                                        Inventory Items
                                                    </header>

                                                    @for (
                                                        item of inventoryItems(
                                                            newItemType
                                                        );
                                                        track $index
                                                    ) {
                                                        <div class="list-item">
                                                            <button
                                                                type="button"
                                                                class="newrow center-aligned"
                                                                (click)="
                                                                    copyItemForCustomItem(
                                                                        item
                                                                    )
                                                                "
                                                            >
                                                                {{
                                                                    item.effectiveName$()
                                                                        | async
                                                                }}
                                                            </button>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }

                                    @for (
                                        property of newItemProperties();
                                        track $index
                                    ) {
                                        @if (
                                            !(
                                                property.key === "equippable" &&
                                                !newItem["allowEquippable"]
                                            )
                                        ) {
                                            <app-new-item-property
                                                [propertyData]="property"
                                                [propertyKey]="property.key"
                                                [newItem]="newItem"
                                            />
                                        }
                                    }

                                    @if (
                                        itemAsMaterialChangeable(newItem);
                                        as itemAsMaterialChangeable
                                    ) {
                                        <div class="list-item newrow">
                                            <strong>Material</strong>

                                            <app-item-material
                                                class="newrow"
                                                [item]="
                                                    itemAsMaterialChangeable
                                                "
                                                [craftingStation]="false"
                                                [customItemStore]="true"
                                            />
                                        </div>
                                    }

                                    @if (
                                        itemAsRuneChangeable(newItem);
                                        as itemAsRuneChangeable
                                    ) {
                                        <div class="list-item newrow">
                                            >
                                            <strong>Runes</strong>

                                            <app-item-runes
                                                class="newrow"
                                                [item]="itemAsRuneChangeable"
                                                [itemStore]="true"
                                                [customItemStore]="true"
                                            />
                                        </div>
                                    }

                                    <div class="list-item newrow">
                                        <button
                                            type="button"
                                            class="newrow center-aligned"
                                            (click)="grantCustomItem()"
                                        >
                                            Get this item
                                        </button>
                                    </div>
                                }
                            }
                        }
                    </div>
                </div>

                <div class="character-sheet-column mobile-hide">
                    @if (
                        otherCreaturesAvailable$() | async;
                        as otherCreaturesAvailable
                    ) {
                        <div class="list-item newrow">
                            <button
                                type="button"
                                class="center-aligned"
                                [ngClass]="{
                                    'fancy-button':
                                        shownCreature() ===
                                        creatureTypesEnum.Character,
                                }"
                                (click)="
                                    toggleShownCreature(
                                        creatureTypesEnum.Character
                                    )
                                "
                            >
                                Character
                            </button>

                            @if (otherCreaturesAvailable.companion) {
                                <button
                                    type="button"
                                    class="center-aligned"
                                    [ngClass]="{
                                        'fancy-button':
                                            shownCreature() ===
                                            creatureTypesEnum.AnimalCompanion,
                                    }"
                                    (click)="
                                        toggleShownCreature(
                                            creatureTypesEnum.AnimalCompanion
                                        )
                                    "
                                >
                                    Companion
                                </button>
                            }

                            @if (otherCreaturesAvailable.familiar) {
                                <button
                                    type="button"
                                    class="center-aligned"
                                    [ngClass]="{
                                        'fancy-button':
                                            shownCreature() ===
                                            creatureTypesEnum.Familiar,
                                    }"
                                    (click)="
                                        toggleShownCreature(
                                            creatureTypesEnum.Familiar
                                        )
                                    "
                                >
                                    Familiar
                                </button>
                            }
                        </div>
                    }

                    <app-inventory
                        id="ItemStore-inventory"
                        style="position: relative"
                        [itemStore]="true"
                        [creature]="creature"
                    />
                </div>
            </div>
        }
    </div>
</app-fly-in-menu>
