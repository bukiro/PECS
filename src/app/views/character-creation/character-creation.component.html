<!-- eslint-disable @angular-eslint/template/conditional-complexity -->
<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
<app-fly-in-menu
    position="left"
    [show]="show"
    [showMinimizeButton]="true"
    [showTileModeButton]="true"
    [minimized]="(isMinimized$ | async) ?? false"
    [tileMode]="(isTileMode$ | async) ?? false"
    (toggleMinimized)="toggleMinimized($event)"
    (toggleTileMode)="toggleTileMode($event)"
>
    @if ({ enabled: isTileMode$ | async }; as tileMode) {
        <div
            id="character-height"
            class="itembox vlist"
        >
            @if (!((isMobile$ | async) && shownList())) {
                <div
                    class="itembox-close-button"
                    [ngbTooltip]="
                        (isBlankCharacter$ | async)
                            ? 'Create your character first!'
                            : ''
                    "
                >
                    <button
                        type="button"
                        class="list-item center-aligned"
                        [disabled]="isBlankCharacter$ | async"
                        (click)="toggleCharacterMenu()"
                    >
                        <header class="sectionHeader">
                            {{ closeButtonTitle$ | async }}
                        </header>
                    </button>
                </div>
            } @else {
                <div class="itembox-close-button">
                    <button
                        type="button"
                        class="list-item center-aligned"
                        (click)="toggleShownList()"
                    >
                        <header class="sectionHeader">Close</header>
                    </button>
                </div>
            }

            <div class="character-sheet-column-container">
                <div class="character-sheet-column">
                    <!-- Management list mode -->
                    @if (!tileMode.enabled) {
                        @if ((isGmMode$ | async) === false) {
                            <div class="list-item">
                                <button
                                    type="button"
                                    class="newrow"
                                    [disabled]="isBlankCharacter$ | async"
                                    (click)="saveCharacterToDB()"
                                >
                                    Save Character
                                </button>
                            </div>
                        }

                        <div class="list-item">
                            <button
                                type="button"
                                class="newrow"
                                [ngClass]="{
                                    activechoice: shownList() === 'settings',
                                }"
                                (click)="toggleShownList('settings')"
                            >
                                Settings
                            </button>
                        </div>

                        <div class="list-item">
                            <button
                                type="button"
                                class="newrow"
                                [ngClass]="{
                                    activechoice: shownList() === 'licenses',
                                }"
                                (click)="toggleShownList('licenses')"
                            >
                                Licenses
                            </button>
                        </div>

                        <div class="list-item">
                            <button
                                type="button"
                                class="newrow"
                                [ngClass]="{
                                    activechoice: shownList() === 'about',
                                }"
                                (click)="toggleShownList('about')"
                            >
                                About
                            </button>
                        </div>
                    }

                    <!-- Management tile mode -->
                    @if (tileMode.enabled) {
                        <div class="newrow list-item">
                            <div class="icon-list">
                                @if ((isGmMode$ | async) === false) {
                                    <button
                                        type="button"
                                        aria-label="Save character"
                                        [disabled]="isBlankCharacter$ | async"
                                        (click)="saveCharacterToDB()"
                                    >
                                        <app-grid-icon
                                            [ngbTooltip]="
                                                (isBlankCharacter$ | async)
                                                    ? 'No changes to character yet.'
                                                    : 'Save Character'
                                            "
                                            [subTitle]="'Save'"
                                            [superTitle]="
                                                'icon-bi-file-earmark-arrow-up'
                                            "
                                        />
                                    </button>
                                }

                                <button
                                    type="button"
                                    aria-label="Settings"
                                    [ngClass]="{
                                        activechoice:
                                            shownList() === 'settings',
                                    }"
                                    (click)="toggleShownList('settings')"
                                >
                                    <app-grid-icon
                                        [ngbTooltip]="'Settings'"
                                        [subTitle]="'Settings'"
                                        [superTitle]="'icon-bi-gear'"
                                    />
                                </button>

                                <div class="filler"></div>

                                <button
                                    type="button"
                                    aria-label="Licenses"
                                    [ngClass]="{
                                        activechoice:
                                            shownList() === 'licenses',
                                    }"
                                    (click)="toggleShownList('licenses')"
                                >
                                    <app-grid-icon
                                        [ngbTooltip]="'Licenses'"
                                        [subTitle]="'Licenses'"
                                        [superTitle]="'ยง'"
                                    />
                                </button>

                                <button
                                    type="button"
                                    aria-label="About"
                                    [ngClass]="{
                                        activechoice: shownList() === 'about',
                                    }"
                                    (click)="toggleShownList('about')"
                                >
                                    <app-grid-icon
                                        [ngbTooltip]="'About'"
                                        [subTitle]="'About'"
                                        [superTitle]="'icon-bi-info-circle'"
                                    />
                                </button>
                            </div>
                        </div>
                    }

                    @if (isMenuOpen$ | async) {
                        <div class="list-item">
                            <strong>Experience Points</strong>

                            <span class="hlist">
                                @if (
                                    character.experiencePoints >= 1000 &&
                                    character.level < 20
                                ) {
                                    <button
                                        type="button"
                                        (click)="onLevelUp()"
                                    >
                                        Level Up
                                    </button>
                                }

                                <input
                                    aria-label="Experience points input"
                                    type="number"
                                    class="number4"
                                    id="experiencePoints"
                                    [ngbTooltip]="
                                        character.experiencePoints >= 1000 &&
                                        character.level < 20
                                            ? 'You are ready to level up!'
                                            : ''
                                    "
                                    [ngClass]="{
                                        bonus:
                                            character.experiencePoints >=
                                                1000 && character.level < 20,
                                    }"
                                    [(ngModel)]="character.experiencePoints"
                                    (keypress)="positiveNumbersOnly($event)"
                                />
                            </span>
                        </div>

                        @for (oldLevel of [character.level]; track $index) {
                            <div class="list-item">
                                <strong>Level</strong>

                                <span>
                                    <select
                                        aria-label="Select level"
                                        [(ngModel)]="character.level"
                                        (ngModelChange)="
                                            onLevelChange(oldLevel)
                                        "
                                    >
                                        @for (
                                            level of [
                                                1, 2, 3, 4, 5, 6, 7, 8, 9, 10,
                                                11, 12, 13, 14, 15, 16, 17, 18,
                                                19, 20,
                                            ];
                                            track $index
                                        ) {
                                            <option [ngValue]="level">
                                                {{ level }}
                                            </option>
                                        }
                                    </select>
                                </span>
                            </div>
                        }

                        <div class="list-item">
                            <button
                                type="button"
                                [ngClass]="{
                                    'fancy-button': isLevelFilterShown(),
                                }"
                                (click)="toggleLevelFilter()"
                            >
                                Filter levels
                            </button>

                            <!-- Level selection -->
                            <div
                                class="list-item"
                                [ngbCollapse]="!isLevelFilterShown()"
                            >
                                <div class="levelBox fullwidth levelBoxTop">
                                    <button
                                        type="button"
                                        class="center-aligned"
                                        [ngClass]="{
                                            'fancy-button': shownLevel() === 0,
                                        }"
                                        (click)="toggleShownLevel(0)"
                                    >
                                        Everything
                                    </button>

                                    <button
                                        type="button"
                                        class="center-aligned"
                                        [ngClass]="{
                                            'fancy-button': shownLevel() === -1,
                                        }"
                                        (click)="toggleShownLevel(-1)"
                                    >
                                        History
                                    </button>
                                </div>

                                <div class="levelBox fullwidth">
                                    @for (
                                        levelNumber of [
                                            1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11,
                                            12, 13, 14, 15, 16, 17, 18, 19, 20,
                                        ];
                                        track $index
                                    ) {
                                        <button
                                            type="button"
                                            class="center-aligned"
                                            [disabled]="!character.class.name"
                                            [ngClass]="{
                                                'fancy-button':
                                                    shownLevel() ===
                                                    levelNumber,
                                            }"
                                            (click)="
                                                toggleShownLevel(levelNumber)
                                            "
                                        >
                                            {{ levelNumber }}
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>

                        <app-tags
                            [creature]="character"
                            [objectName]="'Character'"
                            [showTraits]="true"
                            [showFeats]="true"
                            [showItems]="true"
                            [showActivities]="true"
                            [showConditions]="true"
                        />

                        <div
                            class="vlist"
                            [ngClass]="{ invisible: shownLevel() > 0 }"
                        >
                            <header class="sectionHeader">History</header>

                            <div class="list-item">
                                <strong>Name</strong>

                                <span>
                                    <input
                                        aria-label="Character name"
                                        type="text"
                                        id="charactername"
                                        maxLength="100"
                                        [(ngModel)]="character.name"
                                        (blur)="onNameChange()"
                                    />
                                </span>
                            </div>

                            <div class="list-item">
                                <div class="newrow">
                                    <strong>Party name</strong>

                                    <span>
                                        <input
                                            aria-label="Party name"
                                            type="text"
                                            id="partyname"
                                            maxLength="100"
                                            [(ngModel)]="character.partyName"
                                        />
                                    </span>
                                </div>

                                <div class="newrow">
                                    <span></span>

                                    <span>
                                        <select
                                            aria-label="Select party"
                                            [(ngModel)]="character.partyName"
                                        >
                                            @for (
                                                partyName of partyNames$
                                                    | async;
                                                track $index
                                            ) {
                                                <option [ngValue]="partyName">
                                                    {{ partyName }}
                                                </option>
                                            }
                                        </select>
                                    </span>
                                </div>
                            </div>

                            <div class="list-item">
                                <strong>Alignment</strong>

                                <span>
                                    <select
                                        aria-label="Select alignment"
                                        [(ngModel)]="character.alignment"
                                        (ngModelChange)="onAlignmentChange()"
                                    >
                                        @for (
                                            alignment of alignments();
                                            track $index
                                        ) {
                                            <option [ngValue]="alignment">
                                                {{ alignment }}
                                            </option>
                                        }
                                    </select>
                                </span>
                            </div>

                            <!-- Available Ancestry Feats -->
                            @if (character.class.ancestry.name) {
                                <div class="list-item minimized-hide">
                                    <strong>Available Ancestry Feats</strong>

                                    @if (
                                        character.class.ancestry.ancestries
                                            .length
                                    ) {
                                        <div class="newrow left-aligned">
                                            @for (
                                                ancestry of character.class
                                                    .ancestry.ancestries;
                                                track $index
                                            ) {
                                                <cite class="trait">
                                                    {{ ancestry }}
                                                </cite>
                                            }
                                        </div>
                                    }
                                </div>
                            }

                            <!-- History list mode -->
                            @if (!tileMode.enabled) {
                                <!-- BaseValues -->
                                <div class="list-item">
                                    <button
                                        type="button"
                                        class="newrow fancy-button"
                                        [ngClass]="{
                                            choicecleared:
                                                character.settings
                                                    .useIndividualAbilityBaseValues,
                                            activechoice:
                                                shownList() ===
                                                'alternativeBaseValues',
                                        }"
                                        (click)="
                                            toggleShownList(
                                                'alternativeBaseValues'
                                            )
                                        "
                                    >
                                        Alternative Ability Values:
                                        {{
                                            character.settings
                                                .useIndividualAbilityBaseValues
                                                ? "Used"
                                                : "Not Used"
                                        }}
                                    </button>
                                </div>

                                <!-- Class -->
                                <div
                                    class="list-item"
                                    [ngClass]="{
                                        'minimized-hide': character.class.name,
                                    }"
                                >
                                    <button
                                        type="button"
                                        class="newrow"
                                        [ngClass]="{
                                            'fancy-button choicecleared':
                                                character.class.name,
                                            activechoice:
                                                shownList() === 'class',
                                        }"
                                        (click)="toggleShownList('class')"
                                    >
                                        Class{{
                                            character.class.name
                                                ? ": " + character.class.name
                                                : ""
                                        }}
                                    </button>
                                </div>

                                <!-- Ancestry -->
                                @if (character.class.name) {
                                    <div
                                        class="list-item list-header"
                                        [ngClass]="{
                                            'minimized-hide':
                                                character.class.ancestry.name,
                                        }"
                                    >
                                        <button
                                            type="button"
                                            class="newrow"
                                            [ngClass]="{
                                                'fancy-button choicecleared':
                                                    character.class.ancestry
                                                        .name,
                                                activechoice:
                                                    shownList() === 'ancestry',
                                            }"
                                            (click)="
                                                toggleShownList('ancestry')
                                            "
                                        >
                                            Ancestry{{
                                                character.class.ancestry.name
                                                    ? ": " +
                                                      character.class.ancestry
                                                          .name
                                                    : ""
                                            }}
                                        </button>
                                    </div>
                                }

                                <!-- Heritage -->
                                @if (character.class.ancestry.name) {
                                    <div
                                        class="list-item"
                                        [ngClass]="{
                                            'minimized-hide':
                                                character.class.heritage.name,
                                        }"
                                    >
                                        <button
                                            type="button"
                                            class="newrow"
                                            [ngClass]="{
                                                'fancy-button choicecleared':
                                                    character.class.heritage
                                                        .name,
                                                activechoice:
                                                    shownList() === 'heritage',
                                            }"
                                            (click)="
                                                toggleShownList('heritage')
                                            "
                                        >
                                            Heritage{{
                                                character.class.heritage.name
                                                    ? ": " +
                                                      character.class.heritage
                                                          .name
                                                    : ""
                                            }}
                                        </button>
                                    </div>
                                }

                                <!-- Languages -->
                                @for (
                                    currentLanguages of [
                                        availableLanguagesOnLevel(
                                            character.level
                                        ),
                                    ];
                                    track $index
                                ) {
                                    @for (
                                        blankLanguages of [
                                            blankLanguagesOnLevel(
                                                character.level
                                            ),
                                        ];
                                        track $index
                                    ) {
                                        @if (
                                            areLanguagesAvailableOnLevel$()
                                                | async
                                        ) {
                                            <div
                                                class="list-item"
                                                [ngClass]="{
                                                    'minimized-hide':
                                                        !blankLanguages,
                                                }"
                                            >
                                                <button
                                                    type="button"
                                                    class="newrow"
                                                    [ngClass]="{
                                                        'fancy-button choicecleared':
                                                            !blankLanguages,
                                                        activechoice:
                                                            shownList() ===
                                                                'languages' &&
                                                            shownContentLevelNumber() ===
                                                                character.level,
                                                    }"
                                                    (click)="
                                                        toggleShownList(
                                                            'languages',
                                                            character.level
                                                        )
                                                    "
                                                >
                                                    Languages
                                                </button>
                                            </div>
                                        }
                                    }
                                }

                                <!-- Background -->
                                @if (character.class.name) {
                                    <div
                                        class="list-item"
                                        [ngClass]="{
                                            'minimized-hide':
                                                character.class.background.name,
                                        }"
                                    >
                                        <button
                                            type="button"
                                            class="newrow"
                                            [ngClass]="{
                                                'fancy-button choicecleared':
                                                    character.class.background
                                                        .name,
                                                activechoice:
                                                    shownList() ===
                                                    'background',
                                            }"
                                            (click)="
                                                toggleShownList('background')
                                            "
                                        >
                                            Background{{
                                                character.class.background.name
                                                    ? ": " +
                                                      character.class.background
                                                          .name
                                                    : ""
                                            }}
                                        </button>
                                    </div>
                                }

                                <!-- Deity -->
                                @if (character.class.name) {
                                    <div
                                        class="list-item"
                                        [ngClass]="{
                                            'minimized-hide':
                                                character.class.deity,
                                        }"
                                    >
                                        <button
                                            type="button"
                                            class="newrow"
                                            [ngClass]="{
                                                'fancy-button choicecleared':
                                                    character.class.deity,
                                                activechoice:
                                                    shownList() === 'deity',
                                            }"
                                            (click)="toggleShownList('deity')"
                                        >
                                            Deity{{
                                                character.class.deity
                                                    ? ": " +
                                                      character.class.deity
                                                    : ""
                                            }}
                                        </button>
                                    </div>
                                }
                            }

                            <!-- History tile mode -->
                            @if (tileMode.enabled) {
                                <div class="list-item icon-list">
                                    <!-- BaseValues -->
                                    <button
                                        type="button"
                                        aria-label="Show alternative ability values"
                                        class="fancy-button"
                                        [ngClass]="{
                                            choicecleared:
                                                character.settings
                                                    .useIndividualAbilityBaseValues,
                                            activechoice:
                                                shownList() ===
                                                'alternativeBaseValues',
                                        }"
                                        (click)="
                                            toggleShownList(
                                                'alternativeBaseValues'
                                            )
                                        "
                                    >
                                        <app-grid-icon
                                            class="fancy-button"
                                            [ngbTooltip]="
                                                'Alternative Ability Values: ' +
                                                (character.settings
                                                    .useIndividualAbilityBaseValues
                                                    ? 'Used'
                                                    : 'Not Used')
                                            "
                                            [title]="'A B I'"
                                            [superTitle]="
                                                'icon-ra ra-circle-of-circles'
                                            "
                                        />
                                    </button>

                                    <!-- Class -->
                                    <button
                                        type="button"
                                        aria-label="Show class selection"
                                        [ngClass]="{
                                            'fancy-button choicecleared minimized-hide':
                                                character.class.name,
                                            activechoice:
                                                shownList() === 'class',
                                        }"
                                        (click)="toggleShownList('class')"
                                    >
                                        <app-grid-icon
                                            [ngClass]="{
                                                'fancy-button':
                                                    character.class.name,
                                            }"
                                            [ngbTooltip]="
                                                'Class' +
                                                (character.class.name
                                                    ? ': ' +
                                                      character.class.name
                                                    : '')
                                            "
                                            [title]="
                                                character.class.name
                                                    ? character.class.name
                                                    : 'C L A S'
                                            "
                                            [superTitle]="
                                                'icon-ra ra-lightning-sword'
                                            "
                                        />
                                    </button>

                                    <!-- Ancestry -->
                                    @if (character.class.name) {
                                        <button
                                            type="button"
                                            aria-label="Show ancestry selection"
                                            [ngClass]="{
                                                'fancy-button choicecleared minimized-hide':
                                                    character.class.ancestry
                                                        .name,
                                                activechoice:
                                                    shownList() === 'ancestry',
                                            }"
                                            (click)="
                                                toggleShownList('ancestry')
                                            "
                                        >
                                            <app-grid-icon
                                                [ngClass]="{
                                                    'fancy-button':
                                                        character.class.ancestry
                                                            .name,
                                                }"
                                                [ngbTooltip]="
                                                    'Ancestry' +
                                                    (character.class.ancestry
                                                        .name
                                                        ? ': ' +
                                                          character.class
                                                              .ancestry.name
                                                        : '')
                                                "
                                                [title]="
                                                    character.class.ancestry
                                                        .name
                                                        ? character.class
                                                              .ancestry.name
                                                        : 'A N C E'
                                                "
                                                [superTitle]="
                                                    'icon-ra ra-sprout-emblem'
                                                "
                                            />
                                        </button>
                                    }

                                    <!-- Heritage -->
                                    @if (character.class.ancestry.name) {
                                        <button
                                            type="button"
                                            aria-label="Show heritage selection"
                                            [ngClass]="{
                                                'fancy-button choicecleared minimized-hide':
                                                    character.class.heritage
                                                        .name,
                                                activechoice:
                                                    shownList() === 'heritage',
                                            }"
                                            (click)="
                                                toggleShownList('heritage')
                                            "
                                        >
                                            <app-grid-icon
                                                [ngClass]="{
                                                    'fancy-button':
                                                        character.class.heritage
                                                            .name,
                                                }"
                                                [ngbTooltip]="
                                                    'Heritage' +
                                                    (character.class.heritage
                                                        .name
                                                        ? ': ' +
                                                          character.class
                                                              .heritage.name
                                                        : '')
                                                "
                                                [title]="
                                                    character.class.heritage
                                                        .name
                                                        ? character.class
                                                              .heritage.name
                                                        : 'H E R I'
                                                "
                                                [superTitle]="
                                                    'icon-ra ra-crowned-heart'
                                                "
                                            />
                                        </button>
                                    }

                                    <!-- Languages -->
                                    @for (
                                        currentLanguages of [
                                            availableLanguagesOnLevel(
                                                character.level
                                            ),
                                        ];
                                        track $index
                                    ) {
                                        @for (
                                            blankLanguages of [
                                                blankLanguagesOnLevel(
                                                    character.level
                                                ),
                                            ];
                                            track $index
                                        ) {
                                            @if (
                                                areLanguagesAvailableOnLevel$()
                                                    | async
                                            ) {
                                                <button
                                                    type="button"
                                                    aria-label="Show language menu"
                                                    [ngClass]="{
                                                        'fancy-button choicecleared minimized-hide':
                                                            !blankLanguages,
                                                        activechoice:
                                                            shownList() ===
                                                                'languages' &&
                                                            shownContentLevelNumber() ===
                                                                character.level,
                                                    }"
                                                    (click)="
                                                        toggleShownList(
                                                            'languages',
                                                            character.level
                                                        )
                                                    "
                                                >
                                                    <app-grid-icon
                                                        [ngClass]="{
                                                            'fancy-button':
                                                                !blankLanguages,
                                                        }"
                                                        [ngbTooltip]="
                                                            'Languages'
                                                        "
                                                        [title]="'L A N G'"
                                                        [superTitle]="
                                                            currentLanguages.toString()
                                                        "
                                                    />
                                                </button>
                                            }
                                        }
                                    }

                                    <!-- Background -->
                                    @if (character.class.name) {
                                        <button
                                            type="button"
                                            aria-label="Show background selection"
                                            [ngClass]="{
                                                'fancy-button choicecleared minimized-hide':
                                                    character.class.background
                                                        .name,
                                                activechoice:
                                                    shownList() ===
                                                    'background',
                                            }"
                                            (click)="
                                                toggleShownList('background')
                                            "
                                        >
                                            <app-grid-icon
                                                [ngClass]="{
                                                    'fancy-button':
                                                        character.class
                                                            .background.name,
                                                }"
                                                [ngbTooltip]="
                                                    'Background' +
                                                    (character.class.background
                                                        .name
                                                        ? ': ' +
                                                          character.class
                                                              .background.name
                                                        : '')
                                                "
                                                [title]="
                                                    character.class.background
                                                        .name
                                                        ? character.class
                                                              .background.name
                                                        : 'B A C K'
                                                "
                                                [superTitle]="
                                                    'icon-ra ra-forging'
                                                "
                                            />
                                        </button>
                                    }

                                    <!-- Deity -->
                                    @if (character.class.name) {
                                        <button
                                            type="button"
                                            aria-label="Show deity selection"
                                            [ngClass]="{
                                                'fancy-button choicecleared minimized-hide':
                                                    character.class.deity,
                                                activechoice:
                                                    shownList() === 'deity',
                                            }"
                                            (click)="toggleShownList('deity')"
                                        >
                                            <app-grid-icon
                                                [ngClass]="{
                                                    'fancy-button':
                                                        character.class.deity,
                                                }"
                                                [ngbTooltip]="
                                                    'Deity' +
                                                    (character.class.deity
                                                        ? ': ' +
                                                          character.class.deity
                                                        : '')
                                                "
                                                [title]="
                                                    character.class.deity
                                                        ? character.class.deity
                                                        : 'D E I T'
                                                "
                                                [superTitle]="
                                                    'icon-ra ra-sunbeams'
                                                "
                                            />
                                        </button>
                                    }
                                </div>
                            }
                        </div>

                        <!-- Levels -->
                        @if (character.class) {
                            @for (
                                level of character.class.levels;
                                track $index
                            ) {
                                @if (level.number > 0) {
                                    <div
                                        [ngClass]="{
                                            invisible: !(
                                                level.number > 0 &&
                                                [0, level.number].includes(
                                                    shownLevel()
                                                )
                                            ),
                                            vlist: !tileMode.enabled,
                                        }"
                                    >
                                        <!-- Bonuses templates mode -->
                                        <ng-template #AddBonusesTemplate>
                                            <header class="subsectionHeader">
                                                Add bonuses
                                            </header>

                                            <span>
                                                Source
                                                <input
                                                    aria-label="Bonus source input"
                                                    type="text"
                                                    maxLength="30"
                                                    id="bonusSource_{{
                                                        level.number
                                                    }}"
                                                    [(ngModel)]="bonusSource"
                                                />
                                            </span>

                                            <div class="newrow center-aligned">
                                                <button
                                                    type="button"
                                                    class="abilityboost center-aligned"
                                                    (click)="
                                                        addBonusAbilityChoice(
                                                            level,
                                                            'Boost'
                                                        )
                                                    "
                                                >
                                                    Ability
                                                    <br />
                                                    Boost
                                                </button>

                                                <button
                                                    type="button"
                                                    class="abilityboost center-aligned"
                                                    (click)="
                                                        addBonusAbilityChoice(
                                                            level,
                                                            'Flaw'
                                                        )
                                                    "
                                                >
                                                    Ability
                                                    <br />
                                                    Flaw
                                                </button>
                                            </div>

                                            <div class="newrow center-aligned">
                                                <button
                                                    type="button"
                                                    class="skillincrease center-aligned"
                                                    (click)="
                                                        addBonusSkillChoice(
                                                            level,
                                                            'Perception'
                                                        )
                                                    "
                                                >
                                                    Perception
                                                    <br />
                                                    Increase
                                                </button>

                                                <button
                                                    type="button"
                                                    class="skillincrease center-aligned"
                                                    (click)="
                                                        addBonusSkillChoice(
                                                            level,
                                                            'Save'
                                                        )
                                                    "
                                                >
                                                    Saving&nbsp;Throw
                                                    <br />
                                                    Increase
                                                </button>

                                                <button
                                                    type="button"
                                                    class="skillincrease center-aligned"
                                                    (click)="
                                                        addBonusSkillChoice(
                                                            level,
                                                            'Skill'
                                                        )
                                                    "
                                                >
                                                    Skill
                                                    <br />
                                                    Increase
                                                </button>
                                            </div>

                                            <div class="newrow center-aligned">
                                                <button
                                                    type="button"
                                                    class="featchoice center-aligned"
                                                    [disabled]="
                                                        !this.character.class
                                                            .ancestry.name
                                                    "
                                                    (click)="
                                                        addBonusFeatChoice(
                                                            level,
                                                            'Ancestry'
                                                        )
                                                    "
                                                >
                                                    Ancestry
                                                    <br />
                                                    Feat
                                                </button>

                                                <button
                                                    type="button"
                                                    class="featchoice center-aligned"
                                                    (click)="
                                                        addBonusFeatChoice(
                                                            level,
                                                            'Class'
                                                        )
                                                    "
                                                >
                                                    Class
                                                    <br />
                                                    Feat
                                                </button>

                                                <button
                                                    type="button"
                                                    class="featchoice center-aligned"
                                                    (click)="
                                                        addBonusFeatChoice(
                                                            level,
                                                            'General'
                                                        )
                                                    "
                                                >
                                                    General
                                                    <br />
                                                    Feat
                                                </button>

                                                <button
                                                    type="button"
                                                    class="featchoice center-aligned"
                                                    (click)="
                                                        addBonusFeatChoice(
                                                            level,
                                                            'Skill'
                                                        )
                                                    "
                                                >
                                                    Skill
                                                    <br />
                                                    Feat
                                                </button>
                                            </div>

                                            <div class="newrow center-aligned">
                                                <button
                                                    type="button"
                                                    class="specialchoice center-aligned"
                                                    (click)="
                                                        addBonusLoreChoice(
                                                            level
                                                        )
                                                    "
                                                >
                                                    Lore Training
                                                </button>
                                            </div>
                                        </ng-template>

                                        @if (level.number > 0) {
                                            <header
                                                class="sectionHeader levelHeader"
                                            >
                                                <span
                                                    #AddBonusesPopover="ngbPopover"
                                                    class="minimized-hide"
                                                    triggers="click"
                                                    [ngbPopover]="
                                                        AddBonusesTemplate
                                                    "
                                                >
                                                    <i
                                                        class="bi-patch-plus"
                                                        [ngbTooltip]="
                                                            !AddBonusesPopover.isOpen()
                                                                ? 'Add bonus abilities, skills or feats'
                                                                : ''
                                                        "
                                                    ></i>
                                                </span>
                                                Level {{ level.number }}
                                            </header>
                                        }

                                        <div
                                            [ngClass]="{
                                                'character-choice-grid':
                                                    tileMode.enabled,
                                                vlist: !tileMode.enabled,
                                            }"
                                        >
                                            <div
                                                id="bonuses"
                                                [ngClass]="{
                                                    'icon-list vertical':
                                                        tileMode.enabled,
                                                    vlist: !tileMode.enabled,
                                                }"
                                            >
                                                @for (
                                                    fixedAbilityBoosts of [
                                                        abilityBoostsOnLevel(
                                                            level.number,
                                                            "",
                                                            "",
                                                            "",
                                                            "",
                                                            true
                                                        ),
                                                    ];
                                                    track $index
                                                ) {
                                                    @for (
                                                        fixedSkillIncreases of [
                                                            skillIncreasesByLevel(
                                                                level.number,
                                                                "",
                                                                "",
                                                                "",
                                                                true
                                                            ),
                                                        ];
                                                        track $index
                                                    ) {
                                                        @for (
                                                            fixedFeats of [
                                                                characterFeatsTakenOnLevel$(
                                                                    level.number,
                                                                    "feat"
                                                                ) | async,
                                                            ];
                                                            track $index
                                                        ) {
                                                            @for (
                                                                fixedFeatures of [
                                                                    characterFeatsTakenOnLevel$(
                                                                        level.number,
                                                                        "feature"
                                                                    ) | async,
                                                                ];
                                                                track $index
                                                            ) {
                                                                @if (
                                                                    !!(
                                                                        fixedAbilityBoosts.length +
                                                                        fixedSkillIncreases.length +
                                                                        (fixedFeatures?.length ??
                                                                            0) +
                                                                        (fixedFeats?.length ??
                                                                            0)
                                                                    )
                                                                ) {
                                                                    <!-- Fixed information list mode -->
                                                                    @if (
                                                                        !tileMode.enabled
                                                                    ) {
                                                                        <div
                                                                            class="minimized-hide list-item"
                                                                        >
                                                                            <button
                                                                                type="button"
                                                                                class="newrow left-aligned"
                                                                                [ngClass]="{
                                                                                    'fancy-button':
                                                                                        shownFixedChangesLevelNumber() ===
                                                                                        level.number,
                                                                                }"
                                                                                (click)="
                                                                                    toggleFixedChangesLevelNumber(
                                                                                        level.number
                                                                                    )
                                                                                "
                                                                            >
                                                                                <i
                                                                                    class="bi-lock-fill"
                                                                                ></i>
                                                                                Show
                                                                                fixed
                                                                                changes
                                                                            </button>
                                                                        </div>
                                                                    }

                                                                    <!-- Fixed information tile mode -->
                                                                    @if (
                                                                        tileMode.enabled
                                                                    ) {
                                                                        <div
                                                                            class="minimized-hide"
                                                                        >
                                                                            <button
                                                                                type="button"
                                                                                aria-label="Toggle displaying fixed changes"
                                                                                [ngClass]="{
                                                                                    'fancy-button activechoice':
                                                                                        shownFixedChangesLevelNumber() ===
                                                                                        level.number,
                                                                                }"
                                                                                (click)="
                                                                                    toggleFixedChangesLevelNumber(
                                                                                        level.number
                                                                                    )
                                                                                "
                                                                            >
                                                                                <app-grid-icon
                                                                                    [ngClass]="{
                                                                                        'fancy-button':
                                                                                            shownFixedChangesLevelNumber() ===
                                                                                            level.number,
                                                                                    }"
                                                                                    [ngbTooltip]="
                                                                                        (shownFixedChangesLevelNumber() ===
                                                                                        level.number
                                                                                            ? 'Hide'
                                                                                            : 'Show') +
                                                                                        ' fixed changes'
                                                                                    "
                                                                                    [superTitle]="
                                                                                        'icon-bi-lock-fill'
                                                                                    "
                                                                                />
                                                                            </button>
                                                                        </div>
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            </div>

                                            <!-- Ability boosts -->
                                            <div
                                                id="abilityboosts"
                                                [ngClass]="{
                                                    'icon-list vertical':
                                                        tileMode.enabled,
                                                    vlist: !tileMode.enabled,
                                                }"
                                            >
                                                <!-- List mode fixed ability boosts -->
                                                @if (
                                                    !tileMode.enabled &&
                                                    shownFixedChangesLevelNumber() ===
                                                        level.number
                                                ) {
                                                    @for (
                                                        boost of abilityBoostsOnLevel(
                                                            level.number,
                                                            "",
                                                            "",
                                                            "",
                                                            "",
                                                            true
                                                        );
                                                        track $index
                                                    ) {
                                                        <div
                                                            class="list-item minimized-hide"
                                                        >
                                                            <ng-template
                                                                #ListModeFixedAbilityBoostContent
                                                            >
                                                                <div
                                                                    class="newrow left-aligned"
                                                                >
                                                                    <strong>
                                                                        {{
                                                                            boost.type ===
                                                                            "Flaw"
                                                                                ? "Flaw"
                                                                                : "Boost"
                                                                        }}
                                                                    </strong>
                                                                    {{
                                                                        boost.name
                                                                    }}
                                                                </div>

                                                                <div
                                                                    class="newrow left-aligned"
                                                                >
                                                                    <strong
                                                                        >Granted
                                                                        by</strong
                                                                    >
                                                                    {{
                                                                        boost.source
                                                                    }}
                                                                </div>
                                                            </ng-template>

                                                            <button
                                                                #FixedAbilityPopover="ngbPopover"
                                                                type="button"
                                                                class="newrow left-aligned fancy-button abilityboost"
                                                                triggers="click"
                                                                [ngbPopover]="
                                                                    ListModeFixedAbilityBoostContent
                                                                "
                                                            >
                                                                <span
                                                                    [ngbTooltip]="
                                                                        'Fixed ' +
                                                                        (boost.type ===
                                                                        'Flaw'
                                                                            ? 'flaw'
                                                                            : 'boost')
                                                                    "
                                                                >
                                                                    <i
                                                                        class="bi-lock-fill"
                                                                    ></i>
                                                                </span>
                                                                Ability
                                                                {{
                                                                    boost.type ===
                                                                    "Flaw"
                                                                        ? "Flaw"
                                                                        : "Boost"
                                                                }}:
                                                                {{ boost.name }}
                                                            </button>
                                                        </div>
                                                    }
                                                }

                                                <!-- Tile mode fixed ability boosts -->
                                                @if (
                                                    tileMode.enabled &&
                                                    shownFixedChangesLevelNumber() ===
                                                        level.number
                                                ) {
                                                    @for (
                                                        boost of abilityBoostsOnLevel(
                                                            level.number,
                                                            "",
                                                            "",
                                                            "",
                                                            "",
                                                            true
                                                        );
                                                        track $index
                                                    ) {
                                                        <ng-template
                                                            #TileModeFixedAbilityBoostContent
                                                        >
                                                            <div
                                                                class="newrow left-aligned"
                                                            >
                                                                <strong>
                                                                    {{
                                                                        boost.type ===
                                                                        "Flaw"
                                                                            ? "Flaw"
                                                                            : "Boost"
                                                                    }}
                                                                </strong>
                                                                {{ boost.name }}
                                                            </div>

                                                            <div
                                                                class="newrow left-aligned"
                                                            >
                                                                <strong
                                                                    >Granted
                                                                    by</strong
                                                                >
                                                                {{
                                                                    boost.source
                                                                }}
                                                            </div>
                                                        </ng-template>

                                                        <button
                                                            #FixedAbilityPopover="ngbPopover"
                                                            type="button"
                                                            aria-label="Show fixed ability boost"
                                                            class="minimized-hide inactive-button"
                                                            triggers="click"
                                                            [ngbPopover]="
                                                                TileModeFixedAbilityBoostContent
                                                            "
                                                        >
                                                            <app-grid-icon
                                                                class="abilityboost"
                                                                [ngbTooltip]="
                                                                    (!FixedAbilityPopover.isOpen() &&
                                                                        (boost.type ===
                                                                        'Flaw'
                                                                            ? 'Flaw: '
                                                                            : 'Boost: ') +
                                                                            boost.name) ||
                                                                    undefined
                                                                "
                                                                [title]="
                                                                    boost.name
                                                                "
                                                                [superTitle]="
                                                                    'icon-bi-lock-fill'
                                                                "
                                                                [detail]="
                                                                    boost.type ===
                                                                    'Flaw'
                                                                        ? 'Flaw'
                                                                        : 'Boost'
                                                                "
                                                            />
                                                        </button>
                                                    }
                                                }

                                                @for (
                                                    choice of level.abilityChoices;
                                                    track $index
                                                ) {
                                                    @for (
                                                        maxAvailable of [
                                                            maxAbilityBoostsAvailableInChoice(
                                                                choice
                                                            ),
                                                        ];
                                                        track $index
                                                    ) {
                                                        <!-- List mode ability boost buttons -->
                                                        @if (
                                                            maxAvailable &&
                                                            !tileMode.enabled
                                                        ) {
                                                            <div
                                                                class="list-item"
                                                                [ngClass]="{
                                                                    problem:
                                                                        choice
                                                                            .boosts
                                                                            .length >
                                                                            maxAvailable ||
                                                                        areSomeAbilitiesIllegal(
                                                                            choice,
                                                                            level.number
                                                                        ),
                                                                    'minimized-hide':
                                                                        choice
                                                                            .boosts
                                                                            .length ===
                                                                        maxAvailable,
                                                                }"
                                                            >
                                                                <button
                                                                    type="button"
                                                                    class="newrow abilityboost"
                                                                    [ngClass]="{
                                                                        'fancy-button choicecleared':
                                                                            choice
                                                                                .boosts
                                                                                .length ===
                                                                            maxAvailable,
                                                                        activechoice:
                                                                            shownList() ===
                                                                            choice.id,
                                                                    }"
                                                                    (click)="
                                                                        toggleShownList(
                                                                            choice.id,
                                                                            level.number,
                                                                            choice
                                                                        )
                                                                    "
                                                                >
                                                                    {{
                                                                        abilityChoiceTitle(
                                                                            choice
                                                                        )
                                                                    }}
                                                                </button>
                                                            </div>
                                                        }

                                                        <!-- Tile mode ability boost buttons -->
                                                        @if (
                                                            maxAvailable &&
                                                            tileMode.enabled
                                                        ) {
                                                            <button
                                                                type="button"
                                                                aria-label="Show ability boost menu"
                                                                class="abilityboost"
                                                                [ngClass]="{
                                                                    problem:
                                                                        choice
                                                                            .boosts
                                                                            .length >
                                                                            maxAvailable ||
                                                                        areSomeAbilitiesIllegal(
                                                                            choice,
                                                                            level.number
                                                                        ),
                                                                    'fancy-button minimized-hide choicecleared':
                                                                        choice
                                                                            .boosts
                                                                            .length ===
                                                                        maxAvailable,
                                                                    activechoice:
                                                                        shownList() ===
                                                                        choice.id,
                                                                }"
                                                                (click)="
                                                                    toggleShownList(
                                                                        choice.id,
                                                                        level.number,
                                                                        choice
                                                                    )
                                                                "
                                                            >
                                                                <app-grid-icon
                                                                    class="abilityboost"
                                                                    [ngbTooltip]="
                                                                        abilityChoiceTitle(
                                                                            choice
                                                                        )
                                                                    "
                                                                    [openDelay]="
                                                                        100
                                                                    "
                                                                    [superTitle]="
                                                                        maxAvailable.toString()
                                                                    "
                                                                    [title]="
                                                                        abilityChoiceIconTitle(
                                                                            maxAvailable,
                                                                            choice
                                                                        )
                                                                    "
                                                                    [ngClass]="{
                                                                        'fancy-button':
                                                                            choice
                                                                                .boosts
                                                                                .length ===
                                                                            maxAvailable,
                                                                    }"
                                                                />
                                                            </button>
                                                        }
                                                    }
                                                }
                                            </div>

                                            <!-- Skill Increases -->
                                            <div
                                                id="skillincreases"
                                                [ngClass]="{
                                                    'icon-list vertical':
                                                        tileMode.enabled,
                                                    vlist: !tileMode.enabled,
                                                }"
                                            >
                                                <!-- List mode fixed skill increases -->
                                                @if (
                                                    !tileMode.enabled &&
                                                    shownFixedChangesLevelNumber() ===
                                                        level.number
                                                ) {
                                                    @for (
                                                        skillIncrease of skillIncreasesByLevel(
                                                            level.number,
                                                            "",
                                                            "",
                                                            "",
                                                            true
                                                        );
                                                        track $index
                                                    ) {
                                                        <div
                                                            class="list-item minimized-hide"
                                                        >
                                                            <ng-template
                                                                #ListModeFixedSkillIncreaseContent
                                                            >
                                                                <div
                                                                    class="newrow left-aligned"
                                                                >
                                                                    <strong>{{
                                                                        skillIncrease.name
                                                                    }}</strong>
                                                                </div>

                                                                <div
                                                                    class="newrow left-aligned"
                                                                >
                                                                    <strong
                                                                        >Granted
                                                                        by</strong
                                                                    >
                                                                    {{
                                                                        skillIncrease.source
                                                                    }}
                                                                </div>
                                                            </ng-template>

                                                            <button
                                                                #FixedSkillPopover="ngbPopover"
                                                                type="button"
                                                                class="newrow left-aligned fancy-button skillincrease"
                                                                triggers="click"
                                                                [ngbPopover]="
                                                                    ListModeFixedSkillIncreaseContent
                                                                "
                                                            >
                                                                <span
                                                                    [ngbTooltip]="
                                                                        'Fixed increase'
                                                                    "
                                                                >
                                                                    <i
                                                                        class="bi-lock-fill"
                                                                    ></i>
                                                                </span>
                                                                Skill Increase:
                                                                {{
                                                                    skillIncrease.name
                                                                }}
                                                            </button>
                                                        </div>
                                                    }
                                                }

                                                <!-- Tile mode fixed skill increases -->
                                                @if (
                                                    tileMode.enabled &&
                                                    shownFixedChangesLevelNumber() ===
                                                        level.number
                                                ) {
                                                    @for (
                                                        skillIncrease of skillIncreasesByLevel(
                                                            level.number,
                                                            "",
                                                            "",
                                                            "",
                                                            true
                                                        );
                                                        track $index
                                                    ) {
                                                        <ng-template
                                                            #TileModeFixedSkillIncreaseContent
                                                        >
                                                            <div
                                                                class="newrow left-aligned"
                                                            >
                                                                <strong>{{
                                                                    skillIncrease.name
                                                                }}</strong>
                                                            </div>

                                                            <div
                                                                class="newrow left-aligned"
                                                            >
                                                                <strong
                                                                    >Granted
                                                                    by</strong
                                                                >
                                                                {{
                                                                    skillIncrease.source
                                                                }}
                                                            </div>
                                                        </ng-template>

                                                        <button
                                                            #FixedSkillPopover="ngbPopover"
                                                            type="button"
                                                            aria-label="Show fixed skill increase"
                                                            class="minimized-hide inactive-button"
                                                            triggers="click"
                                                            [ngbPopover]="
                                                                TileModeFixedSkillIncreaseContent
                                                            "
                                                        >
                                                            <app-grid-icon
                                                                class="skillincrease"
                                                                [ngbTooltip]="
                                                                    (!FixedSkillPopover.isOpen() &&
                                                                        skillIncrease.name) ||
                                                                    undefined
                                                                "
                                                                [title]="
                                                                    skillIncrease.name
                                                                "
                                                                [superTitle]="
                                                                    'icon-bi-lock-fill'
                                                                "
                                                            />
                                                        </button>
                                                    }
                                                }

                                                <!-- Skill Choices handle tile mode internally -->
                                                @for (
                                                    choice of skillChoicesOnLevel$(
                                                        level
                                                    ) | async;
                                                    track $index
                                                ) {
                                                    <app-skill-choice
                                                        [choice]="choice"
                                                        [showChoice]="
                                                            shownList()
                                                        "
                                                        [levelNumber]="
                                                            level.number
                                                        "
                                                        [showContent]="false"
                                                        [excludeTemporary]="
                                                            true
                                                        "
                                                        [isTileMode]="
                                                            tileMode.enabled ??
                                                            false
                                                        "
                                                        (showSkillChoiceMessage)="
                                                            receiveChoiceMessage(
                                                                $event
                                                            )
                                                        "
                                                    />
                                                }
                                            </div>

                                            <!-- Feat choices -->
                                            <div
                                                id="featchoices"
                                                [ngClass]="{
                                                    'icon-list vertical':
                                                        tileMode.enabled,
                                                    vlist: !tileMode.enabled,
                                                }"
                                            >
                                                <!-- List mode fixed feats -->
                                                @if (
                                                    !tileMode.enabled &&
                                                    shownFixedChangesLevelNumber() ===
                                                        level.number
                                                ) {
                                                    @for (
                                                        feat of characterFeatsTakenOnLevel$(
                                                            level.number,
                                                            "feat"
                                                        ) | async;
                                                        track $index
                                                    ) {
                                                        @for (
                                                            libraryFeat of characterFeatsAndFeatures$(
                                                                feat.name
                                                            ) | async;
                                                            track $index
                                                        ) {
                                                            @if ($first) {
                                                                <div
                                                                    class="list-item minimized-hide"
                                                                >
                                                                    <ng-template
                                                                        #ListModeFixedFeatContent
                                                                    >
                                                                        <header
                                                                            class="spellHeader"
                                                                        >
                                                                            {{
                                                                                libraryFeat.displayName ||
                                                                                    feat.name
                                                                            }}
                                                                        </header>

                                                                        <div
                                                                            class="newrow left-aligned"
                                                                        >
                                                                            <strong
                                                                                >Granted
                                                                                by</strong
                                                                            >
                                                                            {{
                                                                                feat.source
                                                                            }}
                                                                        </div>

                                                                        <app-feat
                                                                            [feat]="
                                                                                libraryFeat
                                                                            "
                                                                            [levelNumber]="
                                                                                level.number
                                                                            "
                                                                        />
                                                                    </ng-template>

                                                                    <button
                                                                        #FixedFeatPopover="ngbPopover"
                                                                        type="button"
                                                                        class="newrow left-aligned fancy-button featchoice"
                                                                        triggers="click"
                                                                        [ngbPopover]="
                                                                            ListModeFixedFeatContent
                                                                        "
                                                                    >
                                                                        <span
                                                                            [ngbTooltip]="
                                                                                'Fixed feat'
                                                                            "
                                                                        >
                                                                            <i
                                                                                class="bi-lock-fill"
                                                                            ></i>
                                                                        </span>
                                                                        {{
                                                                            libraryFeat.displayName ||
                                                                                feat.name
                                                                        }}
                                                                    </button>
                                                                </div>
                                                            }
                                                        }
                                                    }
                                                }

                                                <!-- Tile mode fixed feats -->
                                                @if (
                                                    tileMode.enabled &&
                                                    shownFixedChangesLevelNumber() ===
                                                        level.number
                                                ) {
                                                    @for (
                                                        feat of characterFeatsTakenOnLevel$(
                                                            level.number,
                                                            "feat"
                                                        ) | async;
                                                        track $index
                                                    ) {
                                                        @for (
                                                            libraryFeat of characterFeatsAndFeatures$(
                                                                feat.name
                                                            ) | async;
                                                            track $index
                                                        ) {
                                                            <ng-template
                                                                #TileModeFixedFeatContent
                                                            >
                                                                <header
                                                                    class="spellHeader"
                                                                >
                                                                    {{
                                                                        libraryFeat.displayName ||
                                                                            feat.name
                                                                    }}
                                                                </header>

                                                                <div
                                                                    class="newrow left-aligned"
                                                                >
                                                                    <strong
                                                                        >Granted
                                                                        by</strong
                                                                    >
                                                                    {{
                                                                        feat.source
                                                                    }}
                                                                </div>

                                                                <app-feat
                                                                    [feat]="
                                                                        libraryFeat
                                                                    "
                                                                    [levelNumber]="
                                                                        level.number
                                                                    "
                                                                />
                                                            </ng-template>

                                                            @if ($first) {
                                                                <button
                                                                    #FixedFeatPopover="ngbPopover"
                                                                    type="button"
                                                                    aria-label="Show gained feat"
                                                                    class="minimized-hide inactive-button"
                                                                    triggers="click"
                                                                    [ngbPopover]="
                                                                        TileModeFixedFeatContent
                                                                    "
                                                                >
                                                                    <app-grid-icon
                                                                        class="featchoice"
                                                                        [ngbTooltip]="
                                                                            (!FixedFeatPopover.isOpen() &&
                                                                                (libraryFeat.displayName ||
                                                                                    feat.name)) ||
                                                                            undefined
                                                                        "
                                                                        [title]="
                                                                            (
                                                                                libraryFeat.displayName ||
                                                                                feat.name
                                                                            ).split(
                                                                                ': '
                                                                            )[0]
                                                                        "
                                                                        [detail]="
                                                                            (
                                                                                libraryFeat.displayName ||
                                                                                feat.name
                                                                            ).split(
                                                                                ': '
                                                                            )[1] ||
                                                                            ''
                                                                        "
                                                                        [superTitle]="
                                                                            'icon-bi-lock-fill'
                                                                        "
                                                                    />
                                                                </button>
                                                            }
                                                        }
                                                    }
                                                }

                                                <!-- Feat Choices handle tile mode internally -->
                                                @for (
                                                    choice of featChoicesOnLevel(
                                                        level,
                                                        false
                                                    );
                                                    track $index
                                                ) {
                                                    <app-feat-choice
                                                        [choice]="choice"
                                                        [levelNumber]="
                                                            level.number
                                                        "
                                                        [showContent]="false"
                                                        [showFeat]="shownItem()"
                                                        [showChoice]="
                                                            shownList()
                                                        "
                                                        [showArchetypeFeats]="
                                                            character.settings
                                                                .archetypeFeats
                                                        "
                                                        [isTileMode]="
                                                            tileMode.enabled ??
                                                            false
                                                        "
                                                        (showFeatChoiceMessage)="
                                                            receiveChoiceMessage(
                                                                $event
                                                            )
                                                        "
                                                        (showFeatMessage)="
                                                            receiveFeatMessage(
                                                                $event
                                                            )
                                                        "
                                                    />
                                                }
                                            </div>

                                            <!-- Special choices -->
                                            <div
                                                id="specialchoices"
                                                [ngClass]="{
                                                    'icon-list vertical':
                                                        tileMode.enabled,
                                                    vlist: !tileMode.enabled,
                                                }"
                                            >
                                                <!-- List mode fixed features -->
                                                @if (
                                                    !tileMode.enabled &&
                                                    shownFixedChangesLevelNumber() ===
                                                        level.number
                                                ) {
                                                    @for (
                                                        feature of characterFeatsTakenOnLevel$(
                                                            level.number,
                                                            "feature"
                                                        ) | async;
                                                        track $index
                                                    ) {
                                                        @for (
                                                            libraryFeature of characterFeatsAndFeatures$(
                                                                feature.name
                                                            ) | async;
                                                            track $index
                                                        ) {
                                                            @if ($first) {
                                                                <div
                                                                    class="list-item minimized-hide"
                                                                >
                                                                    <ng-template
                                                                        #ListModeFixedFeatureContent
                                                                    >
                                                                        <header
                                                                            class="spellHeader"
                                                                        >
                                                                            {{
                                                                                libraryFeature.displayName ||
                                                                                    feature.name
                                                                            }}
                                                                        </header>

                                                                        <div
                                                                            class="newrow left-aligned"
                                                                        >
                                                                            <strong
                                                                                >Granted
                                                                                by</strong
                                                                            >
                                                                            {{
                                                                                feature.source
                                                                            }}
                                                                        </div>

                                                                        <app-feat
                                                                            [feat]="
                                                                                libraryFeature
                                                                            "
                                                                            [levelNumber]="
                                                                                level.number
                                                                            "
                                                                        />
                                                                    </ng-template>

                                                                    <button
                                                                        #FixedFeaturePopover="ngbPopover"
                                                                        type="button"
                                                                        class="newrow left-aligned fancy-button specialchoice"
                                                                        triggers="click"
                                                                        [ngbPopover]="
                                                                            ListModeFixedFeatureContent
                                                                        "
                                                                    >
                                                                        <span
                                                                            [ngbTooltip]="
                                                                                'Fixed ability'
                                                                            "
                                                                        >
                                                                            <i
                                                                                class="bi-lock-fill"
                                                                            ></i>
                                                                        </span>
                                                                        {{
                                                                            libraryFeature.displayName ||
                                                                                feature.name
                                                                        }}
                                                                    </button>
                                                                </div>
                                                            }
                                                        }
                                                    }
                                                }

                                                <!-- Tile mode fixed features -->
                                                @if (
                                                    tileMode.enabled &&
                                                    shownFixedChangesLevelNumber() ===
                                                        level.number
                                                ) {
                                                    @for (
                                                        feature of characterFeatsTakenOnLevel$(
                                                            level.number,
                                                            "feature"
                                                        ) | async;
                                                        track $index
                                                    ) {
                                                        @for (
                                                            libraryFeature of characterFeatsAndFeatures$(
                                                                feature.name
                                                            ) | async;
                                                            track $index
                                                        ) {
                                                            <ng-template
                                                                #TileModeFixedFeatureContent
                                                            >
                                                                <header
                                                                    class="spellHeader"
                                                                >
                                                                    {{
                                                                        libraryFeature.displayName ||
                                                                            feature.name
                                                                    }}
                                                                </header>

                                                                <div
                                                                    class="newrow left-aligned"
                                                                >
                                                                    <strong
                                                                        >Granted
                                                                        by</strong
                                                                    >
                                                                    {{
                                                                        feature.source
                                                                    }}
                                                                </div>

                                                                <app-feat
                                                                    [feat]="
                                                                        libraryFeature
                                                                    "
                                                                    [levelNumber]="
                                                                        level.number
                                                                    "
                                                                />
                                                            </ng-template>

                                                            @if ($first) {
                                                                <button
                                                                    #FixedFeaturePopover="ngbPopover"
                                                                    type="button"
                                                                    aria-label="Show gained feature"
                                                                    class="minimized-hide inactive-button"
                                                                    triggers="click"
                                                                    [ngbPopover]="
                                                                        TileModeFixedFeatureContent
                                                                    "
                                                                >
                                                                    <app-grid-icon
                                                                        class="specialchoice"
                                                                        [ngbTooltip]="
                                                                            (!FixedFeaturePopover.isOpen() &&
                                                                                (libraryFeature.displayName ||
                                                                                    feature.name)) ||
                                                                            undefined
                                                                        "
                                                                        [title]="
                                                                            (
                                                                                libraryFeature.displayName ||
                                                                                feature.name
                                                                            ).split(
                                                                                ': '
                                                                            )[0]
                                                                        "
                                                                        [detail]="
                                                                            (
                                                                                libraryFeature.displayName ||
                                                                                feature.name
                                                                            ).split(
                                                                                ': '
                                                                            )[1] ||
                                                                            ''
                                                                        "
                                                                        [superTitle]="
                                                                            'icon-bi-lock-fill'
                                                                        "
                                                                    />
                                                                </button>
                                                            }
                                                        }
                                                    }
                                                }

                                                <!-- Languages - show if you have gained languages this level -->
                                                @if (
                                                    level.number > 0 &&
                                                    (areLanguagesAvailableOnLevel$(
                                                        level.number
                                                    ) | async)
                                                ) {
                                                    @for (
                                                        currentLanguages of [
                                                            availableLanguagesOnLevel(
                                                                level.number
                                                            ),
                                                        ];
                                                        track $index
                                                    ) {
                                                        @for (
                                                            blankLanguages of [
                                                                blankLanguagesOnLevel(
                                                                    level.number
                                                                ),
                                                            ];
                                                            track $index
                                                        ) {
                                                            @if (
                                                                !tileMode.enabled
                                                            ) {
                                                                <div
                                                                    class="list-item"
                                                                    [ngClass]="{
                                                                        'minimized-hide':
                                                                            !blankLanguages,
                                                                    }"
                                                                >
                                                                    <button
                                                                        type="button"
                                                                        class="newrow specialchoice"
                                                                        [ngClass]="{
                                                                            'fancy-button choicecleared':
                                                                                !blankLanguages,
                                                                            activechoice:
                                                                                shownList() ===
                                                                                    'languages' &&
                                                                                shownContentLevelNumber() ===
                                                                                    level.number,
                                                                        }"
                                                                        (click)="
                                                                            toggleShownList(
                                                                                'languages',
                                                                                level.number
                                                                            )
                                                                        "
                                                                    >
                                                                        Languages:
                                                                        {{
                                                                            currentLanguages -
                                                                                blankLanguages
                                                                        }}/{{
                                                                            currentLanguages
                                                                        }}
                                                                    </button>
                                                                </div>
                                                            }

                                                            @if (
                                                                tileMode.enabled
                                                            ) {
                                                                <button
                                                                    type="button"
                                                                    aria-label="Show special choice menu"
                                                                    class="specialchoice"
                                                                    [ngClass]="{
                                                                        'fancy-button choicecleared minimized-hide':
                                                                            !blankLanguages,
                                                                        activechoice:
                                                                            shownList() ===
                                                                                'languages' &&
                                                                            shownContentLevelNumber() ===
                                                                                level.number,
                                                                    }"
                                                                    (click)="
                                                                        toggleShownList(
                                                                            'languages',
                                                                            level.number
                                                                        )
                                                                    "
                                                                >
                                                                    <app-grid-icon
                                                                        class="specialchoice"
                                                                        [ngClass]="{
                                                                            'fancy-button':
                                                                                !blankLanguages,
                                                                        }"
                                                                        [ngbTooltip]="
                                                                            'Languages: ' +
                                                                            (currentLanguages -
                                                                                blankLanguages) +
                                                                            '/' +
                                                                            currentLanguages
                                                                        "
                                                                        [title]="
                                                                            blankLanguages
                                                                                ? blankLanguages.toString()
                                                                                : currentLanguages.toString()
                                                                        "
                                                                        [superTitle]="
                                                                            'icon-ra ra-speech-bubbles'
                                                                        "
                                                                    />
                                                                </button>
                                                            }
                                                        }
                                                    }
                                                }

                                                <!-- "Specialchoice" feat choices (feats handle tile mode internally) -->
                                                @for (
                                                    choice of featChoicesOnLevel(
                                                        level,
                                                        true
                                                    );
                                                    track $index
                                                ) {
                                                    <app-feat-choice
                                                        [choice]="choice"
                                                        [levelNumber]="
                                                            level.number
                                                        "
                                                        [showContent]="false"
                                                        [showFeat]="shownItem()"
                                                        [showChoice]="
                                                            shownList()
                                                        "
                                                        [showArchetypeFeats]="
                                                            character.settings
                                                                .archetypeFeats
                                                        "
                                                        [isTileMode]="
                                                            tileMode.enabled ??
                                                            false
                                                        "
                                                        (showFeatChoiceMessage)="
                                                            receiveChoiceMessage(
                                                                $event
                                                            )
                                                        "
                                                        (showFeatMessage)="
                                                            receiveFeatMessage(
                                                                $event
                                                            )
                                                        "
                                                    />
                                                }

                                                <!-- Animal Companion -->
                                                @if (
                                                    hasCompanionBecomeAvailableOnLevel$(
                                                        level.number
                                                    ) | async
                                                ) {
                                                    @if (
                                                        animalCompanion$
                                                            | async;
                                                        as companion
                                                    ) {
                                                        @if (
                                                            !tileMode.enabled
                                                        ) {
                                                            <div
                                                                class="list-item"
                                                                [ngClass]="{
                                                                    'minimized-hide':
                                                                        companion.name &&
                                                                        companion.species &&
                                                                        companion
                                                                            .class
                                                                            .ancestry
                                                                            .name,
                                                                }"
                                                            >
                                                                <button
                                                                    type="button"
                                                                    class="newrow specialchoice"
                                                                    [ngClass]="{
                                                                        'fancy-button choicecleared':
                                                                            companion.name &&
                                                                            companion.species &&
                                                                            companion
                                                                                .class
                                                                                .ancestry
                                                                                .name,
                                                                        activechoice:
                                                                            shownList() ===
                                                                                'animalcompanion' &&
                                                                            shownContentLevelNumber() ===
                                                                                level.number,
                                                                    }"
                                                                    (click)="
                                                                        toggleShownList(
                                                                            'animalcompanion',
                                                                            level.number
                                                                        )
                                                                    "
                                                                >
                                                                    Animal
                                                                    Companion{{
                                                                        companion
                                                                            .class
                                                                            .ancestry
                                                                            .name
                                                                            ? ": " +
                                                                              companion
                                                                                  .class
                                                                                  .ancestry
                                                                                  .name
                                                                            : ""
                                                                    }}
                                                                </button>
                                                            </div>
                                                        }

                                                        @if (tileMode.enabled) {
                                                            <button
                                                                type="button"
                                                                aria-label="Show animal companion menu"
                                                                class="specialchoice"
                                                                [ngClass]="{
                                                                    'fancy-button choicecleared minimized-hide':
                                                                        companion.name &&
                                                                        companion.species &&
                                                                        companion
                                                                            .class
                                                                            .ancestry
                                                                            .name,
                                                                    activechoice:
                                                                        shownList() ===
                                                                            'animalcompanion' &&
                                                                        shownContentLevelNumber() ===
                                                                            level.number,
                                                                }"
                                                                (click)="
                                                                    toggleShownList(
                                                                        'animalcompanion',
                                                                        level.number
                                                                    )
                                                                "
                                                            >
                                                                <app-grid-icon
                                                                    class="specialchoice"
                                                                    [ngClass]="{
                                                                        'fancy-button':
                                                                            companion.name &&
                                                                            companion.species &&
                                                                            companion
                                                                                .class
                                                                                .ancestry
                                                                                .name,
                                                                    }"
                                                                    [ngbTooltip]="
                                                                        'Animal Companion' +
                                                                        (companion
                                                                            .class
                                                                            .ancestry
                                                                            .name
                                                                            ? ': ' +
                                                                              companion
                                                                                  .class
                                                                                  .ancestry
                                                                                  .name
                                                                            : '')
                                                                    "
                                                                    [title]="
                                                                        companion
                                                                            .class
                                                                            .ancestry
                                                                            .name ||
                                                                        ''
                                                                    "
                                                                    [superTitle]="
                                                                        'icon-ra ra-wolf-howl'
                                                                    "
                                                                />
                                                            </button>
                                                        }
                                                    }
                                                }

                                                <!-- Animal Specializations -->
                                                @if (
                                                    companionSpecializationsAvailable$(
                                                        level.number
                                                    ) | async
                                                ) {
                                                    @for (
                                                        available of [
                                                            (companionSpecializationsAvailable$(
                                                                level.number
                                                            ) | async) ?? 0,
                                                        ];
                                                        track $index
                                                    ) {
                                                        @if (
                                                            companionSpecializationsOnLevel$(
                                                                level.number
                                                            ) | async;
                                                            as takenSpecializations
                                                        ) {
                                                            @if (
                                                                !tileMode.enabled
                                                            ) {
                                                                <div
                                                                    class="list-item"
                                                                    [ngClass]="{
                                                                        'minimized-hide':
                                                                            takenSpecializations.length ===
                                                                            available,
                                                                    }"
                                                                >
                                                                    <button
                                                                        type="button"
                                                                        class="newrow specialchoice"
                                                                        [ngClass]="{
                                                                            'fancy-button choicecleared':
                                                                                takenSpecializations.length ===
                                                                                available,
                                                                            activechoice:
                                                                                shownList() ===
                                                                                    'companionspecialization' &&
                                                                                shownContentLevelNumber() ===
                                                                                    level.number,
                                                                        }"
                                                                        (click)="
                                                                            toggleShownList(
                                                                                'companionspecialization',
                                                                                level.number
                                                                            )
                                                                        "
                                                                    >
                                                                        {{
                                                                            companionSpecializationChoiceTitle(
                                                                                available,
                                                                                takenSpecializations
                                                                            )
                                                                        }}
                                                                    </button>
                                                                </div>
                                                            }

                                                            @if (
                                                                tileMode.enabled
                                                            ) {
                                                                <button
                                                                    type="button"
                                                                    aria-label="Show animal companion specialization menu"
                                                                    class="specialchoice"
                                                                    [ngClass]="{
                                                                        'fancy-button choicecleared minimized-hide':
                                                                            takenSpecializations.length ===
                                                                            available,
                                                                        activechoice:
                                                                            shownList() ===
                                                                                'companionspecialization' &&
                                                                            shownContentLevelNumber() ===
                                                                                level.number,
                                                                    }"
                                                                    (click)="
                                                                        toggleShownList(
                                                                            'companionspecialization',
                                                                            level.number
                                                                        )
                                                                    "
                                                                >
                                                                    <app-grid-icon
                                                                        class="specialchoice"
                                                                        [ngClass]="{
                                                                            'fancy-button':
                                                                                takenSpecializations.length ===
                                                                                available,
                                                                        }"
                                                                        [ngbTooltip]="
                                                                            'Animal Companion Specialization' +
                                                                            (available >
                                                                            1
                                                                                ? ': ' +
                                                                                  takenSpecializations.length +
                                                                                  '/' +
                                                                                  available
                                                                                : takenSpecializations.length ===
                                                                                    1
                                                                                  ? ': ' +
                                                                                    takenSpecializations[0]
                                                                                  : '')
                                                                        "
                                                                        [title]="
                                                                            available >
                                                                            1
                                                                                ? takenSpecializations.length.toString() +
                                                                                  '/' +
                                                                                  available.toString()
                                                                                : takenSpecializations.length
                                                                                  ? takenSpecializations[0]
                                                                                  : ''
                                                                        "
                                                                        [superTitle]="
                                                                            'icon-ra ra-love-howl'
                                                                        "
                                                                    />
                                                                </button>
                                                            }
                                                        }
                                                    }
                                                }

                                                <!-- Familiar -->
                                                @if (
                                                    isFamiliarAvailableOnLevel$(
                                                        level.number
                                                    ) | async
                                                ) {
                                                    @if (
                                                        familiar$ | async;
                                                        as familiar
                                                    ) {
                                                        @for (
                                                            finished of [
                                                                !!familiar.name &&
                                                                    !!familiar.species,
                                                            ];
                                                            track $index
                                                        ) {
                                                            @if (
                                                                !tileMode.enabled
                                                            ) {
                                                                <div
                                                                    class="list-item"
                                                                    [ngClass]="{
                                                                        'minimized-hide':
                                                                            finished,
                                                                    }"
                                                                >
                                                                    <button
                                                                        type="button"
                                                                        class="newrow specialchoice"
                                                                        [ngClass]="{
                                                                            'fancy-button choicecleared':
                                                                                finished,
                                                                            activechoice:
                                                                                shownList() ===
                                                                                    'familiar' &&
                                                                                shownContentLevelNumber() ===
                                                                                    level.number,
                                                                        }"
                                                                        (click)="
                                                                            toggleShownList(
                                                                                'familiar',
                                                                                level.number
                                                                            )
                                                                        "
                                                                    >
                                                                        Familiar
                                                                    </button>
                                                                </div>
                                                            }

                                                            @if (
                                                                tileMode.enabled
                                                            ) {
                                                                <button
                                                                    type="button"
                                                                    aria-label="Show familiar menu"
                                                                    class="specialchoice"
                                                                    [ngClass]="{
                                                                        'fancy-button choicecleared minimized-hide':
                                                                            finished,
                                                                        activechoice:
                                                                            shownList() ===
                                                                                'familiar' &&
                                                                            shownContentLevelNumber() ===
                                                                                level.number,
                                                                    }"
                                                                    (click)="
                                                                        toggleShownList(
                                                                            'familiar',
                                                                            level.number
                                                                        )
                                                                    "
                                                                >
                                                                    <app-grid-icon
                                                                        class="specialchoice"
                                                                        [ngClass]="{
                                                                            'fancy-button':
                                                                                finished,
                                                                        }"
                                                                        [ngbTooltip]="
                                                                            'Familiar'
                                                                        "
                                                                        [superTitle]="
                                                                            'icon-ra ra-raven'
                                                                        "
                                                                    />
                                                                </button>
                                                            }
                                                        }
                                                    }
                                                }

                                                <!-- Different Worlds -->
                                                @for (
                                                    differentWorldsData of differentWorldsData$(
                                                        level.number
                                                    ) | async;
                                                    track $index
                                                ) {
                                                    @for (
                                                        finished of [
                                                            !!differentWorldsData.getValue(
                                                                "name"
                                                            ) &&
                                                                !!differentWorldsData.getValue(
                                                                    "background"
                                                                ),
                                                        ];
                                                        track $index
                                                    ) {
                                                        <!-- Different Worlds -->
                                                        @if (
                                                            !tileMode.enabled
                                                        ) {
                                                            <div
                                                                class="list-item"
                                                                [ngClass]="{
                                                                    'minimized-hide':
                                                                        finished,
                                                                }"
                                                            >
                                                                <button
                                                                    type="button"
                                                                    class="newrow specialchoice"
                                                                    [ngClass]="{
                                                                        'fancy-button choicecleared':
                                                                            finished,
                                                                        activechoice:
                                                                            shownList() ===
                                                                                'differentworlds' &&
                                                                            shownContentLevelNumber() ===
                                                                                level.number,
                                                                    }"
                                                                    (click)="
                                                                        toggleShownList(
                                                                            'differentworlds',
                                                                            level.number
                                                                        )
                                                                    "
                                                                >
                                                                    Different
                                                                    Worlds{{
                                                                        differentWorldsData.getValue(
                                                                            "background"
                                                                        )
                                                                            ? ":
                                                        " +
                                                                              differentWorldsData.getValue(
                                                                                  "background"
                                                                              )
                                                                            : ""
                                                                    }}
                                                                </button>
                                                            </div>
                                                        }

                                                        @if (tileMode.enabled) {
                                                            <button
                                                                type="button"
                                                                aria-label="Show different worlds menu"
                                                                class="specialchoice"
                                                                [ngClass]="{
                                                                    'fancy-button choicecleared minimized-hide':
                                                                        finished,
                                                                    activechoice:
                                                                        shownList() ===
                                                                            'differentworlds' &&
                                                                        shownContentLevelNumber() ===
                                                                            level.number,
                                                                }"
                                                                (click)="
                                                                    toggleShownList(
                                                                        'differentworlds',
                                                                        level.number
                                                                    )
                                                                "
                                                            >
                                                                <app-grid-icon
                                                                    class="specialchoice"
                                                                    [ngClass]="{
                                                                        'fancy-button':
                                                                            finished,
                                                                    }"
                                                                    [ngbTooltip]="
                                                                        'Different Worlds' +
                                                                        (differentWorldsData.getValue(
                                                                            'background'
                                                                        )
                                                                            ? ': ' +
                                                                              differentWorldsData.getValue(
                                                                                  'background'
                                                                              )
                                                                            : '')
                                                                    "
                                                                    [title]="
                                                                        differentWorldsData.valueAsString(
                                                                            'background'
                                                                        ) || ''
                                                                    "
                                                                    [superTitle]="
                                                                        'icon-ra ra-arcane-mask'
                                                                    "
                                                                />
                                                            </button>
                                                        }
                                                    }
                                                }

                                                <!-- Blessed Blood -->
                                                @if (
                                                    isBlessedBloodAvailable$(
                                                        level.number
                                                    ) | async
                                                ) {
                                                    @for (
                                                        blessedBloodSpells of [
                                                            blessedBloodSpellsTaken(),
                                                        ];
                                                        track $index
                                                    ) {
                                                        @for (
                                                            finished of [
                                                                blessedBloodSpells >=
                                                                    3,
                                                            ];
                                                            track $index
                                                        ) {
                                                            @if (
                                                                !tileMode.enabled
                                                            ) {
                                                                <div
                                                                    class="list-item"
                                                                    [ngClass]="{
                                                                        'minimized-hide':
                                                                            finished,
                                                                    }"
                                                                >
                                                                    <button
                                                                        type="button"
                                                                        class="newrow specialchoice"
                                                                        [ngClass]="{
                                                                            'fancy-button choicecleared':
                                                                                finished,
                                                                            activechoice:
                                                                                shownList() ===
                                                                                    'blessedblood' &&
                                                                                shownContentLevelNumber() ===
                                                                                    level.number,
                                                                        }"
                                                                        (click)="
                                                                            toggleShownList(
                                                                                'blessedblood',
                                                                                level.number
                                                                            )
                                                                        "
                                                                    >
                                                                        Blessed
                                                                        Blood
                                                                        Deity
                                                                        Spells:
                                                                        {{
                                                                            blessedBloodSpells
                                                                        }}/3
                                                                    </button>
                                                                </div>
                                                            }

                                                            @if (
                                                                tileMode.enabled
                                                            ) {
                                                                <button
                                                                    type="button"
                                                                    aria-label="Show blessed blood menu"
                                                                    class="specialchoice"
                                                                    [ngClass]="{
                                                                        'fancy-button choicecleared minimized-hide':
                                                                            finished,
                                                                        activechoice:
                                                                            shownList() ===
                                                                                'blessedblood' &&
                                                                            shownContentLevelNumber() ===
                                                                                level.number,
                                                                    }"
                                                                    (click)="
                                                                        toggleShownList(
                                                                            'blessedblood',
                                                                            level.number
                                                                        )
                                                                    "
                                                                >
                                                                    <app-grid-icon
                                                                        class="specialchoice"
                                                                        [ngClass]="{
                                                                            'fancy-button':
                                                                                finished,
                                                                        }"
                                                                        [ngbTooltip]="
                                                                            'Blessed Blood Deity Spells: ' +
                                                                            blessedBloodSpells.toString() +
                                                                            '/3'
                                                                        "
                                                                        [title]="
                                                                            finished
                                                                                ? '3'
                                                                                : blessedBloodSpells.toString() +
                                                                                  '/3'
                                                                        "
                                                                        [superTitle]="
                                                                            'icon-ra ra-burning-eye'
                                                                        "
                                                                    />
                                                                </button>
                                                            }
                                                        }
                                                    }
                                                }

                                                <!-- Splinter Faith -->
                                                @if (
                                                    isSplinterFaithAvailable$(
                                                        level.number
                                                    ) | async
                                                ) {
                                                    @for (
                                                        splinterFaithDomains of [
                                                            (
                                                                splinterFaithDomains$()
                                                                | async
                                                            )?.length || 0,
                                                        ];
                                                        track $index
                                                    ) {
                                                        @for (
                                                            finished of [
                                                                splinterFaithDomains >=
                                                                    4,
                                                            ];
                                                            track $index
                                                        ) {
                                                            @if (
                                                                !tileMode.enabled
                                                            ) {
                                                                <div
                                                                    class="list-item"
                                                                    [ngClass]="{
                                                                        'minimized-hide':
                                                                            finished,
                                                                    }"
                                                                >
                                                                    <button
                                                                        type="button"
                                                                        class="newrow specialchoice"
                                                                        [ngClass]="{
                                                                            'fancy-button choicecleared':
                                                                                finished,
                                                                            activechoice:
                                                                                shownList() ===
                                                                                    'splinterfaith' &&
                                                                                shownContentLevelNumber() ===
                                                                                    level.number,
                                                                        }"
                                                                        (click)="
                                                                            toggleShownList(
                                                                                'splinterfaith',
                                                                                level.number
                                                                            )
                                                                        "
                                                                    >
                                                                        Splinter
                                                                        Faith
                                                                        Domains:
                                                                        {{
                                                                            splinterFaithDomains
                                                                        }}/4
                                                                    </button>
                                                                </div>
                                                            }

                                                            @if (
                                                                tileMode.enabled
                                                            ) {
                                                                <button
                                                                    type="button"
                                                                    aria-label="Show slinter faith menu"
                                                                    class="specialchoice"
                                                                    [ngClass]="{
                                                                        'fancy-button choicecleared minimized-hide':
                                                                            finished,
                                                                        activechoice:
                                                                            shownList() ===
                                                                                'splinterfaith' &&
                                                                            shownContentLevelNumber() ===
                                                                                level.number,
                                                                    }"
                                                                    (click)="
                                                                        toggleShownList(
                                                                            'splinterfaith',
                                                                            level.number
                                                                        )
                                                                    "
                                                                >
                                                                    <app-grid-icon
                                                                        class="specialchoice"
                                                                        [ngClass]="{
                                                                            'fancy-button':
                                                                                finished,
                                                                        }"
                                                                        [ngbTooltip]="
                                                                            'Splinter Faith Domains: ' +
                                                                            splinterFaithDomains.toString() +
                                                                            '/4'
                                                                        "
                                                                        [title]="
                                                                            finished
                                                                                ? '4'
                                                                                : splinterFaithDomains.toString() +
                                                                                  '/4'
                                                                        "
                                                                        [superTitle]="
                                                                            'icon-ra ra-ocean-emblem'
                                                                        "
                                                                    />
                                                                </button>
                                                            }
                                                        }
                                                    }
                                                }

                                                <!-- Additional Heritages -->
                                                @for (
                                                    heritageGain of additionalHeritagesAvailable$(
                                                        level.number
                                                    ) | async;
                                                    track $index
                                                ) {
                                                    @for (
                                                        heritageIndex of [
                                                            additionalHeritageIndex(
                                                                heritageGain.source,
                                                                level.number
                                                            ),
                                                        ];
                                                        track $index
                                                    ) {
                                                        @for (
                                                            finished of [
                                                                !!character
                                                                    .class
                                                                    .additionalHeritages[
                                                                    heritageIndex
                                                                ].name,
                                                            ];
                                                            track $index
                                                        ) {
                                                            @if (
                                                                !tileMode.enabled
                                                            ) {
                                                                <div
                                                                    class="list-item"
                                                                    [ngClass]="{
                                                                        'minimized-hide':
                                                                            finished,
                                                                    }"
                                                                >
                                                                    <button
                                                                        type="button"
                                                                        class="newrow specialchoice"
                                                                        [ngClass]="{
                                                                            'fancy-button choicecleared':
                                                                                character
                                                                                    .class
                                                                                    .additionalHeritages[
                                                                                    heritageIndex
                                                                                ]
                                                                                    .name,
                                                                            activechoice:
                                                                                shownList() ===
                                                                                    'additionalheritage' &&
                                                                                shownContentLevelNumber() ===
                                                                                    level.number &&
                                                                                this.shownContent()
                                                                                    ?.id ===
                                                                                    heritageGain.source,
                                                                        }"
                                                                        (click)="
                                                                            toggleShownList(
                                                                                'additionalheritages',
                                                                                level.number,
                                                                                {
                                                                                    id:
                                                                                        'additionalheritage' +
                                                                                        level.number +
                                                                                        heritageGain.source,
                                                                                    source: heritageGain.source,
                                                                                }
                                                                            )
                                                                        "
                                                                    >
                                                                        Heritage
                                                                        ({{
                                                                            heritageGain.source
                                                                        }}){{
                                                                            finished
                                                                                ? ": " +
                                                                                  character
                                                                                      .class
                                                                                      .additionalHeritages[
                                                                                      heritageIndex
                                                                                  ]
                                                                                      .name
                                                                                : ""
                                                                        }}
                                                                    </button>
                                                                </div>
                                                            }

                                                            @if (
                                                                tileMode.enabled
                                                            ) {
                                                                <button
                                                                    type="button"
                                                                    aria-label="Show additional heritages menu"
                                                                    class="specialchoice"
                                                                    [ngClass]="{
                                                                        'fancy-button choicecleared minimized-hide':
                                                                            finished,
                                                                        activechoice:
                                                                            shownList() ===
                                                                                'additionalheritage' &&
                                                                            shownContentLevelNumber() ===
                                                                                level.number &&
                                                                            this.shownContent()
                                                                                ?.id ===
                                                                                heritageGain.source,
                                                                    }"
                                                                    (click)="
                                                                        toggleShownList(
                                                                            'additionalheritages',
                                                                            level.number,
                                                                            {
                                                                                id:
                                                                                    'additionalheritage' +
                                                                                    level.number +
                                                                                    heritageGain.source,
                                                                                source: heritageGain.source,
                                                                            }
                                                                        )
                                                                    "
                                                                >
                                                                    <app-grid-icon
                                                                        class="specialchoice"
                                                                        [ngClass]="{
                                                                            'fancy-button':
                                                                                finished,
                                                                        }"
                                                                        [ngbTooltip]="
                                                                            'Heritage (' +
                                                                            heritageGain.source +
                                                                            ')' +
                                                                            (finished
                                                                                ? ': ' +
                                                                                  character
                                                                                      .class
                                                                                      .additionalHeritages[
                                                                                      heritageIndex
                                                                                  ]
                                                                                      .name
                                                                                : '')
                                                                        "
                                                                        [title]="
                                                                            finished
                                                                                ? character
                                                                                      .class
                                                                                      .additionalHeritages[
                                                                                      heritageIndex
                                                                                  ]
                                                                                      .name
                                                                                : ''
                                                                        "
                                                                        [superTitle]="
                                                                            'icon-ra ra-sprout-emblem'
                                                                        "
                                                                    />
                                                                </button>
                                                            }
                                                        }
                                                    }
                                                }

                                                <!-- Fuse Stance -->
                                                @for (
                                                    fuseStanceData of fuseStanceData$(
                                                        level.number
                                                    ) | async;
                                                    track $index
                                                ) {
                                                    @for (
                                                        finished of [
                                                            fuseStanceData
                                                                .stances
                                                                ?.length ===
                                                                2 &&
                                                                !!fuseStanceData.name,
                                                        ];
                                                        track $index
                                                    ) {
                                                        @if (
                                                            !tileMode.enabled
                                                        ) {
                                                            <div
                                                                class="list-item"
                                                                [ngClass]="{
                                                                    'minimized-hide':
                                                                        finished,
                                                                }"
                                                            >
                                                                <button
                                                                    type="button"
                                                                    class="newrow specialchoice"
                                                                    [ngClass]="{
                                                                        'fancy-button choicecleared':
                                                                            finished,
                                                                        activechoice:
                                                                            shownList() ===
                                                                                'fusestance' &&
                                                                            shownContentLevelNumber() ===
                                                                                level.number,
                                                                    }"
                                                                    (click)="
                                                                        toggleShownList(
                                                                            'fusestance',
                                                                            level.number
                                                                        )
                                                                    "
                                                                >
                                                                    Fuse
                                                                    Stance{{
                                                                        finished
                                                                            ? ": " +
                                                                                  fuseStanceData.name +
                                                                                  " (" +
                                                                                  fuseStanceData.stances?.join(
                                                                                      ", "
                                                                                  ) ||
                                                                              "" +
                                                                                  ")"
                                                                            : ""
                                                                    }}
                                                                </button>
                                                            </div>
                                                        }

                                                        @if (tileMode.enabled) {
                                                            <button
                                                                type="button"
                                                                aria-label="Show fuse stance menu"
                                                                class="specialchoice"
                                                                [ngClass]="{
                                                                    'fancy-button choicecleared minimized-hide':
                                                                        finished,
                                                                    activechoice:
                                                                        shownList() ===
                                                                            'fusestance' &&
                                                                        shownContentLevelNumber() ===
                                                                            level.number,
                                                                }"
                                                                (click)="
                                                                    toggleShownList(
                                                                        'fusestance',
                                                                        level.number
                                                                    )
                                                                "
                                                            >
                                                                <app-grid-icon
                                                                    class="specialchoice"
                                                                    [ngClass]="{
                                                                        'fancy-button':
                                                                            finished,
                                                                    }"
                                                                    [ngbTooltip]="
                                                                        'Fuse Stance' +
                                                                        (finished
                                                                            ? ': ' +
                                                                                  fuseStanceData.name +
                                                                                  ' (' +
                                                                                  fuseStanceData.stances?.join(
                                                                                      ', '
                                                                                  ) ||
                                                                              '' +
                                                                                  ')'
                                                                            : '')
                                                                    "
                                                                    [title]="
                                                                        finished
                                                                            ? (fuseStanceData.name ??
                                                                              '')
                                                                            : 'Fuse Stance'
                                                                    "
                                                                    [superTitle]="
                                                                        'icon-ra ra-double-team'
                                                                    "
                                                                />
                                                            </button>
                                                        }
                                                    }
                                                }

                                                <!-- Syncretism -->
                                                @for (
                                                    syncretismData of syncretismData$(
                                                        level.number
                                                    ) | async;
                                                    track $index
                                                ) {
                                                    @for (
                                                        finished of [
                                                            !!syncretismData.deity,
                                                        ];
                                                        track $index
                                                    ) {
                                                        @if (
                                                            !tileMode.enabled
                                                        ) {
                                                            <div
                                                                class="list-item"
                                                                [ngClass]="{
                                                                    'minimized-hide':
                                                                        finished,
                                                                }"
                                                            >
                                                                <button
                                                                    type="button"
                                                                    class="newrow specialchoice"
                                                                    [ngClass]="{
                                                                        'fancy-button choicecleared':
                                                                            finished,
                                                                        activechoice:
                                                                            shownList() ===
                                                                                'syncretism' &&
                                                                            shownContentLevelNumber() ===
                                                                                level.number,
                                                                    }"
                                                                    (click)="
                                                                        toggleShownList(
                                                                            'syncretism',
                                                                            level.number
                                                                        )
                                                                    "
                                                                >
                                                                    Second
                                                                    Deity{{
                                                                        finished
                                                                            ? ": " +
                                                                              syncretismData.deity
                                                                            : ""
                                                                    }}
                                                                </button>
                                                            </div>
                                                        }

                                                        @if (tileMode.enabled) {
                                                            <button
                                                                type="button"
                                                                aria-label="Show syncretism menu"
                                                                class="specialchoice"
                                                                [ngClass]="{
                                                                    'fancy-button choicecleared minimized-hide':
                                                                        finished,
                                                                    activechoice:
                                                                        shownList() ===
                                                                            'syncretism' &&
                                                                        shownContentLevelNumber() ===
                                                                            level.number,
                                                                }"
                                                                (click)="
                                                                    toggleShownList(
                                                                        'syncretism',
                                                                        level.number
                                                                    )
                                                                "
                                                            >
                                                                <app-grid-icon
                                                                    class="specialchoice"
                                                                    [ngClass]="{
                                                                        'fancy-button':
                                                                            finished,
                                                                    }"
                                                                    [ngbTooltip]="
                                                                        'Second Deity' +
                                                                        (finished
                                                                            ? ': ' +
                                                                              syncretismData.deity
                                                                            : '')
                                                                    "
                                                                    [title]="
                                                                        finished
                                                                            ? (syncretismData.deity ??
                                                                              '')
                                                                            : 'D E I T'
                                                                    "
                                                                    [superTitle]="
                                                                        'icon-ra ra-sunbeams'
                                                                    "
                                                                />
                                                            </button>
                                                        }
                                                    }
                                                }

                                                <!-- Lore Training -->
                                                @for (
                                                    choice of level.loreChoices;
                                                    track $index
                                                ) {
                                                    @if (
                                                        choice.available &&
                                                        !tileMode.enabled
                                                    ) {
                                                        <div
                                                            class="list-item"
                                                            [ngClass]="{
                                                                problem:
                                                                    choice
                                                                        .increases
                                                                        .length >
                                                                    choice.available,
                                                                'minimized-hide':
                                                                    choice
                                                                        .increases
                                                                        .length ===
                                                                    choice.available,
                                                            }"
                                                        >
                                                            <button
                                                                type="button"
                                                                class="newrow specialchoice"
                                                                [ngClass]="{
                                                                    'fancy-button choicecleared':
                                                                        choice
                                                                            .increases
                                                                            .length ===
                                                                        choice.available,
                                                                    activechoice:
                                                                        shownList() ===
                                                                        choice.id,
                                                                }"
                                                                (click)="
                                                                    toggleShownList(
                                                                        choice.id,
                                                                        level.number,
                                                                        choice
                                                                    )
                                                                "
                                                            >
                                                                Lore Training
                                                                ({{
                                                                    choice.source
                                                                }}){{
                                                                    choice
                                                                        .increases
                                                                        .length
                                                                        ? ": " +
                                                                          choice
                                                                              .increases[0]
                                                                              .name
                                                                        : ""
                                                                }}
                                                            </button>
                                                        </div>
                                                    }

                                                    @if (
                                                        choice.available &&
                                                        tileMode.enabled
                                                    ) {
                                                        <button
                                                            type="button"
                                                            aria-label="Show lore training menu"
                                                            class="specialchoice"
                                                            [ngClass]="{
                                                                'fancy-button choicecleared minimized-hide':
                                                                    choice
                                                                        .increases
                                                                        .length ===
                                                                    choice.available,
                                                                activechoice:
                                                                    shownList() ===
                                                                    choice.id,
                                                            }"
                                                            (click)="
                                                                toggleShownList(
                                                                    choice.id,
                                                                    level.number,
                                                                    choice
                                                                )
                                                            "
                                                        >
                                                            <app-grid-icon
                                                                class="specialchoice"
                                                                [ngClass]="{
                                                                    'fancy-button':
                                                                        choice
                                                                            .increases
                                                                            .length ===
                                                                        choice.available,
                                                                }"
                                                                [ngbTooltip]="
                                                                    'Lore Training (' +
                                                                    choice.source +
                                                                    ')' +
                                                                    (choice
                                                                        .increases
                                                                        .length
                                                                        ? ': ' +
                                                                          choice.loreName
                                                                        : '')
                                                                "
                                                                [title]="
                                                                    choice
                                                                        .increases
                                                                        .length ===
                                                                    choice.available
                                                                        ? choice.loreName
                                                                        : ''
                                                                "
                                                                [superTitle]="
                                                                    'icon-ra ra-book'
                                                                "
                                                            />
                                                        </button>
                                                    }
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        }
                    }
                </div>

                <div
                    class="character-sheet-column"
                    [ngClass]="{ 'mobile-hide': shownList() === '' }"
                >
                    <div
                        id="character-choiceArea-top"
                        style="margin-top: -0.3em"
                    ></div>

                    <!-- Choice content and templates -->
                    <!-- Settings -->
                    @if (shownList() === "settings") {
                        <div class="newrow list-item padding-8 center-aligned">
                            <header class="box-header sectionHeader">
                                Settings
                            </header>
                        </div>

                        <div
                            id="choiceArea"
                            class="list-item"
                        >
                            <div class="list-item">
                                <strong>Look</strong>

                                <div class="list-item gridicon-fullsizebox">
                                    <input
                                        id="accent"
                                        type="color"
                                        class="character-choice"
                                        id="coloraccent"
                                        style="padding: 0 2px"
                                        maxLength="7"
                                        [(ngModel)]="character.settings.accent"
                                    />
                                    <label for="accent">
                                        <strong>Color Accent</strong>
                                    </label>
                                </div>

                                <div class="list-item gridicon-fullsizebox">
                                    <input
                                        id="darkmode"
                                        class="character-choice"
                                        type="checkbox"
                                        [(ngModel)]="
                                            character.settings.darkmode
                                        "
                                    />
                                    <label for="darkmode">
                                        <strong>Dark mode</strong>
                                    </label>
                                </div>
                            </div>

                            <div class="list-item">
                                <strong>Tags</strong>

                                <div class="list-item gridicon-fullsizebox">
                                    <input
                                        class="character-choice"
                                        id="hintsShowMoreInformation"
                                        type="checkbox"
                                        [(ngModel)]="
                                            character.settings
                                                .hintsShowMoreInformation
                                        "
                                    />
                                    <label for="hintsShowMoreInformation">
                                        <strong>
                                            Clicking a tag shows additional
                                            information, if available
                                        </strong>
                                    </label>
                                </div>
                            </div>

                            <div class="list-item">
                                <strong>Choices</strong>

                                <div class="list-item gridicon-fullsizebox">
                                    <input
                                        class="character-choice"
                                        id="autoCloseChoices"
                                        type="checkbox"
                                        [(ngModel)]="
                                            character.settings.autoCloseChoices
                                        "
                                    />
                                    <label for="autoCloseChoices">
                                        <strong>
                                            Automatically close choices when
                                            they are finished
                                        </strong>
                                    </label>
                                </div>

                                <div class="list-item gridicon-fullsizebox">
                                    <input
                                        class="character-choice"
                                        id="showOtherOptions"
                                        type="checkbox"
                                        [(ngModel)]="
                                            character.settings.showOtherOptions
                                        "
                                    />
                                    <label for="showOtherOptions">
                                        <strong>
                                            Keep showing the other options in
                                            finished choices
                                        </strong>
                                    </label>
                                </div>
                            </div>

                            <div class="list-item">
                                <strong>Feats</strong>

                                <div class="list-item gridicon-fullsizebox">
                                    <input
                                        class="character-choice"
                                        id="unavailableFeats"
                                        type="checkbox"
                                        [(ngModel)]="
                                            character.settings.unavailableFeats
                                        "
                                    />
                                    <label for="unavailableFeats">
                                        <strong>Show unavailable feats</strong>
                                    </label>
                                </div>

                                <div class="list-item gridicon-fullsizebox">
                                    <input
                                        class="character-choice"
                                        id="lowerLevelFeats"
                                        type="checkbox"
                                        [(ngModel)]="
                                            character.settings.lowerLevelFeats
                                        "
                                    />
                                    <label for="lowerLevelFeats">
                                        <strong>Show lower level feats</strong>
                                    </label>
                                </div>

                                <div
                                    class="fullwidth"
                                    [ngbCollapse]="
                                        !character.settings.unavailableFeats
                                    "
                                >
                                    <div class="list-item gridicon-fullsizebox">
                                        <input
                                            class="character-choice"
                                            id="higherLevelFeats"
                                            type="checkbox"
                                            [(ngModel)]="
                                                character.settings
                                                    .higherLevelFeats
                                            "
                                        />
                                        <label for="higherLevelFeats">
                                            <strong
                                                >Show higher level feats</strong
                                            >
                                        </label>
                                    </div>
                                </div>

                                <div class="list-item gridicon-fullsizebox">
                                    <input
                                        class="character-choice"
                                        id="archetypeFeats"
                                        type="checkbox"
                                        [(ngModel)]="
                                            character.settings.archetypeFeats
                                        "
                                    />
                                    <label for="archetypeFeats">
                                        <strong>Show archetype feats</strong>
                                    </label>
                                </div>

                                <div class="list-item gridicon-fullsizebox">
                                    <input
                                        class="character-choice"
                                        id="hiddenFeats"
                                        type="checkbox"
                                        [(ngModel)]="
                                            character.settings.hiddenFeats
                                        "
                                        (ngModelChange)="onHiddenFeatsChange()"
                                    />
                                    <span>
                                        <label for="hiddenFeats">
                                            <strong>Show hidden choices</strong>
                                        </label>

                                        <i
                                            class="bi-question-circle"
                                            [ngbPopover]="
                                                'Certain choices are intended to work automatically, and are hidden if no manual input is required or possible. Showing these can help tracking an issue (e.g. when you take a class choice that grants you a feat, and the feat isn\'t showing up).\n\nThese feat choices may not react as intended to manual input (such as deselecting a feat that was selected automatically).'
                                            "
                                        ></i>
                                    </span>
                                </div>
                            </div>

                            <div class="list-item">
                                <strong>Activities</strong>

                                <div class="list-item gridicon-fullsizebox">
                                    <input
                                        class="character-choice"
                                        id="showSkillActivities"
                                        type="checkbox"
                                        [(ngModel)]="
                                            character.settings
                                                .showSkillActivities
                                        "
                                        (ngModelChange)="onUpdateSkills()"
                                    />
                                    <label for="showSkillActivities">
                                        <strong>
                                            Show related activities on skills
                                            and perception
                                        </strong>
                                    </label>
                                </div>
                            </div>

                            <div class="list-item">
                                <strong>Spells</strong>

                                <div class="list-item gridicon-fullsizebox">
                                    <input
                                        class="character-choice"
                                        id="showHeightenedSpells"
                                        type="checkbox"
                                        [(ngModel)]="
                                            character.settings
                                                .showHeightenedSpells
                                        "
                                    />
                                    <label for="showHeightenedSpells">
                                        <strong>
                                            Show heightened lower-level spells
                                            in spell choices
                                        </strong>
                                    </label>
                                </div>

                                <div class="list-item gridicon-fullsizebox">
                                    <input
                                        class="character-choice"
                                        id="noFriendlyCasterConditions"
                                        type="checkbox"
                                        [(ngModel)]="
                                            character.settings
                                                .noFriendlyCasterConditions
                                        "
                                        (ngModelChange)="onUpdateSpellbook()"
                                    />
                                    <span>
                                        <label for="noFriendlyCasterConditions">
                                            <strong>
                                                Avoid informational caster
                                                conditions for friendly spells
                                            </strong>
                                        </label>

                                        <i
                                            class="bi-question-circle"
                                            [ngbPopover]="
                                                'When casting targeted spells with a duration, the caster will receive a condition that gives information about the effect and tracks the duration. This option will disable these caster conditions for friendly spells if they have no effect on the caster.'
                                            "
                                        ></i>
                                    </span>
                                </div>

                                <div class="list-item gridicon-fullsizebox">
                                    <input
                                        class="character-choice"
                                        id="noHostileCasterConditions"
                                        type="checkbox"
                                        [(ngModel)]="
                                            character.settings
                                                .noHostileCasterConditions
                                        "
                                        (ngModelChange)="onUpdateSpellbook()"
                                    />
                                    <span>
                                        <label for="noHostileCasterConditions">
                                            <strong>
                                                Avoid informational caster
                                                conditions for hostile spells
                                            </strong>
                                        </label>

                                        <i
                                            class="bi-question-circle"
                                            [ngbPopover]="
                                                'When casting targeted spells with a duration, the caster will receive a condition that gives information about the effect and tracks the duration. This option will disable these caster conditions for hostile spells if they have no effect on the caster.'
                                            "
                                        ></i>
                                    </span>
                                </div>
                            </div>

                            <div class="list-item">
                                <strong>Integration</strong>

                                <div class="list-item gridicon-fullsizebox">
                                    <input
                                        class="character-choice"
                                        id="foundryVTTSendRolls"
                                        type="checkbox"
                                        [(ngModel)]="
                                            character.settings
                                                .foundryVTTSendRolls
                                        "
                                    />
                                    <span>
                                        <label for="foundryVTTSendRolls">
                                            <strong>
                                                Send dice rolls to your Foundry
                                                VTT session
                                            </strong>

                                            <span class="newrow">
                                                Requires the External Dice Roll
                                                API module
                                            </span>
                                        </label>
                                    </span>
                                </div>

                                <div
                                    class="fullwidth vlist"
                                    [ngbCollapse]="
                                        !character.settings.foundryVTTSendRolls
                                    "
                                >
                                    <div class="list-item">
                                        <strong>
                                            Foundry VTT session URL (e.g.
                                            http://your.server:30000)
                                        </strong>

                                        <input
                                            class="newrow"
                                            aria-label="Foundry VTT session URL input"
                                            id="foundryVTTUrl"
                                            type="text"
                                            [(ngModel)]="
                                                character.settings.foundryVTTUrl
                                            "
                                        />
                                    </div>

                                    <div class="list-item">
                                        <strong>
                                            Time to close the Foundry API window
                                            (in ms)
                                            <i
                                                class="bi-question-circle"
                                                [ngbPopover]="
                                                    'The API is opened in a new window that closes automatically after this time. If you find that your rolls don\'t turn up in Foundry, try raising this value.'
                                                "
                                            ></i>
                                        </strong>

                                        <input
                                            aria-label="Foundry VTT window timeout input"
                                            class="number5"
                                            id="foundryVTTTimeout"
                                            type="number"
                                            [(ngModel)]="
                                                character.settings
                                                    .foundryVTTTimeout
                                            "
                                        />
                                    </div>

                                    <div class="list-item gridicon-fullsizebox">
                                        <input
                                            class="character-choice"
                                            id="foundryVTTRollDirectly"
                                            type="checkbox"
                                            [(ngModel)]="
                                                character.settings
                                                    .foundryVTTRollDirectly
                                            "
                                        />
                                        <span>
                                            <label for="foundryVTTRollDirectly">
                                                <strong>
                                                    Quick dice buttons roll
                                                    directly in Foundry VTT
                                                </strong>
                                            </label>

                                            <i
                                                class="bi-question-circle"
                                                [ngbPopover]="
                                                    'Quick dice buttons usually roll in PECS, where you can send the result to foundry. With this option, quick dice buttons send the dice formula directly to Foundry, where it is evaluated.'
                                                "
                                            ></i>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="list-item">
                                <strong>Automation</strong>

                                <ng-template #ManualModeDescription>
                                    <p>
                                        Manual mode is for players who want more
                                        control over their attributes, or just
                                        need to restore a spell quickly. Many
                                        automatic and temporary effects are
                                        disabled in manual mode, and buttons are
                                        added that allow you to change them
                                        yourself. The main differences are
                                        listed below:
                                    </p>

                                    <header class="subsectionHeader">
                                        Conditions and effects
                                    </header>

                                    <ul>
                                        <li>
                                            Most mechanisms that would add
                                            conditions are disabled in manual
                                            mode. Conditions can be added
                                            manually from the conditions menu,
                                            including those that would normally
                                            be caused by activities, spells or
                                            items.
                                        </li>

                                        <li>
                                            Any conditions that remain when
                                            manual mode is enabled, or that are
                                            added manually afterwards, still
                                            cause effects.
                                        </li>

                                        <li>
                                            Conditions can still end
                                            automatically with time or through
                                            other factors, for example by
                                            decreasing their value every turn.
                                        </li>

                                        <li>Any custom effects still apply.</li>

                                        <li>
                                            Hints can still be activated and
                                            will then grant their respective
                                            effects.
                                        </li>

                                        <li>
                                            You cannot send or receive any
                                            conditions and effects to or from
                                            other players.
                                        </li>
                                    </ul>

                                    <header class="subsectionHeader">
                                        Activities
                                    </header>

                                    <ul>
                                        <li>
                                            Activities do not cause conditions
                                            or one-time effects (like temporary
                                            Hit Points).
                                        </li>

                                        <li>Activities do not cast spells.</li>

                                        <li>
                                            Because activities don't cause
                                            conditions or cast spells, you
                                            cannot select a target for an
                                            activity.
                                        </li>

                                        <li>
                                            Activities still grant items on
                                            activation (like extra attacks or
                                            transformed weapons).
                                        </li>

                                        <li>
                                            Activities use charges and go into
                                            cooldown. Charges can be restored
                                            and cooldown can be cancelled with a
                                            button.
                                        </li>
                                    </ul>

                                    <header class="subsectionHeader">
                                        Items
                                    </header>

                                    <ul>
                                        <li>
                                            Consumables do not cause conditions
                                            or one-time effects, and do not
                                            grant other items when activated
                                            (like extra attacks).
                                        </li>

                                        <li>Consumables do not cast spells.</li>

                                        <li>
                                            Because consumables don't cause
                                            conditions or cast spells, you
                                            cannot select a target for them.
                                        </li>

                                        <li>
                                            Activities on items can be activated
                                            and act according to the above
                                            description.
                                        </li>

                                        <li>
                                            Equipped and invested items still
                                            grant abilities, bonuses and
                                            penalties.
                                        </li>

                                        <li>
                                            Being encumbered does not cause the
                                            Encumbered condition.
                                        </li>
                                    </ul>

                                    <header class="subsectionHeader">
                                        Spells
                                    </header>

                                    <ul>
                                        <li>
                                            Spells do not cause conditions.
                                            Because all effects of a spell come
                                            from the conditions it causes, they
                                            don't cause any one-time effects,
                                            grant any items or senses or apply
                                            any bonuses or penalties.
                                        </li>

                                        <li>
                                            Because spells have no effects, you
                                            cannot select a target for them.
                                        </li>

                                        <li>
                                            Spells use up spell slots and focus
                                            points, and prepared spells get used
                                            up. Buttons are added to reprepare
                                            spells and restore spell slots and
                                            focus points.
                                        </li>

                                        <li>
                                            Spells can still go into cooldown,
                                            which can be cancelled with a
                                            button.
                                        </li>

                                        <li>
                                            Casting spells does not trigger
                                            bloodline powers in sorcerers.
                                        </li>
                                    </ul>

                                    <header class="subsectionHeader">
                                        Health
                                    </header>

                                    <ul>
                                        <li>
                                            The wounded and dying value is not
                                            tied to a condition. You can
                                            manually change both values with new
                                            buttons.
                                        </li>

                                        <li>
                                            Being reduced to 0 Hit Points does
                                            not cause the Dying or Unconscious
                                            conditions, and being healed from 0
                                            Hit points does not end them.
                                        </li>
                                    </ul>

                                    <header class="subsectionHeader">
                                        Feats
                                    </header>

                                    <ul>
                                        <li>
                                            Feats are unchanged, as their
                                            effects are not temporary.
                                        </li>

                                        <li>
                                            Feats still cause conditions and
                                            effects, and apply one-time effects
                                            when you take them.
                                        </li>
                                    </ul>
                                </ng-template>

                                <div class="list-item gridicon-fullsizebox">
                                    <input
                                        class="character-choice"
                                        id="manualMode"
                                        type="checkbox"
                                        [(ngModel)]="
                                            character.settings.manualMode
                                        "
                                        (change)="onToggleManualMode()"
                                    />
                                    <span>
                                        <label for="manualMode">
                                            <strong>Use manual mode</strong>
                                        </label>

                                        @if (!character.settings.manualMode) {
                                            <i
                                                class="bi-question-circle"
                                                autoClose="false"
                                                triggers="click"
                                                [ngbPopover]="
                                                    ManualModeDescription
                                                "
                                            ></i>
                                        }
                                    </span>
                                </div>

                                <div
                                    class="fullwidth"
                                    [ngbCollapse]="
                                        !character.settings.manualMode
                                    "
                                >
                                    <div class="lower">
                                        <ng-container
                                            *ngTemplateOutlet="
                                                ManualModeDescription
                                            "
                                        />
                                    </div>
                                </div>

                                <div
                                    class="fullwidth vlist"
                                    [ngbCollapse]="
                                        character.settings.manualMode
                                    "
                                >
                                    <div class="list-item gridicon-fullsizebox">
                                        <input
                                            class="character-choice"
                                            id="checkMessagesAutomatically"
                                            type="checkbox"
                                            [(ngModel)]="
                                                character.settings
                                                    .checkMessagesAutomatically
                                            "
                                        />
                                        <label for="checkMessagesAutomatically">
                                            <strong>
                                                Automatically check for new
                                                effects from other party members
                                            </strong>
                                        </label>
                                    </div>

                                    <div
                                        class="fullwidth"
                                        [ngbCollapse]="
                                            !character.settings
                                                .checkMessagesAutomatically
                                        "
                                    >
                                        <div
                                            class="list-item gridicon-fullsizebox"
                                        >
                                            <input
                                                class="character-choice"
                                                id="applyMessagesAutomatically"
                                                type="checkbox"
                                                [(ngModel)]="
                                                    character.settings
                                                        .applyMessagesAutomatically
                                                "
                                            />
                                            <span>
                                                <label
                                                    for="applyMessagesAutomatically"
                                                >
                                                    <strong
                                                        >Apply all new effects
                                                        automatically</strong
                                                    >
                                                </label>

                                                <i
                                                    class="bi-question-circle"
                                                    [ngbPopover]="
                                                        'While automatically checking for new effects, all new effects are immediately applied. You will not be able to select which effects to keep.'
                                                    "
                                                ></i>
                                            </span>
                                        </div>
                                    </div>

                                    <div class="list-item gridicon-fullsizebox">
                                        <input
                                            class="character-choice"
                                            id="sendTurnStartMessage"
                                            type="checkbox"
                                            [(ngModel)]="
                                                character.settings
                                                    .sendTurnStartMessage
                                            "
                                        />
                                        <span>
                                            <label for="sendTurnStartMessage">
                                                <strong>
                                                    Send an event to your party
                                                    when your turn starts
                                                </strong>
                                            </label>

                                            <i
                                                class="bi-question-circle"
                                                [ngbPopover]="
                                                    'If you have given any conditions to your party members that end on your turn, sending this event will end these conditions on their side. The other players still need to check for effects manually or automatically if they want to benefit from this function.'
                                                "
                                            ></i>
                                        </span>
                                    </div>

                                    <div
                                        class="fullwidth"
                                        [ngbCollapse]="
                                            !character.settings
                                                .sendTurnStartMessage
                                        "
                                    >
                                        <div
                                            class="list-item gridicon-fullsizebox"
                                        >
                                            <input
                                                class="character-choice"
                                                id="sendTurnEndMessage"
                                                type="checkbox"
                                                [(ngModel)]="
                                                    character.settings
                                                        .sendTurnEndMessage
                                                "
                                            />
                                            <label for="sendTurnEndMessage">
                                                <strong>
                                                    Send event when your turn
                                                    ends instead (experimental)
                                                </strong>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- History content -->
                    <!-- Alternative Ability Values content -->
                    @if (shownList() === "alternativeBaseValues") {
                        <div class="newrow list-item padding-8 center-aligned">
                            <header class="box-header sectionHeader">
                                Alternative Ability Values:
                                {{
                                    character.settings
                                        .useIndividualAbilityBaseValues
                                        ? "Used"
                                        : "Not used"
                                }}
                            </header>
                        </div>

                        <div
                            id="choiceArea"
                            class="list-item"
                        >
                            <div class="list-item">
                                <p>
                                    You can roll your own ability scores and
                                    enter them here. If you use these values,
                                    your character gets one fewer free ability
                                    boosts than normal from their ancestry and
                                    from their background. These ability boosts
                                    cannot raise a score above 18. If this would
                                    happen, you can put the ability boost into
                                    another ability score instead, as if it were
                                    a free ability boost. The character does not
                                    get any more free ability boosts on level 1.
                                </p>
                            </div>

                            <div class="list-item gridicon-fullsizebox">
                                <input
                                    id="useAlternativeBaseValues"
                                    class="character-choice"
                                    type="checkbox"
                                    [checked]="
                                        character.settings
                                            .useIndividualAbilityBaseValues
                                    "
                                    (change)="onBaseValueChange()"
                                />
                                <label for="useAlternativeBaseValues">
                                    <strong
                                        >Enter your own Ability scores</strong
                                    >
                                </label>
                            </div>

                            @for (
                                ability of character.baseValues;
                                track $index
                            ) {
                                <div class="list-item gridicon-fullsizebox">
                                    <input
                                        aria-label="Ability score input"
                                        type="number"
                                        class="number2"
                                        maxlength="2"
                                        [(ngModel)]="ability.baseValue"
                                        (blur)="
                                            onAbilityBaseValueChange(
                                                ability.name
                                            )
                                        "
                                        (keypress)="positiveNumbersOnly($event)"
                                    />
                                    <strong>{{ ability.name }}</strong>
                                </div>
                            }
                        </div>
                    }

                    <!-- Class choice content -->
                    @if (shownList() === "class") {
                        <div class="newrow list-item padding-8 center-aligned">
                            <header class="box-header sectionHeader">
                                Class{{
                                    character.class.name
                                        ? ": " + character.class.name
                                        : ""
                                }}
                            </header>
                        </div>

                        <div
                            id="choiceArea"
                            class="list-item"
                        >
                            @for (
                                class of availableClasses$() | async;
                                track $index
                            ) {
                                @for (
                                    checked of [
                                        class.name === character.class.name,
                                    ];
                                    track $index
                                ) {
                                    @for (
                                        disabled of [
                                            class.disabled ||
                                                (!!character.class.name &&
                                                    class.name !==
                                                        character.class.name),
                                        ];
                                        track $index
                                    ) {
                                        <ng-template
                                            #ClassChoiceDetailsTemplate
                                        >
                                            <header class="spellHeader">
                                                {{ class.name }}
                                            </header>

                                            @if (!disabled) {
                                                <div
                                                    class="button newrow no-animation"
                                                    [ngClass]="{
                                                        'fancy-button': checked,
                                                        disabled: disabled,
                                                    }"
                                                >
                                                    <label>
                                                        <input
                                                            type="checkbox"
                                                            hidden
                                                            [checked]="checked"
                                                            [disabled]="
                                                                disabled
                                                            "
                                                            (change)="
                                                                onClassChange(
                                                                    class,
                                                                    $event
                                                                )
                                                            "
                                                        />
                                                        {{
                                                            checked
                                                                ? "Remove"
                                                                : "Choose"
                                                        }}
                                                    </label>
                                                </div>
                                            }

                                            @if (class.sourceBook) {
                                                <div
                                                    class="newrow left-aligned"
                                                >
                                                    <strong>Source</strong>

                                                    <i>{{
                                                        class.sourceBook
                                                    }}</i>
                                                </div>
                                            }

                                            @for (
                                                desc of class.desc;
                                                track $index
                                            ) {
                                                <div
                                                    class="newrow left-aligned"
                                                >
                                                    @for (
                                                        text of desc.value.split(
                                                            "\n\n"
                                                        );
                                                        track $index
                                                    ) {
                                                        @if ($first) {
                                                            <header
                                                                class="featureHeader"
                                                            >
                                                                {{ desc.name }}
                                                            </header>
                                                        }

                                                        <app-description
                                                            class="newrow"
                                                            [text]="text"
                                                        />
                                                    }
                                                </div>
                                            }
                                        </ng-template>

                                        <div
                                            class="list-item gridicon-fullsizebox"
                                            [ngClass]="{ selected: checked }"
                                        >
                                            <input
                                                aria-label="Choose this class"
                                                type="checkbox"
                                                class="character-choice"
                                                id="{{ class.name }}"
                                                [checked]="checked"
                                                [disabled]="disabled"
                                                (change)="
                                                    onClassChange(class, $event)
                                                "
                                            />
                                            <div
                                                class="gridicon-fullsizebox"
                                                triggers="click"
                                                [ngbPopover]="
                                                    ClassChoiceDetailsTemplate
                                                "
                                            >
                                                <app-grid-icon
                                                    [title]="class.name"
                                                />

                                                <header class="sectionHeader">
                                                    @if (class.disabled) {
                                                        <i
                                                            style="
                                                                font-size: 200%;
                                                            "
                                                            class="penalty bi-exclamation-triangle"
                                                            [ngbTooltip]="
                                                                class.disabled
                                                            "
                                                        >
                                                        </i>
                                                    }

                                                    @if (class.warning) {
                                                        <i
                                                            style="
                                                                font-size: 200%;
                                                            "
                                                            class="absolute bi-exclamation-triangle"
                                                            [ngbTooltip]="
                                                                class.warning
                                                            "
                                                        >
                                                        </i>
                                                    }

                                                    <span>{{
                                                        class.name
                                                    }}</span>
                                                </header>
                                            </div>
                                        </div>
                                    }
                                }
                            }
                        </div>
                    }

                    <!-- Ancestry choice content -->
                    @if (shownList() === "ancestry") {
                        <div class="newrow list-item padding-8 center-aligned">
                            <header class="box-header sectionHeader">
                                Ancestry{{
                                    character.class.ancestry.name
                                        ? ": " + character.class.ancestry.name
                                        : ""
                                }}
                            </header>
                        </div>

                        <div
                            id="choiceArea"
                            class="list-item"
                        >
                            @for (
                                ancestry of availableAncestries$() | async;
                                track $index
                            ) {
                                @for (
                                    checked of [
                                        ancestry.name ===
                                            character.class.ancestry.name,
                                    ];
                                    track $index
                                ) {
                                    @for (
                                        disabled of [
                                            ancestry.disabled ||
                                                (!!character.class.ancestry
                                                    .name &&
                                                    ancestry.name !==
                                                        character.class.ancestry
                                                            .name),
                                        ];
                                        track $index
                                    ) {
                                        <ng-template
                                            #AncestryChoiceDetailsTemplate
                                        >
                                            <header class="spellHeader">
                                                {{ ancestry.name }}
                                            </header>

                                            @if (!disabled) {
                                                <div
                                                    class="button newrow no-animation"
                                                    [ngClass]="{
                                                        'fancy-button': checked,
                                                        disabled: disabled,
                                                    }"
                                                >
                                                    <label>
                                                        <input
                                                            type="checkbox"
                                                            hidden
                                                            [checked]="checked"
                                                            [disabled]="
                                                                disabled
                                                            "
                                                            (change)="
                                                                onAncestryChange(
                                                                    ancestry,
                                                                    $event
                                                                )
                                                            "
                                                        />
                                                        {{
                                                            checked
                                                                ? "Remove"
                                                                : "Choose"
                                                        }}
                                                    </label>
                                                </div>
                                            }

                                            <div
                                                class="newrow left-aligned tags"
                                            >
                                                @for (
                                                    trait of ancestry.traits;
                                                    track $index
                                                ) {
                                                    <app-trait
                                                        [name]="trait"
                                                        [trait]="
                                                            traitFromName(trait)
                                                        "
                                                    />
                                                }
                                            </div>

                                            @if (ancestry.sourceBook) {
                                                <div
                                                    class="newrow left-aligned"
                                                >
                                                    <strong>Source</strong>

                                                    <i>{{
                                                        ancestry.sourceBook
                                                    }}</i>
                                                </div>
                                            }

                                            @for (
                                                desc of ancestry.desc;
                                                track $index
                                            ) {
                                                <div
                                                    class="newrow left-aligned"
                                                >
                                                    @for (
                                                        text of desc.value.split(
                                                            "\n\n"
                                                        );
                                                        track $index
                                                    ) {
                                                        @if ($first) {
                                                            <header
                                                                class="featureHeader"
                                                            >
                                                                {{ desc.name }}
                                                            </header>
                                                        }

                                                        <app-description
                                                            class="newrow"
                                                            [text]="text"
                                                        />
                                                    }
                                                </div>
                                            }
                                        </ng-template>

                                        <div
                                            class="list-item gridicon-fullsizebox"
                                            [ngClass]="{ selected: checked }"
                                        >
                                            <input
                                                aria-label="Choose this ancestry"
                                                type="checkbox"
                                                class="character-choice"
                                                id="{{ ancestry.name }}"
                                                [checked]="checked"
                                                [disabled]="disabled"
                                                (change)="
                                                    onAncestryChange(
                                                        ancestry,
                                                        $event
                                                    )
                                                "
                                            />
                                            <div
                                                class="gridicon-fullsizebox"
                                                triggers="click"
                                                [ngbPopover]="
                                                    AncestryChoiceDetailsTemplate
                                                "
                                            >
                                                <app-grid-icon
                                                    [title]="ancestry.name"
                                                    [detail]="
                                                        ancestry.traits.includes(
                                                            'Rare'
                                                        )
                                                            ? 'Rare'
                                                            : ancestry.traits.includes(
                                                                    'Uncommon'
                                                                )
                                                              ? 'Uncommon'
                                                              : ''
                                                    "
                                                />

                                                <header class="sectionHeader">
                                                    @if (ancestry.disabled) {
                                                        <i
                                                            style="
                                                                font-size: 200%;
                                                            "
                                                            class="penalty bi-exclamation-triangle"
                                                            [ngbTooltip]="
                                                                ancestry.disabled
                                                            "
                                                        >
                                                        </i>
                                                    }

                                                    @if (ancestry.warning) {
                                                        <i
                                                            style="
                                                                font-size: 200%;
                                                            "
                                                            class="absolute bi-exclamation-triangle"
                                                            [ngbTooltip]="
                                                                ancestry.warning
                                                            "
                                                        >
                                                        </i>
                                                    }

                                                    <span>{{
                                                        ancestry.name
                                                    }}</span>

                                                    @for (
                                                        trait of [
                                                            "Rare",
                                                            "Uncommon",
                                                        ];
                                                        track $index
                                                    ) {
                                                        @if (
                                                            ancestry.traits.includes(
                                                                trait
                                                            )
                                                        ) {
                                                            <app-trait
                                                                [name]="trait"
                                                                [trait]="
                                                                    traitFromName(
                                                                        trait
                                                                    )
                                                                "
                                                            />
                                                        }
                                                    }
                                                </header>
                                            </div>
                                        </div>
                                    }
                                }
                            }
                        </div>
                    }

                    <!-- Heritage choice content -->
                    @if (shownList() === "heritage") {
                        <div class="newrow list-item padding-8 center-aligned">
                            <header class="box-header sectionHeader">
                                Heritage{{
                                    character.class.heritage.name
                                        ? ": " + character.class.heritage.name
                                        : ""
                                }}
                            </header>
                        </div>

                        <div
                            id="choiceArea"
                            class="list-item"
                        >
                            @for (
                                heritage of availableHeritages$(
                                    "",
                                    character.class.ancestry.name
                                ) | async;
                                track $index
                            ) {
                                @for (
                                    selected of [
                                        heritage.name ===
                                            character.class.heritage.name,
                                    ];
                                    track $index
                                ) {
                                    @for (
                                        checked of [
                                            !!selected ||
                                                !!doesCharacterHaveHeritage(
                                                    heritage.name
                                                ),
                                        ];
                                        track $index
                                    ) {
                                        @for (
                                            disabled of [
                                                !selected &&
                                                    (checked ||
                                                        !!character.class
                                                            .heritage.name),
                                            ];
                                            track $index
                                        ) {
                                            <ng-template
                                                #HeritageChoiceDetailsTemplate
                                            >
                                                <header class="spellHeader">
                                                    {{ heritage.name }}
                                                </header>

                                                @if (
                                                    !disabled &&
                                                    !heritage.subTypes.length
                                                ) {
                                                    <div
                                                        class="button newrow no-animation"
                                                        [ngClass]="{
                                                            'fancy-button':
                                                                selected,
                                                            disabled: disabled,
                                                        }"
                                                    >
                                                        <label>
                                                            <input
                                                                type="checkbox"
                                                                hidden
                                                                [checked]="
                                                                    selected
                                                                "
                                                                [disabled]="
                                                                    disabled
                                                                "
                                                                (change)="
                                                                    onHeritageChange(
                                                                        heritage,
                                                                        $event
                                                                    )
                                                                "
                                                            />
                                                            {{
                                                                selected
                                                                    ? "Remove"
                                                                    : "Choose"
                                                            }}
                                                        </label>
                                                    </div>
                                                }

                                                <div
                                                    class="newrow left-aligned tags"
                                                >
                                                    @for (
                                                        trait of heritage.traits;
                                                        track $index
                                                    ) {
                                                        <app-trait
                                                            [name]="trait"
                                                            [trait]="
                                                                traitFromName(
                                                                    trait
                                                                )
                                                            "
                                                        />
                                                    }
                                                </div>

                                                @if (heritage.sourceBook) {
                                                    <div
                                                        class="newrow left-aligned"
                                                    >
                                                        <strong>Source</strong>

                                                        <i>{{
                                                            heritage.sourceBook
                                                        }}</i>
                                                    </div>
                                                }

                                                <div
                                                    class="newrow left-aligned"
                                                >
                                                    @for (
                                                        desc of heritage.desc.split(
                                                            "\n\n"
                                                        );
                                                        track $index
                                                    ) {
                                                        <app-description
                                                            class="newrow"
                                                            [text]="desc"
                                                        />
                                                    }
                                                </div>

                                                @for (
                                                    activityName of heritage.gainActivities;
                                                    track $index
                                                ) {
                                                    @if (
                                                        activityFromName(
                                                            activityName
                                                        );
                                                        as activity
                                                    ) {
                                                        <div
                                                            class="newrow left-aligned"
                                                        >
                                                            <header
                                                                class="spellHeader left-aligned"
                                                            >
                                                                {{
                                                                    activity.name
                                                                }}
                                                                @if (
                                                                    activity.actions
                                                                ) {
                                                                    <app-action-icons
                                                                        [actionString]="
                                                                            activity.actions
                                                                        "
                                                                    />
                                                                }
                                                                {{
                                                                    activity.activationType
                                                                        ? activity.activationType
                                                                        : ""
                                                                }}
                                                            </header>

                                                            <app-activity
                                                                class="newrow"
                                                                [activity]="
                                                                    activity
                                                                "
                                                                [allowActivate]="
                                                                    false
                                                                "
                                                            />
                                                        </div>
                                                    }
                                                }

                                                <!-- Subheritages -->
                                                @for (
                                                    subheritage of heritage.subTypes;
                                                    track $index
                                                ) {
                                                    @for (
                                                        subheritageSelected of [
                                                            subheritage.name ===
                                                                character.class
                                                                    .heritage
                                                                    .name,
                                                        ];
                                                        track $index
                                                    ) {
                                                        @for (
                                                            subheritageChecked of [
                                                                subheritageSelected ||
                                                                    doesCharacterHaveHeritage(
                                                                        heritage.name
                                                                    ),
                                                            ];
                                                            track $index
                                                        ) {
                                                            @for (
                                                                subheritageDisabled of [
                                                                    !subheritageSelected &&
                                                                        (subheritageChecked ||
                                                                            character
                                                                                .class
                                                                                .heritage
                                                                                .name),
                                                                ];
                                                                track $index
                                                            ) {
                                                                <div
                                                                    class="list-item"
                                                                    [ngClass]="{
                                                                        selected:
                                                                            subheritageSelected,
                                                                    }"
                                                                >
                                                                    <div
                                                                        class="gridicon-fullsizebox lower"
                                                                    >
                                                                        <input
                                                                            aria-label="Choose this sub-heritage"
                                                                            type="checkbox"
                                                                            class="character-choice"
                                                                            id="{{
                                                                                subheritage.name
                                                                            }}"
                                                                            [checked]="
                                                                                subheritageChecked
                                                                            "
                                                                            [disabled]="
                                                                                subheritageDisabled
                                                                            "
                                                                            (change)="
                                                                                onHeritageChange(
                                                                                    subheritage,
                                                                                    $event
                                                                                )
                                                                            "
                                                                        />
                                                                        <label
                                                                            for="{{
                                                                                subheritage.name
                                                                            }}"
                                                                        >
                                                                            <strong
                                                                                >{{
                                                                                    subheritage.subType
                                                                                }}</strong
                                                                            >
                                                                        </label>
                                                                    </div>
                                                                </div>
                                                            }
                                                        }
                                                    }
                                                }

                                                <!-- End Subheritages -->
                                            </ng-template>

                                            <div
                                                class="list-item gridicon-fullsizebox"
                                                [ngClass]="{
                                                    selected: selected,
                                                }"
                                            >
                                                @if (
                                                    !heritage.subTypes.length
                                                ) {
                                                    <input
                                                        aria-label="Choose this heritage"
                                                        type="checkbox"
                                                        class="character-choice"
                                                        id="{{ heritage.name }}"
                                                        [checked]="checked"
                                                        [disabled]="disabled"
                                                        (change)="
                                                            onHeritageChange(
                                                                heritage,
                                                                $event
                                                            )
                                                        "
                                                    />
                                                }
                                                @if (heritage.subTypes.length) {
                                                    <button
                                                        type="button"
                                                        class="character-choice"
                                                        (click)="
                                                            HeritageChoiceDetailsPopover.toggle()
                                                        "
                                                    >
                                                        +
                                                    </button>
                                                }

                                                <div
                                                    #HeritageChoiceDetailsPopover="ngbPopover"
                                                    class="gridicon-fullsizebox"
                                                    triggers="click"
                                                    [ngbPopover]="
                                                        HeritageChoiceDetailsTemplate
                                                    "
                                                >
                                                    <app-grid-icon
                                                        [title]="heritage.name"
                                                        [detail]="
                                                            heritage.traits.includes(
                                                                'Rare'
                                                            )
                                                                ? 'Rare'
                                                                : heritage.traits.includes(
                                                                        'Uncommon'
                                                                    )
                                                                  ? 'Uncommon'
                                                                  : ''
                                                        "
                                                    />

                                                    <header
                                                        class="sectionHeader"
                                                    >
                                                        <span
                                                            >{{
                                                                heritage.name
                                                            }}&nbsp;</span
                                                        >

                                                        @for (
                                                            trait of [
                                                                "Rare",
                                                                "Uncommon",
                                                            ];
                                                            track $index
                                                        ) {
                                                            @if (
                                                                heritage.traits.includes(
                                                                    trait
                                                                )
                                                            ) {
                                                                <app-trait
                                                                    [name]="
                                                                        trait
                                                                    "
                                                                    [trait]="
                                                                        traitFromName(
                                                                            trait
                                                                        )
                                                                    "
                                                                />
                                                            }
                                                        }
                                                    </header>
                                                </div>
                                            </div>
                                        }
                                    }
                                }
                            }
                        </div>
                    }

                    <!-- Languages content -->
                    @if (shownList() === "languages") {
                        <div class="newrow list-item padding-8 center-aligned">
                            <header class="box-header sectionHeader">
                                Languages
                            </header>
                        </div>

                        <div
                            id="choiceArea"
                            class="list-item"
                        >
                            @if (
                                character.class.ancestry.recommendedLanguages
                                    .length
                            ) {
                                <div class="newrow list-item left-aligned">
                                    <strong>Recommended Languages</strong>
                                    {{
                                        character.class.ancestry.recommendedLanguages.join(
                                            ", "
                                        )
                                    }}
                                </div>
                            }

                            @for (
                                language of character.class.languages;
                                track $index
                            ) {
                                @if (
                                    !language.level ||
                                    language.level <= shownContentLevelNumber()
                                ) {
                                    <div class="list-item">
                                        <ng-template #LanguageSource>
                                            <div class="newrow">
                                                <span>
                                                    <strong>Granted by</strong>
                                                    {{ language.source }}
                                                </span>
                                            </div>

                                            @if (language.level > 0) {
                                                <div class="newrow">
                                                    <span>
                                                        <strong>Level</strong>
                                                        {{ language.level }}
                                                    </span>
                                                </div>
                                            }
                                        </ng-template>

                                        <div
                                            class="newrow"
                                            [ngbPopover]="
                                                language.source
                                                    ? LanguageSource
                                                    : null
                                            "
                                        >
                                            <input
                                                aria-label="Language name input"
                                                class="newrow"
                                                type="text"
                                                [disabled]="language.locked"
                                                [(ngModel)]="language.name"
                                                (blur)="onLanguageChange()"
                                            />
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    }

                    <!-- Background choice content -->
                    @if (shownList() === "background") {
                        <div class="newrow list-item padding-8 center-aligned">
                            <header class="box-header sectionHeader">
                                Background{{
                                    character.class.background.name
                                        ? ": " + character.class.background.name
                                        : ""
                                }}
                            </header>
                        </div>

                        <!-- Filter -->
                        <div
                            class="list-item"
                            style="margin: 0"
                        >
                            <strong>Filter</strong>

                            <div class="list-item gridicon-fullsizebox">
                                <input
                                    aria-label="Toggle showing adventure backgrounds"
                                    class="character-choice"
                                    id="adventureBackgroundsFilter"
                                    type="checkbox"
                                    [(ngModel)]="adventureBackgrounds"
                                />
                                <label for="adventureBackgroundsFilter">
                                    <strong>Show adventure backgrounds</strong>
                                </label>
                            </div>

                            <div class="list-item gridicon-fullsizebox">
                                <input
                                    aria-label="Toggle showing regional backgrounds"
                                    class="character-choice"
                                    id="regionalBackgroundsFilter"
                                    type="checkbox"
                                    [(ngModel)]="regionalBackgrounds"
                                />
                                <label for="regionalBackgroundsFilter">
                                    <strong>Show regional backgrounds</strong>
                                </label>
                            </div>
                        </div>

                        <div
                            id="choiceArea"
                            class="list-item"
                        >
                            <!-- End Filter -->
                            @for (
                                background of availableBackgrounds$() | async;
                                track $index
                            ) {
                                @for (
                                    checked of [
                                        background.name ===
                                            character.class.background.name ||
                                            background.name ===
                                                character.class.background
                                                    .superType,
                                    ];
                                    track $index
                                ) {
                                    @for (
                                        disabled of [
                                            !!character.class.background.name &&
                                                background.name !==
                                                    character.class.background
                                                        .name,
                                        ];
                                        track $index
                                    ) {
                                        <ng-template
                                            #BackgroundChoiceDetailsTemplate
                                        >
                                            <header class="spellHeader">
                                                {{ background.name }}
                                            </header>

                                            @if (
                                                !disabled &&
                                                !background.subTypes
                                            ) {
                                                <div
                                                    class="button newrow no-animation"
                                                    [ngClass]="{
                                                        'fancy-button': checked,
                                                        disabled: disabled,
                                                    }"
                                                >
                                                    <label>
                                                        <input
                                                            type="checkbox"
                                                            hidden
                                                            [checked]="checked"
                                                            [disabled]="
                                                                disabled
                                                            "
                                                            (change)="
                                                                onBackgroundChange(
                                                                    background,
                                                                    $event
                                                                )
                                                            "
                                                        />
                                                        {{
                                                            checked
                                                                ? "Remove"
                                                                : "Choose"
                                                        }}
                                                    </label>
                                                </div>
                                            }

                                            <div
                                                class="newrow left-aligned tags"
                                            >
                                                @for (
                                                    trait of background.traits;
                                                    track $index
                                                ) {
                                                    <app-trait
                                                        [name]="trait"
                                                        [trait]="
                                                            traitFromName(trait)
                                                        "
                                                    />
                                                }
                                            </div>

                                            @if (background.sourceBook) {
                                                <div
                                                    class="newrow left-aligned"
                                                >
                                                    <strong>Source</strong>

                                                    <i>{{
                                                        background.sourceBook
                                                    }}</i>
                                                </div>
                                            }

                                            @if (background.prerequisites) {
                                                <div
                                                    class="newrow left-aligned"
                                                >
                                                    <strong
                                                        >Prerequisites</strong
                                                    >
                                                    {{
                                                        background.prerequisites
                                                    }}
                                                </div>
                                            }

                                            @if (background.region) {
                                                <div
                                                    class="newrow left-aligned"
                                                >
                                                    <strong>Region</strong>
                                                    {{ background.region }}
                                                </div>
                                            }

                                            <div class="newrow left-aligned">
                                                @for (
                                                    desc of background.desc.split(
                                                        "\n\n"
                                                    );
                                                    track $index
                                                ) {
                                                    <app-description
                                                        class="newrow"
                                                        [text]="desc"
                                                    />
                                                }
                                            </div>

                                            @if (background.inputRequired) {
                                                <div
                                                    class="list-item lower newrow problem"
                                                >
                                                    <strong
                                                        >Player input
                                                        required:</strong
                                                    >

                                                    @for (
                                                        inputRequired of background.inputRequired.split(
                                                            "\n\n"
                                                        );
                                                        track $index
                                                    ) {
                                                        <div
                                                            class="newrow left-aligned"
                                                        >
                                                            <app-description
                                                                class="newrow"
                                                                [text]="
                                                                    inputRequired
                                                                "
                                                            />
                                                        </div>
                                                    }
                                                </div>
                                            }

                                            <!-- Subbackgrounds -->
                                            @for (
                                                subbackground of subTypesOfBackground(
                                                    background.name
                                                );
                                                track $index
                                            ) {
                                                <div
                                                    class="list-item"
                                                    [ngClass]="{
                                                        selected:
                                                            subbackground.name ===
                                                            character.class
                                                                .background
                                                                .name,
                                                    }"
                                                >
                                                    <div
                                                        class="gridicon-fullsizebox lower"
                                                    >
                                                        <input
                                                            type="checkbox"
                                                            class="character-choice"
                                                            id="{{
                                                                subbackground.name
                                                            }}"
                                                            [checked]="
                                                                subbackground.name ===
                                                                character.class
                                                                    .background
                                                                    .name
                                                            "
                                                            [disabled]="
                                                                character.class
                                                                    .background
                                                                    .name &&
                                                                subbackground.name !==
                                                                    character
                                                                        .class
                                                                        .background
                                                                        .name
                                                            "
                                                            (change)="
                                                                onBackgroundChange(
                                                                    subbackground,
                                                                    $event
                                                                )
                                                            "
                                                        />
                                                        <label
                                                            for="{{
                                                                subbackground.name
                                                            }}"
                                                        >
                                                            <strong>{{
                                                                subbackground.subType
                                                            }}</strong>
                                                        </label>
                                                    </div>
                                                </div>
                                            }

                                            <!-- End Subbackgrounds -->
                                        </ng-template>

                                        <div
                                            class="list-item gridicon-fullsizebox"
                                            [ngClass]="{ selected: checked }"
                                        >
                                            @if (!background.subTypes) {
                                                <input
                                                    aria-label="Choose this sub-background"
                                                    type="checkbox"
                                                    class="character-choice"
                                                    id="{{ background.name }}"
                                                    [checked]="checked"
                                                    [disabled]="disabled"
                                                    (change)="
                                                        onBackgroundChange(
                                                            background,
                                                            $event
                                                        )
                                                    "
                                                />
                                            }
                                            @if (background.subTypes) {
                                                <button
                                                    type="button"
                                                    class="character-choice"
                                                    (click)="
                                                        BackgroundChoiceDetailsPopover.toggle()
                                                    "
                                                >
                                                    +
                                                </button>
                                            }

                                            <div
                                                #BackgroundChoiceDetailsPopover="ngbPopover"
                                                class="gridicon-fullsizebox"
                                                triggers="click"
                                                [ngbPopover]="
                                                    BackgroundChoiceDetailsTemplate
                                                "
                                            >
                                                <app-grid-icon
                                                    [title]="background.name"
                                                    [detail]="
                                                        background.traits.includes(
                                                            'Rare'
                                                        )
                                                            ? 'Rare'
                                                            : background.traits.includes(
                                                                    'Uncommon'
                                                                )
                                                              ? 'Uncommon'
                                                              : ''
                                                    "
                                                />

                                                <header class="sectionHeader">
                                                    <span
                                                        >{{
                                                            background.name
                                                        }}&nbsp;</span
                                                    >

                                                    @for (
                                                        trait of [
                                                            "Rare",
                                                            "Uncommon",
                                                            "Adventure",
                                                            "Regional",
                                                        ];
                                                        track $index
                                                    ) {
                                                        @if (
                                                            background.traits.includes(
                                                                trait
                                                            )
                                                        ) {
                                                            <app-trait
                                                                [name]="trait"
                                                                [trait]="
                                                                    traitFromName(
                                                                        trait
                                                                    )
                                                                "
                                                            />
                                                        }
                                                    }
                                                </header>
                                            </div>
                                        </div>
                                    }
                                }
                            }
                        </div>
                    }

                    <!-- Deity choice content -->
                    @if (shownList() === "deity") {
                        <div class="newrow list-item padding-8 center-aligned">
                            <header class="box-header sectionHeader">
                                Deity{{
                                    character.class.deity
                                        ? ": " + character.class.deity
                                        : ""
                                }}
                            </header>
                        </div>

                        <!-- Filter -->
                        <div
                            class="list-item lower"
                            style="margin: 0"
                        >
                            <strong
                                >Find (in Name, Description or Domains)</strong
                            >

                            <span class="hlist">
                                <input
                                    aria-label="Deity search text"
                                    id="deityWordFilter"
                                    type="text"
                                    [(ngModel)]="deityWordFilter"
                                />
                            </span>
                        </div>

                        <div
                            id="choiceArea"
                            class="list-item"
                        >
                            @for (
                                deity of availableDeities$({
                                    filterForSyncretism: false,
                                }) | async;
                                track $index
                            ) {
                                @for (
                                    checked of [
                                        deity.name === character.class.deity,
                                    ];
                                    track $index
                                ) {
                                    @for (
                                        disabled of [
                                            !!character.class.deity &&
                                                deity.name !==
                                                    character.class.deity,
                                        ];
                                        track $index
                                    ) {
                                        <ng-template
                                            #DeityChoiceDetailsTemplate
                                        >
                                            <header class="spellHeader">
                                                {{ deity.name }}
                                            </header>

                                            @if (!disabled) {
                                                <div
                                                    class="button newrow no-animation"
                                                    [ngClass]="{
                                                        'fancy-button': checked,
                                                        disabled: disabled,
                                                    }"
                                                >
                                                    <label>
                                                        <input
                                                            type="checkbox"
                                                            hidden
                                                            [checked]="checked"
                                                            [disabled]="
                                                                disabled
                                                            "
                                                            (change)="
                                                                onDeityChange(
                                                                    deity,
                                                                    $event
                                                                )
                                                            "
                                                        />
                                                        {{
                                                            checked
                                                                ? "Remove"
                                                                : "Choose"
                                                        }}
                                                    </label>
                                                </div>
                                            }

                                            @if (deity.nickname) {
                                                <header
                                                    class="subsectionHeader"
                                                >
                                                    {{ deity.nickname }}
                                                </header>
                                            }

                                            @if (deity.sourceBook) {
                                                <div
                                                    class="newrow left-aligned"
                                                >
                                                    <strong>Source</strong>

                                                    <i>{{
                                                        deity.sourceBook
                                                    }}</i>
                                                </div>
                                            }

                                            @for (
                                                desc of deity.desc.split(
                                                    "\n\n"
                                                );
                                                track $index
                                            ) {
                                                <app-description
                                                    class="newrow"
                                                    [text]="desc"
                                                />
                                            }

                                            @if (deity.edicts) {
                                                <div
                                                    class="newrow left-aligned gap-text"
                                                >
                                                    <strong>Edicts</strong>
                                                    {{
                                                        deity.edicts.join(", ")
                                                    }}
                                                </div>
                                            }

                                            @if (deity.anathema) {
                                                <div
                                                    class="newrow left-aligned gap-text"
                                                >
                                                    <strong>Anathema</strong>
                                                    {{
                                                        deity.anathema.join(
                                                            ", "
                                                        )
                                                    }}
                                                </div>
                                            }

                                            @if (deity.areasOfConcern) {
                                                <div
                                                    class="newrow left-aligned gap-text"
                                                >
                                                    <strong
                                                        >Areas of
                                                        Concern</strong
                                                    >
                                                    {{ deity.areasOfConcern }}
                                                </div>
                                            }

                                            @if (
                                                deity.followerAlignments.length
                                            ) {
                                                <div
                                                    class="newrow left-aligned gap-text"
                                                >
                                                    <strong
                                                        >Follower
                                                        Alignments</strong
                                                    >
                                                    {{
                                                        deity.followerAlignments.join(
                                                            ", "
                                                        )
                                                    }}
                                                </div>
                                            }

                                            @if (deity.pantheonMembers.length) {
                                                <div
                                                    class="newrow left-aligned gap-text"
                                                >
                                                    <strong
                                                        >Pantheon
                                                        Members</strong
                                                    >
                                                    {{
                                                        deity.pantheonMembers.join(
                                                            ", "
                                                        )
                                                    }}
                                                </div>
                                            }

                                            @if (deity.divineAbility.length) {
                                                <div
                                                    class="newrow left-aligned gap-text"
                                                >
                                                    <strong
                                                        >Divine Ability</strong
                                                    >
                                                    {{
                                                        deity.divineAbility.join(
                                                            " or "
                                                        )
                                                    }}
                                                </div>
                                            }

                                            @if (deity.divineFont.length) {
                                                <div
                                                    class="newrow left-aligned gap-text"
                                                >
                                                    <strong>Divine Font</strong>
                                                    {{
                                                        deity.divineFont.join(
                                                            " or "
                                                        )
                                                    }}
                                                </div>
                                            }

                                            @if (deity.divineSkill.length) {
                                                <div
                                                    class="newrow left-aligned gap-text"
                                                >
                                                    <strong
                                                        >Divine Skill</strong
                                                    >
                                                    {{
                                                        deity.divineSkill.join(
                                                            " or "
                                                        )
                                                    }}
                                                </div>
                                            }

                                            @if (deity.favoredWeapon.length) {
                                                <div
                                                    class="newrow left-aligned gap-text"
                                                >
                                                    <strong
                                                        >Favored Weapon</strong
                                                    >
                                                    {{
                                                        deity.favoredWeapon.join(
                                                            " or "
                                                        )
                                                    }}
                                                </div>
                                            }

                                            @if (deity.domains.length) {
                                                <div
                                                    class="newrow left-aligned gap-text"
                                                >
                                                    <strong>Domains</strong>
                                                    {{
                                                        deity.domains.join(", ")
                                                    }}
                                                </div>
                                            }

                                            @if (
                                                deity.alternateDomains.length
                                            ) {
                                                <div
                                                    class="newrow left-aligned gap-text"
                                                >
                                                    <strong
                                                        >Alternate
                                                        Domains</strong
                                                    >
                                                    {{
                                                        deity.alternateDomains.join(
                                                            ", "
                                                        )
                                                    }}
                                                </div>
                                            }

                                            @if (deity.clericSpells.length) {
                                                <div
                                                    class="newrow left-aligned"
                                                >
                                                    <strong
                                                        >Cleric Spells</strong
                                                    >
                                                </div>

                                                @for (
                                                    spell of deity.clericSpells;
                                                    track $index
                                                ) {
                                                    <div
                                                        class="list-item lower left-aligned"
                                                    >
                                                        <strong
                                                            >Level
                                                            {{
                                                                spell.level
                                                            }}</strong
                                                        >
                                                        {{ spell.name }}
                                                        {{
                                                            spell.restrictionDesc
                                                                ? "(" +
                                                                  spell.restrictionDesc +
                                                                  ")"
                                                                : ""
                                                        }}
                                                    </div>
                                                }
                                            }
                                        </ng-template>

                                        <div
                                            class="list-item gridicon-fullsizebox"
                                            [ngClass]="{ selected: checked }"
                                        >
                                            <input
                                                aria-label="Choose this deity"
                                                type="checkbox"
                                                class="character-choice"
                                                id="{{ deity.name }}"
                                                [checked]="checked"
                                                [disabled]="disabled"
                                                (change)="
                                                    onDeityChange(deity, $event)
                                                "
                                            />
                                            <div
                                                class="gridicon-fullsizebox"
                                                triggers="click"
                                                [ngbPopover]="
                                                    DeityChoiceDetailsTemplate
                                                "
                                            >
                                                <app-grid-icon
                                                    [title]="deity.name"
                                                    [detail]="deity.alignment"
                                                />

                                                <header class="sectionHeader">
                                                    <span>{{
                                                        deity.name
                                                    }}</span>

                                                    @if (deity.alignment) {
                                                        <cite class="trait">
                                                            {{
                                                                deity.alignment
                                                            }}
                                                        </cite>
                                                    }
                                                </header>
                                            </div>
                                        </div>
                                    }
                                }
                            }
                        </div>
                    }

                    <!-- Level content -->
                    <!-- Ability Choice Content -->
                    @if (
                        activeAbilityChoiceContent$ | async;
                        as abilityContent
                    ) {
                        <div class="newrow list-item padding-8 center-aligned">
                            <header class="box-header sectionHeader">
                                {{ abilityChoiceTitle(abilityContent.choice) }}
                            </header>

                            <div class="newrow center-aligned">
                                <span>
                                    @if (abilityContent.choice.bonus) {
                                        <button
                                            type="button"
                                            class="center-aligned"
                                            (click)="
                                                removeBonusAbilityChoice(
                                                    abilityContent.choice,
                                                    abilityContent.levelNumber
                                                )
                                            "
                                        >
                                            Remove bonus ability choice
                                        </button>
                                    }
                                </span>
                            </div>
                        </div>

                        <div
                            id="choiceArea"
                            class="list-item"
                        >
                            @for (
                                ability of availableAbilities$(
                                    abilityContent.choice,
                                    abilityContent.levelNumber
                                ) | async;
                                track $index
                            ) {
                                @for (
                                    checked of [
                                        isAbilityTakenByThisChoice(
                                            ability,
                                            abilityContent.choice,
                                            abilityContent.levelNumber
                                        ),
                                    ];
                                    track $index
                                ) {
                                    @for (
                                        disabled of [
                                            abilityChoiceDisabled$(
                                                abilityContent.choice,
                                                ability,
                                                abilityContent.levelNumber,
                                                checked
                                            ) | async,
                                        ];
                                        track $index
                                    ) {
                                        <div
                                            class="list-item gridicon-fullsizebox"
                                            [ngClass]="{
                                                selected: checked,
                                                problem: isAbilityIllegal$(
                                                    abilityContent.levelNumber,
                                                    ability
                                                ),
                                            }"
                                        >
                                            <input
                                                aria-label="Boost this ability"
                                                type="checkbox"
                                                class="character-choice"
                                                id="{{ ability.name }}"
                                                [checked]="checked"
                                                [disabled]="disabled"
                                                (change)="
                                                    onBoostAbility(
                                                        ability.name,
                                                        $event,
                                                        abilityContent.choice,
                                                        false
                                                    )
                                                "
                                            />
                                            @if (
                                                abilityBaseValue$(
                                                    ability,
                                                    abilityContent.levelNumber
                                                ) | async;
                                                as baseValue
                                            ) {
                                                <div
                                                    class="gridicon-fullsizebox"
                                                >
                                                    <!--
                                                A BonusDescription goes here as the popover
                                                <app-grid-icon
                                                    [title]="ability.name"
                                                    [ngbPopover]="baseValue.explain"
                                                    triggers="hover:click"
                                                    [openDelay]=1
                                                    [superTitle]="baseValue.result.toString()"
                                                >
                                                </app-grid-icon>
                                            -->
                                                    <app-grid-icon
                                                        triggers="hover:click"
                                                        [title]="ability.name"
                                                        [superTitle]="
                                                            baseValue.result.toString()
                                                        "
                                                    />

                                                    <header
                                                        class="sectionHeader"
                                                    >
                                                        <span
                                                            >{{
                                                                ability.name
                                                            }}&nbsp;</span
                                                        >

                                                        @for (
                                                            reason of cannotBoostAbilityReasons$(
                                                                ability,
                                                                abilityContent.levelNumber,
                                                                abilityContent.choice
                                                            ) | async;
                                                            track $index
                                                        ) {
                                                            <cite
                                                                class="problem"
                                                            >
                                                                {{ reason }}
                                                            </cite>
                                                        }

                                                        @if (
                                                            isAbilityIllegal$(
                                                                abilityContent.levelNumber,
                                                                ability
                                                            )
                                                        ) {
                                                            <cite
                                                                class="problem"
                                                                [ngbPopover]="
                                                                    'Abilities cannot be raised above 18 on level 1.'
                                                                "
                                                            >
                                                                Limit reached
                                                            </cite>
                                                        }
                                                    </header>
                                                </div>
                                            }
                                        </div>
                                    }
                                }
                            }
                        </div>
                    }

                    <!-- Skill Choice Content -->
                    @if (activeSkillChoiceContent$ | async; as skillContent) {
                        <app-skill-choice
                            [choice]="skillContent.choice"
                            [levelNumber]="skillContent.levelNumber"
                            [showTitle]="false"
                            [showChoice]="skillContent.name"
                            [excludeTemporary]="true"
                            (showSkillChoiceMessage)="
                                receiveChoiceMessage($event)
                            "
                        />
                    }

                    <!-- Feat Choice Content -->
                    @if (activeFeatChoiceContent$ | async; as featContent) {
                        <app-feat-choice
                            [choice]="featContent.choice"
                            [levelNumber]="featContent.levelNumber"
                            [showTitle]="false"
                            [showFeat]="shownItem()"
                            [showChoice]="featContent.name"
                            [showArchetypeFeats]="
                                character.settings.archetypeFeats
                            "
                            (showFeatChoiceMessage)="
                                receiveChoiceMessage($event)
                            "
                            (showFeatMessage)="receiveFeatMessage($event)"
                        />
                    }

                    <!-- Lore Training content -->
                    @if (activeLoreChoiceContent$ | async; as loreContent) {
                        <div class="newrow list-item padding-8 center-aligned">
                            <header class="box-header sectionHeader">
                                Lore Training ({{
                                    loreContent.choice.source
                                }}){{
                                    loreContent.choice.increases.length
                                        ? ": " + loreContent.choice.loreName
                                        : ""
                                }}
                            </header>

                            <div class="newrow center-aligned">
                                <span>
                                    @if (loreContent.choice.bonus) {
                                        <button
                                            type="button"
                                            class="center-aligned"
                                            (click)="
                                                removeBonusLoreChoice(
                                                    loreContent.choice,
                                                    loreContent.levelNumber
                                                )
                                            "
                                        >
                                            Remove bonus lore training
                                        </button>
                                    }
                                </span>
                            </div>
                        </div>

                        <div
                            id="choiceArea"
                            class="list-item"
                        >
                            @for (
                                checked of [
                                    !!skillIncreasesByLevel(
                                        loreContent.levelNumber,
                                        "Lore: " + loreContent.choice.loreName,
                                        loreContent.choice.source,
                                        loreContent.choice.id
                                    ).length,
                                ];
                                track $index
                            ) {
                                @for (
                                    illegal of [
                                        skills(
                                            "Lore: " +
                                                loreContent.choice.loreName,
                                            {},
                                            { noSubstitutions: true }
                                        ).length && !checked,
                                    ];
                                    track $index
                                ) {
                                    @for (
                                        disabled of [
                                            !loreContent.choice.loreName ||
                                                !!illegal,
                                        ];
                                        track $index
                                    ) {
                                        @if (loreContent.choice.loreDesc) {
                                            <div
                                                class="newrow left-aligned list-item"
                                            >
                                                <strong>Lore Type</strong>
                                                {{
                                                    loreContent.choice.loreDesc
                                                }}
                                            </div>
                                        }

                                        <div
                                            class="newrow list-item gridicon-fullsizebox"
                                        >
                                            <div
                                                class="button no-animation"
                                                style="max-width: fit-content"
                                                [ngClass]="{
                                                    'fancy-button': checked,
                                                    disabled: disabled,
                                                }"
                                            >
                                                <label>
                                                    <input
                                                        type="checkbox"
                                                        hidden
                                                        id="{{
                                                            loreContent.choice
                                                                .id
                                                        }}"
                                                        [checked]="checked"
                                                        [disabled]="disabled"
                                                        (change)="
                                                            onLoreChange(
                                                                $event,
                                                                loreContent.choice
                                                            )
                                                        "
                                                    />
                                                    {{
                                                        checked
                                                            ? "Change"
                                                            : "Save"
                                                    }}
                                                </label>
                                            </div>

                                            <header
                                                class="sectionHeader gap-text"
                                            >
                                                @if (illegal) {
                                                    <cite class="problem">
                                                        Lore already trained
                                                    </cite>
                                                }

                                                <input
                                                    aria-label="Lore name input"
                                                    id="LoreName"
                                                    class="short"
                                                    type="text"
                                                    maxLength="20"
                                                    [disabled]="checked"
                                                    [(ngModel)]="
                                                        loreContent.choice
                                                            .loreName
                                                    "
                                                    (blur)="onLoreNameChange()"
                                                />
                                                <span>Lore</span>
                                            </header>
                                        </div>
                                    }
                                }
                            }
                        </div>
                    }

                    <!-- Animal Companion Content -->
                    @if (
                        activeSpecialChoiceShown("animalcompanion");
                        as companionContent
                    ) {
                        @if (animalCompanion$ | async; as companion) {
                            <div
                                class="newrow list-item padding-8 center-aligned"
                            >
                                <header class="box-header sectionHeader">
                                    Animal Companion{{
                                        companion.class.ancestry.name
                                            ? ": " +
                                              companion.class.ancestry.name
                                            : ""
                                    }}
                                </header>
                            </div>

                            <div
                                id="choiceArea"
                                class="list-item"
                            >
                                <div class="newrow list-item">
                                    <button
                                        type="button"
                                        class="newrow list-item"
                                        (click)="onResetCompanion()"
                                    >
                                        <header class="sectionHeader">
                                            Reset Animal Companion
                                        </header>
                                    </button>

                                    <div class="newrow list-item left-aligned">
                                        <strong>Name</strong>

                                        <input
                                            aria-label="Animal companion name input"
                                            id="CompanionName"
                                            type="text"
                                            maxLength="30"
                                            [(ngModel)]="companion.name"
                                        />
                                    </div>

                                    <div class="newrow list-item left-aligned">
                                        <strong>Animal</strong>

                                        <input
                                            aria-label="Animal companion animal input"
                                            id="CompanionSpecies"
                                            type="text"
                                            maxLength="30"
                                            [(ngModel)]="companion.species"
                                        />
                                    </div>
                                </div>

                                <div class="list-item transparent">
                                    <header class="sectionHeader">Type</header>
                                </div>

                                @for (
                                    type of availableCompanionTypes$() | async;
                                    track $index
                                ) {
                                    @for (
                                        checked of [
                                            type.name ===
                                                companion.class.ancestry.name,
                                        ];
                                        track $index
                                    ) {
                                        @for (
                                            disabled of [
                                                !!companion.class.ancestry
                                                    .name &&
                                                    type.name !==
                                                        companion.class.ancestry
                                                            .name,
                                            ];
                                            track $index
                                        ) {
                                            <ng-template
                                                #AnimalCompanionDetailsTemplate
                                            >
                                                <header class="spellHeader">
                                                    {{ type.name }}
                                                </header>

                                                @if (!disabled) {
                                                    <div
                                                        class="button newrow no-animation"
                                                        [ngClass]="{
                                                            'fancy-button':
                                                                checked,
                                                            disabled: disabled,
                                                        }"
                                                    >
                                                        <label>
                                                            <input
                                                                type="checkbox"
                                                                hidden
                                                                [checked]="
                                                                    checked
                                                                "
                                                                [disabled]="
                                                                    disabled
                                                                "
                                                                (change)="
                                                                    onChangeCompanionType(
                                                                        type,
                                                                        $event
                                                                    )
                                                                "
                                                            />
                                                            {{
                                                                checked
                                                                    ? "Remove"
                                                                    : "Choose"
                                                            }}
                                                        </label>
                                                    </div>
                                                }

                                                <div
                                                    class="newrow left-aligned"
                                                >
                                                    <div
                                                        class="newrow left-aligned tags"
                                                    >
                                                        @for (
                                                            trait of type.traits;
                                                            track $index
                                                        ) {
                                                            <app-trait
                                                                [name]="trait"
                                                                [trait]="
                                                                    traitFromName(
                                                                        trait
                                                                    )
                                                                "
                                                            />
                                                        }
                                                    </div>

                                                    @if (type.sourceBook) {
                                                        <div
                                                            class="newrow left-aligned"
                                                        >
                                                            <strong
                                                                >Source</strong
                                                            >

                                                            <i>{{
                                                                type.sourceBook
                                                            }}</i>
                                                        </div>
                                                    }

                                                    @for (
                                                        desc of type.desc.split(
                                                            "\n\n"
                                                        );
                                                        track $index
                                                    ) {
                                                        <app-description
                                                            class="newrow"
                                                            [text]="desc"
                                                        />
                                                    }

                                                    <p>
                                                        <strong>Size</strong>
                                                        {{ size(type.size) }}
                                                    </p>

                                                    @for (
                                                        attack of grantedCompanionAttacks(
                                                            type
                                                        );
                                                        track $index
                                                    ) {
                                                        <p>
                                                            <strong
                                                                >Melee</strong
                                                            >
                                                            {{
                                                                attack.displayName
                                                            }},
                                                            <strong
                                                                >Damage</strong
                                                            >
                                                            {{
                                                                attack.dicenum +
                                                                    "d" +
                                                                    attack.dicesize
                                                            }}
                                                        </p>
                                                    }

                                                    <p>
                                                        @for (
                                                            ability of animalCompanionAbilities$(
                                                                type
                                                            ) | async;
                                                            track $index
                                                        ) {
                                                            <span>
                                                                {{
                                                                    $index
                                                                        ? ", "
                                                                        : ""
                                                                }}
                                                                <strong>{{
                                                                    ability.name
                                                                }}</strong>
                                                                {{
                                                                    ability.modifier
                                                                }}
                                                            </span>
                                                        }
                                                    </p>

                                                    <p>
                                                        <strong
                                                            >Hit Points</strong
                                                        >
                                                        {{ type.hitPoints }}
                                                    </p>

                                                    <p>
                                                        <strong>Skill</strong>
                                                        {{
                                                            type.skillChoices[0]
                                                                .increases[0]
                                                                .name
                                                        }}
                                                    </p>

                                                    <p>
                                                        <strong>Senses</strong>
                                                        {{
                                                            type.senses.join(
                                                                ","
                                                            )
                                                        }}
                                                    </p>

                                                    <p>
                                                        <strong>Speed</strong>

                                                        @for (
                                                            speed of type.speeds;
                                                            track $index
                                                        ) {
                                                            <span>
                                                                {{
                                                                    !$first
                                                                        ? ", "
                                                                        : ""
                                                                }}{{
                                                                    speed.name.split(
                                                                        " "
                                                                    )[0] +
                                                                        " " +
                                                                        speed.value +
                                                                        " feet"
                                                                }}
                                                            </span>
                                                        }
                                                    </p>

                                                    <p>
                                                        <strong
                                                            >Support
                                                            Benefit</strong
                                                        >
                                                        {{
                                                            type.supportBenefit
                                                        }}
                                                    </p>

                                                    @if (
                                                        type.specialdesc.length
                                                    ) {
                                                        <p>
                                                            <strong
                                                                >Special</strong
                                                            >
                                                            {{
                                                                type.specialdesc
                                                            }}
                                                        </p>
                                                    }
                                                </div>

                                                @if (
                                                    type.activities[1];
                                                    as gain
                                                ) {
                                                    @if (
                                                        activityFromName(
                                                            gain.name
                                                        );
                                                        as activity
                                                    ) {
                                                        <div
                                                            class="newrow left-aligned"
                                                        >
                                                            <header
                                                                class="spellHeader left-aligned"
                                                            >
                                                                Advanced
                                                                Maneuver:
                                                                {{
                                                                    activity.name
                                                                }}
                                                                @if (
                                                                    activity.actions
                                                                ) {
                                                                    <app-action-icons
                                                                        [actionString]="
                                                                            activity.actions
                                                                        "
                                                                    />
                                                                }
                                                                {{
                                                                    activity.activationType
                                                                        ? activity.activationType
                                                                        : ""
                                                                }}
                                                            </header>

                                                            <app-activity
                                                                class="newrow"
                                                                [activity]="
                                                                    activity
                                                                "
                                                                [allowActivate]="
                                                                    false
                                                                "
                                                            />
                                                        </div>
                                                    }
                                                }
                                            </ng-template>

                                            <div
                                                class="list-item gridicon-fullsizebox"
                                                [ngClass]="{
                                                    selected: checked,
                                                }"
                                            >
                                                <input
                                                    aria-label="Choose this animal companion type"
                                                    type="checkbox"
                                                    class="character-choice"
                                                    id="{{ type.name }}"
                                                    [checked]="checked"
                                                    [disabled]="disabled"
                                                    (change)="
                                                        onChangeCompanionType(
                                                            type,
                                                            $event
                                                        )
                                                    "
                                                />
                                                <div
                                                    class="gridicon-fullsizebox"
                                                >
                                                    <app-grid-icon
                                                        [title]="type.name"
                                                    />

                                                    <header
                                                        class="sectionHeader"
                                                    >
                                                        <span
                                                            triggers="click"
                                                            [ngbPopover]="
                                                                AnimalCompanionDetailsTemplate
                                                            "
                                                        >
                                                            {{ type.name }}
                                                        </span>
                                                    </header>
                                                </div>
                                            </div>
                                        }
                                    }
                                }
                            </div>
                        }
                    }

                    <!-- Companion Specialization Content -->
                    @if (
                        activeSpecialChoiceShown("companionspecialization");
                        as companionSpecializationContent
                    ) {
                        @if (animalCompanion$ | async; as companion) {
                            @for (
                                available of [
                                    (companionSpecializationsAvailable$(
                                        companionSpecializationContent.levelNumber
                                    ) | async) ?? 0,
                                ];
                                track $index
                            ) {
                                @if (
                                    companionSpecializationsOnLevel$(
                                        companionSpecializationContent.levelNumber
                                    ) | async;
                                    as takenSpecializations
                                ) {
                                    <div
                                        class="newrow list-item padding-8 center-aligned"
                                    >
                                        <header
                                            class="box-header sectionHeader"
                                        >
                                            {{
                                                companionSpecializationChoiceTitle(
                                                    available,
                                                    takenSpecializations
                                                )
                                            }}
                                        </header>
                                    </div>

                                    <div class="list-item">
                                        <p>
                                            The first time an animal gains a
                                            specialization, it gains the
                                            following: Its proficiency rank for
                                            unarmed attacks increases to expert.
                                            Its proficiency ranks for saving
                                            throws and Perception increase to
                                            master. Increase its Dexterity
                                            modifier by 1 and its Intelligence
                                            modifier by 2. Its unarmed attack
                                            damage increases from two dice to
                                            three dice, and it increases its
                                            additional damage with unarmed
                                            attacks from 2 to 4 or from 3 to 6.
                                        </p>
                                    </div>

                                    <div
                                        id="choiceArea"
                                        class="list-item"
                                    >
                                        @for (
                                            spec of availableCompanionSpecializations$(
                                                companionSpecializationContent.levelNumber
                                            ) | async;
                                            track $index
                                        ) {
                                            @for (
                                                taken of [
                                                    takenSpecializations.includes(
                                                        spec.name
                                                    ),
                                                ];
                                                track $index
                                            ) {
                                                @for (
                                                    checked of [
                                                        !!taken ||
                                                            !!(
                                                                hasCompanionTakenThisSpecialization$(
                                                                    spec.name
                                                                ) | async
                                                            ),
                                                    ];
                                                    track $index
                                                ) {
                                                    @for (
                                                        disabled of [
                                                            (!!(
                                                                hasCompanionTakenThisSpecialization$(
                                                                    spec.name
                                                                ) | async
                                                            ) ||
                                                                takenSpecializations.length ===
                                                                    available) &&
                                                                !taken,
                                                        ];
                                                        track $index
                                                    ) {
                                                        <ng-template
                                                            #CompanionSpecializationDetailsTemplate
                                                        >
                                                            <header
                                                                class="spellHeader"
                                                            >
                                                                {{ spec.name }}
                                                            </header>

                                                            @if (
                                                                !disabled &&
                                                                (taken ||
                                                                    !checked)
                                                            ) {
                                                                <div
                                                                    class="button newrow no-animation"
                                                                    [ngClass]="{
                                                                        'fancy-button':
                                                                            taken,
                                                                    }"
                                                                >
                                                                    <label>
                                                                        <input
                                                                            type="checkbox"
                                                                            hidden
                                                                            [checked]="
                                                                                checked
                                                                            "
                                                                            [disabled]="
                                                                                disabled
                                                                            "
                                                                            (change)="
                                                                                onChangeCompanionSpecialization(
                                                                                    spec,
                                                                                    $event,
                                                                                    companionSpecializationContent.levelNumber
                                                                                )
                                                                            "
                                                                        />
                                                                        {{
                                                                            checked
                                                                                ? "Remove"
                                                                                : "Choose"
                                                                        }}
                                                                    </label>
                                                                </div>
                                                            }

                                                            <div
                                                                class="newrow left-aligned"
                                                            >
                                                                @if (
                                                                    checked &&
                                                                    !taken
                                                                ) {
                                                                    <cite
                                                                        class="problem"
                                                                    >
                                                                        Already
                                                                        taken
                                                                    </cite>
                                                                }
                                                            </div>

                                                            @if (
                                                                spec.sourceBook
                                                            ) {
                                                                <div
                                                                    class="newrow left-aligned"
                                                                >
                                                                    <strong
                                                                        >Source</strong
                                                                    >

                                                                    <i>{{
                                                                        spec.sourceBook
                                                                    }}</i>
                                                                </div>
                                                            }

                                                            <div
                                                                class="newrow left-aligned"
                                                            >
                                                                <p>
                                                                    {{
                                                                        spec.desc
                                                                    }}
                                                                </p>
                                                            </div>
                                                        </ng-template>

                                                        <div
                                                            class="list-item gridicon-fullsizebox"
                                                            [ngClass]="{
                                                                selected: taken,
                                                            }"
                                                        >
                                                            <input
                                                                aria-label="Choose this animal companion specialization"
                                                                type="checkbox"
                                                                class="character-choice"
                                                                id="{{
                                                                    spec.name
                                                                }}"
                                                                [checked]="
                                                                    checked
                                                                "
                                                                [disabled]="
                                                                    disabled
                                                                "
                                                                (change)="
                                                                    onChangeCompanionSpecialization(
                                                                        spec,
                                                                        $event,
                                                                        companionSpecializationContent.levelNumber
                                                                    )
                                                                "
                                                            />
                                                            <div
                                                                class="gridicon-fullsizebox"
                                                            >
                                                                <app-grid-icon
                                                                    [title]="
                                                                        spec.name
                                                                    "
                                                                />

                                                                <header
                                                                    class="sectionHeader"
                                                                >
                                                                    <span
                                                                        triggers="click"
                                                                        [ngbPopover]="
                                                                            CompanionSpecializationDetailsTemplate
                                                                        "
                                                                    >
                                                                        {{
                                                                            spec.name
                                                                        }}
                                                                    </span>
                                                                </header>
                                                            </div>
                                                        </div>
                                                    }
                                                }
                                            }
                                        }
                                    </div>
                                }
                            }
                        }
                    }

                    <!-- Familiar Content -->
                    @if (
                        activeSpecialChoiceShown("familiar");
                        as familiarContent
                    ) {
                        @if (familiar$ | async; as familiar) {
                            <div
                                class="newrow list-item padding-8 center-aligned"
                            >
                                <header class="box-header sectionHeader">
                                    Familiar
                                </header>
                            </div>

                            <div
                                id="choiceArea"
                                class="list-item"
                            >
                                <div class="newrow list-item">
                                    <button
                                        type="button"
                                        class="newrow list-item"
                                        (click)="onResetFamiliar()"
                                    >
                                        <header class="sectionHeader">
                                            Reset Familiar
                                        </header>
                                    </button>

                                    <div class="newrow list-item left-aligned">
                                        <strong>Name</strong>

                                        <input
                                            aria-label="Familiar name input"
                                            id="FamiliarName"
                                            type="text"
                                            maxLength="30"
                                            [(ngModel)]="familiar.name"
                                        />
                                    </div>

                                    <div class="newrow list-item left-aligned">
                                        <strong>Creature</strong>

                                        <input
                                            aria-label="Familiar creature input"
                                            id="FamiliarCreature"
                                            type="text"
                                            maxLength="30"
                                            [(ngModel)]="familiar.species"
                                        />
                                    </div>

                                    <div
                                        class="list-item left-aligned gridicon-fullsizebox"
                                    >
                                        <input
                                            class="character-choice"
                                            id="FamiliarSwimmer"
                                            type="checkbox"
                                            [checked]="
                                                isFamiliarSwimmer$() | async
                                            "
                                            (click)="
                                                onFamiliarSpeedChange($event)
                                            "
                                        />
                                        <label for="FamiliarSwimmer">
                                            <strong
                                                >Gain Swim Speed instead of Land
                                                Speed</strong
                                            >
                                        </label>
                                    </div>
                                </div>
                            </div>
                        }
                    }

                    <!-- Different Worlds content -->
                    @if (
                        activeSpecialChoiceShown("differentworlds");
                        as differentWorldsContent
                    ) {
                        @for (
                            differentWorldsData of differentWorldsData$(
                                differentWorldsContent.levelNumber
                            ) | async;
                            track $index
                        ) {
                            <div
                                class="newrow list-item padding-8 center-aligned"
                            >
                                <header class="box-header sectionHeader">
                                    Different Worlds{{
                                        !!differentWorldsData.getValue(
                                            "background"
                                        )
                                            ? ": " +
                                              differentWorldsData.getValue(
                                                  "background"
                                              )
                                            : ""
                                    }}
                                </header>
                            </div>

                            <div
                                id="choiceArea"
                                class="list-item"
                            >
                                <div class="newrow list-item">
                                    <div class="newrow list-item left-aligned">
                                        <strong>Alternative name</strong>

                                        <input
                                            aria-label="Alternative name input"
                                            type="text"
                                            maxLength="30"
                                            [ngModel]="
                                                differentWorldsData.getValue(
                                                    'name'
                                                )
                                            "
                                            (input)="
                                                differentWorldsData.setValue(
                                                    'name',
                                                    $event
                                                )
                                            "
                                            (blur)="onNameChange()"
                                        />
                                    </div>
                                </div>

                                <div class="list-item transparent">
                                    <header class="sectionHeader">
                                        Alternative background
                                    </header>
                                </div>

                                <!-- Filter -->
                                <div class="list-item lower">
                                    <strong>Filter</strong>

                                    <div class="list-item gridicon-fullsizebox">
                                        <input
                                            class="character-choice"
                                            id="differentWorldsAdventureBackgroundsFilter"
                                            type="checkbox"
                                            [(ngModel)]="adventureBackgrounds"
                                        />
                                        <label
                                            for="differentWorldsAdventureBackgroundsFilter"
                                        >
                                            <strong
                                                >Show adventure
                                                backgrounds</strong
                                            >
                                        </label>
                                    </div>

                                    <div class="list-item gridicon-fullsizebox">
                                        <input
                                            class="character-choice"
                                            id="differentWorldsRegionalBackgroundsFilter"
                                            type="checkbox"
                                            [(ngModel)]="regionalBackgrounds"
                                        />
                                        <label
                                            for="differentWorldsRegionalBackgroundsFilter"
                                        >
                                            <strong
                                                >Show regional
                                                backgrounds</strong
                                            >
                                        </label>
                                    </div>
                                </div>

                                <!-- End Filter -->
                                @for (
                                    background of filteredBackgrounds();
                                    track $index
                                ) {
                                    @for (
                                        selected of [
                                            background.name ===
                                                differentWorldsData.getValue(
                                                    "background"
                                                ),
                                        ];
                                        track $index
                                    ) {
                                        @for (
                                            checked of [
                                                selected ||
                                                    background.name ===
                                                        character.class
                                                            .background.name ||
                                                    background.name ===
                                                        character.class
                                                            .background
                                                            .superType,
                                            ];
                                            track $index
                                        ) {
                                            @for (
                                                disabled of [
                                                    !selected &&
                                                        (checked ||
                                                            !!differentWorldsData.getValue(
                                                                "background"
                                                            )),
                                                ];
                                                track $index
                                            ) {
                                                <ng-template
                                                    #DifferentWorldsBackgroundChoiceDetailsTemplate
                                                >
                                                    <header class="spellHeader">
                                                        {{ background.name }}
                                                    </header>

                                                    @if (!disabled) {
                                                        <div
                                                            class="button newrow no-animation"
                                                            [ngClass]="{
                                                                'fancy-button':
                                                                    selected,
                                                                disabled:
                                                                    disabled,
                                                            }"
                                                        >
                                                            <label>
                                                                <input
                                                                    type="checkbox"
                                                                    hidden
                                                                    [checked]="
                                                                        checked
                                                                    "
                                                                    [disabled]="
                                                                        disabled
                                                                    "
                                                                    (change)="
                                                                        onDifferentWorldsBackgroundChange(
                                                                            differentWorldsContent.levelNumber,
                                                                            differentWorldsData,
                                                                            background,
                                                                            $event
                                                                        )
                                                                    "
                                                                />
                                                                {{
                                                                    selected
                                                                        ? "Remove"
                                                                        : "Choose"
                                                                }}
                                                            </label>
                                                        </div>
                                                    }

                                                    <div
                                                        class="newrow left-aligned tags"
                                                    >
                                                        @for (
                                                            trait of background.traits;
                                                            track $index
                                                        ) {
                                                            <app-trait
                                                                [name]="trait"
                                                                [trait]="
                                                                    traitFromName(
                                                                        trait
                                                                    )
                                                                "
                                                            />
                                                        }
                                                    </div>

                                                    @if (
                                                        background.sourceBook
                                                    ) {
                                                        <div
                                                            class="newrow left-aligned"
                                                        >
                                                            <strong
                                                                >Source</strong
                                                            >

                                                            <i>{{
                                                                background.sourceBook
                                                            }}</i>
                                                        </div>
                                                    }

                                                    @if (
                                                        background.prerequisites
                                                    ) {
                                                        <div
                                                            class="newrow left-aligned"
                                                        >
                                                            <strong
                                                                >Prerequisites</strong
                                                            >
                                                            {{
                                                                background.prerequisites
                                                            }}
                                                        </div>
                                                    }

                                                    @if (background.region) {
                                                        <div
                                                            class="newrow left-aligned"
                                                        >
                                                            <strong
                                                                >Region</strong
                                                            >
                                                            {{
                                                                background.region
                                                            }}
                                                        </div>
                                                    }

                                                    <div
                                                        class="newrow left-aligned"
                                                    >
                                                        @for (
                                                            desc of background.desc.split(
                                                                "\n\n"
                                                            );
                                                            track $index
                                                        ) {
                                                            @if ($first) {
                                                                <app-description
                                                                    class="newrow"
                                                                    [text]="
                                                                        desc
                                                                    "
                                                                />
                                                            }
                                                        }

                                                        @if (
                                                            background
                                                                .loreChoices[0]
                                                                ?.loreName !==
                                                            ""
                                                        ) {
                                                            <p>
                                                                You're trained
                                                                in
                                                                {{
                                                                    background
                                                                        .loreChoices[0]
                                                                        .loreName
                                                                }}
                                                                Lore.
                                                            </p>
                                                        }

                                                        @if (
                                                            background
                                                                .loreChoices[0]
                                                                ?.loreDesc !==
                                                            ""
                                                        ) {
                                                            <p>
                                                                You're trained
                                                                in
                                                                {{
                                                                    background.loreChoices[0].loreDesc
                                                                        .substr(
                                                                            0,
                                                                            1
                                                                        )
                                                                        .toLowerCase()
                                                                }}{{
                                                                    background.loreChoices[0].loreDesc.substr(
                                                                        1
                                                                    )
                                                                }}.
                                                            </p>
                                                        }
                                                    </div>
                                                </ng-template>

                                                <div
                                                    class="list-item gridicon-fullsizebox"
                                                    [ngClass]="{
                                                        selected: selected,
                                                    }"
                                                >
                                                    <input
                                                        aria-label="Choose this alternativebackground"
                                                        type="checkbox"
                                                        class="character-choice"
                                                        id="{{
                                                            background.name
                                                        }}"
                                                        [checked]="checked"
                                                        [disabled]="disabled"
                                                        (change)="
                                                            onDifferentWorldsBackgroundChange(
                                                                differentWorldsContent.levelNumber,
                                                                differentWorldsData,
                                                                background,
                                                                $event
                                                            )
                                                        "
                                                    />
                                                    <div
                                                        class="gridicon-fullsizebox"
                                                        triggers="click"
                                                        [ngbPopover]="
                                                            DifferentWorldsBackgroundChoiceDetailsTemplate
                                                        "
                                                    >
                                                        <app-grid-icon
                                                            [title]="
                                                                background.name
                                                            "
                                                            [detail]="
                                                                background.traits.includes(
                                                                    'Rare'
                                                                )
                                                                    ? 'Rare'
                                                                    : background.traits.includes(
                                                                            'Uncommon'
                                                                        )
                                                                      ? 'Uncommon'
                                                                      : ''
                                                            "
                                                        />

                                                        <header
                                                            class="sectionHeader"
                                                        >
                                                            <span
                                                                >{{
                                                                    background.name
                                                                }}&nbsp;</span
                                                            >

                                                            @for (
                                                                trait of [
                                                                    "Rare",
                                                                    "Uncommon",
                                                                    "Adventure",
                                                                    "Regional",
                                                                ];
                                                                track $index
                                                            ) {
                                                                @if (
                                                                    background.traits.includes(
                                                                        trait
                                                                    )
                                                                ) {
                                                                    <app-trait
                                                                        [name]="
                                                                            trait
                                                                        "
                                                                        [trait]="
                                                                            traitFromName(
                                                                                trait
                                                                            )
                                                                        "
                                                                    />
                                                                }
                                                            }
                                                        </header>
                                                    </div>
                                                </div>
                                            }
                                        }
                                    }
                                }
                            </div>
                        }
                    }

                    <!-- Blessed Blood Content -->
                    @if (
                        activeSpecialChoiceShown("blessedblood");
                        as blessedBloodContent
                    ) {
                        @for (
                            blessedBloodSpells of [blessedBloodSpellsTaken()];
                            track $index
                        ) {
                            <div
                                class="newrow list-item padding-8 center-aligned"
                            >
                                <header class="box-header sectionHeader">
                                    Blessed Blood Deity Spells:
                                    {{ blessedBloodSpells }}/3
                                </header>
                            </div>

                            <div class="list-item">
                                <p>
                                    Add up to three of your deity's spells
                                    (spells your deity grants to clerics) to
                                    your spell list. They are not automatically
                                    added to your repertoire, but you can select
                                    them just as you would spells normally on
                                    the divine spell list.
                                </p>
                            </div>

                            <div
                                id="choiceArea"
                                class="list-item"
                            >
                                @for (
                                    spell of blessedBloodDeitySpells$() | async;
                                    track $index
                                ) {
                                    @for (
                                        checked of [
                                            !!isSpellTakenInBlessedBlood(spell),
                                        ];
                                        track $index
                                    ) {
                                        @for (
                                            disabled of [
                                                blessedBloodSpells >= 3 &&
                                                    !checked,
                                            ];
                                            track $index
                                        ) {
                                            <ng-template
                                                #BlessedBloodChoiceDetailsTemplate
                                            >
                                                <header
                                                    class="spellHeader newrow"
                                                >
                                                    <span style="flex-grow: 10">
                                                        {{ spell.name }}
                                                        @if (spell.actions) {
                                                            <app-action-icons
                                                                [actionString]="
                                                                    spell.actions
                                                                "
                                                            />
                                                        }
                                                        {{
                                                            spell.castType
                                                                ? spell.castType
                                                                : ""
                                                        }}
                                                    </span>

                                                    <span
                                                        style="
                                                            flex-basis: auto;
                                                            flex-shrink: 0;
                                                        "
                                                        >Spell
                                                        {{
                                                            spell.levelreq
                                                        }}</span
                                                    >
                                                </header>

                                                @if (!disabled) {
                                                    <div
                                                        class="button newrow no-animation"
                                                        [ngClass]="{
                                                            'fancy-button':
                                                                checked,
                                                            disabled: disabled,
                                                        }"
                                                    >
                                                        <label>
                                                            <input
                                                                type="checkbox"
                                                                hidden
                                                                [checked]="
                                                                    checked
                                                                "
                                                                [disabled]="
                                                                    disabled
                                                                "
                                                                (change)="
                                                                    onBlessedBloodSpellTaken(
                                                                        spell,
                                                                        blessedBloodContent.levelNumber,
                                                                        $event
                                                                    )
                                                                "
                                                            />
                                                            {{
                                                                checked
                                                                    ? "Remove"
                                                                    : "Choose"
                                                            }}
                                                        </label>
                                                    </div>
                                                }

                                                <app-spell
                                                    class="newrow"
                                                    [spell]="spell"
                                                    [spellLevel]="
                                                        spell.levelreq
                                                    "
                                                />
                                            </ng-template>

                                            <div
                                                class="list-item gridicon-fullsizebox"
                                                [ngClass]="{
                                                    selected: checked,
                                                }"
                                            >
                                                <input
                                                    aria-label="Choose this spell"
                                                    type="checkbox"
                                                    class="character-choice"
                                                    id="{{ spell.name }}"
                                                    [checked]="checked"
                                                    [disabled]="disabled"
                                                    (change)="
                                                        onBlessedBloodSpellTaken(
                                                            spell,
                                                            blessedBloodContent.levelNumber,
                                                            $event
                                                        )
                                                    "
                                                />
                                                <div
                                                    class="gridicon-fullsizebox"
                                                    triggers="click"
                                                    [ngbPopover]="
                                                        BlessedBloodChoiceDetailsTemplate
                                                    "
                                                >
                                                    <app-grid-icon
                                                        [title]="spell.name"
                                                    />

                                                    <header
                                                        class="sectionHeader"
                                                    >
                                                        <span>{{
                                                            spell.name
                                                        }}</span>
                                                    </header>
                                                </div>
                                            </div>
                                        }
                                    }
                                }
                            </div>
                        }
                    }

                    <!-- Splinter Faith Content -->
                    @if (
                        activeSpecialChoiceShown("splinterfaith");
                        as splinterFaithContent
                    ) {
                        @if (
                            splinterFaithDomains$() | async;
                            as splinterFaithDomains
                        ) {
                            <div
                                class="newrow list-item padding-8 center-aligned"
                            >
                                <header class="box-header sectionHeader">
                                    Splinter Faith Domains:
                                    {{ splinterFaithDomains.length }}/4
                                </header>
                            </div>

                            <div class="list-item">
                                <p>
                                    Choose four domains. These domains must be
                                    chosen from among your deity's domains, your
                                    deity's alternate domains, and up to one
                                    domain that isn't on either list and isn't
                                    anathematic to your deity. Any domain spell
                                    you cast from a domain that isn't on either
                                    of your deity's lists is always heightened
                                    to 1 level lower than usual for a focus
                                    spell. For the purpose of abilities that
                                    depend on your deity's domains, the four
                                    domains you chose are your deity's domains,
                                    and any of your deity's domains you didn't
                                    choose are now among your deity's alternate
                                    domains.
                                </p>
                            </div>

                            <div
                                id="choiceArea"
                                class="list-item"
                            >
                                @for (
                                    availableDomains of [
                                        splinterFaithAvailableDomains(),
                                    ];
                                    track $index
                                ) {
                                    @for (
                                        domain of availableDomains;
                                        track $index
                                    ) {
                                        @if (domain.title) {
                                            <div class="list-item newrow">
                                                <header class="sectionHeader">
                                                    {{ domain.title }}
                                                </header>
                                            </div>
                                        }

                                        @for (
                                            checked of [
                                                splinterFaithDomains.includes(
                                                    domain.domain.name
                                                ),
                                            ];
                                            track $index
                                        ) {
                                            @for (
                                                disabled of [
                                                    !checked &&
                                                        (splinterFaithDomains.length >=
                                                            4 ||
                                                            (domain.type ===
                                                                3 &&
                                                                !!isSplinterFaithThirdDomainTaken(
                                                                    availableDomains,
                                                                    splinterFaithDomains
                                                                ))),
                                                ];
                                                track $index
                                            ) {
                                                <div
                                                    class="list-item gridicon-fullsizebox"
                                                    [ngClass]="{
                                                        selected: checked,
                                                    }"
                                                >
                                                    <input
                                                        aria-label="Choose this domain"
                                                        type="checkbox"
                                                        class="character-choice"
                                                        id="{{
                                                            domain.domain.name
                                                        }}"
                                                        [checked]="checked"
                                                        [disabled]="disabled"
                                                        (change)="
                                                            onSplinterFaithDomainTaken(
                                                                domain.domain
                                                                    .name,
                                                                $event
                                                            )
                                                        "
                                                    />
                                                    <ng-template
                                                        #DomainDescTemplate
                                                    >
                                                        @if (
                                                            domain.domain
                                                                .sourceBook
                                                        ) {
                                                            <div
                                                                class="newrow left-aligned"
                                                            >
                                                                <strong
                                                                    >Source</strong
                                                                >

                                                                <i>{{
                                                                    domain
                                                                        .domain
                                                                        .sourceBook
                                                                }}</i>
                                                            </div>
                                                        }

                                                        <div
                                                            class="newrow left-aligned"
                                                        >
                                                            {{
                                                                domain.domain
                                                                    .desc
                                                            }}
                                                        </div>
                                                    </ng-template>

                                                    <div
                                                        class="gridicon-fullsizebox"
                                                        triggers="click"
                                                        [ngbPopover]="
                                                            DomainDescTemplate
                                                        "
                                                    >
                                                        <app-grid-icon
                                                            [title]="
                                                                domain.domain
                                                                    .name
                                                            "
                                                        />

                                                        <header
                                                            class="sectionHeader"
                                                        >
                                                            <span>{{
                                                                domain.domain
                                                                    .name
                                                            }}</span>
                                                        </header>
                                                    </div>
                                                </div>
                                            }
                                        }
                                    }
                                }
                            </div>
                        }
                    }

                    <!-- Fuse Stance content -->
                    @if (
                        activeSpecialChoiceShown("fusestance");
                        as fuseStanceContent
                    ) {
                        @for (
                            fuseStanceData of fuseStanceData$(
                                fuseStanceContent.levelNumber
                            ) | async;
                            track $index
                        ) {
                            @for (
                                finished of [
                                    fuseStanceData.stances?.length === 2,
                                ];
                                track $index
                            ) {
                                <div
                                    class="newrow list-item padding-8 center-aligned"
                                >
                                    <header class="box-header sectionHeader">
                                        {{
                                            fuseStanceChoiceTitle(
                                                finished,
                                                fuseStanceData.name,
                                                fuseStanceData.stances
                                            )
                                        }}
                                    </header>
                                </div>

                                <div class="list-item">
                                    <p>
                                        Choose two stances you know and combine
                                        them into a single fused stance. Give
                                        your new fused stance a unique name.
                                        When you enter your fused stance, you
                                        gain all the effects of both stances,
                                        including the requirements and
                                        restrictions.
                                    </p>

                                    <p>
                                        You can't fuse stances with
                                        fundamentally incompatible requirements
                                        or restrictions (such as Mountain Stance
                                        and Crane Stance, which both require
                                        using only one type of Strike).
                                    </p>
                                </div>

                                <div
                                    id="choiceArea"
                                    class="list-item"
                                >
                                    <div class="newrow list-item">
                                        <div
                                            class="newrow list-item left-aligned"
                                        >
                                            <strong>Stance name</strong>

                                            <input
                                                aria-label="Fused stance name input"
                                                type="text"
                                                maxLength="30"
                                                [ngModel]="
                                                    fuseStanceData.name ?? ''
                                                "
                                                (ngModelChange)="
                                                    fuseStanceData.featData.setValue(
                                                        'name',
                                                        $event
                                                    )
                                                "
                                                (blur)="
                                                    onFuseStanceNameChange()
                                                "
                                            />
                                        </div>
                                    </div>

                                    <div class="list-item transparent">
                                        <header class="sectionHeader">
                                            Fused Stances
                                        </header>
                                    </div>

                                    @for (
                                        stance of fuseStanceAvailableStances$(
                                            fuseStanceContent.levelNumber,
                                            fuseStanceData.featData
                                        ) | async;
                                        track $index
                                    ) {
                                        <ng-template
                                            #FuseStanceChoiceDetailsPopover
                                        >
                                            <header class="spellHeader">
                                                {{ stance.activity.name }}
                                                @if (stance.activity.actions) {
                                                    <app-action-icons
                                                        [actionString]="
                                                            stance.activity
                                                                .actions
                                                        "
                                                    />
                                                }
                                                {{
                                                    stance.activity
                                                        .activationType
                                                        ? stance.activity
                                                              .activationType
                                                        : ""
                                                }}
                                            </header>

                                            <app-activity
                                                [creature]="character"
                                                [activity]="stance.activity"
                                                [allowActivate]="false"
                                            />
                                        </ng-template>

                                        <div
                                            class="list-item gridicon-fullsizebox"
                                            [ngClass]="{
                                                unavailable: stance.reason,
                                                selected:
                                                    fuseStanceData.stances?.includes(
                                                        stance.activity.name
                                                    ),
                                            }"
                                        >
                                            <input
                                                aria-label="Choose this stance"
                                                type="checkbox"
                                                class="character-choice"
                                                id="{{ stance.activity.name }}"
                                                [checked]="
                                                    fuseStanceData.stances?.includes(
                                                        stance.activity.name
                                                    )
                                                "
                                                [disabled]="
                                                    (finished ||
                                                        stance.reason) &&
                                                    !fuseStanceData.stances?.includes(
                                                        stance.activity.name
                                                    )
                                                "
                                                (change)="
                                                    onFuseStanceStanceChange(
                                                        fuseStanceData.featData,
                                                        stance.activity.name,
                                                        $event
                                                    )
                                                "
                                            />
                                            <div
                                                class="gridicon-fullsizebox"
                                                triggers="click"
                                                [ngbPopover]="
                                                    FuseStanceChoiceDetailsPopover
                                                "
                                            >
                                                <app-grid-icon
                                                    [title]="
                                                        stance.activity.name
                                                    "
                                                    [superTitle]="
                                                        stance.restricted
                                                            ? 'icon-ra ra-bird-claw'
                                                            : ''
                                                    "
                                                />

                                                <header class="sectionHeader">
                                                    <span
                                                        >{{
                                                            stance.activity
                                                                .name
                                                        }}&nbsp;</span
                                                    >

                                                    @if (stance.restricted) {
                                                        <cite
                                                            class="trait"
                                                            [ngbPopover]="
                                                                'While in this stance, you can only use the stance\'s special attack. You can only add one stance of this type to the fused stance.'
                                                            "
                                                            [openDelay]="100"
                                                        >
                                                            Attack restrictions
                                                        </cite>
                                                    }

                                                    @if (stance.reason) {
                                                        <cite class="problem">
                                                            {{ stance.reason }}
                                                        </cite>
                                                    }
                                                </header>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        }
                    }

                    <!-- Additional Heritages content -->
                    @if (
                        activeSpecialChoiceShown("additionalheritages");
                        as additionalHeritagesContent
                    ) {
                        @for (
                            heritageGain of additionalHeritagesAvailable$(
                                additionalHeritagesContent.levelNumber
                            ) | async;
                            track $index
                        ) {
                            @for (
                                heritageIndex of [
                                    additionalHeritageIndex(
                                        heritageGain.source,
                                        additionalHeritagesContent.levelNumber
                                    ),
                                ];
                                track $index
                            ) {
                                @if (
                                    heritageGain.source ===
                                    additionalHeritagesContent.choice.source
                                ) {
                                    <div
                                        class="newrow list-item padding-8 center-aligned"
                                    >
                                        <header
                                            class="box-header sectionHeader"
                                        >
                                            Heritage ({{
                                                heritageGain.source
                                            }}){{
                                                character.class
                                                    .additionalHeritages[
                                                    heritageIndex
                                                ].name
                                                    ? ": " +
                                                      character.class
                                                          .additionalHeritages[
                                                          heritageIndex
                                                      ].name
                                                    : ""
                                            }}
                                        </header>
                                    </div>

                                    <div
                                        id="choiceArea"
                                        class="list-item"
                                    >
                                        @for (
                                            heritage of availableHeritages$(
                                                "",
                                                heritageGain.ancestry,
                                                heritageIndex
                                            ) | async;
                                            track $index
                                        ) {
                                            @for (
                                                selected of [
                                                    heritage.name ===
                                                        character.class
                                                            .additionalHeritages[
                                                            heritageIndex
                                                        ].name,
                                                ];
                                                track $index
                                            ) {
                                                @for (
                                                    checked of [
                                                        selected ||
                                                            !!doesCharacterHaveHeritage(
                                                                heritage.name
                                                            ),
                                                    ];
                                                    track $index
                                                ) {
                                                    @for (
                                                        disabled of [
                                                            !selected &&
                                                                (checked ||
                                                                    !!character
                                                                        .class
                                                                        .additionalHeritages[
                                                                        heritageIndex
                                                                    ].name),
                                                        ];
                                                        track $index
                                                    ) {
                                                        <ng-template
                                                            #AdditionalHeritageChoiceDetailsTemplate
                                                        >
                                                            <header
                                                                class="spellHeader"
                                                            >
                                                                {{
                                                                    heritage.name
                                                                }}
                                                            </header>

                                                            @if (
                                                                !disabled &&
                                                                !heritage
                                                                    .subTypes
                                                                    .length
                                                            ) {
                                                                <div
                                                                    class="button newrow no-animation"
                                                                    [ngClass]="{
                                                                        'fancy-button':
                                                                            selected,
                                                                        disabled:
                                                                            disabled,
                                                                    }"
                                                                >
                                                                    <label>
                                                                        <input
                                                                            type="checkbox"
                                                                            hidden
                                                                            [checked]="
                                                                                checked
                                                                            "
                                                                            [disabled]="
                                                                                disabled
                                                                            "
                                                                            (change)="
                                                                                onAdditionalHeritageChange(
                                                                                    heritage,
                                                                                    $event,
                                                                                    heritageIndex
                                                                                )
                                                                            "
                                                                        />
                                                                        {{
                                                                            checked
                                                                                ? "Remove"
                                                                                : "Choose"
                                                                        }}
                                                                    </label>
                                                                </div>
                                                            }

                                                            <div
                                                                class="newrow left-aligned tags"
                                                            >
                                                                @for (
                                                                    trait of heritage.traits;
                                                                    track $index
                                                                ) {
                                                                    <app-trait
                                                                        [name]="
                                                                            trait
                                                                        "
                                                                        [trait]="
                                                                            traitFromName(
                                                                                trait
                                                                            )
                                                                        "
                                                                    />
                                                                }
                                                            </div>

                                                            @if (
                                                                heritage.sourceBook
                                                            ) {
                                                                <div
                                                                    class="newrow left-aligned"
                                                                >
                                                                    <strong
                                                                        >Source</strong
                                                                    >

                                                                    <i>{{
                                                                        heritage.sourceBook
                                                                    }}</i>
                                                                </div>
                                                            }

                                                            <div
                                                                class="newrow left-aligned"
                                                            >
                                                                @for (
                                                                    desc of heritage.desc.split(
                                                                        "\n\n"
                                                                    );
                                                                    track $index
                                                                ) {
                                                                    <app-description
                                                                        class="newrow"
                                                                        [text]="
                                                                            desc
                                                                        "
                                                                    />
                                                                }
                                                            </div>

                                                            @for (
                                                                activityName of heritage.gainActivities;
                                                                track $index
                                                            ) {
                                                                @if (
                                                                    activityFromName(
                                                                        activityName
                                                                    );
                                                                    as activity
                                                                ) {
                                                                    <div
                                                                        class="newrow left-aligned"
                                                                    >
                                                                        <header
                                                                            class="spellHeader left-aligned"
                                                                        >
                                                                            {{
                                                                                activity.name
                                                                            }}
                                                                            @if (
                                                                                activity.actions
                                                                            ) {
                                                                                <app-action-icons
                                                                                    [actionString]="
                                                                                        activity.actions
                                                                                    "
                                                                                />
                                                                            }
                                                                            {{
                                                                                activity.activationType
                                                                                    ? activity.activationType
                                                                                    : ""
                                                                            }}
                                                                        </header>

                                                                        <app-activity
                                                                            class="newrow"
                                                                            [activity]="
                                                                                activity
                                                                            "
                                                                            [allowActivate]="
                                                                                false
                                                                            "
                                                                        />
                                                                    </div>
                                                                }
                                                            }

                                                            <!-- Subheritages -->
                                                            @for (
                                                                subheritage of heritage.subTypes;
                                                                track $index
                                                            ) {
                                                                @for (
                                                                    subheritageSelected of [
                                                                        subheritage.name ===
                                                                            character
                                                                                .class
                                                                                .additionalHeritages[
                                                                                heritageIndex
                                                                            ]
                                                                                .name,
                                                                    ];
                                                                    track $index
                                                                ) {
                                                                    @for (
                                                                        subheritageChecked of [
                                                                            subheritageSelected ||
                                                                                doesCharacterHaveHeritage(
                                                                                    heritage.name
                                                                                ),
                                                                        ];
                                                                        track $index
                                                                    ) {
                                                                        @for (
                                                                            subheritageDisabled of [
                                                                                !subheritageSelected &&
                                                                                    (subheritageChecked ||
                                                                                        character
                                                                                            .class
                                                                                            .additionalHeritages[
                                                                                            heritageIndex
                                                                                        ]
                                                                                            .name),
                                                                            ];
                                                                            track $index
                                                                        ) {
                                                                            <div
                                                                                class="list-item"
                                                                                [ngClass]="{
                                                                                    selected:
                                                                                        subheritageSelected,
                                                                                }"
                                                                            >
                                                                                <div
                                                                                    class="gridicon-fullsizebox lower"
                                                                                >
                                                                                    <input
                                                                                        aria-label="Choose this sub-heritage"
                                                                                        type="checkbox"
                                                                                        class="character-choice"
                                                                                        id="additional{{
                                                                                            subheritage.name
                                                                                        }}"
                                                                                        [checked]="
                                                                                            subheritageChecked
                                                                                        "
                                                                                        [disabled]="
                                                                                            subheritageDisabled
                                                                                        "
                                                                                        (change)="
                                                                                            onAdditionalHeritageChange(
                                                                                                subheritage,
                                                                                                $event,
                                                                                                heritageIndex
                                                                                            )
                                                                                        "
                                                                                    />
                                                                                    <label
                                                                                        for="additional{{
                                                                                            subheritage.name
                                                                                        }}"
                                                                                    >
                                                                                        <strong
                                                                                            >{{
                                                                                                subheritage.subType
                                                                                            }}</strong
                                                                                        >
                                                                                    </label>
                                                                                </div>
                                                                            </div>
                                                                        }
                                                                    }
                                                                }
                                                            }

                                                            <!-- End Subheritages -->
                                                        </ng-template>

                                                        <div
                                                            class="list-item gridicon-fullsizebox"
                                                            [ngClass]="{
                                                                selected:
                                                                    selected,
                                                            }"
                                                        >
                                                            @if (
                                                                !heritage
                                                                    .subTypes
                                                                    .length
                                                            ) {
                                                                <input
                                                                    aria-label="Choose this heritage"
                                                                    type="checkbox"
                                                                    class="character-choice"
                                                                    id="{{
                                                                        heritage.name
                                                                    }}"
                                                                    [checked]="
                                                                        checked
                                                                    "
                                                                    [disabled]="
                                                                        disabled
                                                                    "
                                                                    (change)="
                                                                        onAdditionalHeritageChange(
                                                                            heritage,
                                                                            $event,
                                                                            heritageIndex
                                                                        )
                                                                    "
                                                                />
                                                            }
                                                            @if (
                                                                heritage
                                                                    .subTypes
                                                                    .length
                                                            ) {
                                                                <button
                                                                    type="button"
                                                                    class="character-choice"
                                                                    (click)="
                                                                        HeritageChoiceDetailsPopover.toggle()
                                                                    "
                                                                >
                                                                    +
                                                                </button>
                                                            }

                                                            <div
                                                                #HeritageChoiceDetailsPopover="ngbPopover"
                                                                class="gridicon-fullsizebox"
                                                                triggers="click"
                                                                [ngbPopover]="
                                                                    AdditionalHeritageChoiceDetailsTemplate
                                                                "
                                                            >
                                                                <app-grid-icon
                                                                    [title]="
                                                                        heritage.name
                                                                    "
                                                                    [detail]="
                                                                        heritage.traits.includes(
                                                                            'Rare'
                                                                        )
                                                                            ? 'Rare'
                                                                            : heritage.traits.includes(
                                                                                    'Uncommon'
                                                                                )
                                                                              ? 'Uncommon'
                                                                              : ''
                                                                    "
                                                                />

                                                                <header
                                                                    class="sectionHeader"
                                                                >
                                                                    <span
                                                                        >{{
                                                                            heritage.name
                                                                        }}&nbsp;</span
                                                                    >

                                                                    @for (
                                                                        trait of [
                                                                            "Rare",
                                                                            "Uncommon",
                                                                        ];
                                                                        track $index
                                                                    ) {
                                                                        @if (
                                                                            heritage.traits.includes(
                                                                                trait
                                                                            )
                                                                        ) {
                                                                            <app-trait
                                                                                [name]="
                                                                                    trait
                                                                                "
                                                                                [trait]="
                                                                                    traitFromName(
                                                                                        trait
                                                                                    )
                                                                                "
                                                                            />
                                                                        }
                                                                    }
                                                                </header>
                                                            </div>
                                                        </div>
                                                    }
                                                }
                                            }
                                        }
                                    </div>
                                }
                            }
                        }
                    }

                    <!-- Syncretism choice content -->
                    @if (
                        activeSpecialChoiceShown("syncretism");
                        as syncretismContent
                    ) {
                        @for (
                            syncretismData of syncretismData$(
                                syncretismContent.levelNumber
                            ) | async;
                            track $index
                        ) {
                            @for (
                                finishedDeity of [syncretismData.deity];
                                track $index
                            ) {
                                <div
                                    class="newrow list-item padding-8 center-aligned"
                                >
                                    <header class="box-header sectionHeader">
                                        Second Deity{{
                                            finishedDeity
                                                ? ": " + finishedDeity
                                                : ""
                                        }}
                                    </header>
                                </div>

                                <!-- Filter -->
                                <div class="list-item lower">
                                    <strong
                                        >Find (in Name, Description or
                                        Domains)</strong
                                    >

                                    <span class="hlist">
                                        <input
                                            aria-label="Deity search text"
                                            id="deityWordFilter"
                                            type="text"
                                            [(ngModel)]="deityWordFilter"
                                        />
                                    </span>
                                </div>

                                <div
                                    id="choiceArea"
                                    class="list-item"
                                >
                                    @for (
                                        deity of availableDeities$({
                                            filterForSyncretism: true,
                                            charLevel:
                                                syncretismContent.levelNumber,
                                        }) | async;
                                        track $index
                                    ) {
                                        @for (
                                            checked of [
                                                [
                                                    finishedDeity,
                                                    character.class.deity,
                                                ].includes(deity.name),
                                            ];
                                            track $index
                                        ) {
                                            @for (
                                                disabled of [
                                                    deity.name ===
                                                        character.class.deity ||
                                                        (!!finishedDeity &&
                                                            deity.name !==
                                                                finishedDeity),
                                                ];
                                                track $index
                                            ) {
                                                <ng-template
                                                    #SyncretismDeityChoiceDetailsTemplate
                                                >
                                                    <header class="spellHeader">
                                                        {{ deity.name }}
                                                    </header>

                                                    @if (!disabled) {
                                                        <div
                                                            class="button newrow no-animation"
                                                            [ngClass]="{
                                                                'fancy-button':
                                                                    checked,
                                                                disabled:
                                                                    disabled,
                                                            }"
                                                        >
                                                            <label>
                                                                <input
                                                                    type="checkbox"
                                                                    hidden
                                                                    [checked]="
                                                                        checked
                                                                    "
                                                                    [disabled]="
                                                                        disabled
                                                                    "
                                                                    (change)="
                                                                        onSyncretismDeityChange(
                                                                            syncretismData.featData,
                                                                            deity,
                                                                            $event
                                                                        )
                                                                    "
                                                                />
                                                                {{
                                                                    checked
                                                                        ? "Remove"
                                                                        : "Choose"
                                                                }}
                                                            </label>
                                                        </div>
                                                    }

                                                    @if (deity.nickname) {
                                                        <header
                                                            class="subsectionHeader"
                                                        >
                                                            {{ deity.nickname }}
                                                        </header>
                                                    }

                                                    @if (
                                                        !deity.alternateDomains
                                                            .length
                                                    ) {
                                                        <div
                                                            class="newrow left-aligned problem"
                                                        >
                                                            This deity has no
                                                            alternate domains
                                                            and will not grant a
                                                            domain spell to a
                                                            cloistered cleric.
                                                        </div>
                                                    }

                                                    @if (
                                                        !deity.favoredWeapon
                                                            .length
                                                    ) {
                                                        <div
                                                            class="newrow left-aligned problem"
                                                        >
                                                            This deity has no
                                                            favored weapon and
                                                            will not grant one a
                                                            warpriest.
                                                        </div>
                                                    }

                                                    @if (deity.sourceBook) {
                                                        <div
                                                            class="newrow left-aligned"
                                                        >
                                                            <strong
                                                                >Source</strong
                                                            >

                                                            <i>{{
                                                                deity.sourceBook
                                                            }}</i>
                                                        </div>
                                                    }

                                                    @for (
                                                        desc of deity.desc.split(
                                                            "\n\n"
                                                        );
                                                        track $index
                                                    ) {
                                                        <app-description
                                                            class="newrow"
                                                            [text]="desc"
                                                        />
                                                    }

                                                    @if (deity.edicts) {
                                                        <div
                                                            class="newrow left-aligned gap-text"
                                                        >
                                                            <strong
                                                                >Edicts</strong
                                                            >
                                                            {{
                                                                deity.edicts.join(
                                                                    ", "
                                                                )
                                                            }}
                                                        </div>
                                                    }

                                                    @if (deity.anathema) {
                                                        <div
                                                            class="newrow left-aligned gap-text"
                                                        >
                                                            <strong
                                                                >Anathema</strong
                                                            >
                                                            {{
                                                                deity.anathema.join(
                                                                    ", "
                                                                )
                                                            }}
                                                        </div>
                                                    }

                                                    @if (deity.areasOfConcern) {
                                                        <div
                                                            class="newrow left-aligned gap-text"
                                                        >
                                                            <strong
                                                                >Areas of
                                                                Concern</strong
                                                            >
                                                            {{
                                                                deity.areasOfConcern
                                                            }}
                                                        </div>
                                                    }

                                                    @if (
                                                        deity.followerAlignments
                                                            .length
                                                    ) {
                                                        <div
                                                            class="newrow left-aligned gap-text"
                                                        >
                                                            <strong
                                                                >Follower
                                                                Alignments</strong
                                                            >
                                                            {{
                                                                deity.followerAlignments.join(
                                                                    ", "
                                                                )
                                                            }}
                                                        </div>
                                                    }

                                                    @if (
                                                        deity.pantheonMembers
                                                            .length
                                                    ) {
                                                        <div
                                                            class="newrow left-aligned gap-text"
                                                        >
                                                            <strong
                                                                >Pantheon
                                                                Members</strong
                                                            >
                                                            {{
                                                                deity.pantheonMembers.join(
                                                                    ", "
                                                                )
                                                            }}
                                                        </div>
                                                    }

                                                    @if (
                                                        deity.divineAbility
                                                            .length
                                                    ) {
                                                        <div
                                                            class="newrow left-aligned gap-text"
                                                        >
                                                            <strong
                                                                >Divine
                                                                Ability</strong
                                                            >
                                                            {{
                                                                deity.divineAbility.join(
                                                                    " or "
                                                                )
                                                            }}
                                                        </div>
                                                    }

                                                    @if (
                                                        deity.divineFont.length
                                                    ) {
                                                        <div
                                                            class="newrow left-aligned gap-text"
                                                        >
                                                            <strong
                                                                >Divine
                                                                Font</strong
                                                            >
                                                            {{
                                                                deity.divineFont.join(
                                                                    " or "
                                                                )
                                                            }}
                                                        </div>
                                                    }

                                                    @if (
                                                        deity.divineSkill.length
                                                    ) {
                                                        <div
                                                            class="newrow left-aligned gap-text"
                                                        >
                                                            <strong
                                                                >Divine
                                                                Skill</strong
                                                            >
                                                            {{
                                                                deity.divineSkill.join(
                                                                    " or "
                                                                )
                                                            }}
                                                        </div>
                                                    }

                                                    @if (
                                                        deity.favoredWeapon
                                                            .length
                                                    ) {
                                                        <div
                                                            class="newrow left-aligned gap-text"
                                                        >
                                                            <strong
                                                                >Favored
                                                                Weapon</strong
                                                            >
                                                            {{
                                                                deity.favoredWeapon.join(
                                                                    " or "
                                                                )
                                                            }}
                                                        </div>
                                                    }

                                                    @if (deity.domains.length) {
                                                        <div
                                                            class="newrow left-aligned gap-text"
                                                        >
                                                            <strong
                                                                >Domains</strong
                                                            >
                                                            {{
                                                                deity.domains.join(
                                                                    ", "
                                                                )
                                                            }}
                                                        </div>
                                                    }

                                                    @if (
                                                        deity.alternateDomains
                                                            .length
                                                    ) {
                                                        <div
                                                            class="newrow left-aligned gap-text"
                                                        >
                                                            <strong
                                                                >Alternate
                                                                Domains</strong
                                                            >
                                                            {{
                                                                deity.alternateDomains.join(
                                                                    ", "
                                                                )
                                                            }}
                                                        </div>
                                                    }

                                                    @if (
                                                        deity.clericSpells
                                                            .length
                                                    ) {
                                                        <div
                                                            class="newrow left-aligned"
                                                        >
                                                            <strong
                                                                >Cleric
                                                                Spells</strong
                                                            >
                                                        </div>

                                                        @for (
                                                            spell of deity.clericSpells;
                                                            track $index
                                                        ) {
                                                            <div
                                                                class="list-item lower left-aligned"
                                                            >
                                                                <strong
                                                                    >Level
                                                                    {{
                                                                        spell.level
                                                                    }}</strong
                                                                >
                                                                {{ spell.name }}
                                                                {{
                                                                    spell.restrictionDesc
                                                                        ? "(" +
                                                                          spell.restrictionDesc +
                                                                          ")"
                                                                        : ""
                                                                }}
                                                            </div>
                                                        }
                                                    }
                                                </ng-template>

                                                <div
                                                    class="list-item gridicon-fullsizebox"
                                                    [ngClass]="{
                                                        selected: checked,
                                                    }"
                                                >
                                                    <input
                                                        aria-label="Choose this deity"
                                                        type="checkbox"
                                                        class="character-choice"
                                                        id="syncretism{{
                                                            deity.name
                                                        }}"
                                                        [checked]="checked"
                                                        [disabled]="disabled"
                                                        (change)="
                                                            onSyncretismDeityChange(
                                                                syncretismData.featData,
                                                                deity,
                                                                $event
                                                            )
                                                        "
                                                    />
                                                    <div
                                                        class="gridicon-fullsizebox"
                                                        triggers="click"
                                                        [ngbPopover]="
                                                            SyncretismDeityChoiceDetailsTemplate
                                                        "
                                                    >
                                                        <app-grid-icon
                                                            [title]="deity.name"
                                                            [detail]="
                                                                deity.alignment
                                                            "
                                                        />

                                                        <header
                                                            class="sectionHeader"
                                                        >
                                                            <span>{{
                                                                deity.name
                                                            }}</span>

                                                            @if (
                                                                deity.alignment
                                                            ) {
                                                                <cite
                                                                    class="trait"
                                                                >
                                                                    {{
                                                                        deity.alignment
                                                                    }}
                                                                </cite>
                                                            }

                                                            @if (
                                                                !deity
                                                                    .alternateDomains
                                                                    .length
                                                            ) {
                                                                <cite class>
                                                                    No alternate
                                                                    domains
                                                                </cite>
                                                            }

                                                            @if (
                                                                !deity
                                                                    .favoredWeapon
                                                                    .length
                                                            ) {
                                                                <cite class>
                                                                    No favored
                                                                    weapon
                                                                </cite>
                                                            }
                                                        </header>
                                                    </div>
                                                </div>
                                            }
                                        }
                                    }
                                </div>
                            }
                        }
                    }

                    <!-- Licenses content -->
                    @if (shownList() === "licenses") {
                        <div class="newrow list-item padding-8 center-aligned">
                            <header class="box-header sectionHeader">
                                Licenses
                            </header>
                        </div>

                        <div
                            id="choiceArea"
                            style="font-size: 1em"
                        >
                            <app-licenses class="list-item" />
                        </div>
                    }

                    <!-- About content -->
                    @if (shownList() === "about") {
                        <div class="newrow list-item padding-8 center-aligned">
                            <header
                                class="box-header sectionHeader"
                                style="margin-bottom: 0"
                            >
                                Pathfinder Excessive Character Sheet
                            </header>

                            <div class="newrow lower center-aligned">
                                Version {{ versionString }}
                            </div>
                        </div>

                        <div id="choiceArea">
                            <app-about class="list-item" />
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</app-fly-in-menu>
