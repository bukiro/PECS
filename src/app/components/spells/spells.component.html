<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
<div class="window-button-container">
    <button class="minimizebutton lower"
        [ngbTooltip]="get_Minimized() ? 'Click to show all choices and information.' : 'Click to hide finished choices and show compact information.'"
        [ngClass]="{'fancy-button':get_Minimized()}" (click)="minimize()">
        <i class='bi-arrows-collapse' *ngIf="get_Minimized()"></i>
        <i class='bi-arrows-expand' *ngIf="!get_Minimized()"></i>
    </button>
    <button class="tilemodebutton" [ngClass]="{'fancy-button':get_TileMode()}" (click)="toggle_TileMode()"
        [ngbTooltip]="get_TileMode() ? 'Click to enable list layout' : 'Click to enable tiled layout'">
        <!--Content is css only-->
        <div>
            <div> </div>
            <div> </div>
            <div> </div>
            <div> </div>
        </div>
    </button>
</div>
<div id="spells-height" class="itembox vlist">
    <button class="itembox-close-button list-item center-aligned" (click)="toggle_SpellMenu()">
        <header class="sectionHeader">Back to Character Sheet</header>
    </button>
    <div class="loading" *ngIf="still_loading()">Loading</div>
    <ng-container *ngIf="!still_loading() && get_Character().class && get_SpellsMenuState()==='in'">
        <ng-container *ngFor="let componentParameters of [get_ComponentParameters()]; trackBy:trackByIndex;">
            <div class="charactersheet-column-container">
                <div class="charactersheet-column">
                    <div class="fullsize-scroll-box vlist">
                        <div class="list-item" *ngIf="componentParameters.hasSpellChoices">
                            <span>
                                <input id="showHeightened" type="checkbox"
                                    [(ngModel)]="get_Character().settings.showHeightenedSpells">
                                <label for="showHeightened">
                                    <strong>
                                        Show heightened spells
                                    </strong>
                                </label>
                            </span>
                        </div>
                        <ng-container
                            *ngFor="let spellCastingParameters of get_SpellCastingParameters(); let index = index; trackBy:trackByIndex;">
                            <header class="sectionHeader">
                                {{(spellCastingParameters.casting.className + " " +
                                spellCastingParameters.casting.tradition + ((spellCastingParameters.casting.castingType
                                === "Focus") ? (" " + spellCastingParameters.casting.source) : " Spells")).trim()}}
                                <span class="lower"
                                    *ngIf="['Prepared', 'Spontaneous'].includes(spellCastingParameters.casting.castingType)">
                                    <span class="lower">
                                        {{spellCastingParameters.casting.castingType}}
                                    </span>
                                </span>
                            </header>
                            <app-tags [creature]="'Character'"
                                [objectName]="spellCastingParameters.casting.className + ' ' + spellCastingParameters.casting.castingType + ' Spells'"
                                [showTraits]=true [showFeats]=true [showItems]=true [showActivities]=true
                                [showConditions]=true [showEffects]=true>
                            </app-tags>
                            <div class="list-item" *ngIf="spellCastingParameters.needSpellBook">
                                <span>
                                    <input id="allowBorrow" type="checkbox" [(ngModel)]="allowBorrow">
                                    <label for="allowBorrow">
                                        <strong>
                                            Borrow spells
                                        </strong>
                                    </label>
                                    <i class="bi-question-circle"
                                        [ngbPopover]="'Allow selecting spells not in your spellbook, assuming you borrow them from another spellcaster or a different book or scroll.'"></i>
                                </span>
                            </div>
                            <ng-container
                                *ngFor="let spellCastingLevelParameters of get_SpellCastingLevelParameters(spellCastingParameters); trackBy:trackByIndex;">
                                <header class="subsectionHeader"
                                    *ngIf="spellCastingLevelParameters.level === -1 && spellCastingParameters.casting.castingType === 'Focus'">
                                    Focus Spells</header>
                                <header class="subsectionHeader"
                                    *ngIf="spellCastingLevelParameters.level === 0 && spellCastingParameters.casting.castingType === 'Focus'">
                                    Focus Cantrips</header>
                                <header class="subsectionHeader"
                                    *ngIf="spellCastingLevelParameters.level === 0 && spellCastingParameters.casting.castingType !== 'Focus'">
                                    Cantrips</header>
                                <header class="subsectionHeader"
                                    *ngIf="spellCastingLevelParameters.level > 0 && spellCastingParameters.casting.castingType !== 'Focus'">
                                    {{"Level "+spellCastingLevelParameters.level}}</header>
                                <div [ngClass]="{'icon-list':get_TileMode(), 'vlist':!get_TileMode()}"
                                    style="min-height: auto">
                                    <!--Fixed Spells gained-->
                                    <ng-container
                                        *ngFor="let spellParameters of get_FixedSpellParameters(spellCastingLevelParameters); trackBy:trackByIndex;">
                                        <ng-template #FixedSpellContent>
                                            <header class="spellHeader left-aligned" *ngIf="get_TileMode()">
                                                {{spellParameters.gain.name}}
                                                <app-actionIcons *ngIf="spellParameters.spell.actions"
                                                    [actionString]="spellParameters.spell.actions">
                                                </app-actionIcons>
                                            </header>
                                            <div class="newrow left-aligned"
                                                *ngIf="spellParameters.gain.source || spellParameters.choice.source">
                                                <strong>Granted by</strong>
                                                {{spellParameters.gain.source || spellParameters.choice.source}}
                                            </div>
                                            <app-spell [spell]="spellParameters.spell"
                                                [spellLevel]="spellCastingLevelParameters.level"
                                                [source]="spellParameters.gain.source">
                                            </app-spell>
                                        </ng-template>
                                        <ng-container *ngIf="!get_TileMode()">
                                            <div class="list-item fullsize-only"
                                                *ngFor="let spellID of ['showFixedSpell'+spellParameters.choice.id+spellParameters.gain.name]; trackBy:trackByIndex;">
                                                <button class="newrow sublist-toggle fancy-button left-aligned"
                                                    [ngbPopover]="FixedSpellContent" triggers="click">
                                                    <span [ngbTooltip]="'Fixed spell'">
                                                        <i class="bi-lock-fill"></i>
                                                    </span>
                                                    {{spellParameters.gain.name}}
                                                    <app-actionIcons *ngIf="spellParameters.spell.actions"
                                                        [actionString]="spellParameters.spell.actions">
                                                    </app-actionIcons>
                                                </button>
                                            </div>
                                        </ng-container>
                                        <ng-container *ngIf="get_TileMode()">
                                            <div class="fullsize-only">
                                                <button class="fullsize-only inactive-button"
                                                    [ngbPopover]="FixedSpellContent" triggers="click">
                                                    <app-gridIcon class="fancy-button"
                                                        [ngbTooltip]="spellParameters.gain.name"
                                                        [title]="spellParameters.gain.name"
                                                        [superTitle]="'icon-bi-lock-fill'">
                                                    </app-gridIcon>
                                                </button>
                                            </div>
                                        </ng-container>
                                    </ng-container>
                                    <!--Spell choices-->
                                    <ng-container
                                        *ngFor="let choice of spellCastingLevelParameters.availableSpellChoices; trackBy:trackByIndex;">
                                        <app-spellchoice (showChoiceMessage)="receive_ChoiceMessage($event)"
                                            (showSpellMessage)="receive_SpellMessage($event)"
                                            [spellCasting]="spellCastingParameters.casting" [choice]="choice"
                                            [showHeightened]="get_Character().settings.showHeightenedSpells"
                                            [allowBorrow]="allowBorrow" [showChoice]="get_ShowChoice()"
                                            [showSpell]="get_ShowSpell()" [level]="spellCastingLevelParameters.level"
                                            [prepared]="componentParameters.allowSwitchingPreparedSpells"
                                            [spellbook]="true" [showContent]="false" [tileMode]="get_TileMode()">
                                        </app-spellchoice>
                                    </ng-container>
                                </div>
                            </ng-container>
                        </ng-container>
                    </div>
                </div>
                <div class="charactersheet-column" [ngClass]="{'mobile-hide': get_ShowContent() === null}">
                    <div id="spells-choiceArea-top" style="margin-top:-.3em;"></div>
                    <button (click)="toggle_Choice('')" class="choiceclosebutton"
                        *ngIf="get_ShowContent()">Close</button>
                    <!--Spell Choice content-->
                    <ng-container *ngFor="let choiceContent of get_ActiveChoiceContent(); trackBy:trackByID;">
                        <app-spellchoice (showChoiceMessage)="receive_ChoiceMessage($event)"
                            (showSpellMessage)="receive_SpellMessage($event)" [spellCasting]="choiceContent.casting"
                            [choice]="choiceContent.choice"
                            [showHeightened]="get_Character().settings.showHeightenedSpells" [allowBorrow]="allowBorrow"
                            [showChoice]="choiceContent.name" [showSpell]="get_ShowSpell()"
                            [level]="choiceContent.levelNumber"
                            [prepared]="componentParameters.allowSwitchingPreparedSpells" [spellbook]="true"
                            [showTitle]="false">
                        </app-spellchoice>
                    </ng-container>
                </div>
            </div>
        </ng-container>
    </ng-container>
</div>
