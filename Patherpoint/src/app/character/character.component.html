<div id="items" class="itemBox">
    <button class="list-item" (click)="toggleCharacterMenu()">Close</button>
    <div class="loading" *ngIf="still_loading()">Loading</div>
    <div *ngIf="!still_loading()">
        Name: <input type="text" name="name" [(ngModel)]="get_Character().name" (ngModelChange)="this.characterService.set_Changed()">
        Level
        <select [(ngModel)]="get_Character().level" (ngModelChange)="onLevelChange()">
            <option *ngFor="let level of [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]" [value]="level">{{level}}</option>
        </select>
        Deity: <input type="text" name="name" [(ngModel)]="get_Character().deity" (ngModelChange)="this.characterService.set_Changed()">
<!--BaseValues-->
        <div class="list-item">
            <button class="row button fancy-button" (click)="toggle_List('alternateBaseValues')">
                Alternate Ability Values: {{(get_Character().baseValues.length) ? "Used" : "Not used"}}
            </button>
            <div class="list-item sublist fancy-list row" *ngIf="this.showList=='alternateBaseValues'">
                <div class="list-item">
                    <input id="useAlternateBaseValues" type="checkbox"
                        (change)="onBaseValueChange()"
                        [checked]="get_Character().baseValues.length">
                    <label for="useAlternateBaseValues">
                        <strong>Enter your own Ability values</strong>
                    </label>
                </div>
                <div class="list-item" *ngFor="let ability of get_Character().baseValues">
                    {{ability.name}}
                    <input type="number" class="number" [(ngModel)]="ability.baseValue" (ngModelChange)=this.characterService.set_Changed()>
                </div>
            </div>
        </div>
        <h3>History</h3>
<!--Class-->
        <div class="list-item">
            <button class="row button" [className]="(get_Character().class.name) ? 'fancy-button' : ''" (click)="toggle_List('class')">
                Class: {{get_Character().class.name}}
            </button>
            <div class="list-item sublist row" [className]="(get_Character().class.name) ? 'fancy-list' : ''" *ngIf="this.showList=='class'">
                <div class="list-item" *ngFor="let class of get_Classes()">
                    <input id="{{class.name}}" type="checkbox" (change)="onClassChange(class, $event.target.checked)"
                    [checked]="class.name === get_Character().class.name">
                    <label for="{{class.name}}">
                        <strong>{{class.name}}</strong>
                    </label>
                </div>
            </div>
        </div>
<!--Ancestry-->
        <div *ngIf="get_Character().class.name">
            <div class="list-item list-header">
                <button class="row button" [className]="((get_Character().class.ancestry.name)) ? 'fancy-button' : ''" (click)="toggle_List('ancestry')">
                    Ancestry: {{get_Character().class.ancestry.name}}
                </button>
                <div class="list-item sublist row" [className]="((get_Character().class.ancestry.name)) ? 'fancy-list' : ''" *ngIf="this.showList=='ancestry'">
                    <div class="list-item" *ngFor="let ancestry of get_Ancestries()">
                        <input id="{{ancestry.name}}" type="checkbox" (change)="onAncestryChange(ancestry, $event.target.checked)"
                        [checked]="ancestry.name === get_Character().class.ancestry.name">
                        <label for="{{ancestry.name}}">
                            <strong>{{ancestry.name}}</strong>
                        </label>
                    </div>
                </div>
            </div>
        </div>
<!--Heritage-->
        <div *ngIf="get_Character().class.ancestry.name">
            <div class="list-item">
                <button class="row button" [className]="((get_Character().class.heritage.name)) ? 'fancy-button' : ''" (click)="toggle_List('heritage')">
                    Heritage: {{get_Character().class.heritage.name}}
                </button>
                <div class="list-item sublist row" [className]="((get_Character().class.heritage.name)) ? 'fancy-list' : ''" *ngIf="this.showList=='heritage'">
                    <div class="list-item" *ngFor="let heritage of get_Heritages('', get_Character().class.ancestry.name)">
                        <input *ngIf="!heritage.subTypes.length" id="{{heritage.name}}" type="checkbox" (change)="onHeritageChange(heritage, $event.target.checked)"
                        [checked]="heritage.name === get_Character().class.heritage.name">
                        <button class="button lower left" *ngIf="heritage.subTypes.length" id="{{heritage.name}}" (click)="toggle_Item(heritage.name+'desc')">v</button>
                        <label for="{{heritage.name}}">
                            <strong>{{heritage.name}}</strong>
                        </label>
                        <button class="button" (click)="toggle_Item(heritage.name+'desc')">
                            Show Description
                        </button>
                        <div *ngIf="this.get_showItem()==heritage.name+'desc'" class="row">
<!--Subheritages-->
                            <div class="list-item lower" *ngFor="let subheritage of heritage.subTypes">
                                <input id="{{subheritage.name}}" type="checkbox" (change)="onHeritageChange(subheritage, $event.target.checked)"
                                [checked]="subheritage.name === get_Character().class.heritage.name">
                                <label for="{{subheritage.name}}">
                                    <strong>{{subheritage.subType}}</strong>
                                </label>
                            </div>
<!--End Subheritages-->
                            <p *ngFor="let desc of heritage.desc.split('\n')">{{desc}}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
<!--Background-->
        <div *ngIf="get_Character().class.name">
            <div class="list-item">
                <button class="row button" [className]="((get_Character().class.background.name)) ? 'fancy-button' : ''" (click)="toggle_List('background')">
                    Background: {{get_Character().class.background.name}}
                </button>
                <div class="list-item sublist row" [className]="((get_Character().class.background.name)) ? 'fancy-list' : ''" *ngIf="this.showList=='background'">
                    <div class="list-item" *ngFor="let background of get_Backgrounds()">
                        <input *ngIf="!background.subTypes.length" id="{{background.name}}" type="checkbox" (change)="onBackgroundChange(background, $event.target.checked)"
                        [checked]="background.name === get_Character().class.background.name">
                        <button class="button lower left" *ngIf="background.subTypes.length" id="{{background.name}}" (click)="toggle_Item('background'+background.name)">v</button>
                        <label for="{{background.name}}">
                            <strong>{{background.name}}</strong>
                        </label>
                        <button class="button" (click)="toggle_Item('background'+background.name)">
                            Show Description
                        </button>
                        <div *ngIf="this.get_showItem()=='background'+background.name" class="row">
<!--Subbackgrounds-->
                            <div class="list-item lower" *ngFor="let subbackground of background.subTypes">
                                <input id="{{subbackground.name}}" type="checkbox" (change)="onBackgroundChange(subbackground, $event.target.checked)"
                                [checked]="subbackground.name === get_Character().class.background.name">
                                <label for="{{subbackground.name}}">
                                    <strong>{{subbackground.subType}}</strong>
                                </label>
                            </div>
<!--End Subbackgrounds-->
                            <p *ngFor="let desc of background.desc.split('\n')">{{desc}}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
<!--Levels-->
        <div *ngIf="get_Character().class">
            <div *ngFor="let level of get_Character().class.levels">
                <h3 *ngIf="level.number > 0">Level {{level.number}}</h3>
<!--Fixed information-->
                <div class="list-item fancy-button" *ngIf="level.number > 0">
                    <button class="row button fancy-button"
                        (click)="toggle_List('showFixedChanges'+level.number)">
                        Show fixed changes
                    </button>
                    <div class="list-item sublist row fancy-list" *ngIf="this.showList=='showFixedChanges'+level.number">
<!--Fixed Ability boosts-->
                        <div class="list-item" *ngFor="let boost of get_AbilityBoosts(level.number, level.number, '', '', '', '', true)">
                            Ability {{(boost.type == 'Flaw') ? 'Flaw' : 'Boost'}} ({{boost.source}}): {{boost.name}}
                        </div>
<!--Fixed Skill Increases-->
                        <div class="list-item" *ngFor="let skillIncrease of get_SkillIncreases(level.number, level.number, '', '', '', true)">
                            {{(skillIncrease.name.indexOf("Lore:") > -1) ? "Lore " : ""}}Skill Training ({{skillIncrease.source}}): {{skillIncrease.name}}
                        </div>
<!--Fixed Feats-->
                        <div title="{{get_FeatsAndFeatures(feat.name)[0].desc}}" class="list-item" *ngFor="let feat of get_FeatsTaken(level.number, level.number, '', '', '', true)">
                            Feat ({{feat.source}}): {{feat.name}}
                        </div>
                    </div>
                </div>
<!--Ability boosts-->
                <div *ngFor="let choice of level.abilityChoices">
                    <div class="list-item" *ngIf="choice.available - ((get_Character().baseValues.length > 0) ? choice.baseValuesLost : 0)"
                        [className]="(choice.boosts.length > choice.available - ((get_Character().baseValues.length > 0) ? choice.baseValuesLost : 0) || someAbilitiesIllegal(choice)) ? 'problem' : ''">
                        <button class="row button"
                            [className]="(choice.boosts.length == choice.available - ((get_Character().baseValues.length > 0) ? choice.baseValuesLost : 0)) ? 'fancy-button' : ''"
                            (click)="toggle_List(choice.id)">
                            Ability Boosts
                                ({{choice.source}}){{(choice.available - ((get_Character().baseValues.length > 0) ? choice.baseValuesLost : 0) > 1) ?
                                ": "+ choice.boosts.length + "/" + (choice.available - ((get_Character().baseValues.length > 0) ? choice.baseValuesLost : 0)) :
                                (choice.boosts.length) ? ": "+ choice.boosts[0].name : ""}}
                        </button>
                        <div class="list-item sublist row"
                            [className]="(choice.boosts.length == choice.available - ((get_Character().baseValues.length > 0) ? choice.baseValuesLost : 0)) ? 'fancy-list' : ''"
                            *ngIf="this.showList==choice.id">
                            <div class="list-item" *ngFor="let ability of get_AvailableAbilities(choice)"
                                [className]="(abilityIllegal(level.number, ability)) ? 'problem' : ''">
                                <input id="{{choice.id+ability.name}}" type="checkbox"
                                    (change)="on_AbilityBoost(ability.name, $event.target.checked, choice, false)"
                                    [checked]="get_AbilityBoosts(level.number, level.number, ability.name, 'Boost', choice.source).length"
                                    [disabled]="cannotBoost(ability, level, choice).length">
                                <label for="{{choice.id+ability.name}}">
                                    <strong>{{ability.name}}:</strong> {{ability.baseValue(this.characterService, level.number)}}&nbsp;
                                    <cite style="color:darkred" *ngFor="let reason of cannotBoost(ability, level, choice)">
                                        {{reason}}&nbsp;
                                    </cite>
                                    <cite style="color:darkred" *ngIf="abilityIllegal(level.number, ability)">
                                        Abilities cannot be raised above 18 on level 1!&nbsp;
                                    </cite>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
<!--Skill Increases-->
                <div *ngFor="let choice of level.skillChoices">
                    <div class="list-item" *ngIf="choice.available"
                        [className]="(choice.increases.length > choice.available + get_SkillINTBonus(choice) || someIllegal(choice)) ? 'problem' : ''">
                        <button class="row button"
                            [className]="(choice.available + get_SkillINTBonus(choice) == choice.increases.length ) ? 'fancy-button' : ''"
                            (click)="toggle_List(choice.id)">
                            Skill Training
                            ({{choice.source}}){{(choice.available + get_SkillINTBonus(choice) > 1) ?
                                (": "+ choice.increases.length +"/"+ (choice.available + get_SkillINTBonus(choice)) ) : 
                                (choice.increases.length) ? ": "+ choice.increases[0].name : ""}}
                        </button>
                        <div class="list-item sublist row"
                            [className]="(choice.available + get_SkillINTBonus(choice) == choice.increases.length ) ? 'fancy-list' : ''"
                            *ngIf="this.showList==choice.id">
                            <div class="list-item"  *ngFor="let skill of get_AvailableSkills(choice)|sortBy:'asc':'name'"
                                [className]="(!skill.isLegal(this.characterService, level.number) ||
                                    (!skill.isLegal(this.characterService, level.number, choice.maxRank) && skillIncreasedByThis(skill, choice))) ? 'problem' : ''">
                                <input id="{{choice.id+skill.name}}" type="checkbox"
                                    (change)="on_SkillIncrease(skill.name, $event.target.checked, choice, false)"
                                    [checked]="skillIncreasedByThis(skill, choice)"
                                    [disabled]="cannotIncrease(skill, level, choice).length && !skillIncreasedByThis(skill, choice)">
                                <label for="{{choice.id+skill.name}}">
                                    <strong>{{skill.name}}:</strong>
                                    <app-proficiency-form [skill]="skill" [characterService]="this.characterService" [level]="level.number"></app-proficiency-form>
                                    <cite style="color:darkred" *ngFor="let reason of cannotIncrease(skill, level, choice)">
                                        {{reason}}&nbsp;
                                    </cite>
                                    <cite style="color:darkred" *ngIf="!skill.isLegal(this.characterService, level.number) || (!skill.isLegal(this.characterService, level.number, choice.maxRank) && skillIncreasedByThis(skill, choice))">
                                        This skill was raised higher than allowed!&nbsp;
                                    </cite>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
<!--Lore Training-->
                <div *ngFor="let choice of level.loreChoices">
                    <div class="list-item" *ngIf="choice.available"
                        [className]="(choice.increases.length > choice.available) ? 'problem' : ''">
                        <button class="row button" [className]="(choice.available == choice.increases.length ) ? 'fancy-button' : ''"
                            (click)="toggle_List(choice.id)">
                            Lore Training
                            ({{choice.source}}){{(choice.increases.length) ? ": "+ choice.increases[0].name : ""}}
                        </button>
                        <div class="list-item sublist row"
                            [className]="(choice.available == choice.increases.length ) ? 'fancy-list' : ''"
                            *ngIf="this.showList==choice.id">
                            <div class="list-item">
                                <input id="{{choice.id+'LoreIncreaseBox'}}" type="checkbox"
                                    (change)="on_LoreChange($event.target.checked, choice)"
                                    [checked]="get_SkillIncreases(level.number, level.number, 'Lore: '+choice.loreName, choice.source, choice.id).length"
                                    [disabled]="choice.loreName == ''||get_Skills('Lore: '+choice.loreName).length && !get_SkillIncreases(level.number, level.number, 'Lore: '+choice.loreName, choice.source, choice.id).length">
                                <label for="{{choice.id+'LoreIncreaseBox'}}">
                                    <strong>Lore:
                                        <input type="text" [(ngModel)]="choice.loreName"
                                            [disabled]="get_SkillIncreases(level.number, level.number, 'Lore: '+choice.loreName, choice.source, choice.id).length"
                                            (ngModelChange)=this.characterService.set_Changed()>
                                    </strong>
                                    <span>&nbsp;{{choice.loreDesc}}</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
<!--Feat choices-->
                <div *ngFor="let choice of level.featChoices">
                    <div class="list-item" *ngIf="choice.available"
                        [className]="(choice.feats.length > choice.available || cannotTakeSome(choice)) ? 'problem' : ''">
                        <button class="row button"
                            [className]="(choice.available == choice.feats.length) ? 'fancy-button' : ''"
                            (click)="toggle_List(choice.source+choice.id)">
                            {{(choice.level) ? "Level "+choice.level+" " : ""}}{{choice.type}} Feats
                            ({{choice.source}}){{(choice.available > 1) ?
                                ": "+ choice.feats.length +"/"+ choice.available : 
                                (choice.feats.length) ? ": "+ choice.feats[0].name : ""}}
                        </button>
                        <div class="list-item sublist row"
                            [className]="(choice.available == choice.feats.length ) ? 'fancy-list' : ''"
                            *ngIf="this.showList==choice.source+choice.id">
                            <div
                                title="{{(this.get_showItem()==choice.id+feat.name+'desc') ? '' : feat.shortDesc}}"
                                class="list-item"
                                *ngFor="let feat of get_AvailableFeats(choice)"
                                [className]="(cannotTake(feat, choice).length) ? 'problem' : ''">
                                <input *ngIf="!feat.subTypes" id="{{choice.id+feat.name}}" type="checkbox"
                                    (change)="on_FeatTaken(feat.name, $event.target.checked, choice, false)"
                                    [checked]="featTakenByThis(feat, choice)"
                                    [disabled]="cannotTake(feat, choice).length && !featTakenByThis(feat, choice)">
                                <button class="button lower left" *ngIf="feat.subTypes" id="{{choice.id+feat.name}}" (click)="toggle_Item(choice.id+feat.name+'desc')">v</button>
                                <label for="{{choice.id+feat.name}}">
                                    <strong>{{feat.name}}&nbsp;</strong><cite>Level {{feat.levelreq}}</cite>
                                </label>
                                <cite style="color:darkred" *ngFor="let reason of cannotTake(feat, choice)">
                                    {{reason}}&nbsp;
                                </cite>
                                <button class="button" (click)="toggle_Item(choice.id+feat.name+'desc')">
                                    Show Description
                                </button>
                                <div *ngIf="this.get_showItem()==choice.id+feat.name+'desc'" class="row">
<!--Subfeats-->
                                    <div class="list-item lower" *ngFor="let subfeat of get_SubFeats(feat, choice)"
                                        [className]="(cannotTake(subfeat, choice).length) ? 'problem' : ''">
                                        <input id="{{choice.id+subfeat.name}}" type="checkbox"
                                            (change)="on_FeatTaken(subfeat.name, $event.target.checked, choice, false)"
                                            [checked]="featTakenByThis(subfeat, choice)"
                                            [disabled]="cannotTake(subfeat, choice).length && !featTakenByThis(subfeat, choice)">
                                        <label for="{{choice.id+subfeat.name}}">
                                            <strong>{{subfeat.subType}}&nbsp;</strong>
                                            <span [className]="(req.met == false) ? 'problem' : ''" *ngFor="let req of get_FeatRequirements(choice, subfeat, feat)">{{(req.desc == ", ") ? req.desc : "&nbsp;"+req.desc }}</span>
                                            <cite style="color:darkred" *ngFor="let reason of cannotTake(subfeat, choice)">
                                                {{reason}}&nbsp;
                                            </cite>
                                        </label>
                                    </div>
<!--Unavailable Subfeats-->
                                    <div class="list-item lower unavailable" *ngFor="let subfeat of get_SubFeats(feat, choice, true)">
                                        <strong>{{subfeat.subType}}&nbsp;</strong>
                                        <span [className]="(req.met == false) ? 'problem' : ''" *ngFor="let req of get_FeatRequirements(choice, subfeat, feat)">{{(req.desc == ", ") ? req.desc : "&nbsp;"+req.desc }}</span>
                                        <cite style="color:darkred" *ngFor="let reason of cannotTake(subfeat, choice)">
                                            {{reason}}&nbsp;
                                        </cite>
                                    </div>
<!--End Subfeats-->
                                    <cite *ngFor="let trait of feat.traits">
                                        {{trait}}&nbsp;
                                    </cite>
                                    <div class="row">
                                        <p>
                                            <strong>Requirements&nbsp;</strong>
                                            <span [className]="(req.met == false) ? 'problem' : ''" *ngFor="let req of get_FeatRequirements(choice, feat)">{{req.desc}}</span>
                                        </p>
                                        <p *ngFor="let desc of feat.desc.split('\n')">
                                            {{desc}}
                                        </p>
                                        <p *ngIf="feat.specialdesc.length">
                                            <strong>Special</strong>
                                            {{feat.specialdesc}}
                                        </p>
                                    </div>
                                </div>
                            </div>
<!--UnavailableFeats-->
                            <div
                                class="list-item unavailable"
                                title="{{(this.get_showItem()==choice.id+feat.name+'desc') ? '' : feat.shortDesc}}"
                                *ngFor="let feat of get_AvailableFeats(choice, true)">
                                <strong>{{feat.name}}&nbsp;</strong><cite>Level {{feat.levelreq}}</cite>
                                <cite style="color:darkred" *ngFor="let reason of cannotTake(feat, choice)">
                                    {{reason}}&nbsp;
                                </cite>
                                <button class="button" (click)="toggle_Item(choice.id+feat.name+'desc')">
                                    Show Description
                                </button>
                                <div *ngIf="this.get_showItem()==choice.id+feat.name+'desc'">
<!--Subfeats-->
                                    <div class="list-item lower unavailable" *ngFor="let subfeat of get_SubFeats(feat, choice)">
                                        <strong>{{subfeat.subType}}&nbsp;</strong>
                                        <span [className]="(req.met == false) ? 'problem' : ''" *ngFor="let req of get_FeatRequirements(choice, subfeat, feat)">{{(req.desc == ", ") ? req.desc : "&nbsp;"+req.desc }}</span>
                                        <cite style="color:darkred" *ngFor="let reason of cannotTake(subfeat, choice)">
                                            {{reason}}&nbsp;
                                        </cite>
                                    </div>
<!--Unavailable Subfeats-->
                                    <div class="list-item lower unavailable" *ngFor="let subfeat of get_SubFeats(feat, choice, true)">
                                        <strong>{{subfeat.subType}}&nbsp;</strong>
                                        <span [className]="(req.met == false) ? 'problem' : ''" *ngFor="let req of get_FeatRequirements(choice, subfeat, feat)">{{(req.desc == ", ") ? req.desc : "&nbsp;"+req.desc }}</span>
                                        <cite style="color:darkred" *ngFor="let reason of cannotTake(subfeat, choice)">
                                            {{reason}}&nbsp;
                                        </cite>
                                    </div>
<!--End Subfeats-->
                                    <cite *ngFor="let trait of feat.traits">
                                        {{trait}}&nbsp;
                                    </cite>
                                    <div class="row">
                                        <p>
                                            <strong>Requirements&nbsp;</strong>
                                            <span [className]="(req.met == false) ? 'problem' : ''" *ngFor="let req of get_FeatRequirements(choice, feat)">{{req.desc}}</span>
                                        </p>
                                        <p *ngFor="let desc of feat.desc.split('\n')">
                                            {{desc}}
                                        </p>
                                        <p *ngIf="feat.specialdesc.length">
                                            <strong>Special</strong>
                                            {{feat.specialdesc}}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>