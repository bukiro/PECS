<div class="list-item" *ngIf="get_Available(choice) || get_SpellBlendingUsed() || get_InfinitePossibilitiesUsed()"
    [ngClass]="{'problem':(choice.spells.length > get_Available(choice) || cannotTakeSome(choice)), 'fullsize-only':(get_Available(choice) == choice.spells.length)}">
    <ng-container *ngFor="let signatureSpellsAllowed of [get_SignatureSpellsAllowed()]; trackBy:trackByIndex;">
        <ng-container *ngFor="let available of [get_Available(choice)]; trackBy:trackByIndex;">
        <button class="row left-aligned sublist-toggle"
            [ngClass]="{'fancy-button':(available == choice.spells.length)}"
            (click)="toggle_Choice(choice.source+choice.id)">
            <span title="Signature spell" *ngIf="is_SignatureSpell(choice, signatureSpellsAllowed)">&#9733;&nbsp;</span>
            <span title="Combination spell" *ngIf="choice.spellCombinationAllowed">&#8853;&nbsp;</span>
            <span title="Infinite Possibilities spell" *ngIf="is_InfinitePossibilitiesSpell(choice)">&#9883;&nbsp;</span>
            {{itemSpell || choice.showOnSheet ? "Level "+choice.level : ""}}
            {{choice.frequency ? capitalize(choice.frequency) : ""}}
            {{choice.tradition ? choice.tradition : ""}}
            {{choice.source == 'Feat: Adapted Cantrip' ? "non-"+spellCasting.tradition : ""}}
            {{choice.traitFilter.length ? choice.traitFilter.join(" ") : ""}}
            {{is_SignatureSpell(choice, signatureSpellsAllowed) ? "Signature" : ""}}
            {{choice.spellCombinationAllowed ? "Combination" : ""}}
            {{choice.className}}
            {{choice.spellBookOnly ? "Spellbook" : ""}}
            Spell{{(available != 1) ? "s" : ""}}{{!itemSpell ? " ("+choice.source+")" : ""}}{{(available != 1) ?
                ": "+ choice.spells.length +"/"+ available : 
                (choice.spells.length) ? ": "+ choice.spells[0].name + (choice.spells[0].combinationSpellName ? " & " + choice.spells[0].combinationSpellName : "") : ""}}
        </button>
        <div class="list-item sublist" [ngClass]="{'fancy-list':(available == choice.spells.length )}"
            *ngIf="get_ShowChoice()==choice.source+choice.id">
            <!-- Signature Spells -->
            <ng-container *ngIf="signatureSpellsAllowed">
                <div class="list-item">
                    <strong>Signature Spell</strong>
                    <div class="row" *ngIf="get_SignatureSpellsUnlocked(choice.level) && !choice.signatureSpell">
                        There is already a signature spell chosen for this level.
                    </div>
                    <div class="row" *ngIf="choice.signatureSpell || !get_SignatureSpellsUnlocked(choice.level)">
                        <span>
                            <input id="{{choice.id}}signaturespell" type="checkbox"
                                [(ngModel)]="choice.signatureSpell" (ngModelChange)="on_SignatureSpell()">
                            <label for="{{choice.id}}signaturespell">Choose this spell as a signature spell.</label>
                        </span>
                    </div>
                </div>
            </ng-container>
            <!-- End Signature Spells -->
            <!-- Spell Blending -->
            <ng-container *ngIf="spellbook && get_SpellBlendingAllowed()">
                <div class="list-item">
                    <strong>Spell Blending</strong>
                    <div class="row"
                        *ngIf="get_SpellBlendingUnlocked(0) && get_SpellBlendingUnlocked(choice.level + 1) && get_SpellBlendingUnlocked(choice.level + 2) && choice.spellBlending.toString() == '0,0,0'">
                        No bonus spell slots can currently be unlocked by trading in this spell slot.
                    </div>
                    <div class="row" *ngIf="!get_SpellBlendingUnlocked(0) || choice.spellBlending[0]">
                        <span>
                            <button [disabled]="!choice.spellBlending[0]" (click)="on_SpellBlending(0, -1)">-</button>
                            <button
                                [disabled]="get_SpellBlendingUnlocked(0) || available <= choice.spells.length"
                                (click)="on_SpellBlending(0, 1)">+</button>
                            {{choice.spellBlending[0]}} spell slot{{choice.spellBlending[0] ? "" : "s"}} traded in for 2
                            cantrip slots
                        </span>
                    </div>
                    <div class="row" *ngIf="!get_SpellBlendingUnlocked(choice.level + 1) || choice.spellBlending[1]">
                        <span>
                            <button [disabled]="!choice.spellBlending[1]" (click)="on_SpellBlending(1, -1)">-</button>
                            <button
                                [disabled]="get_SpellBlendingUnlocked(choice.level + 1) || available <= choice.spells.length"
                                (click)="on_SpellBlending(1, 1)">+</button>
                            {{choice.spellBlending[1]}} spell slot{{choice.spellBlending[1] != 1 ? "s" : ""}} traded in for
                            level {{choice.level + 1}} spell slot (2 needed for 1)
                        </span>
                    </div>
                    <div class="row" *ngIf="!get_SpellBlendingUnlocked(choice.level + 2) || choice.spellBlending[2]">
                        <span>
                            <button [disabled]="!choice.spellBlending[2]" (click)="on_SpellBlending(2, -1)">-</button>
                            <button
                                [disabled]="get_SpellBlendingUnlocked(choice.level + 2) || available <= choice.spells.length"
                                (click)="on_SpellBlending(2, 1)">+</button>
                            {{choice.spellBlending[2]}} spell slot{{choice.spellBlending[2] != 1 ? "s" : ""}} traded in for
                            level {{choice.level + 2}} spell slot (2 needed for 1)
                        </span>
                    </div>
                </div>
            </ng-container>
            <!-- End Spell Blending -->
            <!-- Infinite Possibilities -->
            <ng-container *ngIf="spellbook && get_InfinitePossibilitiesAllowed()">
                <div class="list-item">
                    <strong>Infinite Possibilities</strong>
                    <div class="row" *ngIf="get_InfinitePossibilitiesUnlocked() && !choice.infinitePossibilities">
                        There is already an Infinite Possibilities spell slot unlocked.
                    </div>
                    <div class="row" *ngIf="!get_InfinitePossibilitiesUnlocked() || choice.infinitePossibilities">
                        <span>
                            <input id="{{choice.id}}infinitePossibilities" type="checkbox"
                                [(ngModel)]="choice.infinitePossibilities" (ngModelChange)="on_InfinitePossibilities()"
                                [disabled]="(available <= choice.spells.length) && !choice.infinitePossibilities">
                            <label for="{{choice.id}}infinitePossibilities">Trade one spell slot in for a level
                                {{choice.level - 2}} Infinite Possibilities spell slot.</label>
                        </span>
                    </div>
                </div>
            </ng-container>
            <!-- End Infinite Possibilities -->
            <!-- Spell Combination -->
            <ng-container *ngIf="choice.spellCombinationAllowed">
                <div class="list-item">
                    <strong>Spell Combination</strong>
                    <div class="row">
                        <span>
                            <input id="{{choice.id}}spellCombination" type="checkbox" [(ngModel)]="choice.spellCombination"
                                (ngModelChange)="on_SpellCombination(choice)"
                                [disabled]="available <= choice.spells.length">
                            <label for="{{choice.id}}spellCombination">
                                Use this spell slot as a spell combination slot.
                            </label>
                        </span>
                    </div>
                    <div class="row left-aligned" *ngIf="choice.spellCombination">
                        <p>
                            Both spells must be level {{choice.level - 2}} or lower, and both must target only one creature
                            or object or have the option to target only one creature or object.
                        </p>
                        <p>
                            The second spell you choose for this spell slot must have the same means of determining whether
                            it has an effect as the first spell - both spells must require a ranged spell attack roll,
                            require the same type of saving throw, or automatically affect the target.
                        </p>
                    </div>
                </div>
            </ng-container>
            <!-- End Spell Combination -->
            <!-- Esoteric Polymath -->
            <ng-container *ngIf="is_EsotericPolymathSpell(choice)">
                <div class="list-item">
                    <strong>Esoteric Polymath</strong>
                    <span class="row left-aligned">
                        <strong>Spell Level&nbsp;</strong>
                        <button (click)="on_ChangeSpellLevel(choice, -1)"
                            [disabled]="choice.level <= 1">-</button>
                        <button (click)="on_ChangeSpellLevel(choice, 1)"
                            [disabled]="choice.level >= get_HighestSpellLevel()">+</button>
                    </span>
                        <p>
                            During your daily preparations, choose any one spell from your book of occult spells.
                            If that spell is already in your spell repertoire, you can treat it as an additional signature spell that day.
                            If it isn't in your repertoire, treat it as though it were until your next daily preparations.
                        </p>
                        <p>
                            You may add all spells from your repertoire to this book for free,
                            and you can use the Occultism skill to Learn Spells (page 238) and add them to your spellbook by paying the approptiate cost,
                            similar to a wizard.
                        </p>
                </div>
            </ng-container>
            <!-- End Esoteric Polymath -->
            <ng-container *ngFor="let spells of [get_AvailableSpells(choice)]; trackBy:trackByIndex;">
                <div class="list-item" *ngIf="!available && !choice.spells.length">
                    <span>There are no spell slots available in this choice.</span>
                </div>
                <div class="list-item" *ngIf="available && !spells?.length">
                    <span>No available spell matches the requirements of this spell choice, or no spells are
                        available.</span>
                    <span *ngIf="!allowHeightened">More spells may be found if you allow heightened spells.</span>
                </div>
                <div title="{{(this.get_ShowSpell()==choice.id+spell.name+'desc') ? '' : spell.shortDesc}}"
                    class="list-item" *ngFor="let spell of spells; trackBy:trackByIndex;">
                    <span>
                        <input id="{{choice.id+spell.name}}" type="checkbox"
                            (change)="on_SpellTaken(spell.name, $event.target.checked, choice, false)"
                            [checked]="spellTakenByThis(spell.name, choice)"
                            [disabled]="cannotTake(spell, choice).length && !spellTakenByThis(spell.name, choice)"
                            *ngIf="spellCasting?.castingType!='Prepared' && !lockedSpellTakenByThis(spell.name, choice)">
                        <ng-container
                            *ngIf="!choice.spellCombination || (choice.spellCombination && (!choice.spells.length || choice.spells[0].name == spell.name))">
                            <span
                                *ngIf="choice.spellCombination && (!choice.spells.length || choice.spells[0].name == spell.name)">1&nbsp;</span>
                            <button (click)="on_SpellTaken(spell.name, false, choice, false)"
                                [disabled]="!spellTakenByThis(spell.name, choice)"
                                *ngIf="spellCasting?.castingType=='Prepared'">-</button>
                            <button (click)="on_SpellTaken(spell.name, true, choice, false)"
                                [disabled]="cannotTake(spell, choice).length || choice.spells.length >= available"
                                *ngIf="spellCasting?.castingType=='Prepared'">+</button>
                        </ng-container>
                        <ng-container
                            *ngIf="choice.spellCombination && choice.spells.length && choice.spells[0].name != spell.name && (!choice.spells[0].combinationSpellName || choice.spells[0].combinationSpellName == spell.name)">
                            <span
                                *ngIf="choice.spellCombination && choice.spells.length && (!choice.spells[0].combinationSpellName || choice.spells[0].combinationSpellName == spell.name)">2&nbsp;</span>
                            <button (click)="on_SpellCombinationTaken(spell.name, false, choice)"
                                [disabled]="!spellTakenByThis(spell.name, choice)"
                                *ngIf="spellCasting?.castingType=='Prepared'">-</button>
                            <button (click)="on_SpellCombinationTaken(spell.name, true, choice)"
                                [disabled]="cannotTake(spell, choice).length || choice.spells.length >= available && choice.spells[0]?.combinationSpellName"
                                *ngIf="spellCasting?.castingType=='Prepared'">+</button>
                        </ng-container>
                        <span *ngIf="spellCasting?.castingType=='Prepared'">&nbsp;</span>
                        <label for="{{choice.id+spell.name}}">
                            <strong>{{(spellCasting?.castingType == 'Prepared' && spellTakenByThis(spell.name, choice)) ? " " + spellTakenByThis(spell.name, choice) + " " : ""}}{{spell.name}}&nbsp;</strong><cite>Level
                                {{spell.levelreq}}</cite>
                            <cite class="trait" *ngIf="spell.traits.includes('Rare')"
                                title="{{get_Traits('Rare')[0]?.description}}">Rare</cite>
                            <cite class="trait" *ngIf="spell.traits.includes('Uncommon')"
                                title="{{get_Traits('Uncommon')[0]?.description}}">Uncommon</cite>
                        </label>
                    </span>
                    <cite class="problem" *ngFor="let reason of cannotTake(spell, choice); trackBy:trackByIndex;">
                        {{reason}}
                    </cite>
                    <button class="right-bound" (click)="toggle_Spell(choice.id+spell.name+'desc')">
                        Show Description
                    </button>
                    <div class="row left-aligned" *ngIf="this.get_ShowSpell()==choice.id+spell.name+'desc'">
                        <app-spell [spell]="spell" [spellLevel]="level"></app-spell>
                    </div>
                </div>
            </ng-container>
        </div>
        </ng-container>
    </ng-container>
</div>