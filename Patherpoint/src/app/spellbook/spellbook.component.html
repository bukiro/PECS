<button class="minimizebutton lower" (click)="minimize()">&#8691;</button>
<div id="spellbook-height" class="attributeBox">
    <h3 class="box-header">Spells</h3>
    <div class="loading" *ngIf="still_loading()">Loading</div>
    <ng-container *ngIf="!still_loading()">
        <app-tags [creature]="'Character'" [objectName]="'Spellbook'" [showTraits]=true [showFeats]=true [showItems]=true
            [showActivities]=true [showConditions]=true [showEffects]=true></app-tags>
        <button class="fullsize-only center-aligned list-item" (click)="toggleSpellsMenu()">Get
            Spells</button>
        <ng-container *ngFor="let casting of get_SpellCastings(); trackBy:trackByIndex;">
            <h3>
                {{(casting.className + " " + casting.tradition + ((casting.castingType == "Focus") ? (" " + casting.source) : " Spells")).trim()}}
                <span class="lower" *ngIf="['Prepared', 'Spontaneous'].includes(casting.castingType)">
                    <span class="lower">
                        {{casting.castingType}}
                    </span>
                </span>
                <strong class="lower" *ngIf="casting.bondedItemCharges[0]">
                    {{casting.bondedItemCharges[0]}} charge available
                </strong>
            </h3>
            <ng-container *ngFor="let level of [-1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10]; trackBy:trackByIndex;">
                <ng-container *ngIf="level <= get_MaxSpellLevel()">
                    <ng-container *ngFor="let spellTaken of get_SpellsByLevel(level, casting); let index = index; trackBy:trackByIndex;">
                        <ng-container *ngFor="let maxspellslots of [get_MaxSpellSlots(level, casting)]; trackBy:trackByIndex;">
                            <div class="list-item row" style="background-color:transparent" *ngIf="index == 0">
                                <strong>
                                    {{level == -1 ? "Focus Spells" : (level == 0 ? "Cantrips" : "Level "+level)}}
                                </strong>
                                <strong *ngIf="maxspellslots">
                                    {{(maxspellslots - get_UsedSpellSlots(level, casting)) + " / " + maxspellslots}}
                                </strong>
                                <strong *ngIf="casting.bondedItemCharges[level] && level != 0">
                                    {{casting.bondedItemCharges[level]}} charge available
                                </strong>
                            </div>
                            <div class="list-item" [ngClass]="{'problem':(get_FocusPoints() > get_MaxFocusPoints())}"
                                *ngIf="level == -1 && index == 0">
                                <strong>Focus Points</strong>
                                <input type="number" class="number2" [ngModel]="get_FocusPoints()" disabled>
                                <strong>Focus Pool</strong>
                                <input type="number" class="number2" [ngModel]="get_MaxFocusPoints()" disabled>
                                <button class="row center-aligned" (click)="refocus()"
                                    [disabled]="get_FocusPoints() >= get_MaxFocusPoints()">
                                    Refocus
                                </button>
                                <app-tags [objectName]="'Focus'" [showTraits]=true [showFeats]=true [showItems]=true
                                    [showActivities]=true [showConditions]=true [showEffects]=true></app-tags>
                            </div>
                            <ng-container *ngFor="let spell of get_Spells(spellTaken.gain.name); trackBy:trackByIndex;">
                                <div class="list-item" *ngFor="let spellID of [get_ID()]; trackBy:trackByIndex;">
                                    <button class="row sublist-toggle left-aligned"
                                        (click)="toggle_Spell(casting.castingType+casting.class+spellTaken.gain.name+spellID)"
                                        [className]="{'inactive-button': casting.castingType=='Prepared' && !spellTaken.gain.prepared && level > 0}">
                                        <span title="Signature spell" *ngIf="is_SignatureSpell(spellTaken.choice)">&#9733;&nbsp;</span>{{spell.name}}<app-actionIcons [actionString]="spell.actions">
                                        </app-actionIcons>{{spell.castType}}
                                        {{spellTaken.gain.frequency ? spellTaken.gain.frequency : ""}}
                                    </button>
                                    <div class="list-item sublist lower"
                                        [className]="{'inactive-list': casting.castingType=='Prepared'&&!spellTaken.gain.prepared && level > 0}"
                                        *ngIf="this.get_showSpell()==casting.castingType+casting.class+spellTaken.gain.name+spellID">
                                        <button class="row center-aligned"
                                            (click)="on_Restore(spellTaken.gain, casting, level)"
                                            *ngIf="casting.castingType == 'Prepared' && casting.className == 'Wizard' && !spellTaken.gain.prepared && level > 0"
                                            title="{{(!casting.bondedItemCharges[level] && !casting.bondedItemCharges[0]) ? 'No bonded item charges remaining.' : ''}}"
                                            [disabled]="!casting.bondedItemCharges[level] && !casting.bondedItemCharges[0]">
                                            <span class="center-aligned">Restore with bonded item <app-actionIcons [actionString]="'Free'">
                                            </app-actionIcons></span>
                                        </button>
                                        <button class="row center-aligned"
                                            (click)="on_Cast(spellTaken.gain, casting, spellTaken.choice, 'Character', spell, true)"
                                            *ngIf="['self', 'ally'].includes(spell.target) && !spellTaken.gain.active"
                                            title="{{cannot_Cast(spell, level, casting, spellTaken.choice, spellTaken.gain, maxspellslots)}}"
                                            [disabled]="cannot_Cast(spell, level, casting, spellTaken.choice, spellTaken.gain, maxspellslots)">
                                            {{spell.target == 'ally' ? "Cast on yourself" : "Cast"}}
                                        </button>
                                        <button class="row center-aligned"
                                            (click)="on_Cast(spellTaken.gain, casting, spellTaken.choice, 'Companion', spell, true)"
                                            *ngIf="['companion', 'ally'].includes(spell.target) && !spellTaken.gain.active && get_CompanionAvailable()"
                                            title="{{cannot_Cast(spell, level, casting, spellTaken.choice, spellTaken.gain, maxspellslots)}}"
                                            [disabled]="cannot_Cast(spell, level, casting, spellTaken.choice, spellTaken.gain, maxspellslots)">
                                            Cast on your animal companion
                                        </button>
                                        <button class="row center-aligned"
                                            (click)="on_Cast(spellTaken.gain, casting, spellTaken.choice, 'Familiar', spell, true)"
                                            *ngIf="['companion', 'ally'].includes(spell.target) && !spellTaken.gain.active && get_FamiliarAvailable()"
                                            title="{{cannot_Cast(spell, level, casting, spellTaken.choice, spellTaken.gain, maxspellslots)}}"
                                            [disabled]="cannot_Cast(spell, level, casting, spellTaken.choice, spellTaken.gain, maxspellslots)">
                                            Cast on your Familiar
                                        </button>
                                        <button class="row center-aligned"
                                            (click)="on_Cast(spellTaken.gain, casting, spellTaken.choice, '', spell, true)"
                                            *ngIf="spell.target == 'ally' && !spellTaken.gain.active"
                                            title="{{cannot_Cast(spell, level, casting, spellTaken.choice, spellTaken.gain, maxspellslots)}}"
                                            [disabled]="cannot_Cast(spell, level, casting, spellTaken.choice, spellTaken.gain, maxspellslots)">
                                            Cast on other targets
                                        </button>
                                        <button class="row center-aligned"
                                            (click)="on_Cast(spellTaken.gain, casting, spellTaken.choice, '', spell, true)"
                                            *ngIf="!spell.target && !spellTaken.gain.active"
                                            title="{{cannot_Cast(spell, level, casting, spellTaken.choice, spellTaken.gain, maxspellslots)}}"
                                            [disabled]="cannot_Cast(spell, level, casting, spellTaken.choice, spellTaken.gain, maxspellslots)">
                                            Cast
                                        </button>
                                        <button class="row center-aligned"
                                            (click)="on_Cast(spellTaken.gain, casting, spellTaken.choice, spellTaken.gain.target, spell, false)"
                                            *ngIf="spellTaken.gain.active">
                                            Stop sustaining
                                            {{spellTaken.gain.duration ? "(Duration: " + get_Duration(spellTaken.gain.duration) + ")" : ""}}
                                        </button>
                                        <button class="row center-aligned"
                                            (click)="on_Counterspell(spellTaken.gain, casting, spellTaken.choice, spell)"
                                            *ngIf="can_Counterspell(casting) && !spellTaken.gain.active"
                                            title="{{cannot_Cast(spell, level, casting, spellTaken.choice, spellTaken.gain, maxspellslots)}}"
                                            [disabled]="cannot_Cast(spell, level, casting, spellTaken.choice, spellTaken.gain, maxspellslots)">
                                            Use for Counterspells
                                        </button>
                                        <app-spell [spell]="spell" [spellLevel]="level"></app-spell>
                                    </div>
                                </div>
                            </ng-container>
                        </ng-container>
                    </ng-container>
                </ng-container>
            </ng-container>
        </ng-container>
    </ng-container>
</div>
<div *ngIf="set_Span()"></div>